
// ===== FILE: app\globals.css =====

@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

/* <CHANGE> Enterprise dark theme with emerald accent for RBAC admin panel */
:root {
  --background: oklch(0.985 0 0);
  --foreground: oklch(0.145 0 0);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.145 0 0);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.145 0 0);
  --primary: oklch(0.696 0.17 162.48);
  --primary-foreground: oklch(0.985 0 0);
  --secondary: oklch(0.97 0 0);
  --secondary-foreground: oklch(0.205 0 0);
  --muted: oklch(0.97 0 0);
  --muted-foreground: oklch(0.556 0 0);
  --accent: oklch(0.97 0 0);
  --accent-foreground: oklch(0.205 0 0);
  --destructive: oklch(0.577 0.245 27.325);
  --destructive-foreground: oklch(0.985 0 0);
  --border: oklch(0.922 0 0);
  --input: oklch(0.922 0 0);
  --ring: oklch(0.696 0.17 162.48);
  --chart-1: oklch(0.646 0.222 41.116);
  --chart-2: oklch(0.6 0.118 184.704);
  --chart-3: oklch(0.398 0.07 227.392);
  --chart-4: oklch(0.828 0.189 84.429);
  --chart-5: oklch(0.769 0.188 70.08);
  --radius: 0.5rem;
  --sidebar: oklch(0.985 0 0);
  --sidebar-foreground: oklch(0.145 0 0);
  --sidebar-primary: oklch(0.696 0.17 162.48);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.97 0 0);
  --sidebar-accent-foreground: oklch(0.205 0 0);
  --sidebar-border: oklch(0.922 0 0);
  --sidebar-ring: oklch(0.696 0.17 162.48);
}

.dark {
  --background: oklch(0.12 0 0);
  --foreground: oklch(0.985 0 0);
  --card: oklch(0.16 0 0);
  --card-foreground: oklch(0.985 0 0);
  --popover: oklch(0.16 0 0);
  --popover-foreground: oklch(0.985 0 0);
  --primary: oklch(0.696 0.17 162.48);
  --primary-foreground: oklch(0.12 0 0);
  --secondary: oklch(0.22 0 0);
  --secondary-foreground: oklch(0.985 0 0);
  --muted: oklch(0.22 0 0);
  --muted-foreground: oklch(0.65 0 0);
  --accent: oklch(0.22 0 0);
  --accent-foreground: oklch(0.985 0 0);
  --destructive: oklch(0.577 0.245 27.325);
  --destructive-foreground: oklch(0.985 0 0);
  --border: oklch(0.25 0 0);
  --input: oklch(0.22 0 0);
  --ring: oklch(0.696 0.17 162.48);
  --chart-1: oklch(0.696 0.17 162.48);
  --chart-2: oklch(0.488 0.243 264.376);
  --chart-3: oklch(0.769 0.188 70.08);
  --chart-4: oklch(0.627 0.265 303.9);
  --chart-5: oklch(0.645 0.246 16.439);
  --sidebar: oklch(0.14 0 0);
  --sidebar-foreground: oklch(0.985 0 0);
  --sidebar-primary: oklch(0.696 0.17 162.48);
  --sidebar-primary-foreground: oklch(0.12 0 0);
  --sidebar-accent: oklch(0.22 0 0);
  --sidebar-accent-foreground: oklch(0.985 0 0);
  --sidebar-border: oklch(0.25 0 0);
  --sidebar-ring: oklch(0.696 0.17 162.48);
}

@theme inline {
  --font-sans: "Geist", "Geist Fallback";
  --font-mono: "Geist Mono", "Geist Mono Fallback";
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --color-card: var(--card);
  --color-card-foreground: var(--card-foreground);
  --color-popover: var(--popover);
  --color-popover-foreground: var(--popover-foreground);
  --color-primary: var(--primary);
  --color-primary-foreground: var(--primary-foreground);
  --color-secondary: var(--secondary);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-muted: var(--muted);
  --color-muted-foreground: var(--muted-foreground);
  --color-accent: var(--accent);
  --color-accent-foreground: var(--accent-foreground);
  --color-destructive: var(--destructive);
  --color-destructive-foreground: var(--destructive-foreground);
  --color-border: var(--border);
  --color-input: var(--input);
  --color-ring: var(--ring);
  --color-chart-1: var(--chart-1);
  --color-chart-2: var(--chart-2);
  --color-chart-3: var(--chart-3);
  --color-chart-4: var(--chart-4);
  --color-chart-5: var(--chart-5);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --color-sidebar: var(--sidebar);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-ring: var(--sidebar-ring);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
}

// ===== FILE: app\layout.tsx =====

import type React from "react"
import type { Metadata } from "next"
import { Geist, Geist_Mono } from "next/font/google"
import { Analytics } from "@vercel/analytics/next"
import { Toaster } from "sonner"
import { ThemeProvider } from "@/components/providers/theme-provider"
import { AuthProvider } from "@/components/providers/auth-provider"
import "./globals.css"

const _geist = Geist({ subsets: ["latin"] })
const _geistMono = Geist_Mono({ subsets: ["latin"] })

export const metadata: Metadata = {
  title: "RBAC Admin - Role Based Access Control",
  description: "Enterprise-grade authentication and role-based access control system",
    generator: 'v0.app'
}

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode
}>) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body className="font-sans antialiased">
        <ThemeProvider attribute="class" defaultTheme="dark" enableSystem disableTransitionOnChange>
          <AuthProvider>
            {children}
            <Toaster richColors position="top-right" />
          </AuthProvider>
        </ThemeProvider>
        <Analytics />
      </body>
    </html>
  )
}

// ===== FILE: app\page.tsx =====

import { redirect } from "next/navigation"

export default function Home() {
  redirect("login")
}

// ===== FILE: app\(auth)\layout.tsx =====

import type React from "react"
import { Shield } from "lucide-react"
import Link from "next/link"

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="flex min-h-screen">
      {/* Left side - Branding */}
      <div className="hidden lg:flex lg:w-1/2 bg-card border-r border-border flex-col justify-between p-10">
        <Link href="/" className="flex items-center gap-2">
          <div className="rounded-lg bg-primary p-2">
            <Shield className="h-6 w-6 text-primary-foreground" />
          </div>
          <span className="text-xl font-bold">RBAC Admin</span>
        </Link>

        <div className="space-y-6">
          <blockquote className="space-y-2">
            <p className="text-lg text-muted-foreground leading-relaxed">
              {'"'}Enterprise-grade authentication and role-based access control. Secure your applications with granular
              permissions and comprehensive audit logging.{'"'}
            </p>
          </blockquote>

          <div className="grid grid-cols-3 gap-4">
            <div className="rounded-lg border border-border bg-background/50 p-4">
              <p className="text-2xl font-bold text-primary">256-bit</p>
              <p className="text-sm text-muted-foreground">Encryption</p>
            </div>
            <div className="rounded-lg border border-border bg-background/50 p-4">
              <p className="text-2xl font-bold text-primary">RS256</p>
              <p className="text-sm text-muted-foreground">JWT Algorithm</p>
            </div>
            <div className="rounded-lg border border-border bg-background/50 p-4">
              <p className="text-2xl font-bold text-primary">100%</p>
              <p className="text-sm text-muted-foreground">Type-Safe</p>
            </div>
          </div>
        </div>

        <p className="text-sm text-muted-foreground">Secured by enterprise-grade authentication</p>
      </div>

      {/* Right side - Auth forms */}
      <div className="flex flex-1 flex-col justify-center px-4 py-12 sm:px-6 lg:px-20 xl:px-24">
        <div className="mx-auto w-full max-w-sm lg:max-w-md">{children}</div>
      </div>
    </div>
  )
}

// ===== FILE: app\(auth)\forgot-password\page.tsx =====

import { ForgotPasswordForm } from "@/components/auth/forgot-password-form"

export default function ForgotPasswordPage() {
  return <ForgotPasswordForm />
}

// ===== FILE: app\(auth)\login\page.tsx =====

import { LoginForm } from "@/components/auth/login-form"

export default function LoginPage() {
  return <LoginForm />
}

// ===== FILE: app\(auth)\register\page.tsx =====

import { RegisterForm } from "@/components/auth/register-form"

export default function RegisterPage() {
  return <RegisterForm />
}

// ===== FILE: app\(auth)\reset-password\page.tsx =====

import { Suspense } from "react"
import { ResetPasswordForm } from "@/components/auth/reset-password-form"
import { FullPageLoader } from "@/components/common/loading-spinner"

export default function ResetPasswordPage() {
  return (
    <Suspense fallback={<FullPageLoader />}>
      <ResetPasswordForm />
    </Suspense>
  )
}

// ===== FILE: app\(auth)\verify-email\page.tsx =====

import { Suspense } from "react"
import { VerifyEmailForm } from "@/components/auth/verify-email-form"
import { FullPageLoader } from "@/components/common/loading-spinner"

export default function VerifyEmailPage() {
  return (
    <Suspense fallback={<FullPageLoader />}>
      <VerifyEmailForm />
    </Suspense>
  )
}

// ===== FILE: app\(dashboard)\layout.tsx =====

"use client"

import type React from "react"

import { useState } from "react"
import { Sidebar } from "@/components/layout/sidebar"
import { Header } from "@/components/layout/header"
import { ProtectedRoute } from "@/components/layout/protected-route"

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const [isCollapsed, setIsCollapsed] = useState(false)

  return (
    <ProtectedRoute>
      <div className="flex h-screen overflow-hidden">
        <Sidebar isCollapsed={isCollapsed} onToggle={() => setIsCollapsed(!isCollapsed)} />
        <div className="flex flex-1 flex-col overflow-hidden">
          <Header />
          <main className="flex-1 overflow-auto bg-background p-6">{children}</main>
        </div>
      </div>
    </ProtectedRoute>
  )
}

// ===== FILE: app\(dashboard)\admin\invites\page.tsx =====

// ===== FILE: app/(dashboard)/admin/invites/page.tsx =====
// Admin invite management page

"use client"

import { useState, useEffect, useCallback } from "react"
import { 
  Plus, 
  Mail, 
  Clock, 
  CheckCircle, 
  XCircle, 
  Trash2, 
  Loader2, 
  AlertCircle,
  RefreshCw,
  Copy,
  Search
} from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table"
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select"
import { ProtectedRoute } from "@/components/layout/protected-route"
import { PermissionGate } from "@/components/common/permission-gate"
import { ConfirmDialog } from "@/components/common/confirm-dialog"
import { CreateInviteDialog } from "@/components/admin/invites/create-invite-dialog"
import { getInvites, revokeInvite } from "@/lib/api/admin"
import { formatDateTime, formatRelativeTime } from "@/lib/utils/formatters"
import type { Invite, InviteStatus } from "@/types"

// Status badge component
function InviteStatusBadge({ status }: { status: InviteStatus }) {
  switch (status) {
    case "PENDING":
      return (
        <Badge variant="outline" className="bg-amber-500/10 text-amber-500 border-amber-500/20">
          <Clock className="mr-1 h-3 w-3" />
          Pending
        </Badge>
      )
    case "USED":
      return (
        <Badge variant="outline" className="bg-emerald-500/10 text-emerald-500 border-emerald-500/20">
          <CheckCircle className="mr-1 h-3 w-3" />
          Used
        </Badge>
      )
    case "EXPIRED":
      return (
        <Badge variant="outline" className="bg-gray-500/10 text-gray-500 border-gray-500/20">
          <XCircle className="mr-1 h-3 w-3" />
          Expired
        </Badge>
      )
    case "REVOKED":
      return (
        <Badge variant="outline" className="bg-red-500/10 text-red-500 border-red-500/20">
          <XCircle className="mr-1 h-3 w-3" />
          Revoked
        </Badge>
      )
    default:
      return <Badge variant="outline">{status}</Badge>
  }
}

export default function InvitesPage() {
  const [invites, setInvites] = useState<Invite[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [refreshing, setRefreshing] = useState(false)
  
  // Filters
  const [statusFilter, setStatusFilter] = useState<string>("all")
  const [searchQuery, setSearchQuery] = useState("")
  
  // Pagination
  const [page, setPage] = useState(0)
  const [totalPages, setTotalPages] = useState(0)
  const [totalElements, setTotalElements] = useState(0)
  
  // Dialogs
  const [showCreateDialog, setShowCreateDialog] = useState(false)
  const [inviteToRevoke, setInviteToRevoke] = useState<Invite | null>(null)
  const [isRevoking, setIsRevoking] = useState(false)

  const fetchInvites = useCallback(async (isRefresh = false) => {
    try {
      if (isRefresh) {
        setRefreshing(true)
      } else {
        setLoading(true)
      }
      setError(null)

      const status = statusFilter === "all" ? undefined : statusFilter
      const response = await getInvites(page, 10, status)
      
      setInvites(response.content || [])
      setTotalPages(response.totalPages || 0)
      setTotalElements(response.totalElements || 0)
    } catch (err) {
      console.error("Failed to fetch invites:", err)
      setError("Failed to load invites. Please try again.")
      setInvites([]) // Ensure invites is always an array even on error
    } finally {
      setLoading(false)
      setRefreshing(false)
    }
  }, [page, statusFilter])

  useEffect(() => {
    fetchInvites()
  }, [fetchInvites])

  const handleRevoke = async () => {
    if (!inviteToRevoke) return

    setIsRevoking(true)
    try {
      const response = await revokeInvite(inviteToRevoke.id)
      if (response.success) {
        toast.success("Invite revoked successfully")
        fetchInvites(true)
      } else {
        toast.error(response.message || "Failed to revoke invite")
      }
    } catch {
      toast.error("Failed to revoke invite")
    } finally {
      setIsRevoking(false)
      setInviteToRevoke(null)
    }
  }

  const copyInviteLink = (token: string) => {
    const link = `${window.location.origin}/register?invite=${token}`
    navigator.clipboard.writeText(link)
    toast.success("Invite link copied to clipboard")
  }

  // Filter invites by search query
  const filteredInvites = (invites || []).filter(invite =>
    invite.email.toLowerCase().includes(searchQuery.toLowerCase()) ||
    invite.department?.toLowerCase().includes(searchQuery.toLowerCase())
  )

  if (loading) {
    return (
      <ProtectedRoute permissions={["AUTH_INVITE_LIST", "AUTH_INVITE_READ"]}>
        <div className="flex h-[50vh] items-center justify-center">
          <div className="flex flex-col items-center gap-4">
            <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
            <p className="text-muted-foreground">Loading invites...</p>
          </div>
        </div>
      </ProtectedRoute>
    )
  }

  return (
    <ProtectedRoute permissions={["AUTH_INVITE_LIST", "AUTH_INVITE_READ"]}>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight">Invite Management</h1>
            <p className="text-muted-foreground">
              Create and manage user registration invites
            </p>
          </div>
          <div className="flex items-center gap-2">
            <Button
              variant="outline"
              size="icon"
              onClick={() => fetchInvites(true)}
              disabled={refreshing}
            >
              <RefreshCw className={`h-4 w-4 ${refreshing ? "animate-spin" : ""}`} />
            </Button>
            <PermissionGate permissions={["AUTH_INVITE_CREATE"]}>
              <Button onClick={() => setShowCreateDialog(true)}>
                <Plus className="mr-2 h-4 w-4" />
                Create Invite
              </Button>
            </PermissionGate>
          </div>
        </div>

        {/* Error state */}
        {error && (
          <Card className="border-destructive">
            <CardContent className="flex items-center gap-4 py-4">
              <AlertCircle className="h-5 w-5 text-destructive" />
              <p className="text-destructive">{error}</p>
              <Button 
                variant="outline" 
                size="sm" 
                onClick={() => fetchInvites()}
                className="ml-auto"
              >
                Retry
              </Button>
            </CardContent>
          </Card>
        )}

        {/* Filters */}
        <Card>
          <CardHeader>
            <CardTitle>Invites</CardTitle>
            <CardDescription>
              {totalElements} total invite{totalElements !== 1 ? "s" : ""}
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="flex items-center gap-4">
              <div className="relative flex-1">
                <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
                <Input
                  placeholder="Search by email or department..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="pl-9"
                />
              </div>
              <Select value={statusFilter} onValueChange={setStatusFilter}>
                <SelectTrigger className="w-[180px]">
                  <SelectValue placeholder="Filter by status" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Statuses</SelectItem>
                  <SelectItem value="PENDING">Pending</SelectItem>
                  <SelectItem value="USED">Used</SelectItem>
                  <SelectItem value="EXPIRED">Expired</SelectItem>
                  <SelectItem value="REVOKED">Revoked</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Table */}
            <div className="rounded-lg border border-border">
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>Email</TableHead>
                    <TableHead>Status</TableHead>
                    <TableHead>Intended Roles</TableHead>
                    <TableHead>Department</TableHead>
                    <TableHead>Created</TableHead>
                    <TableHead>Expires</TableHead>
                    <TableHead className="text-right">Actions</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {filteredInvites.length === 0 ? (
                    <TableRow>
                      <TableCell colSpan={7} className="h-24 text-center">
                        <div className="flex flex-col items-center gap-2">
                          <Mail className="h-8 w-8 text-muted-foreground" />
                          <p className="text-muted-foreground">No invites found</p>
                        </div>
                      </TableCell>
                    </TableRow>
                  ) : (
                    filteredInvites.map((invite) => (
                      <TableRow key={invite.id}>
                        <TableCell className="font-medium">{invite.email}</TableCell>
                        <TableCell>
                          <InviteStatusBadge status={invite.status} />
                        </TableCell>
                        <TableCell>
                          <div className="flex flex-wrap gap-1">
                            {invite.intendedRoles.length > 0 ? (
                              invite.intendedRoles.map((role) => (
                                <Badge key={role} variant="secondary" className="text-xs">
                                  {role}
                                </Badge>
                              ))
                            ) : (
                              <span className="text-muted-foreground text-sm">Default</span>
                            )}
                          </div>
                        </TableCell>
                        <TableCell>
                          {invite.department || (
                            <span className="text-muted-foreground">—</span>
                          )}
                        </TableCell>
                        <TableCell className="text-sm">
                          <span title={formatDateTime(invite.createdAt)}>
                            {formatRelativeTime(invite.createdAt)}
                          </span>
                        </TableCell>
                        <TableCell className="text-sm">
                          <span title={formatDateTime(invite.expiresAt)}>
                            {formatRelativeTime(invite.expiresAt)}
                          </span>
                        </TableCell>
                        <TableCell className="text-right">
                          <div className="flex items-center justify-end gap-2">
                            {invite.status === "PENDING" && (
                              <>
                                <Button
                                  variant="ghost"
                                  size="icon"
                                  onClick={() => copyInviteLink(invite.token)}
                                  title="Copy invite link"
                                >
                                  <Copy className="h-4 w-4" />
                                </Button>
                                <PermissionGate permissions={["AUTH_INVITE_REVOKE"]}>
                                  <Button
                                    variant="ghost"
                                    size="icon"
                                    onClick={() => setInviteToRevoke(invite)}
                                    className="text-destructive hover:text-destructive"
                                    title="Revoke invite"
                                  >
                                    <Trash2 className="h-4 w-4" />
                                  </Button>
                                </PermissionGate>
                              </>
                            )}
                          </div>
                        </TableCell>
                      </TableRow>
                    ))
                  )}
                </TableBody>
              </Table>
            </div>

            {/* Pagination */}
            {totalPages > 1 && (
              <div className="flex items-center justify-between">
                <p className="text-sm text-muted-foreground">
                  Page {page + 1} of {totalPages}
                </p>
                <div className="flex items-center gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setPage(p => Math.max(0, p - 1))}
                    disabled={page === 0}
                  >
                    Previous
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setPage(p => Math.min(totalPages - 1, p + 1))}
                    disabled={page >= totalPages - 1}
                  >
                    Next
                  </Button>
                </div>
              </div>
            )}
          </CardContent>
        </Card>

        {/* Create Invite Dialog */}
        <CreateInviteDialog
          open={showCreateDialog}
          onOpenChange={setShowCreateDialog}
          onSuccess={() => {
            setShowCreateDialog(false)
            fetchInvites(true)
          }}
        />

        {/* Revoke Confirmation Dialog */}
        <ConfirmDialog
          open={!!inviteToRevoke}
          onOpenChange={(open) => !open && setInviteToRevoke(null)}
          title="Revoke Invite"
          description={`Are you sure you want to revoke the invite for ${inviteToRevoke?.email}? This action cannot be undone and they will need a new invitation to register.`}
          confirmText="Revoke"
          onConfirm={handleRevoke}
          variant="destructive"
          isLoading={isRevoking}
        />
      </div>
    </ProtectedRoute>
  )
}

// ===== FILE: app\(dashboard)\admin\user-approval\page.tsx =====

// ===== FILE: app/(dashboard)/admin/user-approval/page.tsx =====
// Admin user approval page

"use client"

import { useState, useEffect, useCallback } from "react"
import { 
  UserCheck, 
  UserX, 
  Clock, 
  Loader2, 
  AlertCircle,
  RefreshCw,
  Search,
  Mail,
  CheckCircle,
  Ban
} from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table"
import { Avatar, AvatarFallback } from "@/components/ui/avatar"
import { ProtectedRoute } from "@/components/layout/protected-route"
import { PermissionGate } from "@/components/common/permission-gate"
import { ApproveUserDialog } from "@/components/admin/users/approve-user-dialog"
import { RejectUserDialog } from "@/components/admin/users/reject-user-dialog"
import { SuspendUserDialog } from "@/components/admin/users/suspend-user-dialog"
import { ConfirmDialog } from "@/components/common/confirm-dialog"
import {
  getPendingApprovalUsers,
  getPendingVerificationUsers,
  getSuspendedUsers,
  reactivateUser,
} from "@/lib/api/admin"
import { formatDateTime, formatRelativeTime, getInitials } from "@/lib/utils/formatters"
import type { User, AccountStatus } from "@/types"

// Stats card component
function StatsCard({
  title,
  value,
  icon: Icon,
  description,
  variant = "default",
}: {
  title: string
  value: number
  icon: React.ElementType
  description: string
  variant?: "default" | "warning" | "success" | "destructive"
}) {
  const colorMap = {
    default: "text-muted-foreground",
    warning: "text-amber-500",
    success: "text-emerald-500",
    destructive: "text-red-500",
  }

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-sm font-medium">{title}</CardTitle>
        <Icon className={`h-4 w-4 ${colorMap[variant]}`} />
      </CardHeader>
      <CardContent>
        <div className="text-2xl font-bold">{value}</div>
        <p className="text-xs text-muted-foreground">{description}</p>
      </CardContent>
    </Card>
  )
}

// Account status badge
function AccountStatusBadge({ status }: { status: AccountStatus }) {
  switch (status) {
    case "PENDING_VERIFICATION":
      return (
        <Badge variant="outline" className="bg-blue-500/10 text-blue-500 border-blue-500/20">
          <Mail className="mr-1 h-3 w-3" />
          Pending Verification
        </Badge>
      )
    case "PENDING_APPROVAL":
      return (
        <Badge variant="outline" className="bg-amber-500/10 text-amber-500 border-amber-500/20">
          <Clock className="mr-1 h-3 w-3" />
          Pending Approval
        </Badge>
      )
    case "ACTIVE":
      return (
        <Badge variant="outline" className="bg-emerald-500/10 text-emerald-500 border-emerald-500/20">
          <CheckCircle className="mr-1 h-3 w-3" />
          Active
        </Badge>
      )
    case "SUSPENDED":
      return (
        <Badge variant="outline" className="bg-red-500/10 text-red-500 border-red-500/20">
          <Ban className="mr-1 h-3 w-3" />
          Suspended
        </Badge>
      )
    case "DEACTIVATED":
      return (
        <Badge variant="outline" className="bg-gray-500/10 text-gray-500 border-gray-500/20">
          <Ban className="mr-1 h-3 w-3" />
          Deactivated
        </Badge>
      )
    default:
      return <Badge variant="outline">{status}</Badge>
  }
}

export default function UserApprovalPage() {
  // Data states
  const [pendingApproval, setPendingApproval] = useState<User[]>([])
  const [pendingVerification, setPendingVerification] = useState<User[]>([])
  const [suspendedUsers, setSuspendedUsers] = useState<User[]>([])
  
  // Loading states
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [refreshing, setRefreshing] = useState(false)
  
  // Counts
  const [approvalCount, setApprovalCount] = useState(0)
  const [verificationCount, setVerificationCount] = useState(0)
  const [suspendedCount, setSuspendedCount] = useState(0)
  
  // Search
  const [searchQuery, setSearchQuery] = useState("")
  
  // Dialogs
  const [userToApprove, setUserToApprove] = useState<User | null>(null)
  const [userToReject, setUserToReject] = useState<User | null>(null)
  const [userToSuspend, setUserToSuspend] = useState<User | null>(null)
  const [userToReactivate, setUserToReactivate] = useState<User | null>(null)
  const [isReactivating, setIsReactivating] = useState(false)

  const fetchData = useCallback(async (isRefresh = false) => {
    try {
      if (isRefresh) {
        setRefreshing(true)
      } else {
        setLoading(true)
      }
      setError(null)

      const [approvalRes, verificationRes, suspendedRes] = await Promise.all([
        getPendingApprovalUsers(0, 50),
        getPendingVerificationUsers(0, 50),
        getSuspendedUsers(0, 50),
      ])

      setPendingApproval(approvalRes.content || [])
      setApprovalCount(approvalRes.totalElements || 0)
      
      setPendingVerification(verificationRes.content || [])
      setVerificationCount(verificationRes.totalElements || 0)
      
      setSuspendedUsers(suspendedRes.content || [])
      setSuspendedCount(suspendedRes.totalElements || 0)
    } catch (err) {
      console.error("Failed to fetch user data:", err)
      setError("Failed to load user data. Please try again.")
      // Ensure arrays are always defined even on error
      setPendingApproval([])
      setPendingVerification([])
      setSuspendedUsers([])
    } finally {
      setLoading(false)
      setRefreshing(false)
    }
  }, [])

  useEffect(() => {
    fetchData()
  }, [fetchData])

  const handleReactivate = async () => {
    if (!userToReactivate) return

    setIsReactivating(true)
    try {
      const response = await reactivateUser(userToReactivate.id)
      if (response.success) {
        toast.success(`${userToReactivate.firstName} ${userToReactivate.lastName} has been reactivated`)
        fetchData(true)
      } else {
        toast.error(response.message || "Failed to reactivate user")
      }
    } catch {
      toast.error("Failed to reactivate user")
    } finally {
      setIsReactivating(false)
      setUserToReactivate(null)
    }
  }

  // Filter function
  const filterUsers = (users: User[]) => {
    if (!users || !Array.isArray(users)) return []
    if (!searchQuery) return users
    const query = searchQuery.toLowerCase()
    return users.filter(
      (user) =>
        user.email.toLowerCase().includes(query) ||
        user.firstName.toLowerCase().includes(query) ||
        user.lastName.toLowerCase().includes(query) ||
        user.userName.toLowerCase().includes(query)
    )
  }

  // User table component
  const UserTable = ({ 
    users, 
    emptyMessage,
    showApprovalActions = false,
    showSuspendedActions = false,
  }: { 
    users: User[]
    emptyMessage: string
    showApprovalActions?: boolean
    showSuspendedActions?: boolean
  }) => (
    <div className="rounded-lg border border-border">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>User</TableHead>
            <TableHead>Email</TableHead>
            <TableHead>Status</TableHead>
            <TableHead>Registered</TableHead>
            <TableHead className="text-right">Actions</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {users.length === 0 ? (
            <TableRow>
              <TableCell colSpan={5} className="h-24 text-center">
                <p className="text-muted-foreground">{emptyMessage}</p>
              </TableCell>
            </TableRow>
          ) : (
            users.map((user) => (
              <TableRow key={user.id}>
                <TableCell>
                  <div className="flex items-center gap-3">
                    <Avatar className="h-8 w-8">
                      <AvatarFallback className="bg-primary/10 text-primary text-xs">
                        {getInitials(user.firstName, user.lastName)}
                      </AvatarFallback>
                    </Avatar>
                    <div>
                      <p className="font-medium">
                        {user.firstName} {user.lastName}
                      </p>
                      <p className="text-xs text-muted-foreground">@{user.userName}</p>
                    </div>
                  </div>
                </TableCell>
                <TableCell>{user.email}</TableCell>
                <TableCell>
                  <AccountStatusBadge status={user.accountStatus} />
                </TableCell>
                <TableCell className="text-sm">
                  <span title={formatDateTime(user.createdAt)}>
                    {formatRelativeTime(user.createdAt)}
                  </span>
                </TableCell>
                <TableCell className="text-right">
                  <div className="flex items-center justify-end gap-2">
                    {showApprovalActions && (
                      <PermissionGate permissions={["AUTH_USER_APPROVE"]}>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => setUserToApprove(user)}
                          className="text-emerald-600 hover:text-emerald-600"
                        >
                          <UserCheck className="mr-1 h-4 w-4" />
                          Approve
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => setUserToReject(user)}
                          className="text-destructive hover:text-destructive"
                        >
                          <UserX className="mr-1 h-4 w-4" />
                          Reject
                        </Button>
                      </PermissionGate>
                    )}
                    {showSuspendedActions && (
                      <PermissionGate permissions={["AUTH_USER_ACTIVATE"]}>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => setUserToReactivate(user)}
                          className="text-emerald-600 hover:text-emerald-600"
                        >
                          <CheckCircle className="mr-1 h-4 w-4" />
                          Reactivate
                        </Button>
                      </PermissionGate>
                    )}
                  </div>
                </TableCell>
              </TableRow>
            ))
          )}
        </TableBody>
      </Table>
    </div>
  )

  if (loading) {
    return (
      <ProtectedRoute permissions={["AUTH_USER_APPROVE", "AUTH_USER_ACTIVATE"]}>
        <div className="flex h-[50vh] items-center justify-center">
          <div className="flex flex-col items-center gap-4">
            <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
            <p className="text-muted-foreground">Loading user data...</p>
          </div>
        </div>
      </ProtectedRoute>
    )
  }

  return (
    <ProtectedRoute permissions={["AUTH_USER_APPROVE", "AUTH_USER_ACTIVATE"]}>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight">User Approval</h1>
            <p className="text-muted-foreground">
              Review and manage user registrations
            </p>
          </div>
          <Button
            variant="outline"
            size="icon"
            onClick={() => fetchData(true)}
            disabled={refreshing}
          >
            <RefreshCw className={`h-4 w-4 ${refreshing ? "animate-spin" : ""}`} />
          </Button>
        </div>

        {/* Error state */}
        {error && (
          <Card className="border-destructive">
            <CardContent className="flex items-center gap-4 py-4">
              <AlertCircle className="h-5 w-5 text-destructive" />
              <p className="text-destructive">{error}</p>
              <Button 
                variant="outline" 
                size="sm" 
                onClick={() => fetchData()}
                className="ml-auto"
              >
                Retry
              </Button>
            </CardContent>
          </Card>
        )}

        {/* Stats */}
        <div className="grid gap-4 md:grid-cols-3">
          <StatsCard
            title="Pending Approval"
            value={approvalCount}
            icon={Clock}
            description="Users awaiting admin approval"
            variant="warning"
          />
          <StatsCard
            title="Pending Verification"
            value={verificationCount}
            icon={Mail}
            description="Users who haven't verified email"
            variant="default"
          />
          <StatsCard
            title="Suspended"
            value={suspendedCount}
            icon={Ban}
            description="Currently suspended accounts"
            variant="destructive"
          />
        </div>

        {/* Search */}
        <div className="relative max-w-sm">
          <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
          <Input
            placeholder="Search users..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="pl-9"
          />
        </div>

        {/* Tabs */}
        <Tabs defaultValue="pending-approval">
          <TabsList>
            <TabsTrigger value="pending-approval" className="gap-2">
              <Clock className="h-4 w-4" />
              Pending Approval
              {approvalCount > 0 && (
                <Badge variant="secondary" className="ml-1">
                  {approvalCount}
                </Badge>
              )}
            </TabsTrigger>
            <TabsTrigger value="pending-verification" className="gap-2">
              <Mail className="h-4 w-4" />
              Pending Verification
              {verificationCount > 0 && (
                <Badge variant="secondary" className="ml-1">
                  {verificationCount}
                </Badge>
              )}
            </TabsTrigger>
            <TabsTrigger value="suspended" className="gap-2">
              <Ban className="h-4 w-4" />
              Suspended
              {suspendedCount > 0 && (
                <Badge variant="secondary" className="ml-1">
                  {suspendedCount}
                </Badge>
              )}
            </TabsTrigger>
          </TabsList>

          <TabsContent value="pending-approval" className="mt-4">
            <Card>
              <CardHeader>
                <CardTitle>Users Pending Approval</CardTitle>
                <CardDescription>
                  These users have verified their email and are waiting for admin approval
                </CardDescription>
              </CardHeader>
              <CardContent>
                <UserTable
                  users={filterUsers(pendingApproval)}
                  emptyMessage="No users pending approval"
                  showApprovalActions
                />
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="pending-verification" className="mt-4">
            <Card>
              <CardHeader>
                <CardTitle>Users Pending Email Verification</CardTitle>
                <CardDescription>
                  These users have registered but haven't verified their email yet
                </CardDescription>
              </CardHeader>
              <CardContent>
                <UserTable
                  users={filterUsers(pendingVerification)}
                  emptyMessage="No users pending verification"
                />
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="suspended" className="mt-4">
            <Card>
              <CardHeader>
                <CardTitle>Suspended Users</CardTitle>
                <CardDescription>
                  These users have been suspended and cannot access their accounts
                </CardDescription>
              </CardHeader>
              <CardContent>
                <UserTable
                  users={filterUsers(suspendedUsers)}
                  emptyMessage="No suspended users"
                  showSuspendedActions
                />
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>

        {/* Dialogs */}
        <ApproveUserDialog
          user={userToApprove}
          open={!!userToApprove}
          onOpenChange={(open) => !open && setUserToApprove(null)}
          onSuccess={() => {
            setUserToApprove(null)
            fetchData(true)
          }}
        />

        <RejectUserDialog
          user={userToReject}
          open={!!userToReject}
          onOpenChange={(open) => !open && setUserToReject(null)}
          onSuccess={() => {
            setUserToReject(null)
            fetchData(true)
          }}
        />

        <SuspendUserDialog
          user={userToSuspend}
          open={!!userToSuspend}
          onOpenChange={(open) => !open && setUserToSuspend(null)}
          onSuccess={() => {
            setUserToSuspend(null)
            fetchData(true)
          }}
        />

        <ConfirmDialog
          open={!!userToReactivate}
          onOpenChange={(open) => !open && setUserToReactivate(null)}
          title="Reactivate User"
          description={`Are you sure you want to reactivate ${userToReactivate?.firstName} ${userToReactivate?.lastName}? They will regain access to their account.`}
          confirmText="Reactivate"
          onConfirm={handleReactivate}
          isLoading={isReactivating}
        />
      </div>
    </ProtectedRoute>
  )
}

// ===== FILE: app\(dashboard)\business\page.tsx =====

"use client"

// ===== Business Dashboard Page =====

import { useState, useEffect, useCallback } from "react"
import { RefreshCw, Building2, FileText, Receipt, DollarSign, Plus, AlertTriangle, TrendingUp } from "lucide-react"
import Link from "next/link"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { StatsCard } from "@/components/dashboard/stats-card"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { EmptyState } from "@/components/common/empty-state"
import { StatusBadge } from "@/components/business/common/status-badge"
import { MoneyDisplay } from "@/components/business/common/money-display"
import { PermissionGate } from "@/components/common/permission-gate"
import { formatDateDO } from "@/lib/utils/business"
import type { Invoice, BusinessDashboardStats, RevenueDataPoint } from "@/lib/types/business"
import { getDashboardStats, getRevenueData } from "@/lib/api/business/dashboard"
import { getInvoices } from "@/lib/api/business/invoices"
import { ChartContainer, ChartTooltip, ChartTooltipContent } from "@/components/ui/chart"
import { LineChart, Line, XAxis, YAxis, ResponsiveContainer } from "recharts"

export default function BusinessDashboardPage() {
  const [stats, setStats] = useState<BusinessDashboardStats | null>(null)
  const [revenueData, setRevenueData] = useState<RevenueDataPoint[]>([])
  const [recentInvoices, setRecentInvoices] = useState<Invoice[]>([])
  const [overdueInvoices, setOverdueInvoices] = useState<Invoice[]>([])
  const [isLoading, setIsLoading] = useState(true)

  const loadDashboardData = useCallback(async () => {
    setIsLoading(true)
    try {
      const [statsData, revenue, recent, overdue] = await Promise.all([
        getDashboardStats(),
        getRevenueData(),
        getInvoices(0, 5, undefined, undefined, false),
        getInvoices(0, 5, undefined, "ISSUED", true),
      ])

      setStats(statsData)
      setRevenueData(revenue)
      setRecentInvoices(recent.content)
      setOverdueInvoices(overdue.content)
    } catch {
      toast.error("Error al cargar datos del dashboard")
    } finally {
      setIsLoading(false)
    }
  }, [])

  useEffect(() => {
    loadDashboardData()
  }, [loadDashboardData])

  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-12">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Business Overview</h1>
          <p className="text-muted-foreground">Panel de control para gestión comercial de ASEPRE</p>
        </div>
        <Button variant="outline" size="icon" onClick={loadDashboardData}>
          <RefreshCw className={`h-4 w-4 ${isLoading ? "animate-spin" : ""}`} />
        </Button>
      </div>

      {/* Stats Cards */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <StatsCard
          title="Total Clientes"
          value={stats?.totalClients ?? 0}
          description={`${stats?.activeClients ?? 0} activos`}
          icon={Building2}
        />
        <StatsCard title="Contratos Activos" value={stats?.activeContracts ?? 0} icon={FileText} />
        <StatsCard
          title="Facturas Pendientes"
          value={stats?.pendingInvoices ?? 0}
          description={`${stats?.overdueInvoices ?? 0} vencidas`}
          icon={Receipt}
        />
        <StatsCard
          title="Ingresos del Mes"
          value={<MoneyDisplay amount={stats?.monthlyRevenue ?? 0} size="lg" />}
          icon={DollarSign}
        />
      </div>

      {/* Main Content Grid */}
      <div className="grid gap-6 lg:grid-cols-7">
        {/* Revenue Chart */}
        <Card className="lg:col-span-4">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <TrendingUp className="h-5 w-5" />
              Ingresos Mensuales
            </CardTitle>
            <CardDescription>Últimos 12 meses</CardDescription>
          </CardHeader>
          <CardContent>
            {revenueData.length > 0 ? (
              <ChartContainer
                config={{
                  revenue: {
                    label: "Ingresos",
                    color: "hsl(var(--primary))",
                  },
                }}
                className="h-[300px]"
              >
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={revenueData}>
                    <XAxis dataKey="month" stroke="#888888" fontSize={12} tickLine={false} axisLine={false} />
                    <YAxis
                      stroke="#888888"
                      fontSize={12}
                      tickLine={false}
                      axisLine={false}
                      tickFormatter={(value) => `${(value / 1000).toFixed(0)}k`}
                    />
                    <ChartTooltip content={<ChartTooltipContent />} />
                    <Line type="monotone" dataKey="revenue" stroke="var(--color-revenue)" strokeWidth={2} dot={false} />
                  </LineChart>
                </ResponsiveContainer>
              </ChartContainer>
            ) : (
              <div className="flex h-[300px] items-center justify-center text-muted-foreground">
                No hay datos de ingresos disponibles
              </div>
            )}
          </CardContent>
        </Card>

        {/* Quick Actions */}
        <Card className="lg:col-span-3">
          <CardHeader>
            <CardTitle>Acciones Rápidas</CardTitle>
            <CardDescription>Operaciones frecuentes</CardDescription>
          </CardHeader>
          <CardContent className="space-y-3">
            <PermissionGate permissions={["BUSINESS_CLIENT_CREATE"]}>
              <Button asChild className="w-full justify-start bg-transparent" variant="outline">
                <Link href="/business/clients?action=new">
                  <Plus className="mr-2 h-4 w-4" />
                  Nuevo Cliente
                </Link>
              </Button>
            </PermissionGate>
            <PermissionGate permissions={["BUSINESS_CONTRACT_CREATE"]}>
              <Button asChild className="w-full justify-start bg-transparent" variant="outline">
                <Link href="/business/contracts?action=new">
                  <Plus className="mr-2 h-4 w-4" />
                  Nuevo Contrato
                </Link>
              </Button>
            </PermissionGate>
            <PermissionGate permissions={["BUSINESS_INVOICE_CREATE"]}>
              <Button asChild className="w-full justify-start bg-transparent" variant="outline">
                <Link href="/business/invoices?action=new">
                  <Plus className="mr-2 h-4 w-4" />
                  Nueva Factura
                </Link>
              </Button>
            </PermissionGate>
            <PermissionGate permissions={["BUSINESS_PAYMENT_CREATE"]}>
              <Button asChild className="w-full justify-start bg-transparent" variant="outline">
                <Link href="/business/payments?action=new">
                  <Plus className="mr-2 h-4 w-4" />
                  Registrar Pago
                </Link>
              </Button>
            </PermissionGate>
          </CardContent>
        </Card>
      </div>

      {/* Bottom Grid */}
      <div className="grid gap-6 lg:grid-cols-2">
        {/* Recent Invoices */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between">
            <div>
              <CardTitle>Facturas Recientes</CardTitle>
              <CardDescription>Últimas 5 facturas creadas</CardDescription>
            </div>
            <Button asChild variant="ghost" size="sm">
              <Link href="/business/invoices">Ver todas</Link>
            </Button>
          </CardHeader>
          <CardContent>
            {recentInvoices.length > 0 ? (
              <div className="space-y-4">
                {recentInvoices.map((invoice) => (
                  <div
                    key={invoice.id}
                    className="flex items-center justify-between border-b border-border pb-3 last:border-0 last:pb-0"
                  >
                    <div className="space-y-1">
                      <Link href={`/business/invoices/${invoice.id}`} className="font-medium hover:underline">
                        {invoice.invoiceNumber}
                      </Link>
                      <p className="text-sm text-muted-foreground">{invoice.clientName}</p>
                    </div>
                    <div className="text-right space-y-1">
                      <MoneyDisplay amount={invoice.total} className="font-medium" />
                      <StatusBadge type="invoice" status={invoice.status} />
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <EmptyState icon={Receipt} title="Sin facturas" description="No hay facturas recientes" />
            )}
          </CardContent>
        </Card>

        {/* Overdue Invoices */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between">
            <div>
              <CardTitle className="flex items-center gap-2">
                <AlertTriangle className="h-5 w-5 text-amber-500" />
                Facturas Vencidas
              </CardTitle>
              <CardDescription>Requieren atención inmediata</CardDescription>
            </div>
            <Button asChild variant="ghost" size="sm">
              <Link href="/business/invoices?status=overdue">Ver todas</Link>
            </Button>
          </CardHeader>
          <CardContent>
            {overdueInvoices.length > 0 ? (
              <div className="space-y-4">
                {overdueInvoices.map((invoice) => (
                  <div
                    key={invoice.id}
                    className="flex items-center justify-between border-b border-border pb-3 last:border-0 last:pb-0"
                  >
                    <div className="space-y-1">
                      <Link href={`/business/invoices/${invoice.id}`} className="font-medium hover:underline">
                        {invoice.invoiceNumber}
                      </Link>
                      <p className="text-sm text-muted-foreground">{invoice.clientName}</p>
                      <p className="text-xs text-red-500">Venció: {formatDateDO(invoice.dueDate)}</p>
                    </div>
                    <div className="text-right space-y-1">
                      <MoneyDisplay amount={invoice.balance} className="font-medium text-red-500" />
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <EmptyState icon={Receipt} title="Sin vencimientos" description="No hay facturas vencidas" />
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  )
}

// ===== FILE: app\(dashboard)\business\clients\loading.tsx =====

export default function Loading() {
  return null
}

// ===== FILE: app\(dashboard)\business\clients\page.tsx =====

"use client"

// ===== Clients List Page =====

import { useState, useEffect, useCallback } from "react"
import { Building2, Plus, RefreshCw, Search } from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { StatsCard } from "@/components/dashboard/stats-card"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { EmptyState } from "@/components/common/empty-state"
import { ConfirmDialog } from "@/components/common/confirm-dialog"
import { PermissionGate } from "@/components/common/permission-gate"
import { ClientTable } from "@/components/business/clients/client-table"
import { CreateClientDialog } from "@/components/business/clients/create-client-dialog"
import { EditClientDialog } from "@/components/business/clients/edit-client-dialog"
import { getClients, getClientStats, deleteClient, getLegalTypes } from "@/lib/api/business/clients"
import type { Client, ClientStatus, LegalType } from "@/lib/types/business"
import {
  Pagination,
  PaginationContent,
  PaginationItem,
  PaginationLink,
  PaginationNext,
  PaginationPrevious,
} from "@/components/ui/pagination"

export default function ClientsPage() {
  // Data state
  const [clients, setClients] = useState<Client[]>([])
  const [legalTypes, setLegalTypes] = useState<LegalType[]>([])
  const [stats, setStats] = useState({ total: 0, active: 0, inactive: 0, suspended: 0 })
  const [isLoading, setIsLoading] = useState(true)

  // Pagination state
  const [page, setPage] = useState(0)
  const [totalPages, setTotalPages] = useState(0)
  const pageSize = 20

  // Filter state
  const [searchTerm, setSearchTerm] = useState("")
  const [statusFilter, setStatusFilter] = useState<ClientStatus | "ALL">("ALL")
  const [legalTypeFilter, setLegalTypeFilter] = useState<string>("ALL")

  // Dialog state
  const [isCreateOpen, setIsCreateOpen] = useState(false)
  const [editingClient, setEditingClient] = useState<Client | null>(null)
  const [deactivatingClient, setDeactivatingClient] = useState<Client | null>(null)
  const [isDeactivating, setIsDeactivating] = useState(false)

  const loadData = useCallback(async () => {
    setIsLoading(true)
    try {
      const [clientsResponse, statsResponse, typesResponse] = await Promise.all([
        getClients(page, pageSize, statusFilter === "ALL" ? undefined : statusFilter, searchTerm || undefined),
        getClientStats(),
        getLegalTypes(),
      ])

      setClients(clientsResponse.content)
      setTotalPages(clientsResponse.totalPages)
      setStats(statsResponse)
      setLegalTypes(typesResponse)
    } catch {
      toast.error("Error al cargar clientes")
    } finally {
      setIsLoading(false)
    }
  }, [page, statusFilter, searchTerm])

  useEffect(() => {
    loadData()
  }, [loadData])

  // Debounced search
  useEffect(() => {
    const timer = setTimeout(() => {
      setPage(0)
    }, 300)
    return () => clearTimeout(timer)
  }, [searchTerm])

  async function handleDeactivate() {
    if (!deactivatingClient) return

    setIsDeactivating(true)
    try {
      const response = await deleteClient(deactivatingClient.id)
      if (response.success) {
        toast.success("Cliente desactivado")
        loadData()
      } else {
        toast.error(response.message || "Error al desactivar cliente")
      }
    } catch {
      toast.error("Error al desactivar cliente")
    } finally {
      setIsDeactivating(false)
      setDeactivatingClient(null)
    }
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Clientes</h1>
          <p className="text-muted-foreground">Gestione los clientes de ASEPRE</p>
        </div>
        <div className="flex items-center gap-2">
          <Button variant="outline" size="icon" onClick={loadData}>
            <RefreshCw className={`h-4 w-4 ${isLoading ? "animate-spin" : ""}`} />
          </Button>
          <PermissionGate permissions={["BUSINESS_CLIENT_CREATE"]}>
            <Button onClick={() => setIsCreateOpen(true)}>
              <Plus className="mr-2 h-4 w-4" />
              Nuevo Cliente
            </Button>
          </PermissionGate>
        </div>
      </div>

      {/* Stats Cards */}
      <div className="grid gap-4 md:grid-cols-3">
        <StatsCard title="Total Clientes" value={stats.total} icon={Building2} />
        <StatsCard title="Activos" value={stats.active} icon={Building2} className="border-l-4 border-l-emerald-500" />
        <StatsCard
          title="Inactivos / Suspendidos"
          value={stats.inactive + stats.suspended}
          icon={Building2}
          className="border-l-4 border-l-gray-500"
        />
      </div>

      {/* Filters */}
      <div className="flex flex-col gap-4 sm:flex-row">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
          <Input
            placeholder="Buscar por nombre, RNC o email..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="pl-9"
          />
        </div>
        <Select value={statusFilter} onValueChange={(v) => setStatusFilter(v as ClientStatus | "ALL")}>
          <SelectTrigger className="w-[180px]">
            <SelectValue placeholder="Estado" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="ALL">Todos los estados</SelectItem>
            <SelectItem value="ACTIVE">Activo</SelectItem>
            <SelectItem value="INACTIVE">Inactivo</SelectItem>
            <SelectItem value="SUSPENDED">Suspendido</SelectItem>
          </SelectContent>
        </Select>
        <Select value={legalTypeFilter} onValueChange={setLegalTypeFilter}>
          <SelectTrigger className="w-[200px]">
            <SelectValue placeholder="Tipo legal" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="ALL">Todos los tipos</SelectItem>
            {legalTypes.map((type) => (
              <SelectItem key={type.id} value={type.id}>
                {type.name}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      {/* Content */}
      {isLoading ? (
        <div className="flex items-center justify-center py-12">
          <LoadingSpinner size="lg" />
        </div>
      ) : clients.length === 0 ? (
        <EmptyState
          icon={Building2}
          title="No hay clientes"
          description={
            searchTerm || statusFilter !== "ALL"
              ? "No se encontraron clientes con los filtros aplicados"
              : "Comience agregando su primer cliente"
          }
          action={
            !searchTerm &&
            statusFilter === "ALL" && (
              <PermissionGate permissions={["BUSINESS_CLIENT_CREATE"]}>
                <Button onClick={() => setIsCreateOpen(true)}>
                  <Plus className="mr-2 h-4 w-4" />
                  Nuevo Cliente
                </Button>
              </PermissionGate>
            )
          }
        />
      ) : (
        <>
          <ClientTable
            clients={clients}
            onEdit={(client) => setEditingClient(client)}
            onDeactivate={(client) => setDeactivatingClient(client)}
          />

          {/* Pagination */}
          {totalPages > 1 && (
            <Pagination>
              <PaginationContent>
                <PaginationItem>
                  <PaginationPrevious
                    onClick={() => setPage((p) => Math.max(0, p - 1))}
                    className={page === 0 ? "pointer-events-none opacity-50" : "cursor-pointer"}
                  />
                </PaginationItem>
                {Array.from({ length: totalPages }, (_, i) => (
                  <PaginationItem key={i}>
                    <PaginationLink onClick={() => setPage(i)} isActive={page === i} className="cursor-pointer">
                      {i + 1}
                    </PaginationLink>
                  </PaginationItem>
                ))}
                <PaginationItem>
                  <PaginationNext
                    onClick={() => setPage((p) => Math.min(totalPages - 1, p + 1))}
                    className={page === totalPages - 1 ? "pointer-events-none opacity-50" : "cursor-pointer"}
                  />
                </PaginationItem>
              </PaginationContent>
            </Pagination>
          )}
        </>
      )}

      {/* Dialogs */}
      <CreateClientDialog open={isCreateOpen} onOpenChange={setIsCreateOpen} onSuccess={loadData} />

      <EditClientDialog
        client={editingClient}
        open={!!editingClient}
        onOpenChange={(open) => !open && setEditingClient(null)}
        onSuccess={loadData}
      />

      <ConfirmDialog
        open={!!deactivatingClient}
        onOpenChange={(open) => !open && setDeactivatingClient(null)}
        title="Desactivar Cliente"
        description={`¿Está seguro de desactivar a ${deactivatingClient?.name}? El cliente no podrá ser seleccionado para nuevos contratos o facturas.`}
        confirmText="Desactivar"
        variant="destructive"
        onConfirm={handleDeactivate}
        isLoading={isDeactivating}
      />
    </div>
  )
}

// ===== FILE: app\(dashboard)\business\clients\[id]\page.tsx =====

"use client"

// ===== Client Detail Page =====

import { useState, useEffect, useCallback, use } from "react"
import { useRouter } from "next/navigation"
import Link from "next/link"
import {
  ArrowLeft,
  Building2,
  Pencil,
  Ban,
  RefreshCw,
  Mail,
  Phone,
  MapPin,
  FileText,
  Receipt,
  CreditCard,
  DollarSign,
} from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { ConfirmDialog } from "@/components/common/confirm-dialog"
import { PermissionGate } from "@/components/common/permission-gate"
import { StatusBadge } from "@/components/business/common/status-badge"
import { MoneyDisplay } from "@/components/business/common/money-display"
import { EditClientDialog } from "@/components/business/clients/edit-client-dialog"
import { getClientById, deleteClient } from "@/lib/api/business/clients"
import { getContracts } from "@/lib/api/business/contracts"
import { getInvoices } from "@/lib/api/business/invoices"
import { getPayments } from "@/lib/api/business/payments"
import { formatRNC, formatDateDO } from "@/lib/utils/business"
import type { Client, Contract, Invoice, Payment } from "@/lib/types/business"

interface ClientDetailPageProps {
  params: Promise<{ id: string }>
}

export default function ClientDetailPage(props: ClientDetailPageProps) {
  const params = use(props.params)
  const router = useRouter()

  const [client, setClient] = useState<Client | null>(null)
  const [contracts, setContracts] = useState<Contract[]>([])
  const [invoices, setInvoices] = useState<Invoice[]>([])
  const [payments, setPayments] = useState<Payment[]>([])
  const [isLoading, setIsLoading] = useState(true)

  const [isEditOpen, setIsEditOpen] = useState(false)
  const [isDeactivateOpen, setIsDeactivateOpen] = useState(false)
  const [isDeactivating, setIsDeactivating] = useState(false)

  const loadData = useCallback(async () => {
    setIsLoading(true)
    try {
      const [clientData, contractsData, invoicesData, paymentsData] = await Promise.all([
        getClientById(params.id),
        getContracts(0, 10, params.id),
        getInvoices(0, 10, params.id),
        getPayments(0, 10, params.id),
      ])

      setClient(clientData)
      setContracts(contractsData.content)
      setInvoices(invoicesData.content)
      setPayments(paymentsData.content)
    } catch {
      toast.error("Error al cargar cliente")
    } finally {
      setIsLoading(false)
    }
  }, [params.id])

  useEffect(() => {
    loadData()
  }, [loadData])

  async function handleDeactivate() {
    if (!client) return

    setIsDeactivating(true)
    try {
      const response = await deleteClient(client.id)
      if (response.success) {
        toast.success("Cliente desactivado")
        router.push("/business/clients")
      } else {
        toast.error(response.message || "Error al desactivar cliente")
      }
    } catch {
      toast.error("Error al desactivar cliente")
    } finally {
      setIsDeactivating(false)
      setIsDeactivateOpen(false)
    }
  }

  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-12">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  if (!client) {
    return (
      <div className="text-center py-12">
        <Building2 className="mx-auto h-12 w-12 text-muted-foreground" />
        <h2 className="mt-4 text-lg font-semibold">Cliente no encontrado</h2>
        <Button asChild variant="link" className="mt-2">
          <Link href="/business/clients">Volver a clientes</Link>
        </Button>
      </div>
    )
  }

  // Calculate account summary
  const totalInvoiced = invoices.reduce((sum, inv) => sum + inv.total, 0)
  const totalPaid = invoices.reduce((sum, inv) => sum + inv.amountPaid, 0)
  const totalBalance = invoices.reduce((sum, inv) => sum + inv.balance, 0)

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-start justify-between">
        <div className="space-y-2">
          <div className="flex items-center gap-2">
            <Button asChild variant="ghost" size="icon">
              <Link href="/business/clients">
                <ArrowLeft className="h-4 w-4" />
              </Link>
            </Button>
            <h1 className="text-3xl font-bold tracking-tight">{client.name}</h1>
            <StatusBadge type="client" status={client.status} />
          </div>
          <p className="text-muted-foreground pl-10">
            {client.legalTypeName} {client.rnc && `• RNC: ${formatRNC(client.rnc)}`}
          </p>
        </div>
        <div className="flex items-center gap-2">
          <Button variant="outline" size="icon" onClick={loadData}>
            <RefreshCw className={`h-4 w-4 ${isLoading ? "animate-spin" : ""}`} />
          </Button>
          <PermissionGate permissions={["BUSINESS_CLIENT_UPDATE"]}>
            <Button variant="outline" onClick={() => setIsEditOpen(true)}>
              <Pencil className="mr-2 h-4 w-4" />
              Editar
            </Button>
          </PermissionGate>
          {client.status === "ACTIVE" && (
            <PermissionGate permissions={["BUSINESS_CLIENT_DELETE"]}>
              <Button variant="destructive" onClick={() => setIsDeactivateOpen(true)}>
                <Ban className="mr-2 h-4 w-4" />
                Desactivar
              </Button>
            </PermissionGate>
          )}
        </div>
      </div>

      {/* Tabs */}
      <Tabs defaultValue="overview" className="space-y-4">
        <TabsList>
          <TabsTrigger value="overview">Resumen</TabsTrigger>
          <TabsTrigger value="contracts">Contratos ({contracts.length})</TabsTrigger>
          <TabsTrigger value="invoices">Facturas ({invoices.length})</TabsTrigger>
          <TabsTrigger value="payments">Pagos ({payments.length})</TabsTrigger>
        </TabsList>

        {/* Overview Tab */}
        <TabsContent value="overview" className="space-y-6">
          <div className="grid gap-6 md:grid-cols-2">
            {/* Contact Info */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <Mail className="h-4 w-4" />
                  Información de Contacto
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                {client.contactPerson && (
                  <div>
                    <p className="text-sm text-muted-foreground">Contacto principal</p>
                    <p className="font-medium">{client.contactPerson}</p>
                  </div>
                )}
                {client.primaryEmail && (
                  <div className="flex items-center gap-2">
                    <Mail className="h-4 w-4 text-muted-foreground" />
                    <a href={`mailto:${client.primaryEmail}`} className="hover:underline">
                      {client.primaryEmail}
                    </a>
                  </div>
                )}
                {client.secondaryEmail && (
                  <div className="flex items-center gap-2">
                    <Mail className="h-4 w-4 text-muted-foreground" />
                    <a href={`mailto:${client.secondaryEmail}`} className="hover:underline">
                      {client.secondaryEmail}
                    </a>
                  </div>
                )}
                {client.primaryPhone && (
                  <div className="flex items-center gap-2">
                    <Phone className="h-4 w-4 text-muted-foreground" />
                    <span>{client.primaryPhone}</span>
                  </div>
                )}
                {client.secondaryPhone && (
                  <div className="flex items-center gap-2">
                    <Phone className="h-4 w-4 text-muted-foreground" />
                    <span>{client.secondaryPhone}</span>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Account Summary */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <DollarSign className="h-4 w-4" />
                  Resumen de Cuenta
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Total facturado</span>
                  <MoneyDisplay amount={totalInvoiced} className="font-medium" />
                </div>
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Total pagado</span>
                  <MoneyDisplay amount={totalPaid} className="font-medium text-emerald-500" />
                </div>
                <div className="flex justify-between border-t pt-4">
                  <span className="font-medium">Balance pendiente</span>
                  <MoneyDisplay amount={totalBalance} className="font-bold" size="lg" />
                </div>
              </CardContent>
            </Card>

            {/* Billing Address */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <MapPin className="h-4 w-4" />
                  Dirección de Facturación
                </CardTitle>
              </CardHeader>
              <CardContent>
                {client.billingAddressLine1 ? (
                  <div className="space-y-1">
                    <p>{client.billingAddressLine1}</p>
                    {client.billingAddressLine2 && <p>{client.billingAddressLine2}</p>}
                    <p>
                      {[client.billingCity, client.billingProvince, client.billingPostalCode]
                        .filter(Boolean)
                        .join(", ")}
                    </p>
                    <p>{client.billingCountry}</p>
                  </div>
                ) : (
                  <p className="text-muted-foreground">Sin dirección registrada</p>
                )}
              </CardContent>
            </Card>

            {/* Service Address */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-lg">
                  <MapPin className="h-4 w-4" />
                  Dirección de Servicio
                </CardTitle>
              </CardHeader>
              <CardContent>
                {client.serviceAddressLine1 ? (
                  <div className="space-y-1">
                    <p>{client.serviceAddressLine1}</p>
                    {client.serviceAddressLine2 && <p>{client.serviceAddressLine2}</p>}
                    <p>
                      {[client.serviceCity, client.serviceProvince, client.servicePostalCode]
                        .filter(Boolean)
                        .join(", ")}
                    </p>
                    {client.serviceCountry && <p>{client.serviceCountry}</p>}
                  </div>
                ) : (
                  <p className="text-muted-foreground">Sin dirección registrada</p>
                )}
              </CardContent>
            </Card>
          </div>

          {/* Notes */}
          {client.notes && (
            <Card>
              <CardHeader>
                <CardTitle className="text-lg">Notas Internas</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="whitespace-pre-wrap">{client.notes}</p>
              </CardContent>
            </Card>
          )}
        </TabsContent>

        {/* Contracts Tab */}
        <TabsContent value="contracts">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between">
              <div>
                <CardTitle>Contratos</CardTitle>
                <CardDescription>Contratos asociados a este cliente</CardDescription>
              </div>
              <PermissionGate permissions={["BUSINESS_CONTRACT_CREATE"]}>
                <Button asChild>
                  <Link href={`/business/contracts?action=new&clientId=${client.id}`}>
                    <FileText className="mr-2 h-4 w-4" />
                    Nuevo Contrato
                  </Link>
                </Button>
              </PermissionGate>
            </CardHeader>
            <CardContent>
              {contracts.length > 0 ? (
                <div className="space-y-4">
                  {contracts.map((contract) => (
                    <div key={contract.id} className="flex items-center justify-between border-b pb-4 last:border-0">
                      <div>
                        <Link href={`/business/contracts/${contract.id}`} className="font-medium hover:underline">
                          {contract.contractNumber}
                        </Link>
                        <p className="text-sm text-muted-foreground">
                          {formatDateDO(contract.startDate)} -{" "}
                          {contract.endDate ? formatDateDO(contract.endDate) : "Indefinido"}
                        </p>
                      </div>
                      <StatusBadge type="contract" status={contract.status} />
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-muted-foreground text-center py-6">No hay contratos</p>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        {/* Invoices Tab */}
        <TabsContent value="invoices">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between">
              <div>
                <CardTitle>Facturas</CardTitle>
                <CardDescription>Facturas emitidas a este cliente</CardDescription>
              </div>
              <PermissionGate permissions={["BUSINESS_INVOICE_CREATE"]}>
                <Button asChild>
                  <Link href={`/business/invoices?action=new&clientId=${client.id}`}>
                    <Receipt className="mr-2 h-4 w-4" />
                    Nueva Factura
                  </Link>
                </Button>
              </PermissionGate>
            </CardHeader>
            <CardContent>
              {invoices.length > 0 ? (
                <div className="space-y-4">
                  {invoices.map((invoice) => (
                    <div key={invoice.id} className="flex items-center justify-between border-b pb-4 last:border-0">
                      <div>
                        <Link href={`/business/invoices/${invoice.id}`} className="font-medium hover:underline">
                          {invoice.invoiceNumber}
                        </Link>
                        <p className="text-sm text-muted-foreground">{formatDateDO(invoice.issueDate)}</p>
                      </div>
                      <div className="text-right">
                        <MoneyDisplay amount={invoice.total} className="font-medium" />
                        <StatusBadge type="invoice" status={invoice.status} className="ml-2" />
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-muted-foreground text-center py-6">No hay facturas</p>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        {/* Payments Tab */}
        <TabsContent value="payments">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between">
              <div>
                <CardTitle>Pagos</CardTitle>
                <CardDescription>Pagos recibidos de este cliente</CardDescription>
              </div>
              <PermissionGate permissions={["BUSINESS_PAYMENT_CREATE"]}>
                <Button asChild>
                  <Link href={`/business/payments?action=new&clientId=${client.id}`}>
                    <CreditCard className="mr-2 h-4 w-4" />
                    Registrar Pago
                  </Link>
                </Button>
              </PermissionGate>
            </CardHeader>
            <CardContent>
              {payments.length > 0 ? (
                <div className="space-y-4">
                  {payments.map((payment) => (
                    <div key={payment.id} className="flex items-center justify-between border-b pb-4 last:border-0">
                      <div>
                        <Link href={`/business/payments/${payment.id}`} className="font-medium hover:underline">
                          {payment.paymentNumber}
                        </Link>
                        <p className="text-sm text-muted-foreground">
                          {formatDateDO(payment.paymentDate)} • {payment.paymentTypeName}
                        </p>
                      </div>
                      <MoneyDisplay amount={payment.amount} className="font-medium text-emerald-500" />
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-muted-foreground text-center py-6">No hay pagos registrados</p>
              )}
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      {/* Dialogs */}
      <EditClientDialog client={client} open={isEditOpen} onOpenChange={setIsEditOpen} onSuccess={loadData} />

      <ConfirmDialog
        open={isDeactivateOpen}
        onOpenChange={setIsDeactivateOpen}
        title="Desactivar Cliente"
        description={`¿Está seguro de desactivar a ${client.name}? El cliente no podrá ser seleccionado para nuevos contratos o facturas.`}
        confirmText="Desactivar"
        variant="destructive"
        onConfirm={handleDeactivate}
        isLoading={isDeactivating}
      />
    </div>
  )
}

// ===== FILE: app\(dashboard)\business\contracts\loading.tsx =====

import { Skeleton } from "@/components/ui/skeleton"

export default function ContractsLoading() {
  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div className="space-y-2">
          <Skeleton className="h-8 w-48" />
          <Skeleton className="h-4 w-64" />
        </div>
        <Skeleton className="h-10 w-40" />
      </div>

      <div className="grid gap-4 md:grid-cols-4">
        {Array.from({ length: 4 }).map((_, i) => (
          <Skeleton key={i} className="h-32" />
        ))}
      </div>

      <Skeleton className="h-10 w-full" />
      <Skeleton className="h-96" />
    </div>
  )
}

// ===== FILE: app\(dashboard)\business\contracts\page.tsx =====

"use client"

import { useState } from "react"
import useSWR from "swr"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { StatsCard } from "@/components/dashboard/stats-card"
import { EmptyState } from "@/components/common/empty-state"
import { PermissionGate } from "@/components/common/permission-gate"
import { ContractTable } from "@/components/business/contracts/contract-table"
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog"
import { Skeleton } from "@/components/ui/skeleton"
import { FileText, Plus, Search, Filter, AlertTriangle } from "lucide-react"
import type { Contract } from "@/lib/types/business"
import { contractsApi } from "@/lib/api/business/contracts"
import { formatCurrency } from "@/lib/utils/business"
import { toast } from "sonner"
import Link from "next/link"

export default function ContractsPage() {
  const [search, setSearch] = useState("")
  const [statusFilter, setStatusFilter] = useState<string>("all")
  const [page, setPage] = useState(1)
  const [selectedIds, setSelectedIds] = useState<string[]>([])
  const [contractToCancel, setContractToCancel] = useState<Contract | null>(null)
  const [contractToActivate, setContractToActivate] = useState<Contract | null>(null)

  const { data, error, isLoading, mutate } = useSWR(["contracts", search, statusFilter, page], () =>
    contractsApi.getAll({
      search,
      status: statusFilter !== "all" ? statusFilter : undefined,
      page,
      limit: 10,
    }),
  )

  const handleCancel = async () => {
    if (!contractToCancel) return
    try {
      await contractsApi.cancel(contractToCancel.id)
      toast.success("Contrato cancelado exitosamente")
      mutate()
    } catch {
      toast.error("Error al cancelar el contrato")
    } finally {
      setContractToCancel(null)
    }
  }

  const handleActivate = async () => {
    if (!contractToActivate) return
    try {
      await contractsApi.activate(contractToActivate.id)
      toast.success("Contrato activado exitosamente")
      mutate()
    } catch {
      toast.error("Error al activar el contrato")
    } finally {
      setContractToActivate(null)
    }
  }

  const contracts = data?.data || []
  const stats = {
    total: data?.pagination?.total || 0,
    active: contracts.filter((c) => c.status === "active").length,
    expiringSoon: contracts.filter((c) => {
      if (!c.endDate) return false
      const daysUntilEnd = Math.ceil((new Date(c.endDate).getTime() - Date.now()) / (1000 * 60 * 60 * 24))
      return daysUntilEnd <= 30 && daysUntilEnd > 0
    }).length,
    monthlyRevenue: contracts.filter((c) => c.status === "active").reduce((sum, c) => sum + c.monthlyValue, 0),
  }

  return (
    <PermissionGate permissions={["contracts.view"]}>
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight">Contratos</h1>
            <p className="text-muted-foreground">Gestione los contratos de servicios con sus clientes</p>
          </div>
          <PermissionGate permissions={["contracts.create"]}>
            <Button asChild>
              <Link href="/business/contracts/new">
                <Plus className="mr-2 h-4 w-4" />
                Nuevo Contrato
              </Link>
            </Button>
          </PermissionGate>
        </div>

        {/* Stats */}
        <div className="grid gap-4 md:grid-cols-4">
          {isLoading ? (
            Array.from({ length: 4 }).map((_, i) => <Skeleton key={i} className="h-32" />)
          ) : (
            <>
              <StatsCard title="Total Contratos" value={stats.total} icon={FileText} />
              <StatsCard
                title="Contratos Activos"
                value={stats.active}
                icon={FileText}
                trend={{ value: 0, isPositive: true }}
              />
              <StatsCard
                title="Por Vencer (30 días)"
                value={stats.expiringSoon}
                icon={AlertTriangle}
                className={stats.expiringSoon > 0 ? "border-amber-500" : ""}
              />
              <StatsCard title="Ingreso Mensual" value={formatCurrency(stats.monthlyRevenue)} icon={FileText} />
            </>
          )}
        </div>

        {/* Filters */}
        <div className="flex flex-col gap-4 md:flex-row md:items-center">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
            <Input
              placeholder="Buscar por número de contrato o cliente..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="pl-10"
            />
          </div>
          <div className="flex gap-2">
            <Select value={statusFilter} onValueChange={setStatusFilter}>
              <SelectTrigger className="w-[180px]">
                <Filter className="mr-2 h-4 w-4" />
                <SelectValue placeholder="Estado" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">Todos</SelectItem>
                <SelectItem value="draft">Borrador</SelectItem>
                <SelectItem value="active">Activo</SelectItem>
                <SelectItem value="expired">Vencido</SelectItem>
                <SelectItem value="cancelled">Cancelado</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>

        {/* Table */}
        {isLoading ? (
          <Skeleton className="h-96" />
        ) : error ? (
          <EmptyState
            icon={AlertTriangle}
            title="Error al cargar"
            description="No se pudieron cargar los contratos"
            action={{
              label: "Reintentar",
              onClick: () => mutate(),
            }}
          />
        ) : contracts.length === 0 ? (
          <EmptyState
            icon={FileText}
            title="Sin contratos"
            description="No hay contratos que coincidan con los filtros"
            action={{
              label: "Crear Contrato",
              href: "/business/contracts/new",
            }}
          />
        ) : (
          <ContractTable
            contracts={contracts}
            selectedIds={selectedIds}
            onSelectChange={setSelectedIds}
            onEdit={() => {}}
            onCancel={setContractToCancel}
            onActivate={setContractToActivate}
            onRenew={() => {}}
          />
        )}

        {/* Pagination */}
        {data?.pagination && data.pagination.totalPages > 1 && (
          <div className="flex items-center justify-between">
            <p className="text-sm text-muted-foreground">
              Mostrando {contracts.length} de {data.pagination.total} contratos
            </p>
            <div className="flex gap-2">
              <Button variant="outline" size="sm" disabled={page === 1} onClick={() => setPage((p) => p - 1)}>
                Anterior
              </Button>
              <Button
                variant="outline"
                size="sm"
                disabled={page === data.pagination.totalPages}
                onClick={() => setPage((p) => p + 1)}
              >
                Siguiente
              </Button>
            </div>
          </div>
        )}

        {/* Cancel Dialog */}
        <AlertDialog open={!!contractToCancel} onOpenChange={() => setContractToCancel(null)}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>Cancelar Contrato</AlertDialogTitle>
              <AlertDialogDescription>
                ¿Está seguro que desea cancelar el contrato {contractToCancel?.contractNumber}? Esta acción no se puede
                deshacer.
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel>No, mantener</AlertDialogCancel>
              <AlertDialogAction onClick={handleCancel} className="bg-destructive text-destructive-foreground">
                Sí, cancelar
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        {/* Activate Dialog */}
        <AlertDialog open={!!contractToActivate} onOpenChange={() => setContractToActivate(null)}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>Activar Contrato</AlertDialogTitle>
              <AlertDialogDescription>
                ¿Está seguro que desea activar el contrato {contractToActivate?.contractNumber}? Una vez activado, se
                comenzará a facturar según los términos establecidos.
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel>Cancelar</AlertDialogCancel>
              <AlertDialogAction onClick={handleActivate}>Activar Contrato</AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>
      </div>
    </PermissionGate>
  )
}

// ===== FILE: app\(dashboard)\business\contracts\new\page.tsx =====

"use client"

import { useRouter } from "next/navigation"
import { PermissionGate } from "@/components/common/permission-gate"
import { ContractWizard } from "@/components/business/contracts/contract-wizard"
import { contractsApi } from "@/lib/api/business/contracts"
import type { ContractFormData } from "@/lib/validations/business"
import { toast } from "sonner"
import { useState } from "react"

export default function NewContractPage() {
  const router = useRouter()
  const [isLoading, setIsLoading] = useState(false)

  const handleSubmit = async (data: ContractFormData) => {
    setIsLoading(true)
    try {
      const contract = await contractsApi.create(data)
      toast.success("Contrato creado exitosamente")
      router.push(`/business/contracts/${contract.id}`)
    } catch {
      toast.error("Error al crear el contrato")
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <PermissionGate permissions={["contracts.create"]}>
      <div className="space-y-6">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Nuevo Contrato</h1>
          <p className="text-muted-foreground">Complete los pasos para crear un nuevo contrato de servicios</p>
        </div>

        <ContractWizard
          onSubmit={handleSubmit}
          onCancel={() => router.push("/business/contracts")}
          isLoading={isLoading}
        />
      </div>
    </PermissionGate>
  )
}

// ===== FILE: app\(dashboard)\business\contracts\[id]\page.tsx =====

"use client"

import { use } from "react"
import useSWR from "swr"
import Link from "next/link"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Badge } from "@/components/ui/badge"
import { Separator } from "@/components/ui/separator"
import { Skeleton } from "@/components/ui/skeleton"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { EmptyState } from "@/components/common/empty-state"
import { PermissionGate } from "@/components/common/permission-gate"
import { StatusBadge } from "@/components/business/common/status-badge"
import { MoneyDisplay } from "@/components/business/common/money-display"
import {
  ArrowLeft,
  Building2,
  Calendar,
  FileText,
  Pencil,
  RefreshCw,
  XCircle,
  CheckCircle,
  Download,
} from "lucide-react"
import { contractsApi } from "@/lib/api/business/contracts"
import { formatDate } from "@/lib/utils/business"

export default function ContractDetailPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = use(params)
  const { data: contract, error, isLoading } = useSWR(["contract", id], () => contractsApi.getById(id))

  if (isLoading) {
    return (
      <div className="space-y-6">
        <Skeleton className="h-10 w-48" />
        <div className="grid gap-6 md:grid-cols-3">
          <Skeleton className="h-40 md:col-span-2" />
          <Skeleton className="h-40" />
        </div>
      </div>
    )
  }

  if (error || !contract) {
    return (
      <EmptyState
        icon={FileText}
        title="Contrato no encontrado"
        description="El contrato solicitado no existe o fue eliminado"
        action={{ label: "Volver a Contratos", href: "/business/contracts" }}
      />
    )
  }

  const daysUntilEnd = contract.endDate
    ? Math.ceil((new Date(contract.endDate).getTime() - Date.now()) / (1000 * 60 * 60 * 24))
    : null

  return (
    <PermissionGate permissions={["contracts.view"]}>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Button variant="ghost" size="icon" asChild>
              <Link href="/business/contracts">
                <ArrowLeft className="h-4 w-4" />
              </Link>
            </Button>
            <div>
              <div className="flex items-center gap-2">
                <h1 className="text-3xl font-bold tracking-tight">{contract.contractNumber}</h1>
                <StatusBadge status={contract.status} type="contract" />
              </div>
              <p className="text-muted-foreground">Contrato con {contract.client?.companyName}</p>
            </div>
          </div>
          <div className="flex gap-2">
            <Button variant="outline" size="sm">
              <Download className="mr-2 h-4 w-4" />
              Exportar PDF
            </Button>
            {contract.status === "draft" && (
              <>
                <PermissionGate permissions={["contracts.edit"]}>
                  <Button variant="outline" size="sm">
                    <Pencil className="mr-2 h-4 w-4" />
                    Editar
                  </Button>
                </PermissionGate>
                <PermissionGate permissions={["contracts.activate"]}>
                  <Button size="sm">
                    <CheckCircle className="mr-2 h-4 w-4" />
                    Activar
                  </Button>
                </PermissionGate>
              </>
            )}
            {contract.status === "active" && (
              <>
                <Button variant="outline" size="sm">
                  <RefreshCw className="mr-2 h-4 w-4" />
                  Renovar
                </Button>
                <Button variant="outline" size="sm" className="text-destructive bg-transparent">
                  <XCircle className="mr-2 h-4 w-4" />
                  Cancelar
                </Button>
              </>
            )}
          </div>
        </div>

        {/* Warning for expiring contracts */}
        {daysUntilEnd !== null && daysUntilEnd <= 30 && daysUntilEnd > 0 && (
          <div className="rounded-lg border border-amber-500 bg-amber-50 p-4 dark:bg-amber-950/20">
            <p className="text-sm font-medium text-amber-800 dark:text-amber-200">
              Este contrato vence en {daysUntilEnd} días ({formatDate(contract.endDate!)})
            </p>
          </div>
        )}

        <div className="grid gap-6 lg:grid-cols-3">
          {/* Main Content */}
          <div className="lg:col-span-2 space-y-6">
            <Tabs defaultValue="overview">
              <TabsList>
                <TabsTrigger value="overview">Resumen</TabsTrigger>
                <TabsTrigger value="services">Servicios</TabsTrigger>
                <TabsTrigger value="invoices">Facturas</TabsTrigger>
                <TabsTrigger value="history">Historial</TabsTrigger>
              </TabsList>

              <TabsContent value="overview" className="space-y-6">
                <Card>
                  <CardHeader>
                    <CardTitle>Información del Contrato</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <dl className="grid gap-4 md:grid-cols-2">
                      <div>
                        <dt className="text-sm text-muted-foreground">Tipo de Contrato</dt>
                        <dd className="font-medium">
                          {contract.contractType === "fixed" ? "Precio Fijo" : "Por Hora"}
                        </dd>
                      </div>
                      <div>
                        <dt className="text-sm text-muted-foreground">Fecha de Inicio</dt>
                        <dd className="font-medium">{formatDate(contract.startDate)}</dd>
                      </div>
                      <div>
                        <dt className="text-sm text-muted-foreground">Fecha de Fin</dt>
                        <dd className="font-medium">
                          {contract.endDate ? formatDate(contract.endDate) : "Indefinido"}
                        </dd>
                      </div>
                      <div>
                        <dt className="text-sm text-muted-foreground">Renovación Automática</dt>
                        <dd className="font-medium">{contract.autoRenew ? "Sí" : "No"}</dd>
                      </div>
                      <div>
                        <dt className="text-sm text-muted-foreground">Día de Facturación</dt>
                        <dd className="font-medium">Día {contract.billingDay} de cada mes</dd>
                      </div>
                      <div>
                        <dt className="text-sm text-muted-foreground">Días de Crédito</dt>
                        <dd className="font-medium">{contract.paymentTermDays} días</dd>
                      </div>
                    </dl>
                  </CardContent>
                </Card>

                {contract.notes && (
                  <Card>
                    <CardHeader>
                      <CardTitle>Notas</CardTitle>
                    </CardHeader>
                    <CardContent>
                      <p className="text-sm text-muted-foreground whitespace-pre-wrap">{contract.notes}</p>
                    </CardContent>
                  </Card>
                )}
              </TabsContent>

              <TabsContent value="services">
                <Card>
                  <CardHeader>
                    <CardTitle>Líneas de Servicio</CardTitle>
                    <CardDescription>Servicios incluidos en este contrato</CardDescription>
                  </CardHeader>
                  <CardContent>
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead>Servicio</TableHead>
                          <TableHead>Descripción</TableHead>
                          <TableHead className="text-right">Cantidad</TableHead>
                          <TableHead className="text-right">Precio Unit.</TableHead>
                          <TableHead className="text-right">ITBIS</TableHead>
                          <TableHead className="text-right">Subtotal</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {contract.lines?.map((line) => (
                          <TableRow key={line.id}>
                            <TableCell className="font-medium">{line.service?.name}</TableCell>
                            <TableCell>{line.description || "-"}</TableCell>
                            <TableCell className="text-right">{line.quantity}</TableCell>
                            <TableCell className="text-right">
                              <MoneyDisplay amount={line.unitPrice} />
                            </TableCell>
                            <TableCell className="text-right">
                              {line.itbisAmount > 0 ? <MoneyDisplay amount={line.itbisAmount} /> : "N/A"}
                            </TableCell>
                            <TableCell className="text-right">
                              <MoneyDisplay amount={line.subtotal} />
                            </TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </CardContent>
                </Card>
              </TabsContent>

              <TabsContent value="invoices">
                <Card>
                  <CardHeader>
                    <CardTitle>Facturas del Contrato</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <EmptyState
                      icon={FileText}
                      title="Sin facturas"
                      description="No se han generado facturas para este contrato"
                    />
                  </CardContent>
                </Card>
              </TabsContent>

              <TabsContent value="history">
                <Card>
                  <CardHeader>
                    <CardTitle>Historial de Cambios</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-4">
                      <div className="flex gap-4">
                        <div className="flex h-8 w-8 items-center justify-center rounded-full bg-emerald-100 dark:bg-emerald-900">
                          <FileText className="h-4 w-4 text-emerald-600" />
                        </div>
                        <div>
                          <p className="font-medium">Contrato creado</p>
                          <p className="text-sm text-muted-foreground">{formatDate(contract.createdAt)}</p>
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </TabsContent>
            </Tabs>
          </div>

          {/* Sidebar */}
          <div className="space-y-6">
            {/* Client Info */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Building2 className="h-4 w-4" />
                  Cliente
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <p className="font-medium">{contract.client?.companyName}</p>
                  <p className="text-sm text-muted-foreground">RNC: {contract.client?.rnc}</p>
                </div>
                <Separator />
                <Button variant="outline" size="sm" className="w-full bg-transparent" asChild>
                  <Link href={`/business/clients/${contract.clientId}`}>Ver Cliente</Link>
                </Button>
              </CardContent>
            </Card>

            {/* Financial Summary */}
            <Card>
              <CardHeader>
                <CardTitle>Resumen Financiero</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Subtotal:</span>
                  <MoneyDisplay amount={contract.subtotal} />
                </div>
                <div className="flex justify-between">
                  <span className="text-muted-foreground">ITBIS (18%):</span>
                  <MoneyDisplay amount={contract.itbisTotal} />
                </div>
                <Separator />
                <div className="flex justify-between text-lg font-bold">
                  <span>Valor Mensual:</span>
                  <MoneyDisplay amount={contract.monthlyValue} className="text-emerald-600" />
                </div>
              </CardContent>
            </Card>

            {/* Timeline */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Calendar className="h-4 w-4" />
                  Vigencia
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Inicio:</span>
                    <span>{formatDate(contract.startDate)}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Fin:</span>
                    <span>{contract.endDate ? formatDate(contract.endDate) : "Indefinido"}</span>
                  </div>
                  {daysUntilEnd !== null && (
                    <div className="flex justify-between">
                      <span className="text-muted-foreground">Días restantes:</span>
                      <Badge variant={daysUntilEnd <= 30 ? "destructive" : "secondary"}>{daysUntilEnd} días</Badge>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </PermissionGate>
  )
}

// ===== FILE: app\(dashboard)\business\invoices\loading.tsx =====

import { Skeleton } from "@/components/ui/skeleton"

export default function InvoicesLoading() {
  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div className="space-y-2">
          <Skeleton className="h-8 w-48" />
          <Skeleton className="h-4 w-64" />
        </div>
        <Skeleton className="h-10 w-40" />
      </div>

      <div className="grid gap-4 md:grid-cols-4">
        {Array.from({ length: 4 }).map((_, i) => (
          <Skeleton key={i} className="h-32" />
        ))}
      </div>

      <Skeleton className="h-10 w-full" />
      <Skeleton className="h-96" />
    </div>
  )
}

// ===== FILE: app\(dashboard)\business\invoices\page.tsx =====

"use client"

import { useState } from "react"
import useSWR from "swr"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { StatsCard } from "@/components/dashboard/stats-card"
import { EmptyState } from "@/components/common/empty-state"
import { PermissionGate } from "@/components/common/permission-gate"
import { InvoiceTable } from "@/components/business/invoices/invoice-table"
import { CreateInvoiceDialog } from "@/components/business/invoices/create-invoice-dialog"
import { RegisterPaymentDialog } from "@/components/business/payments/register-payment-dialog"
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog"
import { Skeleton } from "@/components/ui/skeleton"
import { FileText, Plus, Search, Filter, AlertTriangle, DollarSign, Clock } from "lucide-react"
import type { Invoice } from "@/lib/types/business"
import { invoicesApi } from "@/lib/api/business/invoices"
import { paymentsApi } from "@/lib/api/business/payments"
import { formatCurrency } from "@/lib/utils/business"
import { toast } from "sonner"

export default function InvoicesPage() {
  const [search, setSearch] = useState("")
  const [statusFilter, setStatusFilter] = useState<string>("all")
  const [page, setPage] = useState(1)
  const [selectedIds, setSelectedIds] = useState<string[]>([])
  const [createDialogOpen, setCreateDialogOpen] = useState(false)
  const [invoiceToSend, setInvoiceToSend] = useState<Invoice | null>(null)
  const [invoiceToCancel, setInvoiceToCancel] = useState<Invoice | null>(null)
  const [invoiceForPayment, setInvoiceForPayment] = useState<Invoice | null>(null)

  const { data, error, isLoading, mutate } = useSWR(["invoices", search, statusFilter, page], () =>
    invoicesApi.getAll({
      search,
      status: statusFilter !== "all" ? statusFilter : undefined,
      page,
      limit: 10,
    }),
  )

  const handleCreate = async (formData: Parameters<typeof invoicesApi.create>[0]) => {
    try {
      await invoicesApi.create(formData)
      toast.success("Factura creada exitosamente")
      mutate()
    } catch {
      toast.error("Error al crear la factura")
      throw new Error("Error")
    }
  }

  const handleSend = async () => {
    if (!invoiceToSend) return
    try {
      await invoicesApi.send(invoiceToSend.id)
      toast.success("Factura enviada al cliente")
      mutate()
    } catch {
      toast.error("Error al enviar la factura")
    } finally {
      setInvoiceToSend(null)
    }
  }

  const handleCancel = async () => {
    if (!invoiceToCancel) return
    try {
      await invoicesApi.cancel(invoiceToCancel.id)
      toast.success("Factura anulada")
      mutate()
    } catch {
      toast.error("Error al anular la factura")
    } finally {
      setInvoiceToCancel(null)
    }
  }

  const handleRegisterPayment = async (data: Parameters<typeof paymentsApi.create>[0]) => {
    try {
      await paymentsApi.create(data)
      toast.success("Pago registrado exitosamente")
      mutate()
    } catch {
      toast.error("Error al registrar el pago")
      throw new Error("Error")
    }
  }

  const invoices = data?.data || []
  const stats = {
    total: data?.pagination?.total || 0,
    pending: invoices.filter((i) => i.status === "sent").length,
    overdue: invoices.filter((i) => i.status === "sent" && new Date(i.dueDate) < new Date()).length,
    totalPending: invoices.filter((i) => i.status === "sent").reduce((sum, i) => sum + i.balanceDue, 0),
  }

  return (
    <PermissionGate permissions={["invoices.view"]}>
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight">Facturas</h1>
            <p className="text-muted-foreground">Gestione la facturación de sus servicios</p>
          </div>
          <PermissionGate permissions={["invoices.create"]}>
            <Button onClick={() => setCreateDialogOpen(true)}>
              <Plus className="mr-2 h-4 w-4" />
              Nueva Factura
            </Button>
          </PermissionGate>
        </div>

        {/* Stats */}
        <div className="grid gap-4 md:grid-cols-4">
          {isLoading ? (
            Array.from({ length: 4 }).map((_, i) => <Skeleton key={i} className="h-32" />)
          ) : (
            <>
              <StatsCard title="Total Facturas" value={stats.total} icon={FileText} />
              <StatsCard title="Por Cobrar" value={stats.pending} icon={Clock} />
              <StatsCard
                title="Vencidas"
                value={stats.overdue}
                icon={AlertTriangle}
                className={stats.overdue > 0 ? "border-destructive" : ""}
              />
              <StatsCard
                title="Monto Pendiente"
                value={formatCurrency(stats.totalPending)}
                icon={DollarSign}
                className={stats.totalPending > 0 ? "border-amber-500" : ""}
              />
            </>
          )}
        </div>

        {/* Filters */}
        <div className="flex flex-col gap-4 md:flex-row md:items-center">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
            <Input
              placeholder="Buscar por NCF, cliente..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="pl-10"
            />
          </div>
          <div className="flex gap-2">
            <Select value={statusFilter} onValueChange={setStatusFilter}>
              <SelectTrigger className="w-[180px]">
                <Filter className="mr-2 h-4 w-4" />
                <SelectValue placeholder="Estado" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">Todas</SelectItem>
                <SelectItem value="draft">Borrador</SelectItem>
                <SelectItem value="sent">Enviada</SelectItem>
                <SelectItem value="partial">Pago Parcial</SelectItem>
                <SelectItem value="paid">Pagada</SelectItem>
                <SelectItem value="cancelled">Anulada</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>

        {/* Table */}
        {isLoading ? (
          <Skeleton className="h-96" />
        ) : error ? (
          <EmptyState
            icon={AlertTriangle}
            title="Error al cargar"
            description="No se pudieron cargar las facturas"
            action={{ label: "Reintentar", onClick: () => mutate() }}
          />
        ) : invoices.length === 0 ? (
          <EmptyState
            icon={FileText}
            title="Sin facturas"
            description="No hay facturas que coincidan con los filtros"
            action={{ label: "Crear Factura", onClick: () => setCreateDialogOpen(true) }}
          />
        ) : (
          <InvoiceTable
            invoices={invoices}
            selectedIds={selectedIds}
            onSelectChange={setSelectedIds}
            onSend={setInvoiceToSend}
            onRegisterPayment={setInvoiceForPayment}
            onCancel={setInvoiceToCancel}
          />
        )}

        {/* Pagination */}
        {data?.pagination && data.pagination.totalPages > 1 && (
          <div className="flex items-center justify-between">
            <p className="text-sm text-muted-foreground">
              Mostrando {invoices.length} de {data.pagination.total} facturas
            </p>
            <div className="flex gap-2">
              <Button variant="outline" size="sm" disabled={page === 1} onClick={() => setPage((p) => p - 1)}>
                Anterior
              </Button>
              <Button
                variant="outline"
                size="sm"
                disabled={page === data.pagination.totalPages}
                onClick={() => setPage((p) => p + 1)}
              >
                Siguiente
              </Button>
            </div>
          </div>
        )}

        {/* Create Dialog */}
        <CreateInvoiceDialog open={createDialogOpen} onOpenChange={setCreateDialogOpen} onSubmit={handleCreate} />

        {/* Register Payment Dialog */}
        <RegisterPaymentDialog
          open={!!invoiceForPayment}
          onOpenChange={() => setInvoiceForPayment(null)}
          invoice={invoiceForPayment}
          onSubmit={handleRegisterPayment}
        />

        {/* Send Dialog */}
        <AlertDialog open={!!invoiceToSend} onOpenChange={() => setInvoiceToSend(null)}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>Enviar Factura</AlertDialogTitle>
              <AlertDialogDescription>
                ¿Está seguro que desea enviar la factura {invoiceToSend?.ncf || invoiceToSend?.invoiceNumber} al
                cliente? Esto asignará el NCF oficial y enviará el documento por correo.
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel>Cancelar</AlertDialogCancel>
              <AlertDialogAction onClick={handleSend}>Enviar Factura</AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        {/* Cancel Dialog */}
        <AlertDialog open={!!invoiceToCancel} onOpenChange={() => setInvoiceToCancel(null)}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>Anular Factura</AlertDialogTitle>
              <AlertDialogDescription>
                ¿Está seguro que desea anular la factura {invoiceToCancel?.ncf || invoiceToCancel?.invoiceNumber}? Esta
                acción no se puede deshacer.
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel>No, mantener</AlertDialogCancel>
              <AlertDialogAction onClick={handleCancel} className="bg-destructive text-destructive-foreground">
                Sí, anular
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>
      </div>
    </PermissionGate>
  )
}

// ===== FILE: app\(dashboard)\business\invoices\[id]\page.tsx =====

"use client"

import { use } from "react"
import useSWR from "swr"
import Link from "next/link"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Separator } from "@/components/ui/separator"
import { Skeleton } from "@/components/ui/skeleton"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { EmptyState } from "@/components/common/empty-state"
import { PermissionGate } from "@/components/common/permission-gate"
import { StatusBadge } from "@/components/business/common/status-badge"
import { MoneyDisplay } from "@/components/business/common/money-display"
import { ArrowLeft, Building2, FileText, Download, Send, DollarSign, Printer, Mail } from "lucide-react"
import { invoicesApi } from "@/lib/api/business/invoices"
import { formatDate, formatNCF, getPaymentMethodLabel } from "@/lib/utils/business"

export default function InvoiceDetailPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = use(params)
  const { data: invoice, error, isLoading } = useSWR(["invoice", id], () => invoicesApi.getById(id))

  if (isLoading) {
    return (
      <div className="space-y-6">
        <Skeleton className="h-10 w-48" />
        <div className="grid gap-6 md:grid-cols-3">
          <Skeleton className="h-96 md:col-span-2" />
          <Skeleton className="h-96" />
        </div>
      </div>
    )
  }

  if (error || !invoice) {
    return (
      <EmptyState
        icon={FileText}
        title="Factura no encontrada"
        description="La factura solicitada no existe o fue eliminada"
        action={{ label: "Volver a Facturas", href: "/business/invoices" }}
      />
    )
  }

  const isOverdue = invoice.status === "sent" && new Date(invoice.dueDate) < new Date()

  return (
    <PermissionGate permissions={["invoices.view"]}>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Button variant="ghost" size="icon" asChild>
              <Link href="/business/invoices">
                <ArrowLeft className="h-4 w-4" />
              </Link>
            </Button>
            <div>
              <div className="flex items-center gap-2">
                <h1 className="text-3xl font-bold tracking-tight">{formatNCF(invoice.ncf) || invoice.invoiceNumber}</h1>
                <StatusBadge status={isOverdue ? "overdue" : invoice.status} type="invoice" />
              </div>
              <p className="text-muted-foreground">Factura a {invoice.client?.companyName}</p>
            </div>
          </div>
          <div className="flex gap-2">
            <Button variant="outline" size="sm">
              <Download className="mr-2 h-4 w-4" />
              PDF
            </Button>
            <Button variant="outline" size="sm">
              <Printer className="mr-2 h-4 w-4" />
              Imprimir
            </Button>
            {invoice.status === "draft" && (
              <Button size="sm">
                <Send className="mr-2 h-4 w-4" />
                Enviar
              </Button>
            )}
            {(invoice.status === "sent" || isOverdue) && (
              <>
                <Button variant="outline" size="sm">
                  <Mail className="mr-2 h-4 w-4" />
                  Recordatorio
                </Button>
                <Button size="sm">
                  <DollarSign className="mr-2 h-4 w-4" />
                  Registrar Pago
                </Button>
              </>
            )}
          </div>
        </div>

        {/* Overdue Warning */}
        {isOverdue && (
          <div className="rounded-lg border border-destructive bg-destructive/10 p-4">
            <p className="text-sm font-medium text-destructive">
              Esta factura está vencida desde el {formatDate(invoice.dueDate)}
            </p>
          </div>
        )}

        <div className="grid gap-6 lg:grid-cols-3">
          {/* Invoice Content */}
          <div className="lg:col-span-2 space-y-6">
            {/* Invoice Header Info */}
            <Card>
              <CardContent className="pt-6">
                <div className="grid gap-6 md:grid-cols-2">
                  <div>
                    <h3 className="font-semibold mb-2">De:</h3>
                    <p className="font-medium">ASEPRE S.R.L.</p>
                    <p className="text-sm text-muted-foreground">Agentes de Seguridad Preventiva</p>
                    <p className="text-sm text-muted-foreground">RNC: 1-23-45678-9</p>
                  </div>
                  <div>
                    <h3 className="font-semibold mb-2">Para:</h3>
                    <p className="font-medium">{invoice.client?.companyName}</p>
                    <p className="text-sm text-muted-foreground">RNC: {invoice.client?.rnc}</p>
                    {invoice.client?.billingAddress && (
                      <p className="text-sm text-muted-foreground">{invoice.client.billingAddress}</p>
                    )}
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Invoice Lines */}
            <Card>
              <CardHeader>
                <CardTitle>Detalle de la Factura</CardTitle>
              </CardHeader>
              <CardContent>
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>Descripción</TableHead>
                      <TableHead className="text-right">Cantidad</TableHead>
                      <TableHead className="text-right">Precio Unit.</TableHead>
                      <TableHead className="text-right">ITBIS</TableHead>
                      <TableHead className="text-right">Subtotal</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {invoice.lines?.map((line) => (
                      <TableRow key={line.id}>
                        <TableCell>
                          <p className="font-medium">{line.service?.name}</p>
                          {line.description && <p className="text-sm text-muted-foreground">{line.description}</p>}
                        </TableCell>
                        <TableCell className="text-right">{line.quantity}</TableCell>
                        <TableCell className="text-right">
                          <MoneyDisplay amount={line.unitPrice} />
                        </TableCell>
                        <TableCell className="text-right">
                          {line.itbisAmount > 0 ? <MoneyDisplay amount={line.itbisAmount} /> : "N/A"}
                        </TableCell>
                        <TableCell className="text-right">
                          <MoneyDisplay amount={line.subtotal} />
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>

                <Separator className="my-4" />

                <div className="flex justify-end">
                  <div className="w-64 space-y-2">
                    <div className="flex justify-between text-sm">
                      <span className="text-muted-foreground">Subtotal:</span>
                      <MoneyDisplay amount={invoice.subtotal} />
                    </div>
                    <div className="flex justify-between text-sm">
                      <span className="text-muted-foreground">ITBIS (18%):</span>
                      <MoneyDisplay amount={invoice.itbisTotal} />
                    </div>
                    <Separator />
                    <div className="flex justify-between text-lg font-bold">
                      <span>Total:</span>
                      <MoneyDisplay amount={invoice.total} />
                    </div>
                    {invoice.balanceDue !== invoice.total && (
                      <>
                        <div className="flex justify-between text-sm text-emerald-600">
                          <span>Pagado:</span>
                          <MoneyDisplay amount={invoice.total - invoice.balanceDue} />
                        </div>
                        <div className="flex justify-between font-medium text-amber-600">
                          <span>Pendiente:</span>
                          <MoneyDisplay amount={invoice.balanceDue} />
                        </div>
                      </>
                    )}
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Payments */}
            {invoice.payments && invoice.payments.length > 0 && (
              <Card>
                <CardHeader>
                  <CardTitle>Pagos Recibidos</CardTitle>
                </CardHeader>
                <CardContent>
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead>Fecha</TableHead>
                        <TableHead>Método</TableHead>
                        <TableHead>Referencia</TableHead>
                        <TableHead className="text-right">Monto</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {invoice.payments.map((payment) => (
                        <TableRow key={payment.id}>
                          <TableCell>{formatDate(payment.paymentDate)}</TableCell>
                          <TableCell>{getPaymentMethodLabel(payment.paymentMethod)}</TableCell>
                          <TableCell>{payment.reference || "-"}</TableCell>
                          <TableCell className="text-right">
                            <MoneyDisplay amount={payment.amount} className="text-emerald-600" />
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </CardContent>
              </Card>
            )}
          </div>

          {/* Sidebar */}
          <div className="space-y-6">
            {/* Invoice Info */}
            <Card>
              <CardHeader>
                <CardTitle>Información</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex justify-between text-sm">
                  <span className="text-muted-foreground">NCF:</span>
                  <span className="font-mono">{formatNCF(invoice.ncf)}</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span className="text-muted-foreground">Tipo NCF:</span>
                  <span>{invoice.ncfType}</span>
                </div>
                <Separator />
                <div className="flex justify-between text-sm">
                  <span className="text-muted-foreground">Emisión:</span>
                  <span>{formatDate(invoice.issueDate)}</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span className="text-muted-foreground">Vencimiento:</span>
                  <span className={isOverdue ? "text-destructive font-medium" : ""}>{formatDate(invoice.dueDate)}</span>
                </div>
              </CardContent>
            </Card>

            {/* Client Info */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Building2 className="h-4 w-4" />
                  Cliente
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <p className="font-medium">{invoice.client?.companyName}</p>
                  <p className="text-sm text-muted-foreground">RNC: {invoice.client?.rnc}</p>
                </div>
                <Separator />
                <Button variant="outline" size="sm" className="w-full bg-transparent" asChild>
                  <Link href={`/business/clients/${invoice.clientId}`}>Ver Cliente</Link>
                </Button>
              </CardContent>
            </Card>

            {/* Contract Info */}
            {invoice.contract && (
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <FileText className="h-4 w-4" />
                    Contrato
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div>
                    <p className="font-medium">{invoice.contract.contractNumber}</p>
                    <p className="text-sm text-muted-foreground">
                      Vigencia: {formatDate(invoice.contract.startDate)} -{" "}
                      {invoice.contract.endDate ? formatDate(invoice.contract.endDate) : "Indefinido"}
                    </p>
                  </div>
                  <Separator />
                  <Button variant="outline" size="sm" className="w-full bg-transparent" asChild>
                    <Link href={`/business/contracts/${invoice.contractId}`}>Ver Contrato</Link>
                  </Button>
                </CardContent>
              </Card>
            )}
          </div>
        </div>
      </div>
    </PermissionGate>
  )
}

// ===== FILE: app\(dashboard)\business\payments\loading.tsx =====

import { Skeleton } from "@/components/ui/skeleton"

export default function PaymentsLoading() {
  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div className="space-y-2">
          <Skeleton className="h-8 w-48" />
          <Skeleton className="h-4 w-64" />
        </div>
      </div>

      <div className="grid gap-4 md:grid-cols-4">
        {Array.from({ length: 4 }).map((_, i) => (
          <Skeleton key={i} className="h-32" />
        ))}
      </div>

      <Skeleton className="h-10 w-full" />
      <Skeleton className="h-96" />
    </div>
  )
}

// ===== FILE: app\(dashboard)\business\payments\page.tsx =====

"use client"

import { useState } from "react"
import useSWR from "swr"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { StatsCard } from "@/components/dashboard/stats-card"
import { EmptyState } from "@/components/common/empty-state"
import { PermissionGate } from "@/components/common/permission-gate"
import { PaymentTable } from "@/components/business/payments/payment-table"
import { Skeleton } from "@/components/ui/skeleton"
import { DollarSign, Search, Filter, AlertTriangle, CreditCard, TrendingUp } from "lucide-react"
import type { Payment } from "@/lib/types/business"
import { paymentsApi } from "@/lib/api/business/payments"
import { formatCurrency } from "@/lib/utils/business"
import { Sheet, SheetContent, SheetDescription, SheetHeader, SheetTitle } from "@/components/ui/sheet"
import { MoneyDisplay } from "@/components/business/common/money-display"
import { formatDate, getPaymentMethodLabel } from "@/lib/utils/business"
import { Separator } from "@/components/ui/separator"

export default function PaymentsPage() {
  const [search, setSearch] = useState("")
  const [methodFilter, setMethodFilter] = useState<string>("all")
  const [page, setPage] = useState(1)
  const [receiptPayment, setReceiptPayment] = useState<Payment | null>(null)

  const { data, error, isLoading, mutate } = useSWR(["payments", search, methodFilter, page], () =>
    paymentsApi.getAll({
      search,
      paymentMethod: methodFilter !== "all" ? methodFilter : undefined,
      page,
      limit: 10,
    }),
  )

  const payments = data?.data || []

  const stats = {
    total: data?.pagination?.total || 0,
    thisMonth: payments.filter((p) => {
      const paymentDate = new Date(p.paymentDate)
      const now = new Date()
      return paymentDate.getMonth() === now.getMonth() && paymentDate.getFullYear() === now.getFullYear()
    }).length,
    totalAmount: payments.reduce((sum, p) => sum + p.amount, 0),
    avgPayment: payments.length > 0 ? payments.reduce((sum, p) => sum + p.amount, 0) / payments.length : 0,
  }

  return (
    <PermissionGate permissions={["payments.view"]}>
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight">Pagos</h1>
            <p className="text-muted-foreground">Historial de pagos recibidos</p>
          </div>
        </div>

        {/* Stats */}
        <div className="grid gap-4 md:grid-cols-4">
          {isLoading ? (
            Array.from({ length: 4 }).map((_, i) => <Skeleton key={i} className="h-32" />)
          ) : (
            <>
              <StatsCard title="Total Pagos" value={stats.total} icon={DollarSign} />
              <StatsCard title="Este Mes" value={stats.thisMonth} icon={TrendingUp} />
              <StatsCard
                title="Monto Total"
                value={formatCurrency(stats.totalAmount)}
                icon={CreditCard}
                className="border-emerald-500"
              />
              <StatsCard title="Promedio por Pago" value={formatCurrency(stats.avgPayment)} icon={DollarSign} />
            </>
          )}
        </div>

        {/* Filters */}
        <div className="flex flex-col gap-4 md:flex-row md:items-center">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
            <Input
              placeholder="Buscar por cliente, referencia..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="pl-10"
            />
          </div>
          <div className="flex gap-2">
            <Select value={methodFilter} onValueChange={setMethodFilter}>
              <SelectTrigger className="w-[180px]">
                <Filter className="mr-2 h-4 w-4" />
                <SelectValue placeholder="Método" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">Todos</SelectItem>
                <SelectItem value="transfer">Transferencia</SelectItem>
                <SelectItem value="check">Cheque</SelectItem>
                <SelectItem value="cash">Efectivo</SelectItem>
                <SelectItem value="card">Tarjeta</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>

        {/* Table */}
        {isLoading ? (
          <Skeleton className="h-96" />
        ) : error ? (
          <EmptyState
            icon={AlertTriangle}
            title="Error al cargar"
            description="No se pudieron cargar los pagos"
            action={{ label: "Reintentar", onClick: () => mutate() }}
          />
        ) : payments.length === 0 ? (
          <EmptyState icon={DollarSign} title="Sin pagos" description="No hay pagos que coincidan con los filtros" />
        ) : (
          <PaymentTable payments={payments} onViewReceipt={setReceiptPayment} />
        )}

        {/* Pagination */}
        {data?.pagination && data.pagination.totalPages > 1 && (
          <div className="flex items-center justify-between">
            <p className="text-sm text-muted-foreground">
              Mostrando {payments.length} de {data.pagination.total} pagos
            </p>
            <div className="flex gap-2">
              <Button variant="outline" size="sm" disabled={page === 1} onClick={() => setPage((p) => p - 1)}>
                Anterior
              </Button>
              <Button
                variant="outline"
                size="sm"
                disabled={page === data.pagination.totalPages}
                onClick={() => setPage((p) => p + 1)}
              >
                Siguiente
              </Button>
            </div>
          </div>
        )}

        {/* Receipt Sheet */}
        <Sheet open={!!receiptPayment} onOpenChange={() => setReceiptPayment(null)}>
          <SheetContent>
            <SheetHeader>
              <SheetTitle>Recibo de Pago</SheetTitle>
              <SheetDescription>{receiptPayment?.receipt?.receiptNumber}</SheetDescription>
            </SheetHeader>
            {receiptPayment && (
              <div className="mt-6 space-y-6">
                <div className="space-y-4">
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Fecha:</span>
                    <span>{formatDate(receiptPayment.paymentDate)}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Cliente:</span>
                    <span className="font-medium">{receiptPayment.invoice?.client?.companyName}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Factura:</span>
                    <span>{receiptPayment.invoice?.ncf}</span>
                  </div>
                  <Separator />
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Método:</span>
                    <span>{getPaymentMethodLabel(receiptPayment.paymentMethod)}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Referencia:</span>
                    <span>{receiptPayment.reference || "-"}</span>
                  </div>
                  <Separator />
                  <div className="flex justify-between text-lg font-bold">
                    <span>Monto:</span>
                    <MoneyDisplay amount={receiptPayment.amount} className="text-emerald-600" />
                  </div>
                </div>
                <Button className="w-full">Imprimir Recibo</Button>
              </div>
            )}
          </SheetContent>
        </Sheet>
      </div>
    </PermissionGate>
  )
}

// ===== FILE: app\(dashboard)\business\payments\types\page.tsx =====

"use client"

// ===== Payment Types Management Page (SUPERADMIN Only) =====

import { useState, useEffect, useCallback } from "react"
import { CreditCard, Plus, RefreshCw, Check, X, Pencil, Trash2 } from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Switch } from "@/components/ui/switch"
import { Badge } from "@/components/ui/badge"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { EmptyState } from "@/components/common/empty-state"
import { ConfirmDialog } from "@/components/common/confirm-dialog"
import { ProtectedRoute } from "@/components/common/protected-route"
import { getPaymentTypes, createPaymentType, updatePaymentType, deletePaymentType } from "@/lib/api/business/payments"
import type { PaymentType, CreatePaymentTypeRequest } from "@/lib/types/business"
import { Loader2 } from "lucide-react"

export default function PaymentTypesPage() {
  const [paymentTypes, setPaymentTypes] = useState<PaymentType[]>([])
  const [isLoading, setIsLoading] = useState(true)

  // Dialog state
  const [isDialogOpen, setIsDialogOpen] = useState(false)
  const [editingType, setEditingType] = useState<PaymentType | null>(null)
  const [deletingType, setDeletingType] = useState<PaymentType | null>(null)
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [isDeleting, setIsDeleting] = useState(false)

  // Form state
  const [formData, setFormData] = useState<CreatePaymentTypeRequest>({
    code: "",
    name: "",
    description: "",
    requiresReference: false,
  })

  const loadData = useCallback(async () => {
    setIsLoading(true)
    try {
      const types = await getPaymentTypes()
      setPaymentTypes(types)
    } catch {
      toast.error("Error al cargar tipos de pago")
    } finally {
      setIsLoading(false)
    }
  }, [])

  useEffect(() => {
    loadData()
  }, [loadData])

  function handleOpenDialog(type?: PaymentType) {
    if (type) {
      setEditingType(type)
      setFormData({
        code: type.code,
        name: type.name,
        description: type.description || "",
        requiresReference: type.requiresReference,
      })
    } else {
      setEditingType(null)
      setFormData({
        code: "",
        name: "",
        description: "",
        requiresReference: false,
      })
    }
    setIsDialogOpen(true)
  }

  async function handleSubmit() {
    if (!formData.code || !formData.name) {
      toast.error("Código y nombre son requeridos")
      return
    }

    setIsSubmitting(true)
    try {
      if (editingType) {
        const response = await updatePaymentType(editingType.id, formData)
        if (response.success) {
          toast.success("Tipo de pago actualizado")
          loadData()
          setIsDialogOpen(false)
        } else {
          toast.error(response.message || "Error al actualizar")
        }
      } else {
        const response = await createPaymentType(formData)
        if (response.success) {
          toast.success("Tipo de pago creado")
          loadData()
          setIsDialogOpen(false)
        } else {
          toast.error(response.message || "Error al crear")
        }
      }
    } catch {
      toast.error("Error al guardar tipo de pago")
    } finally {
      setIsSubmitting(false)
    }
  }

  async function handleDelete() {
    if (!deletingType) return

    setIsDeleting(true)
    try {
      const response = await deletePaymentType(deletingType.id)
      if (response.success) {
        toast.success("Tipo de pago eliminado")
        loadData()
      } else {
        toast.error(response.message || "Error al eliminar")
      }
    } catch {
      toast.error("Error al eliminar tipo de pago")
    } finally {
      setIsDeleting(false)
      setDeletingType(null)
    }
  }

  return (
    <ProtectedRoute permissions={["BUSINESS_PAYMENT_TYPE_MANAGE"]}>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight">Tipos de Pago</h1>
            <p className="text-muted-foreground">Configure los métodos de pago aceptados</p>
          </div>
          <div className="flex items-center gap-2">
            <Button variant="outline" size="icon" onClick={loadData}>
              <RefreshCw className={`h-4 w-4 ${isLoading ? "animate-spin" : ""}`} />
            </Button>
            <Button onClick={() => handleOpenDialog()}>
              <Plus className="mr-2 h-4 w-4" />
              Nuevo Tipo
            </Button>
          </div>
        </div>

        {/* Content */}
        <Card>
          <CardHeader>
            <CardTitle>Métodos de Pago</CardTitle>
            <CardDescription>Defina los tipos de pago que pueden registrarse en el sistema</CardDescription>
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <div className="flex items-center justify-center py-12">
                <LoadingSpinner size="lg" />
              </div>
            ) : paymentTypes.length === 0 ? (
              <EmptyState
                icon={CreditCard}
                title="Sin tipos de pago"
                description="Configure los métodos de pago aceptados"
                action={
                  <Button onClick={() => handleOpenDialog()}>
                    <Plus className="mr-2 h-4 w-4" />
                    Crear Tipo de Pago
                  </Button>
                }
              />
            ) : (
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>Código</TableHead>
                    <TableHead>Nombre</TableHead>
                    <TableHead>Descripción</TableHead>
                    <TableHead className="text-center">Req. Referencia</TableHead>
                    <TableHead className="text-center">Estado</TableHead>
                    <TableHead className="text-right">Acciones</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {paymentTypes.map((type) => (
                    <TableRow key={type.id}>
                      <TableCell className="font-mono font-medium">{type.code}</TableCell>
                      <TableCell className="font-medium">{type.name}</TableCell>
                      <TableCell className="text-muted-foreground">{type.description || "-"}</TableCell>
                      <TableCell className="text-center">
                        {type.requiresReference ? (
                          <Check className="h-4 w-4 text-emerald-500 mx-auto" />
                        ) : (
                          <X className="h-4 w-4 text-muted-foreground mx-auto" />
                        )}
                      </TableCell>
                      <TableCell className="text-center">
                        <Badge variant={type.active ? "default" : "secondary"}>
                          {type.active ? "Activo" : "Inactivo"}
                        </Badge>
                      </TableCell>
                      <TableCell className="text-right">
                        <div className="flex items-center justify-end gap-2">
                          <Button variant="ghost" size="icon" onClick={() => handleOpenDialog(type)}>
                            <Pencil className="h-4 w-4" />
                          </Button>
                          <Button variant="ghost" size="icon" onClick={() => setDeletingType(type)}>
                            <Trash2 className="h-4 w-4 text-destructive" />
                          </Button>
                        </div>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            )}
          </CardContent>
        </Card>

        {/* Create/Edit Dialog */}
        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>{editingType ? "Editar Tipo de Pago" : "Nuevo Tipo de Pago"}</DialogTitle>
              <DialogDescription>
                {editingType
                  ? "Modifique la configuración del método de pago"
                  : "Configure un nuevo método de pago aceptado"}
              </DialogDescription>
            </DialogHeader>
            <div className="space-y-4 py-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="code">Código *</Label>
                  <Input
                    id="code"
                    placeholder="TRANSFER"
                    value={formData.code}
                    onChange={(e) => setFormData({ ...formData, code: e.target.value.toUpperCase() })}
                    disabled={!!editingType}
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="name">Nombre *</Label>
                  <Input
                    id="name"
                    placeholder="Transferencia Bancaria"
                    value={formData.name}
                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                  />
                </div>
              </div>
              <div className="space-y-2">
                <Label htmlFor="description">Descripción</Label>
                <Input
                  id="description"
                  placeholder="Descripción opcional del método de pago"
                  value={formData.description}
                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                />
              </div>
              <div className="flex items-center justify-between rounded-lg border p-4">
                <div className="space-y-0.5">
                  <Label>Requiere Referencia</Label>
                  <p className="text-sm text-muted-foreground">
                    El usuario deberá ingresar un número de referencia al registrar pagos
                  </p>
                </div>
                <Switch
                  checked={formData.requiresReference}
                  onCheckedChange={(checked) => setFormData({ ...formData, requiresReference: checked })}
                />
              </div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setIsDialogOpen(false)}>
                Cancelar
              </Button>
              <Button onClick={handleSubmit} disabled={isSubmitting}>
                {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                {editingType ? "Guardar Cambios" : "Crear Tipo"}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>

        {/* Delete Confirmation */}
        <ConfirmDialog
          open={!!deletingType}
          onOpenChange={(open) => !open && setDeletingType(null)}
          title="Eliminar Tipo de Pago"
          description={`¿Está seguro de eliminar el tipo de pago "${deletingType?.name}"? Esta acción no se puede deshacer.`}
          confirmText="Eliminar"
          variant="destructive"
          onConfirm={handleDelete}
          isLoading={isDeleting}
        />
      </div>
    </ProtectedRoute>
  )
}

// ===== FILE: app\(dashboard)\business\pricing\page.tsx =====

"use client"

// ===== Pricing Management Page =====

import { useState } from "react"
import { DollarSign, RefreshCw } from "lucide-react"

import { Button } from "@/components/ui/button"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { GlobalPricesTable } from "@/components/business/pricing/global-prices-table"
import { PriceCalculator } from "@/components/business/pricing/price-calculator"
import { SetPriceDialog } from "@/components/business/pricing/set-price-dialog"
import { PriceHistorySheet } from "@/components/business/pricing/price-history-sheet"
import type { ServiceCatalog } from "@/lib/types/business"

export default function PricingPage() {
  const [key, setKey] = useState(0) // Force re-render
  const [pricingService, setPricingService] = useState<ServiceCatalog | null>(null)
  const [historyService, setHistoryService] = useState<ServiceCatalog | null>(null)

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Gestión de Precios</h1>
          <p className="text-muted-foreground">Configure precios globales y por cliente</p>
        </div>
        <Button variant="outline" size="icon" onClick={() => setKey((k) => k + 1)}>
          <RefreshCw className="h-4 w-4" />
        </Button>
      </div>

      {/* Tabs */}
      <Tabs defaultValue="global" className="space-y-4">
        <TabsList>
          <TabsTrigger value="global">Precios Globales</TabsTrigger>
          <TabsTrigger value="calculator">Calculadora</TabsTrigger>
        </TabsList>

        {/* Global Prices Tab */}
        <TabsContent value="global">
          <GlobalPricesTable
            key={key}
            onSetPrice={(service) => setPricingService(service)}
            onViewHistory={(service) => setHistoryService(service)}
          />
        </TabsContent>

        {/* Price Calculator Tab */}
        <TabsContent value="calculator">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <DollarSign className="h-5 w-5" />
                Calculadora de Precios
              </CardTitle>
              <CardDescription>
                Calcule el precio final para un cliente y servicio específico, incluyendo ITBIS
              </CardDescription>
            </CardHeader>
            <CardContent>
              <PriceCalculator key={key} />
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      {/* Dialogs */}
      <SetPriceDialog
        service={pricingService}
        open={!!pricingService}
        onOpenChange={(open) => !open && setPricingService(null)}
        onSuccess={() => setKey((k) => k + 1)}
      />

      <PriceHistorySheet
        service={historyService}
        open={!!historyService}
        onOpenChange={(open) => !open && setHistoryService(null)}
      />
    </div>
  )
}

// ===== FILE: app\(dashboard)\business\reports\loading.tsx =====

import { Skeleton } from "@/components/ui/skeleton"

export default function ReportsLoading() {
  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div className="space-y-2">
          <Skeleton className="h-8 w-48" />
          <Skeleton className="h-4 w-64" />
        </div>
        <div className="flex gap-2">
          <Skeleton className="h-10 w-24" />
          <Skeleton className="h-10 w-24" />
        </div>
      </div>

      <Skeleton className="h-20" />

      <div className="grid gap-4 md:grid-cols-4">
        {Array.from({ length: 4 }).map((_, i) => (
          <Skeleton key={i} className="h-32" />
        ))}
      </div>

      <Skeleton className="h-[500px]" />
    </div>
  )
}

// ===== FILE: app\(dashboard)\business\reports\page.tsx =====

"use client"

import { useState } from "react"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { PermissionGate } from "@/components/common/permission-gate"
import { MoneyDisplay } from "@/components/business/common/money-display"
import {
  BarChart3,
  Download,
  FileText,
  TrendingUp,
  TrendingDown,
  DollarSign,
  Users,
  FileCheck,
  Calendar,
} from "lucide-react"
import { ChartContainer, ChartTooltip, ChartTooltipContent, type ChartConfig } from "@/components/ui/chart"
import { Bar, BarChart, Line, LineChart, XAxis, YAxis, CartesianGrid, ResponsiveContainer } from "recharts"

// Sample data for charts
const revenueData = [
  { month: "Ene", ingresos: 450000, gastos: 180000 },
  { month: "Feb", ingresos: 520000, gastos: 195000 },
  { month: "Mar", ingresos: 480000, gastos: 175000 },
  { month: "Abr", ingresos: 590000, gastos: 210000 },
  { month: "May", ingresos: 620000, gastos: 225000 },
  { month: "Jun", ingresos: 680000, gastos: 240000 },
]

const collectionsData = [
  { month: "Ene", cobrado: 420000, pendiente: 80000 },
  { month: "Feb", cobrado: 490000, pendiente: 95000 },
  { month: "Mar", cobrado: 450000, pendiente: 110000 },
  { month: "Abr", cobrado: 560000, pendiente: 85000 },
  { month: "May", cobrado: 590000, pendiente: 70000 },
  { month: "Jun", cobrado: 650000, pendiente: 60000 },
]

const chartConfig = {
  ingresos: {
    label: "Ingresos",
    color: "hsl(var(--chart-1))",
  },
  gastos: {
    label: "Gastos",
    color: "hsl(var(--chart-2))",
  },
  cobrado: {
    label: "Cobrado",
    color: "hsl(var(--chart-1))",
  },
  pendiente: {
    label: "Pendiente",
    color: "hsl(var(--chart-3))",
  },
} satisfies ChartConfig

export default function ReportsPage() {
  const [dateFrom, setDateFrom] = useState("")
  const [dateTo, setDateTo] = useState("")
  const [reportType, setReportType] = useState("revenue")

  const summaryStats = {
    totalRevenue: 3340000,
    revenueGrowth: 12.5,
    totalCollected: 3160000,
    collectionRate: 94.6,
    activeContracts: 45,
    activeClients: 38,
    overdueAmount: 180000,
    overdueInvoices: 5,
  }

  const handleExport = (format: "pdf" | "excel") => {
    // Export logic would go here
    console.log(`Exporting report as ${format}`)
  }

  return (
    <PermissionGate permissions={["reports.view"]}>
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight">Reportes</h1>
            <p className="text-muted-foreground">Análisis financiero y operativo del negocio</p>
          </div>
          <div className="flex gap-2">
            <Button variant="outline" onClick={() => handleExport("excel")}>
              <Download className="mr-2 h-4 w-4" />
              Excel
            </Button>
            <Button variant="outline" onClick={() => handleExport("pdf")}>
              <FileText className="mr-2 h-4 w-4" />
              PDF
            </Button>
          </div>
        </div>

        {/* Date Filters */}
        <Card>
          <CardContent className="pt-6">
            <div className="flex flex-wrap gap-4 items-end">
              <div className="space-y-2">
                <Label>Desde</Label>
                <Input type="date" value={dateFrom} onChange={(e) => setDateFrom(e.target.value)} className="w-40" />
              </div>
              <div className="space-y-2">
                <Label>Hasta</Label>
                <Input type="date" value={dateTo} onChange={(e) => setDateTo(e.target.value)} className="w-40" />
              </div>
              <div className="space-y-2">
                <Label>Período</Label>
                <Select defaultValue="month">
                  <SelectTrigger className="w-40">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="week">Semanal</SelectItem>
                    <SelectItem value="month">Mensual</SelectItem>
                    <SelectItem value="quarter">Trimestral</SelectItem>
                    <SelectItem value="year">Anual</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <Button>
                <Calendar className="mr-2 h-4 w-4" />
                Aplicar
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Summary Stats */}
        <div className="grid gap-4 md:grid-cols-4">
          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-muted-foreground">Ingresos Totales</p>
                  <MoneyDisplay amount={summaryStats.totalRevenue} className="text-2xl font-bold" />
                </div>
                <div
                  className={`flex items-center gap-1 text-sm ${summaryStats.revenueGrowth > 0 ? "text-emerald-600" : "text-destructive"}`}
                >
                  {summaryStats.revenueGrowth > 0 ? (
                    <TrendingUp className="h-4 w-4" />
                  ) : (
                    <TrendingDown className="h-4 w-4" />
                  )}
                  {Math.abs(summaryStats.revenueGrowth)}%
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-muted-foreground">Total Cobrado</p>
                  <MoneyDisplay amount={summaryStats.totalCollected} className="text-2xl font-bold text-emerald-600" />
                </div>
                <div className="text-sm text-muted-foreground">{summaryStats.collectionRate}% cobrado</div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-muted-foreground">Contratos Activos</p>
                  <p className="text-2xl font-bold">{summaryStats.activeContracts}</p>
                </div>
                <FileCheck className="h-8 w-8 text-muted-foreground" />
              </div>
              <p className="text-sm text-muted-foreground mt-1">{summaryStats.activeClients} clientes</p>
            </CardContent>
          </Card>

          <Card className="border-amber-500">
            <CardContent className="pt-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-muted-foreground">Por Cobrar (Vencido)</p>
                  <MoneyDisplay amount={summaryStats.overdueAmount} className="text-2xl font-bold text-amber-600" />
                </div>
                <DollarSign className="h-8 w-8 text-amber-500" />
              </div>
              <p className="text-sm text-muted-foreground mt-1">{summaryStats.overdueInvoices} facturas vencidas</p>
            </CardContent>
          </Card>
        </div>

        {/* Charts */}
        <Tabs defaultValue="revenue" className="space-y-4">
          <TabsList>
            <TabsTrigger value="revenue">Ingresos vs Gastos</TabsTrigger>
            <TabsTrigger value="collections">Cobranza</TabsTrigger>
            <TabsTrigger value="clients">Por Cliente</TabsTrigger>
            <TabsTrigger value="services">Por Servicio</TabsTrigger>
          </TabsList>

          <TabsContent value="revenue">
            <Card>
              <CardHeader>
                <CardTitle>Ingresos vs Gastos</CardTitle>
                <CardDescription>Comparativa mensual de ingresos y gastos operativos</CardDescription>
              </CardHeader>
              <CardContent>
                <ChartContainer config={chartConfig} className="h-[400px] w-full">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={revenueData}>
                      <CartesianGrid strokeDasharray="3 3" vertical={false} />
                      <XAxis dataKey="month" tickLine={false} axisLine={false} />
                      <YAxis tickLine={false} axisLine={false} tickFormatter={(value) => `${value / 1000}K`} />
                      <ChartTooltip content={<ChartTooltipContent />} />
                      <Bar dataKey="ingresos" fill="var(--color-ingresos)" radius={[4, 4, 0, 0]} />
                      <Bar dataKey="gastos" fill="var(--color-gastos)" radius={[4, 4, 0, 0]} />
                    </BarChart>
                  </ResponsiveContainer>
                </ChartContainer>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="collections">
            <Card>
              <CardHeader>
                <CardTitle>Análisis de Cobranza</CardTitle>
                <CardDescription>Montos cobrados vs pendientes por mes</CardDescription>
              </CardHeader>
              <CardContent>
                <ChartContainer config={chartConfig} className="h-[400px] w-full">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={collectionsData}>
                      <CartesianGrid strokeDasharray="3 3" vertical={false} />
                      <XAxis dataKey="month" tickLine={false} axisLine={false} />
                      <YAxis tickLine={false} axisLine={false} tickFormatter={(value) => `${value / 1000}K`} />
                      <ChartTooltip content={<ChartTooltipContent />} />
                      <Line
                        type="monotone"
                        dataKey="cobrado"
                        stroke="var(--color-cobrado)"
                        strokeWidth={2}
                        dot={{ r: 4 }}
                      />
                      <Line
                        type="monotone"
                        dataKey="pendiente"
                        stroke="var(--color-pendiente)"
                        strokeWidth={2}
                        dot={{ r: 4 }}
                      />
                    </LineChart>
                  </ResponsiveContainer>
                </ChartContainer>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="clients">
            <Card>
              <CardHeader>
                <CardTitle>Ingresos por Cliente</CardTitle>
                <CardDescription>Top 10 clientes por facturación</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {[
                    { name: "Supermercados Nacional", amount: 520000, percentage: 15.6 },
                    { name: "Banco Popular Dominicano", amount: 480000, percentage: 14.4 },
                    { name: "Grupo Ramos", amount: 420000, percentage: 12.6 },
                    { name: "CCN", amount: 380000, percentage: 11.4 },
                    { name: "Farmacia Carol", amount: 340000, percentage: 10.2 },
                    { name: "Plaza Lama", amount: 300000, percentage: 9.0 },
                    { name: "Jumbo", amount: 280000, percentage: 8.4 },
                    { name: "La Sirena", amount: 260000, percentage: 7.8 },
                    { name: "Carrefour", amount: 200000, percentage: 6.0 },
                    { name: "Otros", amount: 160000, percentage: 4.8 },
                  ].map((client, index) => (
                    <div key={client.name} className="flex items-center gap-4">
                      <span className="w-6 text-sm text-muted-foreground">{index + 1}.</span>
                      <div className="flex-1">
                        <div className="flex items-center justify-between mb-1">
                          <span className="font-medium">{client.name}</span>
                          <MoneyDisplay amount={client.amount} className="font-medium" />
                        </div>
                        <div className="h-2 bg-muted rounded-full overflow-hidden">
                          <div
                            className="h-full bg-emerald-500 rounded-full"
                            style={{ width: `${client.percentage * 4}%` }}
                          />
                        </div>
                      </div>
                      <span className="w-12 text-sm text-muted-foreground text-right">{client.percentage}%</span>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="services">
            <Card>
              <CardHeader>
                <CardTitle>Ingresos por Servicio</CardTitle>
                <CardDescription>Distribución de ingresos por tipo de servicio</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {[
                    { name: "Vigilancia Física 24/7", amount: 1200000, percentage: 35.9, color: "bg-emerald-500" },
                    { name: "Vigilancia Física 12h", amount: 800000, percentage: 24.0, color: "bg-blue-500" },
                    { name: "Escoltas Ejecutivos", amount: 520000, percentage: 15.6, color: "bg-purple-500" },
                    { name: "Monitoreo CCTV", amount: 420000, percentage: 12.6, color: "bg-amber-500" },
                    { name: "Seguridad Eventos", amount: 280000, percentage: 8.4, color: "bg-pink-500" },
                    { name: "Otros Servicios", amount: 120000, percentage: 3.6, color: "bg-slate-500" },
                  ].map((service) => (
                    <div key={service.name} className="flex items-center gap-4">
                      <div className={`w-3 h-3 rounded-full ${service.color}`} />
                      <div className="flex-1">
                        <div className="flex items-center justify-between mb-1">
                          <span className="font-medium">{service.name}</span>
                          <MoneyDisplay amount={service.amount} className="font-medium" />
                        </div>
                        <div className="h-2 bg-muted rounded-full overflow-hidden">
                          <div
                            className={`h-full ${service.color} rounded-full`}
                            style={{ width: `${service.percentage * 2.5}%` }}
                          />
                        </div>
                      </div>
                      <span className="w-12 text-sm text-muted-foreground text-right">{service.percentage}%</span>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>

        {/* Quick Reports */}
        <div className="grid gap-4 md:grid-cols-3">
          <Card className="cursor-pointer hover:border-emerald-500 transition-colors">
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-lg">
                <BarChart3 className="h-5 w-5" />
                Reporte 606
              </CardTitle>
              <CardDescription>Compras de bienes y servicios</CardDescription>
            </CardHeader>
            <CardContent>
              <Button variant="outline" className="w-full bg-transparent">
                <Download className="mr-2 h-4 w-4" />
                Generar
              </Button>
            </CardContent>
          </Card>

          <Card className="cursor-pointer hover:border-emerald-500 transition-colors">
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-lg">
                <BarChart3 className="h-5 w-5" />
                Reporte 607
              </CardTitle>
              <CardDescription>Ventas de bienes y servicios</CardDescription>
            </CardHeader>
            <CardContent>
              <Button variant="outline" className="w-full bg-transparent">
                <Download className="mr-2 h-4 w-4" />
                Generar
              </Button>
            </CardContent>
          </Card>

          <Card className="cursor-pointer hover:border-emerald-500 transition-colors">
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-lg">
                <Users className="h-5 w-5" />
                Cartera de Clientes
              </CardTitle>
              <CardDescription>Listado completo de clientes activos</CardDescription>
            </CardHeader>
            <CardContent>
              <Button variant="outline" className="w-full bg-transparent">
                <Download className="mr-2 h-4 w-4" />
                Generar
              </Button>
            </CardContent>
          </Card>
        </div>
      </div>
    </PermissionGate>
  )
}

// ===== FILE: app\(dashboard)\business\services\loading.tsx =====

export default function Loading() {
  return null
}

// ===== FILE: app\(dashboard)\business\services\page.tsx =====

"use client"

// ===== Services Catalog Page =====

import { useState, useEffect, useCallback } from "react"
import { Briefcase, Plus, RefreshCw, Search } from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Checkbox } from "@/components/ui/checkbox"
import { Label } from "@/components/ui/label"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { EmptyState } from "@/components/common/empty-state"
import { ConfirmDialog } from "@/components/common/confirm-dialog"
import { PermissionGate } from "@/components/common/permission-gate"
import { ServiceTable } from "@/components/business/services/service-table"
import { CreateServiceDialog } from "@/components/business/services/create-service-dialog"
import { SetPriceDialog } from "@/components/business/pricing/set-price-dialog"
import { PriceHistorySheet } from "@/components/business/pricing/price-history-sheet"
import { getServices, deleteService } from "@/lib/api/business/services"
import type { ServiceCatalog } from "@/lib/types/business"

export default function ServicesPage() {
  const [services, setServices] = useState<ServiceCatalog[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState("")
  const [showInactive, setShowInactive] = useState(false)

  // Dialog states
  const [isCreateOpen, setIsCreateOpen] = useState(false)
  const [pricingService, setPricingService] = useState<ServiceCatalog | null>(null)
  const [historyService, setHistoryService] = useState<ServiceCatalog | null>(null)
  const [deactivatingService, setDeactivatingService] = useState<ServiceCatalog | null>(null)
  const [isDeactivating, setIsDeactivating] = useState(false)

  const loadServices = useCallback(async () => {
    setIsLoading(true)
    try {
      const data = await getServices(!showInactive)
      setServices(data)
    } catch {
      toast.error("Error al cargar servicios")
    } finally {
      setIsLoading(false)
    }
  }, [showInactive])

  useEffect(() => {
    loadServices()
  }, [loadServices])

  // Filter services by search term
  const filteredServices = services.filter(
    (service) =>
      service.code.toLowerCase().includes(searchTerm.toLowerCase()) ||
      service.name.toLowerCase().includes(searchTerm.toLowerCase()),
  )

  async function handleDeactivate() {
    if (!deactivatingService) return

    setIsDeactivating(true)
    try {
      const response = await deleteService(deactivatingService.id)
      if (response.success) {
        toast.success("Servicio desactivado")
        loadServices()
      } else {
        toast.error(response.message || "Error al desactivar servicio")
      }
    } catch {
      toast.error("Error al desactivar servicio")
    } finally {
      setIsDeactivating(false)
      setDeactivatingService(null)
    }
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Catálogo de Servicios</h1>
          <p className="text-muted-foreground">Gestione los servicios ofrecidos por ASEPRE</p>
        </div>
        <div className="flex items-center gap-2">
          <Button variant="outline" size="icon" onClick={loadServices}>
            <RefreshCw className={`h-4 w-4 ${isLoading ? "animate-spin" : ""}`} />
          </Button>
          <PermissionGate permissions={["BUSINESS_SERVICE_CREATE"]}>
            <Button onClick={() => setIsCreateOpen(true)}>
              <Plus className="mr-2 h-4 w-4" />
              Nuevo Servicio
            </Button>
          </PermissionGate>
        </div>
      </div>

      {/* Filters */}
      <div className="flex flex-col gap-4 sm:flex-row sm:items-center">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
          <Input
            placeholder="Buscar por código o nombre..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="pl-9"
          />
        </div>
        <div className="flex items-center space-x-2">
          <Checkbox id="showInactive" checked={showInactive} onCheckedChange={(v) => setShowInactive(v as boolean)} />
          <Label htmlFor="showInactive" className="text-sm text-muted-foreground cursor-pointer">
            Mostrar inactivos
          </Label>
        </div>
      </div>

      {/* Content */}
      {isLoading ? (
        <div className="flex items-center justify-center py-12">
          <LoadingSpinner size="lg" />
        </div>
      ) : filteredServices.length === 0 ? (
        <EmptyState
          icon={Briefcase}
          title="No hay servicios"
          description={searchTerm ? "No se encontraron servicios con ese criterio" : "Comience agregando un servicio"}
          action={
            !searchTerm && (
              <PermissionGate permissions={["BUSINESS_SERVICE_CREATE"]}>
                <Button onClick={() => setIsCreateOpen(true)}>
                  <Plus className="mr-2 h-4 w-4" />
                  Nuevo Servicio
                </Button>
              </PermissionGate>
            )
          }
        />
      ) : (
        <ServiceTable
          services={filteredServices}
          onEdit={() => {}}
          onSetPrice={(service) => setPricingService(service)}
          onViewHistory={(service) => setHistoryService(service)}
          onDeactivate={(service) => setDeactivatingService(service)}
        />
      )}

      {/* Dialogs */}
      <CreateServiceDialog open={isCreateOpen} onOpenChange={setIsCreateOpen} onSuccess={loadServices} />

      <SetPriceDialog
        service={pricingService}
        open={!!pricingService}
        onOpenChange={(open) => !open && setPricingService(null)}
        onSuccess={loadServices}
      />

      <PriceHistorySheet
        service={historyService}
        open={!!historyService}
        onOpenChange={(open) => !open && setHistoryService(null)}
      />

      <ConfirmDialog
        open={!!deactivatingService}
        onOpenChange={(open) => !open && setDeactivatingService(null)}
        title="Desactivar Servicio"
        description={`¿Está seguro de desactivar "${deactivatingService?.name}"? El servicio no podrá ser seleccionado para nuevos contratos.`}
        confirmText="Desactivar"
        variant="destructive"
        onConfirm={handleDeactivate}
        isLoading={isDeactivating}
      />
    </div>
  )
}

// ===== FILE: app\(dashboard)\business\settings\page.tsx =====

"use client"

// ===== Business Settings Page =====

import { useState, useEffect, useCallback } from "react"
import { RefreshCw, Save, AlertTriangle } from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { ProtectedRoute } from "@/components/common/protected-route"
import { Loader2 } from "lucide-react"

interface BusinessSettings {
  // Tax settings
  itbisRate: number
  itbisLastUpdated?: string
  // NCF settings
  ncfSeries: string
  ncfTypeCode: string
  ncfCurrentSequence: number
  ncfMaxSequence: number
  // Company info
  companyName: string
  companyRnc: string
  companyAddress?: string
  companyPhone?: string
  companyEmail?: string
}

// Mock data - replace with actual API calls
const mockSettings: BusinessSettings = {
  itbisRate: 18,
  itbisLastUpdated: "2024-01-01",
  ncfSeries: "B",
  ncfTypeCode: "01",
  ncfCurrentSequence: 89,
  ncfMaxSequence: 99999999,
  companyName: "ASEPRE SRL",
  companyRnc: "123456789",
  companyAddress: "Santo Domingo, República Dominicana",
  companyPhone: "809-555-1234",
  companyEmail: "info@asepre.com.do",
}

export default function BusinessSettingsPage() {
  const [settings, setSettings] = useState<BusinessSettings | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [isSaving, setIsSaving] = useState(false)
  const [activeTab, setActiveTab] = useState("tax")

  // Form state
  const [itbisRate, setItbisRate] = useState("")
  const [companyName, setCompanyName] = useState("")
  const [companyRnc, setCompanyRnc] = useState("")
  const [companyAddress, setCompanyAddress] = useState("")
  const [companyPhone, setCompanyPhone] = useState("")
  const [companyEmail, setCompanyEmail] = useState("")

  const loadSettings = useCallback(async () => {
    setIsLoading(true)
    try {
      // TODO: Replace with actual API call
      // const data = await getBusinessSettings()
      await new Promise((resolve) => setTimeout(resolve, 500))
      const data = mockSettings

      setSettings(data)
      setItbisRate(data.itbisRate.toString())
      setCompanyName(data.companyName)
      setCompanyRnc(data.companyRnc)
      setCompanyAddress(data.companyAddress || "")
      setCompanyPhone(data.companyPhone || "")
      setCompanyEmail(data.companyEmail || "")
    } catch {
      toast.error("Error al cargar configuración")
    } finally {
      setIsLoading(false)
    }
  }, [])

  useEffect(() => {
    loadSettings()
  }, [loadSettings])

  async function handleSaveTax() {
    const rate = Number.parseFloat(itbisRate)
    if (isNaN(rate) || rate < 0 || rate > 100) {
      toast.error("Tasa de ITBIS inválida")
      return
    }

    setIsSaving(true)
    try {
      // TODO: Replace with actual API call
      // await updateBusinessSettings({ itbisRate: rate })
      await new Promise((resolve) => setTimeout(resolve, 500))
      toast.success("Configuración de impuestos actualizada")
      loadSettings()
    } catch {
      toast.error("Error al guardar configuración")
    } finally {
      setIsSaving(false)
    }
  }

  async function handleSaveCompany() {
    if (!companyName || !companyRnc) {
      toast.error("Nombre y RNC de la empresa son requeridos")
      return
    }

    setIsSaving(true)
    try {
      // TODO: Replace with actual API call
      await new Promise((resolve) => setTimeout(resolve, 500))
      toast.success("Información de empresa actualizada")
      loadSettings()
    } catch {
      toast.error("Error al guardar configuración")
    } finally {
      setIsSaving(false)
    }
  }

  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-12">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <ProtectedRoute permissions={["BUSINESS_CONFIG_MANAGE"]}>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold tracking-tight">Configuración del Negocio</h1>
            <p className="text-muted-foreground">Configure parámetros del sistema de facturación</p>
          </div>
          <Button variant="outline" size="icon" onClick={loadSettings}>
            <RefreshCw className={`h-4 w-4 ${isLoading ? "animate-spin" : ""}`} />
          </Button>
        </div>

        {/* Tabs */}
        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <TabsList className="grid w-full grid-cols-3 lg:w-[400px]">
            <TabsTrigger value="tax">Impuestos</TabsTrigger>
            <TabsTrigger value="fiscal">Números Fiscales</TabsTrigger>
            <TabsTrigger value="company">Empresa</TabsTrigger>
          </TabsList>

          {/* Tax Settings Tab */}
          <TabsContent value="tax" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Configuración de ITBIS</CardTitle>
                <CardDescription>Tasa de impuesto aplicada a servicios gravables</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid gap-4 sm:grid-cols-2">
                  <div className="space-y-2">
                    <Label htmlFor="itbisRate">Tasa de ITBIS (%)</Label>
                    <div className="flex items-center gap-2">
                      <Input
                        id="itbisRate"
                        type="number"
                        min="0"
                        max="100"
                        step="0.01"
                        value={itbisRate}
                        onChange={(e) => setItbisRate(e.target.value)}
                        className="w-24"
                      />
                      <span className="text-muted-foreground">%</span>
                    </div>
                    {settings?.itbisLastUpdated && (
                      <p className="text-sm text-muted-foreground">Última actualización: {settings.itbisLastUpdated}</p>
                    )}
                  </div>
                </div>
                <Button onClick={handleSaveTax} disabled={isSaving}>
                  {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                  <Save className="mr-2 h-4 w-4" />
                  Actualizar Tasa
                </Button>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Fiscal Numbers Tab */}
          <TabsContent value="fiscal" className="space-y-4">
            <Alert variant="default" className="border-amber-500/50 bg-amber-500/10">
              <AlertTriangle className="h-4 w-4 text-amber-500" />
              <AlertTitle>Importante</AlertTitle>
              <AlertDescription>
                Los cambios en la configuración de NCF requieren autorización de la DGII. Modifique estos valores solo
                si tiene la documentación correspondiente.
              </AlertDescription>
            </Alert>

            <Card>
              <CardHeader>
                <CardTitle>Configuración de NCF</CardTitle>
                <CardDescription>Números de Comprobante Fiscal para facturación</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid gap-4 sm:grid-cols-3">
                  <div className="space-y-2">
                    <Label>Serie</Label>
                    <Input value={settings?.ncfSeries || ""} disabled className="font-mono" />
                  </div>
                  <div className="space-y-2">
                    <Label>Código de Tipo</Label>
                    <Input value={settings?.ncfTypeCode || ""} disabled className="font-mono" />
                    <p className="text-xs text-muted-foreground">01 = Crédito Fiscal</p>
                  </div>
                  <div className="space-y-2">
                    <Label>Secuencia Actual</Label>
                    <Input value={settings?.ncfCurrentSequence?.toString() || ""} disabled className="font-mono" />
                  </div>
                </div>

                <div className="rounded-lg border p-4 bg-muted/50">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="font-medium">Próximo NCF</p>
                      <p className="text-2xl font-mono font-bold text-primary">
                        {settings?.ncfSeries}
                        {settings?.ncfTypeCode}
                        {String((settings?.ncfCurrentSequence || 0) + 1).padStart(8, "0")}
                      </p>
                    </div>
                    <div className="text-right">
                      <p className="text-sm text-muted-foreground">Disponibles</p>
                      <p className="text-lg font-medium">
                        {((settings?.ncfMaxSequence || 0) - (settings?.ncfCurrentSequence || 0)).toLocaleString()}
                      </p>
                    </div>
                  </div>
                </div>

                <p className="text-sm text-muted-foreground">
                  Para modificar la secuencia de NCF, contacte al administrador del sistema con la documentación de la
                  DGII.
                </p>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Company Info Tab */}
          <TabsContent value="company" className="space-y-4">
            <Card>
              <CardHeader>
                <CardTitle>Información de la Empresa</CardTitle>
                <CardDescription>Datos que aparecen en facturas y recibos</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid gap-4 sm:grid-cols-2">
                  <div className="space-y-2">
                    <Label htmlFor="companyName">Nombre de la Empresa *</Label>
                    <Input
                      id="companyName"
                      value={companyName}
                      onChange={(e) => setCompanyName(e.target.value)}
                      placeholder="ASEPRE SRL"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="companyRnc">RNC de la Empresa *</Label>
                    <Input
                      id="companyRnc"
                      value={companyRnc}
                      onChange={(e) => setCompanyRnc(e.target.value)}
                      placeholder="123456789"
                      className="font-mono"
                    />
                  </div>
                </div>
                <div className="space-y-2">
                  <Label htmlFor="companyAddress">Dirección</Label>
                  <Input
                    id="companyAddress"
                    value={companyAddress}
                    onChange={(e) => setCompanyAddress(e.target.value)}
                    placeholder="Calle Principal #123, Santo Domingo"
                  />
                </div>
                <div className="grid gap-4 sm:grid-cols-2">
                  <div className="space-y-2">
                    <Label htmlFor="companyPhone">Teléfono</Label>
                    <Input
                      id="companyPhone"
                      value={companyPhone}
                      onChange={(e) => setCompanyPhone(e.target.value)}
                      placeholder="809-555-1234"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="companyEmail">Email</Label>
                    <Input
                      id="companyEmail"
                      type="email"
                      value={companyEmail}
                      onChange={(e) => setCompanyEmail(e.target.value)}
                      placeholder="info@empresa.com.do"
                    />
                  </div>
                </div>
                <Button onClick={handleSaveCompany} disabled={isSaving}>
                  {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                  <Save className="mr-2 h-4 w-4" />
                  Guardar Información
                </Button>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    </ProtectedRoute>
  )
}

// ===== FILE: app\(dashboard)\dashboard\page.tsx =====

"use client"

import { useEffect, useState, useCallback } from "react"
import { Users, Shield, UserCheck, Activity, Loader2, AlertCircle, RefreshCw } from "lucide-react"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { StatsCard } from "@/components/dashboard/stats-card"
import { ActivityItem } from "@/components/dashboard/activity-item"
import { useAuthStore } from "@/lib/store/auth-store"
import { RoleBadge } from "@/components/common/role-badge"
import { PermissionGate } from "@/components/common/permission-gate"
import { Button } from "@/components/ui/button"
import Link from "next/link"
import {
  getDashboardSummary,
  type DashboardStats,
  type ActivityItem as ActivityItemType,
} from "@/lib/api/dashboard"

export default function DashboardPage() {
  const user = useAuthStore((state) => state.user)
  const [stats, setStats] = useState<DashboardStats | null>(null)
  const [activity, setActivity] = useState<ActivityItemType[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [refreshing, setRefreshing] = useState(false)

  const fetchDashboardData = useCallback(async (isRefresh: boolean = false) => {
    try {
      if (isRefresh) {
        setRefreshing(true)
      } else {
        setLoading(true)
      }
      setError(null)

      const { stats, recentActivity } = await getDashboardSummary(10)
      setStats(stats)
      setActivity(recentActivity)
    } catch (err) {
      console.error("Failed to fetch dashboard data:", err)
      setError("Failed to load dashboard data. Please try again.")
    } finally {
      setLoading(false)
      setRefreshing(false)
    }
  }, [])

  useEffect(() => {
    fetchDashboardData()
  }, [fetchDashboardData])

  // Auto-refresh every 5 minutes
  useEffect(() => {
    const interval = setInterval(() => {
      fetchDashboardData(true)
    }, 5 * 60 * 1000)

    return () => clearInterval(interval)
  }, [fetchDashboardData])

  if (loading) {
    return (
      <div className="flex h-[50vh] items-center justify-center">
        <div className="flex flex-col items-center gap-4">
          <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
          <p className="text-muted-foreground">Loading dashboard...</p>
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="flex h-[50vh] items-center justify-center">
        <div className="flex flex-col items-center gap-4">
          <AlertCircle className="h-8 w-8 text-destructive" />
          <p className="text-destructive">{error}</p>
          <Button onClick={() => fetchDashboardData()} variant="outline">
            Try Again
          </Button>
        </div>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Welcome Section */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Welcome back, {user?.firstName}!</h1>
          <p className="text-muted-foreground">{"Here's what's happening with your RBAC system today."}</p>
        </div>
        <div className="flex items-center gap-3">
          <Button
            variant="ghost"
            size="icon"
            onClick={() => fetchDashboardData(true)}
            disabled={refreshing}
            title="Refresh dashboard"
          >
            <RefreshCw className={`h-4 w-4 ${refreshing ? "animate-spin" : ""}`} />
          </Button>
          <div className="flex gap-2">
            {user?.roles.map((role) => (
              <RoleBadge key={role} role={role} />
            ))}
          </div>
        </div>
      </div>

      {/* Stats Grid */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <StatsCard
          title="Total Users"
          value={stats?.totalUsers?.toLocaleString() ?? "0"}
          icon={Users}
          trend={
            stats?.usersTrend
              ? {
                  value: stats.usersTrend.value,
                  isPositive: stats.usersTrend.isPositive,
                }
              : undefined
          }
          description="from last month"
        />
        <StatsCard
          title="Active Users"
          value={stats?.activeUsers?.toLocaleString() ?? "0"}
          icon={UserCheck}
          trend={
            stats?.activeUsersTrend
              ? {
                  value: stats.activeUsersTrend.value,
                  isPositive: stats.activeUsersTrend.isPositive,
                }
              : undefined
          }
          description="currently online"
        />
        <StatsCard
          title="Total Roles"
          value={stats?.totalRoles?.toString() ?? "0"}
          icon={Shield}
          description="system roles configured"
        />
        <StatsCard
          title="Pending Verifications"
          value={stats?.pendingVerifications?.toString() ?? "0"}
          icon={Activity}
          trend={
            stats?.verificationsTrend && stats.pendingVerifications > 0
              ? {
                  value: stats.verificationsTrend.value,
                  isPositive: false,
                }
              : undefined
          }
          description="awaiting email verification"
        />
      </div>

      {/* Main Content Grid */}
      <div className="grid gap-6 lg:grid-cols-7">
        {/* Quick Actions */}
        <Card className="lg:col-span-3">
          <CardHeader>
            <CardTitle>Quick Actions</CardTitle>
            <CardDescription>Common tasks and shortcuts</CardDescription>
          </CardHeader>
          <CardContent className="grid gap-3">
            <PermissionGate permissions={["AUTH_USER_CREATE", "CREATE_USER"]}>
              <Link href="/users?action=create">
                <Button variant="outline" className="w-full justify-start bg-transparent">
                  <Users className="mr-2 h-4 w-4" />
                  Create New User
                </Button>
              </Link>
            </PermissionGate>
            <PermissionGate permissions={["AUTH_ROLE_CREATE"]} roles={["SUPERADMIN"]}>
              <Link href="/roles?action=create">
                <Button variant="outline" className="w-full justify-start bg-transparent">
                  <Shield className="mr-2 h-4 w-4" />
                  Create New Role
                </Button>
              </Link>
            </PermissionGate>
            <Link href="/users">
              <Button variant="outline" className="w-full justify-start bg-transparent">
                <UserCheck className="mr-2 h-4 w-4" />
                Manage Users
              </Button>
            </Link>
            <Link href="/profile">
              <Button variant="outline" className="w-full justify-start bg-transparent">
                <Activity className="mr-2 h-4 w-4" />
                View My Profile
              </Button>
            </Link>
          </CardContent>
        </Card>

        {/* Recent Activity */}
        <Card className="lg:col-span-4">
          <CardHeader>
            <CardTitle>Recent Activity</CardTitle>
            <CardDescription>Latest actions in the system</CardDescription>
          </CardHeader>
          <CardContent>
            {activity.length > 0 ? (
              <div className="divide-y divide-border">
                {activity.map((item) => (
                  <ActivityItem
                    key={item.id}
                    user={item.user}
                    action={item.action}
                    target={item.target}
                    role={item.role}
                    timestamp={item.timestamp}
                  />
                ))}
              </div>
            ) : (
              <div className="flex h-32 items-center justify-center text-muted-foreground">
                No recent activity
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      {/* Your Permissions */}
      <Card>
        <CardHeader>
          <CardTitle>Your Permissions</CardTitle>
          <CardDescription>Current permissions assigned to your account</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="flex flex-wrap gap-2">
            {user?.permissions.length ? (
              user.permissions.map((permission) => (
                <span
                  key={permission}
                  className="inline-flex items-center rounded-md bg-secondary px-2.5 py-0.5 text-xs font-medium text-secondary-foreground"
                >
                  {permission}
                </span>
              ))
            ) : (
              <p className="text-sm text-muted-foreground">
                No specific permissions assigned. Access is determined by your roles.
              </p>
            )}
          </div>
        </CardContent>
      </Card>
    </div>
  )
}

// ===== FILE: app\(dashboard)\profile\page.tsx =====

"use client"

import { useState } from "react"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import { toast } from "sonner"
import { Eye, EyeOff, User, Mail, Shield, Key, Calendar, Clock, MailCheck } from "lucide-react"
import { z } from "zod"

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Separator } from "@/components/ui/separator"
import { Avatar, AvatarFallback } from "@/components/ui/avatar"
import { Badge } from "@/components/ui/badge"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { RoleBadge } from "@/components/common/role-badge"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { useAuthStore } from "@/lib/store/auth-store"
import { updateUserSchema, type UpdateUserFormData } from "@/lib/validations/users"
import { getInitials, formatDateTime, formatRelativeTime } from "@/lib/utils/formatters"
import { updateUser } from "@/lib/api/users"
import { changePassword } from "@/lib/api/password"

// Password change schema with current password
const changePasswordSchema = z
  .object({
    currentPassword: z.string().min(1, "Current password is required"),
    newPassword: z
      .string()
      .min(8, "Password must be at least 8 characters")
      .max(100, "Password must not exceed 100 characters")
      .regex(
        /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/,
        "Password must contain at least one uppercase letter, one lowercase letter, and one number"
      ),
    confirmPassword: z.string().min(1, "Please confirm your password"),
  })
  .refine((data) => data.newPassword === data.confirmPassword, {
    message: "Passwords don't match",
    path: ["confirmPassword"],
  })
  .refine((data) => data.currentPassword !== data.newPassword, {
    message: "New password must be different from current password",
    path: ["newPassword"],
  })

type ChangePasswordFormData = z.infer<typeof changePasswordSchema>

export default function ProfilePage() {
  const user = useAuthStore((state) => state.user)
  const refreshAuth = useAuthStore((state) => state.refreshAuth)

  const [isUpdatingProfile, setIsUpdatingProfile] = useState(false)
  const [isUpdatingPassword, setIsUpdatingPassword] = useState(false)
  const [showCurrentPassword, setShowCurrentPassword] = useState(false)
  const [showNewPassword, setShowNewPassword] = useState(false)
  const [showConfirmPassword, setShowConfirmPassword] = useState(false)

  const profileForm = useForm<UpdateUserFormData>({
    resolver: zodResolver(updateUserSchema),
    defaultValues: {
      firstName: user?.firstName || "",
      lastName: user?.lastName || "",
      userName: user?.userName || "",
    },
  })

  const passwordForm = useForm<ChangePasswordFormData>({
    resolver: zodResolver(changePasswordSchema),
    defaultValues: {
      currentPassword: "",
      newPassword: "",
      confirmPassword: "",
    },
  })

  const handleProfileUpdate = async (data: UpdateUserFormData) => {
    if (!user) return

    setIsUpdatingProfile(true)
    try {
      const response = await updateUser(user.id, data)
      if (response.success) {
        toast.success("Profile updated successfully")
        await refreshAuth()
      } else {
        toast.error(response.message)
      }
    } catch {
      toast.error("Failed to update profile")
    } finally {
      setIsUpdatingProfile(false)
    }
  }

  const handlePasswordUpdate = async (data: ChangePasswordFormData) => {
    setIsUpdatingPassword(true)
    try {
      const response = await changePassword(data.currentPassword, data.newPassword)
      
      if (response.success) {
        toast.success("Password updated successfully")
        passwordForm.reset()
        // Reset visibility states
        setShowCurrentPassword(false)
        setShowNewPassword(false)
        setShowConfirmPassword(false)
      } else {
        toast.error(response.message || "Failed to update password")
      }
    } catch (error) {
      const message = error instanceof Error ? error.message : "Failed to update password"
      toast.error(message)
    } finally {
      setIsUpdatingPassword(false)
    }
  }

  if (!user) {
    return (
      <div className="flex items-center justify-center py-12">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-3xl font-bold tracking-tight">Profile</h1>
        <p className="text-muted-foreground">Manage your account settings and preferences</p>
      </div>

      <div className="grid gap-6 lg:grid-cols-3">
        {/* Profile Overview Card */}
        <Card className="lg:col-span-1">
          <CardHeader className="text-center">
            <Avatar className="h-24 w-24 mx-auto">
              <AvatarFallback className="bg-primary/10 text-primary text-2xl">
                {getInitials(user.firstName, user.lastName)}
              </AvatarFallback>
            </Avatar>
            <CardTitle className="mt-4">
              {user.firstName} {user.lastName}
            </CardTitle>
            <CardDescription>@{user.userName}</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="flex items-center gap-2 text-sm">
              <Mail className="h-4 w-4 text-muted-foreground" />
              <span className="truncate">{user.email}</span>
              {user.emailVerified && <MailCheck className="h-4 w-4 text-emerald-500" />}
            </div>

            <Separator />

            <div className="space-y-2">
              <p className="text-sm font-medium text-muted-foreground">Roles</p>
              <div className="flex flex-wrap gap-2">
                {user.roles.map((role) => (
                  <RoleBadge key={role} role={role} />
                ))}
              </div>
            </div>

            <Separator />

            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p className="text-muted-foreground flex items-center gap-1">
                  <Calendar className="h-3 w-3" />
                  Joined
                </p>
                <p className="font-medium">{formatDateTime(user.createdAt).split(" at")[0]}</p>
              </div>
              <div>
                <p className="text-muted-foreground flex items-center gap-1">
                  <Clock className="h-3 w-3" />
                  Last Login
                </p>
                <p className="font-medium">{user.lastLoginAt ? formatRelativeTime(user.lastLoginAt) : "Never"}</p>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Settings Tabs */}
        <Card className="lg:col-span-2">
          <CardHeader>
            <CardTitle>Account Settings</CardTitle>
            <CardDescription>Update your personal information and security settings</CardDescription>
          </CardHeader>
          <CardContent>
            <Tabs defaultValue="profile" className="w-full">
              <TabsList className="grid w-full grid-cols-3">
                <TabsTrigger value="profile" className="gap-2">
                  <User className="h-4 w-4" />
                  Profile
                </TabsTrigger>
                <TabsTrigger value="security" className="gap-2">
                  <Key className="h-4 w-4" />
                  Security
                </TabsTrigger>
                <TabsTrigger value="permissions" className="gap-2">
                  <Shield className="h-4 w-4" />
                  Permissions
                </TabsTrigger>
              </TabsList>

              {/* Profile Tab */}
              <TabsContent value="profile" className="space-y-4 mt-6">
                <form onSubmit={profileForm.handleSubmit(handleProfileUpdate)} className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-2">
                      <Label htmlFor="firstName">First Name</Label>
                      <Input id="firstName" {...profileForm.register("firstName")} />
                      {profileForm.formState.errors.firstName && (
                        <p className="text-sm text-destructive">{profileForm.formState.errors.firstName.message}</p>
                      )}
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="lastName">Last Name</Label>
                      <Input id="lastName" {...profileForm.register("lastName")} />
                      {profileForm.formState.errors.lastName && (
                        <p className="text-sm text-destructive">{profileForm.formState.errors.lastName.message}</p>
                      )}
                    </div>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="userName">Username</Label>
                    <Input id="userName" {...profileForm.register("userName")} />
                    {profileForm.formState.errors.userName && (
                      <p className="text-sm text-destructive">{profileForm.formState.errors.userName.message}</p>
                    )}
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="email">Email</Label>
                    <Input id="email" value={user.email} disabled className="bg-muted" />
                    <p className="text-xs text-muted-foreground">Contact support to change your email address</p>
                  </div>

                  <Button type="submit" disabled={isUpdatingProfile}>
                    {isUpdatingProfile && <LoadingSpinner size="sm" className="mr-2" />}
                    Save Changes
                  </Button>
                </form>
              </TabsContent>

              {/* Security Tab */}
              <TabsContent value="security" className="space-y-4 mt-6">
                <form onSubmit={passwordForm.handleSubmit(handlePasswordUpdate)} className="space-y-4">
                  <div className="space-y-2">
                    <Label htmlFor="currentPassword">Current Password</Label>
                    <div className="relative">
                      <Input
                        id="currentPassword"
                        type={showCurrentPassword ? "text" : "password"}
                        placeholder="Enter current password"
                        {...passwordForm.register("currentPassword")}
                      />
                      <Button
                        type="button"
                        variant="ghost"
                        size="icon"
                        className="absolute right-0 top-0 h-full px-3 hover:bg-transparent"
                        onClick={() => setShowCurrentPassword(!showCurrentPassword)}
                      >
                        {showCurrentPassword ? (
                          <EyeOff className="h-4 w-4 text-muted-foreground" />
                        ) : (
                          <Eye className="h-4 w-4 text-muted-foreground" />
                        )}
                      </Button>
                    </div>
                    {passwordForm.formState.errors.currentPassword && (
                      <p className="text-sm text-destructive">
                        {passwordForm.formState.errors.currentPassword.message}
                      </p>
                    )}
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="newPassword">New Password</Label>
                    <div className="relative">
                      <Input
                        id="newPassword"
                        type={showNewPassword ? "text" : "password"}
                        placeholder="Enter new password"
                        {...passwordForm.register("newPassword")}
                      />
                      <Button
                        type="button"
                        variant="ghost"
                        size="icon"
                        className="absolute right-0 top-0 h-full px-3 hover:bg-transparent"
                        onClick={() => setShowNewPassword(!showNewPassword)}
                      >
                        {showNewPassword ? (
                          <EyeOff className="h-4 w-4 text-muted-foreground" />
                        ) : (
                          <Eye className="h-4 w-4 text-muted-foreground" />
                        )}
                      </Button>
                    </div>
                    {passwordForm.formState.errors.newPassword && (
                      <p className="text-sm text-destructive">{passwordForm.formState.errors.newPassword.message}</p>
                    )}
                    <p className="text-xs text-muted-foreground">
                      Must be at least 8 characters with uppercase, lowercase, and number
                    </p>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="confirmPassword">Confirm New Password</Label>
                    <div className="relative">
                      <Input
                        id="confirmPassword"
                        type={showConfirmPassword ? "text" : "password"}
                        placeholder="Confirm new password"
                        {...passwordForm.register("confirmPassword")}
                      />
                      <Button
                        type="button"
                        variant="ghost"
                        size="icon"
                        className="absolute right-0 top-0 h-full px-3 hover:bg-transparent"
                        onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                      >
                        {showConfirmPassword ? (
                          <EyeOff className="h-4 w-4 text-muted-foreground" />
                        ) : (
                          <Eye className="h-4 w-4 text-muted-foreground" />
                        )}
                      </Button>
                    </div>
                    {passwordForm.formState.errors.confirmPassword && (
                      <p className="text-sm text-destructive">
                        {passwordForm.formState.errors.confirmPassword.message}
                      </p>
                    )}
                  </div>

                  <Button type="submit" disabled={isUpdatingPassword}>
                    {isUpdatingPassword && <LoadingSpinner size="sm" className="mr-2" />}
                    Update Password
                  </Button>
                </form>
              </TabsContent>

              {/* Permissions Tab */}
              <TabsContent value="permissions" className="space-y-4 mt-6">
                <div className="space-y-4">
                  <div>
                    <h3 className="text-sm font-medium mb-2">Your Roles</h3>
                    <div className="flex flex-wrap gap-2">
                      {user.roles.map((role) => (
                        <RoleBadge key={role} role={role} />
                      ))}
                    </div>
                  </div>

                  <Separator />

                  <div>
                    <h3 className="text-sm font-medium mb-2">Your Permissions ({user.permissions.length})</h3>
                    <div className="flex flex-wrap gap-2 max-h-64 overflow-y-auto">
                      {user.permissions.length > 0 ? (
                        user.permissions.map((permission) => (
                          <Badge key={permission} variant="secondary" className="text-xs">
                            {permission}
                          </Badge>
                        ))
                      ) : (
                        <p className="text-sm text-muted-foreground">Permissions are inherited from your roles.</p>
                      )}
                    </div>
                  </div>
                </div>
              </TabsContent>
            </Tabs>
          </CardContent>
        </Card>
      </div>
    </div>
  )
}

// ===== FILE: app\(dashboard)\roles\page.tsx =====

"use client"

import { useState, useEffect, useCallback } from "react"
import { Shield, Plus, RefreshCw } from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { RoleCard } from "@/components/roles/role-card"
import { CreateRoleDialog } from "@/components/roles/create-role-dialog"
import { EditRoleDialog } from "@/components/roles/edit-role-dialog"
import { ConfirmDialog } from "@/components/common/confirm-dialog"
import { EmptyState } from "@/components/common/empty-state"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { PermissionGate } from "@/components/common/permission-gate"
import type { Role } from "@/types"
import { deleteRole, getRoles } from "@/lib/api/roles"

export default function RolesPage() {
  const [roles, setRoles] = useState<Role[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [selectedRole, setSelectedRole] = useState<Role | null>(null)
  const [isCreateOpen, setIsCreateOpen] = useState(false)
  const [isEditOpen, setIsEditOpen] = useState(false)
  const [isDeleteOpen, setIsDeleteOpen] = useState(false)
  const [isDeleting, setIsDeleting] = useState(false)

  const loadRoles = useCallback(async () => {
    setIsLoading(true)
    try {
      const data = await getRoles()
      setRoles(data)
    } catch {
      toast.error("Failed to load roles")
    } finally {
      setIsLoading(false)
    }
  }, [])

  useEffect(() => {
    loadRoles()
  }, [loadRoles])

  const handleEdit = (role: Role) => {
    setSelectedRole(role)
    setIsEditOpen(true)
  }

  const handleDeleteClick = (role: Role) => {
    setSelectedRole(role)
    setIsDeleteOpen(true)
  }

  const handleViewUsers = (role: Role) => {
    // In production, navigate to users filtered by this role
    toast.info(`Viewing users with role: ${role.name}`)
  }

  const handleDelete = async () => {
    if (!selectedRole) return

    setIsDeleting(true)
    try {
      const response = await deleteRole(selectedRole.id)
      if (response.success) {
        toast.success("Role deleted successfully")
        loadRoles()
      } else {
        toast.error(response.message)
      }
    } catch {
      toast.error("Failed to delete role")
    } finally {
      setIsDeleting(false)
      setIsDeleteOpen(false)
    }
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Roles</h1>
          <p className="text-muted-foreground">Manage roles and their associated permissions</p>
        </div>
        <div className="flex items-center gap-2">
          <Button variant="outline" size="icon" onClick={loadRoles}>
            <RefreshCw className={`h-4 w-4 ${isLoading ? "animate-spin" : ""}`} />
          </Button>
          <PermissionGate permissions={["AUTH_ROLE_CREATE"]} roles={["SUPERADMIN"]}>
            <Button onClick={() => setIsCreateOpen(true)}>
              <Plus className="mr-2 h-4 w-4" />
              Create Role
            </Button>
          </PermissionGate>
        </div>
      </div>

      {/* Content */}
      {isLoading ? (
        <div className="flex items-center justify-center py-12">
          <LoadingSpinner size="lg" />
        </div>
      ) : roles.length === 0 ? (
        <EmptyState
          icon={Shield}
          title="No roles found"
          description="Get started by creating your first role."
          action={
            <PermissionGate permissions={["AUTH_ROLE_CREATE"]} roles={["SUPERADMIN"]}>
              <Button onClick={() => setIsCreateOpen(true)}>
                <Plus className="mr-2 h-4 w-4" />
                Create Role
              </Button>
            </PermissionGate>
          }
        />
      ) : (
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {roles.map((role) => (
            <RoleCard
              key={role.id}
              role={role}
              onEdit={handleEdit}
              onDelete={handleDeleteClick}
              onViewUsers={handleViewUsers}
            />
          ))}
        </div>
      )}

      {/* Dialogs */}
      <CreateRoleDialog open={isCreateOpen} onOpenChange={setIsCreateOpen} onSuccess={loadRoles} />

      <EditRoleDialog role={selectedRole} open={isEditOpen} onOpenChange={setIsEditOpen} onSuccess={loadRoles} />

      <ConfirmDialog
        open={isDeleteOpen}
        onOpenChange={setIsDeleteOpen}
        title="Delete Role"
        description={`Are you sure you want to delete the "${selectedRole?.name}" role? Users with this role will lose associated permissions.`}
        confirmText="Delete"
        variant="destructive"
        onConfirm={handleDelete}
        isLoading={isDeleting}
      />
    </div>
  )
}

// ===== FILE: app\(dashboard)\settings\page.tsx =====

"use client"

import { useState } from "react"
import { toast } from "sonner"
import { Settings, Database, Bell, Shield, Activity, Download, Trash2, RefreshCw } from "lucide-react"

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Switch } from "@/components/ui/switch"
import { Separator } from "@/components/ui/separator"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Badge } from "@/components/ui/badge"
import { ProtectedRoute } from "@/components/layout/protected-route"
import { ConfirmDialog } from "@/components/common/confirm-dialog"
import { LoadingSpinner } from "@/components/common/loading-spinner"

// Mock audit logs for demo
const mockAuditLogs = [
  {
    id: 1,
    action: "USER_LOGIN",
    user: "john.doe@example.com",
    details: "Successful login",
    ip: "192.168.1.1",
    timestamp: new Date(Date.now() - 1000 * 60 * 5).toISOString(),
  },
  {
    id: 2,
    action: "ROLE_ASSIGNED",
    user: "admin@example.com",
    details: "Assigned USER_ADMIN to jane.smith@example.com",
    ip: "192.168.1.100",
    timestamp: new Date(Date.now() - 1000 * 60 * 30).toISOString(),
  },
  {
    id: 3,
    action: "USER_CREATED",
    user: "admin@example.com",
    details: "Created user bob.wilson@example.com",
    ip: "192.168.1.100",
    timestamp: new Date(Date.now() - 1000 * 60 * 60).toISOString(),
  },
  {
    id: 4,
    action: "PASSWORD_RESET",
    user: "alice.johnson@example.com",
    details: "Password reset initiated",
    ip: "10.0.0.50",
    timestamp: new Date(Date.now() - 1000 * 60 * 60 * 2).toISOString(),
  },
  {
    id: 5,
    action: "ROLE_MODIFIED",
    user: "superadmin@example.com",
    details: "Updated permissions for VIEWER role",
    ip: "192.168.1.1",
    timestamp: new Date(Date.now() - 1000 * 60 * 60 * 5).toISOString(),
  },
]

// Mock system metrics
const mockMetrics = {
  totalRequests: 45892,
  avgResponseTime: 127,
  errorRate: 0.3,
  activeConnections: 234,
  cacheHitRate: 94.5,
  dbQueries: 12456,
}

export default function SettingsPage() {
  const [isClearingCache, setIsClearingCache] = useState(false)
  const [isResetOpen, setIsResetOpen] = useState(false)
  const [isResetting, setIsResetting] = useState(false)

  // Settings state
  const [settings, setSettings] = useState({
    emailNotifications: true,
    securityAlerts: true,
    sessionTimeout: "30",
    maxLoginAttempts: "5",
    requireEmailVerification: true,
    enableAuditLogs: true,
  })

  const handleClearCache = async () => {
    setIsClearingCache(true)
    try {
      await new Promise((resolve) => setTimeout(resolve, 1500))
      toast.success("Cache cleared successfully")
    } catch {
      toast.error("Failed to clear cache")
    } finally {
      setIsClearingCache(false)
    }
  }

  const handleSystemReset = async () => {
    setIsResetting(true)
    try {
      await new Promise((resolve) => setTimeout(resolve, 2000))
      toast.success("System reset initiated")
      setIsResetOpen(false)
    } catch {
      toast.error("Failed to reset system")
    } finally {
      setIsResetting(false)
    }
  }

  const handleExportLogs = () => {
    toast.success("Audit logs exported")
  }

  return (
    <ProtectedRoute roles={["SUPERADMIN"]}>
      <div className="space-y-6">
        {/* Header */}
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Settings</h1>
          <p className="text-muted-foreground">System configuration and administration</p>
        </div>

        <Tabs defaultValue="general" className="space-y-6">
          <TabsList>
            <TabsTrigger value="general" className="gap-2">
              <Settings className="h-4 w-4" />
              General
            </TabsTrigger>
            <TabsTrigger value="security" className="gap-2">
              <Shield className="h-4 w-4" />
              Security
            </TabsTrigger>
            <TabsTrigger value="notifications" className="gap-2">
              <Bell className="h-4 w-4" />
              Notifications
            </TabsTrigger>
            <TabsTrigger value="audit" className="gap-2">
              <Activity className="h-4 w-4" />
              Audit Logs
            </TabsTrigger>
            <TabsTrigger value="system" className="gap-2">
              <Database className="h-4 w-4" />
              System
            </TabsTrigger>
          </TabsList>

          {/* General Settings */}
          <TabsContent value="general" className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>General Settings</CardTitle>
                <CardDescription>Configure general application settings</CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="space-y-2">
                  <Label htmlFor="appName">Application Name</Label>
                  <Input id="appName" defaultValue="RBAC Admin" />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="apiUrl">API Base URL</Label>
                  <Input id="apiUrl" defaultValue="http://localhost:8080" />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="timezone">Default Timezone</Label>
                  <Select defaultValue="utc">
                    <SelectTrigger>
                      <SelectValue placeholder="Select timezone" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="utc">UTC</SelectItem>
                      <SelectItem value="est">Eastern Time (EST)</SelectItem>
                      <SelectItem value="pst">Pacific Time (PST)</SelectItem>
                      <SelectItem value="cet">Central European Time (CET)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <Button>Save Changes</Button>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Security Settings */}
          <TabsContent value="security" className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>Security Configuration</CardTitle>
                <CardDescription>Configure authentication and security settings</CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="flex items-center justify-between">
                  <div className="space-y-0.5">
                    <Label>Require Email Verification</Label>
                    <p className="text-sm text-muted-foreground">
                      New users must verify their email before accessing the system
                    </p>
                  </div>
                  <Switch
                    checked={settings.requireEmailVerification}
                    onCheckedChange={(checked) =>
                      setSettings((s) => ({
                        ...s,
                        requireEmailVerification: checked,
                      }))
                    }
                  />
                </div>

                <Separator />

                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="sessionTimeout">Session Timeout (minutes)</Label>
                    <Select
                      value={settings.sessionTimeout}
                      onValueChange={(value) => setSettings((s) => ({ ...s, sessionTimeout: value }))}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="15">15 minutes</SelectItem>
                        <SelectItem value="30">30 minutes</SelectItem>
                        <SelectItem value="60">1 hour</SelectItem>
                        <SelectItem value="120">2 hours</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="maxLoginAttempts">Max Login Attempts</Label>
                    <Select
                      value={settings.maxLoginAttempts}
                      onValueChange={(value) => setSettings((s) => ({ ...s, maxLoginAttempts: value }))}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="3">3 attempts</SelectItem>
                        <SelectItem value="5">5 attempts</SelectItem>
                        <SelectItem value="10">10 attempts</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                <div className="flex items-center justify-between">
                  <div className="space-y-0.5">
                    <Label>Enable Audit Logs</Label>
                    <p className="text-sm text-muted-foreground">Track all user actions and system events</p>
                  </div>
                  <Switch
                    checked={settings.enableAuditLogs}
                    onCheckedChange={(checked) => setSettings((s) => ({ ...s, enableAuditLogs: checked }))}
                  />
                </div>

                <Button>Save Security Settings</Button>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Notifications Settings */}
          <TabsContent value="notifications" className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>Notification Preferences</CardTitle>
                <CardDescription>Configure system notification settings</CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="flex items-center justify-between">
                  <div className="space-y-0.5">
                    <Label>Email Notifications</Label>
                    <p className="text-sm text-muted-foreground">Receive email notifications for important events</p>
                  </div>
                  <Switch
                    checked={settings.emailNotifications}
                    onCheckedChange={(checked) => setSettings((s) => ({ ...s, emailNotifications: checked }))}
                  />
                </div>

                <Separator />

                <div className="flex items-center justify-between">
                  <div className="space-y-0.5">
                    <Label>Security Alerts</Label>
                    <p className="text-sm text-muted-foreground">
                      Get notified about suspicious login attempts and security events
                    </p>
                  </div>
                  <Switch
                    checked={settings.securityAlerts}
                    onCheckedChange={(checked) => setSettings((s) => ({ ...s, securityAlerts: checked }))}
                  />
                </div>

                <Button>Save Notification Settings</Button>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Audit Logs */}
          <TabsContent value="audit" className="space-y-6">
            <Card>
              <CardHeader className="flex flex-row items-center justify-between">
                <div>
                  <CardTitle>Audit Logs</CardTitle>
                  <CardDescription>Track all system activities and user actions</CardDescription>
                </div>
                <Button variant="outline" onClick={handleExportLogs}>
                  <Download className="mr-2 h-4 w-4" />
                  Export Logs
                </Button>
              </CardHeader>
              <CardContent>
                <div className="rounded-lg border border-border">
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="border-b border-border bg-muted/50">
                          <th className="px-4 py-3 text-left text-sm font-medium">Action</th>
                          <th className="px-4 py-3 text-left text-sm font-medium">User</th>
                          <th className="px-4 py-3 text-left text-sm font-medium">Details</th>
                          <th className="px-4 py-3 text-left text-sm font-medium">IP Address</th>
                          <th className="px-4 py-3 text-left text-sm font-medium">Timestamp</th>
                        </tr>
                      </thead>
                      <tbody>
                        {mockAuditLogs.map((log) => (
                          <tr key={log.id} className="border-b border-border last:border-0">
                            <td className="px-4 py-3">
                              <Badge variant="outline" className="text-xs">
                                {log.action}
                              </Badge>
                            </td>
                            <td className="px-4 py-3 text-sm">{log.user}</td>
                            <td className="px-4 py-3 text-sm text-muted-foreground">{log.details}</td>
                            <td className="px-4 py-3 text-sm font-mono">{log.ip}</td>
                            <td className="px-4 py-3 text-sm text-muted-foreground">
                              {new Date(log.timestamp).toLocaleString()}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* System Settings */}
          <TabsContent value="system" className="space-y-6">
            {/* System Metrics */}
            <Card>
              <CardHeader>
                <CardTitle>System Metrics</CardTitle>
                <CardDescription>Real-time system performance data</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                  <div className="rounded-lg border border-border p-4">
                    <p className="text-sm text-muted-foreground">Total Requests</p>
                    <p className="text-2xl font-bold">{mockMetrics.totalRequests.toLocaleString()}</p>
                  </div>
                  <div className="rounded-lg border border-border p-4">
                    <p className="text-sm text-muted-foreground">Avg Response Time</p>
                    <p className="text-2xl font-bold">{mockMetrics.avgResponseTime}ms</p>
                  </div>
                  <div className="rounded-lg border border-border p-4">
                    <p className="text-sm text-muted-foreground">Error Rate</p>
                    <p className="text-2xl font-bold">{mockMetrics.errorRate}%</p>
                  </div>
                  <div className="rounded-lg border border-border p-4">
                    <p className="text-sm text-muted-foreground">Active Connections</p>
                    <p className="text-2xl font-bold">{mockMetrics.activeConnections}</p>
                  </div>
                  <div className="rounded-lg border border-border p-4">
                    <p className="text-sm text-muted-foreground">Cache Hit Rate</p>
                    <p className="text-2xl font-bold">{mockMetrics.cacheHitRate}%</p>
                  </div>
                  <div className="rounded-lg border border-border p-4">
                    <p className="text-sm text-muted-foreground">DB Queries</p>
                    <p className="text-2xl font-bold">{mockMetrics.dbQueries.toLocaleString()}</p>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* System Actions */}
            <Card>
              <CardHeader>
                <CardTitle>System Actions</CardTitle>
                <CardDescription>Perform system maintenance operations</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-center justify-between rounded-lg border border-border p-4">
                  <div>
                    <p className="font-medium">Clear System Cache</p>
                    <p className="text-sm text-muted-foreground">Clear all cached data to refresh the system</p>
                  </div>
                  <Button variant="outline" onClick={handleClearCache} disabled={isClearingCache}>
                    {isClearingCache ? (
                      <LoadingSpinner size="sm" className="mr-2" />
                    ) : (
                      <RefreshCw className="mr-2 h-4 w-4" />
                    )}
                    Clear Cache
                  </Button>
                </div>

                <div className="flex items-center justify-between rounded-lg border border-destructive/20 bg-destructive/5 p-4">
                  <div>
                    <p className="font-medium text-destructive">Reset System to Defaults</p>
                    <p className="text-sm text-muted-foreground">
                      This will reset all settings to their default values
                    </p>
                  </div>
                  <Button variant="destructive" onClick={() => setIsResetOpen(true)}>
                    <Trash2 className="mr-2 h-4 w-4" />
                    Reset System
                  </Button>
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>

        {/* Reset Confirmation Dialog */}
        <ConfirmDialog
          open={isResetOpen}
          onOpenChange={setIsResetOpen}
          title="Reset System Settings"
          description="Are you sure you want to reset all system settings to their default values? This action cannot be undone."
          confirmText="Reset System"
          variant="destructive"
          onConfirm={handleSystemReset}
          isLoading={isResetting}
        />
      </div>
    </ProtectedRoute>
  )
}

// ===== FILE: app\(dashboard)\users\page.tsx =====

// ===== FILE: app/(dashboard)/users/page.tsx =====
// Users page with Deleted Users tab for SUPERADMIN

"use client"

import { useState, useEffect, useCallback } from "react"
import { Users, UserPlus, RefreshCw, Trash2, RotateCcw, AlertTriangle } from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Badge } from "@/components/ui/badge"
import { UsersTable } from "@/components/users/users-table"
import { UserDetailsDialog } from "@/components/users/user-details-dialog"
import { EditUserDialog } from "@/components/users/edit-user-dialog"
import { AssignRolesDialog } from "@/components/users/assign-roles-dialog"
import { ConfirmDialog } from "@/components/common/confirm-dialog"
import { EmptyState } from "@/components/common/empty-state"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { PermissionGate } from "@/components/common/permission-gate"
import { useAuthStore } from "@/lib/store/auth-store"
import type { User } from "@/types"
import { deleteUser, getUsers, getDeletedUsers, restoreUser, permanentlyDeleteUser } from "@/lib/api/users"
import { DeletedUsersTable } from "@/components/users/deleted-users-table"

export default function UsersPage() {
  // Active users state
  const [users, setUsers] = useState<User[]>([])
  const [isLoading, setIsLoading] = useState(true)
  
  // Deleted users state
  const [deletedUsers, setDeletedUsers] = useState<User[]>([])
  const [deletedCount, setDeletedCount] = useState(0)
  const [isLoadingDeleted, setIsLoadingDeleted] = useState(false)
  
  // Selected user for dialogs
  const [selectedUser, setSelectedUser] = useState<User | null>(null)
  
  // Dialog states
  const [isDetailsOpen, setIsDetailsOpen] = useState(false)
  const [isEditOpen, setIsEditOpen] = useState(false)
  const [isAssignRolesOpen, setIsAssignRolesOpen] = useState(false)
  const [isDeleteOpen, setIsDeleteOpen] = useState(false)
  const [isDeleting, setIsDeleting] = useState(false)
  
  // Restore dialog states
  const [userToRestore, setUserToRestore] = useState<User | null>(null)
  const [isRestoring, setIsRestoring] = useState(false)
  
  // Permanent delete dialog states
  const [userToPermanentDelete, setUserToPermanentDelete] = useState<User | null>(null)
  const [isPermanentDeleting, setIsPermanentDeleting] = useState(false)

  // Auth store for checking SUPERADMIN role
  const { hasRole } = useAuthStore()
  const isSuperAdmin = hasRole("SUPERADMIN")

  // Load active users
  const loadUsers = useCallback(async () => {
    setIsLoading(true)
    try {
      const response = await getUsers()
      setUsers(response.content)
    } catch {
      toast.error("Failed to load users")
    } finally {
      setIsLoading(false)
    }
  }, [])

  // Load deleted users (only for SUPERADMIN)
  const loadDeletedUsers = useCallback(async () => {
    if (!isSuperAdmin) return
    
    setIsLoadingDeleted(true)
    try {
      const response = await getDeletedUsers()
      setDeletedUsers(response.content)
      setDeletedCount(response.totalElements)
    } catch {
      toast.error("Failed to load deleted users")
    } finally {
      setIsLoadingDeleted(false)
    }
  }, [isSuperAdmin])

  useEffect(() => {
    loadUsers()
  }, [loadUsers])

  useEffect(() => {
    if (isSuperAdmin) {
      loadDeletedUsers()
    }
  }, [isSuperAdmin, loadDeletedUsers])

  // Handlers for active users
  const handleViewDetails = (user: User) => {
    setSelectedUser(user)
    setIsDetailsOpen(true)
  }

  const handleEdit = (user: User) => {
    setSelectedUser(user)
    setIsEditOpen(true)
  }

  const handleAssignRoles = (user: User) => {
    setSelectedUser(user)
    setIsAssignRolesOpen(true)
  }

  const handleDeleteClick = (user: User) => {
    setSelectedUser(user)
    setIsDeleteOpen(true)
  }

  const handleDelete = async () => {
    if (!selectedUser) return

    setIsDeleting(true)
    try {
      const response = await deleteUser(selectedUser.id)
      if (response.success) {
        toast.success("User deleted successfully")
        loadUsers()
        if (isSuperAdmin) {
          loadDeletedUsers()
        }
      } else {
        toast.error(response.message || "Failed to delete user")
      }
    } catch {
      toast.error("Failed to delete user")
    } finally {
      setIsDeleting(false)
      setIsDeleteOpen(false)
    }
  }

  // Handlers for deleted users
  const handleRestoreClick = (user: User) => {
    setUserToRestore(user)
  }

  const handleRestore = async () => {
    if (!userToRestore) return

    setIsRestoring(true)
    try {
      const response = await restoreUser(userToRestore.id)
      if (response.success) {
        toast.success(`${userToRestore.firstName} ${userToRestore.lastName} has been restored`)
        loadUsers()
        loadDeletedUsers()
      } else {
        toast.error(response.message || "Failed to restore user")
      }
    } catch {
      toast.error("Failed to restore user")
    } finally {
      setIsRestoring(false)
      setUserToRestore(null)
    }
  }

  const handlePermanentDeleteClick = (user: User) => {
    setUserToPermanentDelete(user)
  }

  const handlePermanentDelete = async () => {
    if (!userToPermanentDelete) return

    setIsPermanentDeleting(true)
    try {
      const response = await permanentlyDeleteUser(userToPermanentDelete.id)
      if (response.success) {
        toast.success("User permanently deleted")
        loadDeletedUsers()
      } else {
        toast.error(response.message || "Failed to permanently delete user")
      }
    } catch {
      toast.error("Failed to permanently delete user")
    } finally {
      setIsPermanentDeleting(false)
      setUserToPermanentDelete(null)
    }
  }

  const refreshAll = () => {
    loadUsers()
    if (isSuperAdmin) {
      loadDeletedUsers()
    }
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Users</h1>
          <p className="text-muted-foreground">Manage user accounts and their access permissions</p>
        </div>
        <div className="flex items-center gap-2">
          <Button variant="outline" size="icon" onClick={refreshAll}>
            <RefreshCw className={`h-4 w-4 ${isLoading || isLoadingDeleted ? "animate-spin" : ""}`} />
          </Button>
          <PermissionGate permissions={["AUTH_USER_CREATE", "CREATE_USER"]}>
            <Button>
              <UserPlus className="mr-2 h-4 w-4" />
              Add User
            </Button>
          </PermissionGate>
        </div>
      </div>

      {/* Tabs - Only show if SUPERADMIN */}
      {isSuperAdmin ? (
        <Tabs defaultValue="active" className="space-y-4">
          <TabsList>
            <TabsTrigger value="active" className="flex items-center gap-2">
              <Users className="h-4 w-4" />
              Active Users
            </TabsTrigger>
            <TabsTrigger value="deleted" className="flex items-center gap-2">
              <Trash2 className="h-4 w-4" />
              Deleted Users
              {deletedCount > 0 && (
                <Badge variant="secondary" className="ml-1">
                  {deletedCount}
                </Badge>
              )}
            </TabsTrigger>
          </TabsList>

          {/* Active Users Tab */}
          <TabsContent value="active">
            {isLoading ? (
              <div className="flex items-center justify-center py-12">
                <LoadingSpinner size="lg" />
              </div>
            ) : users.length === 0 ? (
              <EmptyState
                icon={Users}
                title="No users found"
                description="Get started by creating your first user account."
                action={
                  <PermissionGate permissions={["AUTH_USER_CREATE", "CREATE_USER"]}>
                    <Button>
                      <UserPlus className="mr-2 h-4 w-4" />
                      Add User
                    </Button>
                  </PermissionGate>
                }
              />
            ) : (
              <UsersTable
                users={users}
                onViewDetails={handleViewDetails}
                onEdit={handleEdit}
                onDelete={handleDeleteClick}
                onAssignRoles={handleAssignRoles}
              />
            )}
          </TabsContent>

          {/* Deleted Users Tab */}
          <TabsContent value="deleted">
            {isLoadingDeleted ? (
              <div className="flex items-center justify-center py-12">
                <LoadingSpinner size="lg" />
              </div>
            ) : deletedUsers.length === 0 ? (
              <EmptyState
                icon={Trash2}
                title="No deleted users"
                description="Deleted users will appear here and can be restored."
              />
            ) : (
              <DeletedUsersTable
                users={deletedUsers}
                onRestore={handleRestoreClick}
                onPermanentDelete={handlePermanentDeleteClick}
              />
            )}
          </TabsContent>
        </Tabs>
      ) : (
        // Non-SUPERADMIN users only see active users (no tabs)
        <>
          {isLoading ? (
            <div className="flex items-center justify-center py-12">
              <LoadingSpinner size="lg" />
            </div>
          ) : users.length === 0 ? (
            <EmptyState
              icon={Users}
              title="No users found"
              description="Get started by creating your first user account."
              action={
                <PermissionGate permissions={["AUTH_USER_CREATE", "CREATE_USER"]}>
                  <Button>
                    <UserPlus className="mr-2 h-4 w-4" />
                    Add User
                  </Button>
                </PermissionGate>
              }
            />
          ) : (
            <UsersTable
              users={users}
              onViewDetails={handleViewDetails}
              onEdit={handleEdit}
              onDelete={handleDeleteClick}
              onAssignRoles={handleAssignRoles}
            />
          )}
        </>
      )}

      {/* Dialogs */}
      <UserDetailsDialog user={selectedUser} open={isDetailsOpen} onOpenChange={setIsDetailsOpen} />

      <EditUserDialog user={selectedUser} open={isEditOpen} onOpenChange={setIsEditOpen} onSuccess={loadUsers} />

      <AssignRolesDialog
        user={selectedUser}
        open={isAssignRolesOpen}
        onOpenChange={setIsAssignRolesOpen}
        onSuccess={loadUsers}
      />

      {/* Delete Confirmation Dialog */}
      <ConfirmDialog
        open={isDeleteOpen}
        onOpenChange={setIsDeleteOpen}
        title="Delete User"
        description={`Are you sure you want to delete ${selectedUser?.firstName} ${selectedUser?.lastName}? The user can be restored later by a Super Admin.`}
        confirmText="Delete"
        variant="destructive"
        onConfirm={handleDelete}
        isLoading={isDeleting}
      />

      {/* Restore Confirmation Dialog */}
      <ConfirmDialog
        open={!!userToRestore}
        onOpenChange={(open) => !open && setUserToRestore(null)}
        title="Restore User"
        description={`Are you sure you want to restore ${userToRestore?.firstName} ${userToRestore?.lastName}? They will regain access to the system with their previous account status.`}
        confirmText="Restore"
        onConfirm={handleRestore}
        isLoading={isRestoring}
      />

      {/* Permanent Delete Confirmation Dialog */}
      <ConfirmDialog
        open={!!userToPermanentDelete}
        onOpenChange={(open) => !open && setUserToPermanentDelete(null)}
        title={
          <span className="flex items-center gap-2 text-destructive">
            <AlertTriangle className="h-5 w-5" />
            Permanently Delete User
          </span>
        }
        description={
          <div className="space-y-2">
            <p>
              Are you sure you want to <strong>permanently delete</strong>{" "}
              {userToPermanentDelete?.firstName} {userToPermanentDelete?.lastName}?
            </p>
            <p className="text-destructive font-medium">
              This action cannot be undone. All user data will be permanently removed from the system.
            </p>
          </div>
        }
        confirmText="Permanently Delete"
        variant="destructive"
        onConfirm={handlePermanentDelete}
        isLoading={isPermanentDeleting}
      />
    </div>
  )
}

// ===== FILE: components\theme-provider.tsx =====

'use client'

import * as React from 'react'
import {
  ThemeProvider as NextThemesProvider,
  type ThemeProviderProps,
} from 'next-themes'

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>
}

// ===== FILE: components\admin\invites\create-invite-dialog.tsx =====

// ===== FILE: components/admin/invites/create-invite-dialog.tsx =====
// Dialog for creating new invites

"use client"

import { useState, useEffect } from "react"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import { z } from "zod"
import { toast } from "sonner"
import { Mail, Copy, Check } from "lucide-react"

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { Checkbox } from "@/components/ui/checkbox"
import { ScrollArea } from "@/components/ui/scroll-area"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { createInvite } from "@/lib/api/admin"
import { getRoles } from "@/lib/api/roles"
import type { Role, Invite } from "@/types"

// Validation schema
const createInviteSchema = z.object({
  email: z.string().email("Invalid email address"),
  department: z.string().optional(),
  notes: z.string().max(500, "Notes must be less than 500 characters").optional(),
})

type CreateInviteFormData = z.infer<typeof createInviteSchema>

interface CreateInviteDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: () => void
}

export function CreateInviteDialog({
  open,
  onOpenChange,
  onSuccess,
}: CreateInviteDialogProps) {
  const [isLoading, setIsLoading] = useState(false)
  const [roles, setRoles] = useState<Role[]>([])
  const [selectedRoles, setSelectedRoles] = useState<string[]>([])
  const [loadingRoles, setLoadingRoles] = useState(true)
  
  // Success state
  const [createdInvite, setCreatedInvite] = useState<Invite | null>(null)
  const [copied, setCopied] = useState(false)

  const {
    register,
    handleSubmit,
    reset,
    formState: { errors },
  } = useForm<CreateInviteFormData>({
    resolver: zodResolver(createInviteSchema),
  })

  // Fetch available roles
  useEffect(() => {
    const fetchRoles = async () => {
      try {
        const rolesData = await getRoles()
        setRoles(rolesData)
      } catch (error) {
        console.error("Failed to fetch roles:", error)
      } finally {
        setLoadingRoles(false)
      }
    }

    if (open) {
      fetchRoles()
    }
  }, [open])

  // Reset form when dialog closes
  useEffect(() => {
    if (!open) {
      reset()
      setSelectedRoles([])
      setCreatedInvite(null)
      setCopied(false)
    }
  }, [open, reset])

  const toggleRole = (roleName: string) => {
    setSelectedRoles(prev =>
      prev.includes(roleName)
        ? prev.filter(r => r !== roleName)
        : [...prev, roleName]
    )
  }

  const onSubmit = async (data: CreateInviteFormData) => {
    setIsLoading(true)
    try {
      const response = await createInvite({
        email: data.email,
        intendedRoles: selectedRoles.length > 0 ? selectedRoles : undefined,
        department: data.department || undefined,
        notes: data.notes || undefined,
      })

      if (response.success && response.data) {
        toast.success("Invite created successfully")
        setCreatedInvite(response.data)
      } else {
        toast.error(response.message || "Failed to create invite")
      }
    } catch {
      toast.error("Failed to create invite")
    } finally {
      setIsLoading(false)
    }
  }

  const copyInviteLink = () => {
    if (!createdInvite) return
    
    const link = `${window.location.origin}/register?invite=${createdInvite.token}`
    navigator.clipboard.writeText(link)
    setCopied(true)
    toast.success("Invite link copied to clipboard")
    
    setTimeout(() => setCopied(false), 2000)
  }

  const handleClose = () => {
    if (createdInvite) {
      onSuccess()
    }
    onOpenChange(false)
  }

  // Success view after invite is created
  if (createdInvite) {
    const inviteLink = `${typeof window !== 'undefined' ? window.location.origin : ''}/register?invite=${createdInvite.token}`
    
    return (
      <Dialog open={open} onOpenChange={handleClose}>
        <DialogContent className="sm:max-w-[500px]">
          <DialogHeader>
            <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-primary/10">
              <Mail className="h-6 w-6 text-primary" />
            </div>
            <DialogTitle className="text-center">Invite Created!</DialogTitle>
            <DialogDescription className="text-center">
              An invitation has been created for {createdInvite.email}
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label>Invite Link</Label>
              <div className="flex gap-2">
                <Input
                  value={inviteLink}
                  readOnly
                  className="font-mono text-xs"
                />
                <Button
                  variant="outline"
                  size="icon"
                  onClick={copyInviteLink}
                >
                  {copied ? (
                    <Check className="h-4 w-4 text-primary" />
                  ) : (
                    <Copy className="h-4 w-4" />
                  )}
                </Button>
              </div>
              <p className="text-xs text-muted-foreground">
                Share this link with {createdInvite.email} to complete their registration
              </p>
            </div>

            {createdInvite.intendedRoles.length > 0 && (
              <div className="space-y-2">
                <Label>Assigned Roles</Label>
                <div className="flex flex-wrap gap-2">
                  {createdInvite.intendedRoles.map((role) => (
                    <span
                      key={role}
                      className="inline-flex items-center rounded-md bg-secondary px-2 py-1 text-xs font-medium"
                    >
                      {role}
                    </span>
                  ))}
                </div>
              </div>
            )}
          </div>

          <DialogFooter>
            <Button onClick={handleClose} className="w-full">
              Done
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    )
  }

  // Create invite form
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle>Create Invitation</DialogTitle>
          <DialogDescription>
            Send a registration invite to a new user. They will receive an email with a unique link to create their account.
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="email">Email Address *</Label>
            <Input
              id="email"
              type="email"
              placeholder="user@example.com"
              {...register("email")}
            />
            {errors.email && (
              <p className="text-sm text-destructive">{errors.email.message}</p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="department">Department</Label>
            <Input
              id="department"
              placeholder="e.g., Engineering, Sales"
              {...register("department")}
            />
          </div>

          <div className="space-y-2">
            <Label>Intended Roles (Optional)</Label>
            <p className="text-xs text-muted-foreground mb-2">
              Select roles to assign when the user is approved. If none selected, default role will be used.
            </p>
            {loadingRoles ? (
              <div className="flex items-center justify-center py-4">
                <LoadingSpinner size="sm" />
              </div>
            ) : (
              <ScrollArea className="h-[150px] rounded-md border p-2">
                <div className="space-y-2">
                  {roles.map((role) => (
                    <div key={role.id} className="flex items-center space-x-2">
                      <Checkbox
                        id={`role-${role.id}`}
                        checked={selectedRoles.includes(role.name)}
                        onCheckedChange={() => toggleRole(role.name)}
                      />
                      <Label
                        htmlFor={`role-${role.id}`}
                        className="flex-1 cursor-pointer text-sm font-normal"
                      >
                        <span className="font-medium">{role.name}</span>
                        {role.description && (
                          <span className="text-muted-foreground ml-2">
                            — {role.description}
                          </span>
                        )}
                      </Label>
                    </div>
                  ))}
                </div>
              </ScrollArea>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="notes">Notes</Label>
            <Textarea
              id="notes"
              placeholder="Optional notes about this invitation..."
              rows={3}
              {...register("notes")}
            />
            {errors.notes && (
              <p className="text-sm text-destructive">{errors.notes.message}</p>
            )}
          </div>

          <DialogFooter>
            <Button
              type="button"
              variant="outline"
              onClick={() => onOpenChange(false)}
              disabled={isLoading}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={isLoading}>
              {isLoading && <LoadingSpinner size="sm" className="mr-2" />}
              Create Invite
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}

// ===== FILE: components\admin\users\approve-user-dialog.tsx =====

// ===== FILE: components/admin/users/approve-user-dialog.tsx =====
// Dialog for approving a pending user

"use client"

import { useState, useEffect } from "react"
import { toast } from "sonner"
import { UserCheck } from "lucide-react"

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Label } from "@/components/ui/label"
import { Checkbox } from "@/components/ui/checkbox"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Avatar, AvatarFallback } from "@/components/ui/avatar"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { approveUser } from "@/lib/api/admin"
import { getRoles } from "@/lib/api/roles"
import { getInitials } from "@/lib/utils/formatters"
import type { User, Role } from "@/types"

interface ApproveUserDialogProps {
  user: User | null
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: () => void
}

export function ApproveUserDialog({
  user,
  open,
  onOpenChange,
  onSuccess,
}: ApproveUserDialogProps) {
  const [isLoading, setIsLoading] = useState(false)
  const [roles, setRoles] = useState<Role[]>([])
  const [selectedRoles, setSelectedRoles] = useState<string[]>([])
  const [loadingRoles, setLoadingRoles] = useState(true)

  // Fetch available roles
  useEffect(() => {
    const fetchRoles = async () => {
      try {
        const rolesData = await getRoles()
        setRoles(rolesData)
      } catch (error) {
        console.error("Failed to fetch roles:", error)
      } finally {
        setLoadingRoles(false)
      }
    }

    if (open) {
      fetchRoles()
    }
  }, [open])

  // Reset selection when dialog closes
  useEffect(() => {
    if (!open) {
      setSelectedRoles([])
    }
  }, [open])

  const toggleRole = (roleName: string) => {
    setSelectedRoles(prev =>
      prev.includes(roleName)
        ? prev.filter(r => r !== roleName)
        : [...prev, roleName]
    )
  }

  const handleApprove = async () => {
    if (!user) return

    setIsLoading(true)
    try {
      const response = await approveUser(user.id, {
        roles: selectedRoles.length > 0 ? selectedRoles : undefined,
      })

      if (response.success) {
        toast.success(`${user.firstName} ${user.lastName} has been approved`)
        onSuccess()
      } else {
        toast.error(response.message || "Failed to approve user")
      }
    } catch {
      toast.error("Failed to approve user")
    } finally {
      setIsLoading(false)
    }
  }

  if (!user) return null

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <UserCheck className="h-5 w-5 text-emerald-500" />
            Approve User
          </DialogTitle>
          <DialogDescription>
            Review and approve this user's registration request
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          {/* User info */}
          <div className="flex items-center gap-4 rounded-lg border p-4">
            <Avatar className="h-12 w-12">
              <AvatarFallback className="bg-primary/10 text-primary">
                {getInitials(user.firstName, user.lastName)}
              </AvatarFallback>
            </Avatar>
            <div>
              <p className="font-medium">
                {user.firstName} {user.lastName}
              </p>
              <p className="text-sm text-muted-foreground">{user.email}</p>
              <p className="text-xs text-muted-foreground">@{user.userName}</p>
            </div>
          </div>

          {/* Role selection */}
          <div className="space-y-2">
            <Label>Assign Roles (Optional)</Label>
            <p className="text-xs text-muted-foreground">
              Select roles to assign to this user. If none selected, the default role from their invitation will be used.
            </p>
            {loadingRoles ? (
              <div className="flex items-center justify-center py-4">
                <LoadingSpinner size="sm" />
              </div>
            ) : (
              <ScrollArea className="h-[200px] rounded-md border p-2">
                <div className="space-y-2">
                  {roles.map((role) => (
                    <div key={role.id} className="flex items-center space-x-2">
                      <Checkbox
                        id={`approve-role-${role.id}`}
                        checked={selectedRoles.includes(role.name)}
                        onCheckedChange={() => toggleRole(role.name)}
                      />
                      <Label
                        htmlFor={`approve-role-${role.id}`}
                        className="flex-1 cursor-pointer text-sm font-normal"
                      >
                        <span className="font-medium">{role.name}</span>
                        {role.description && (
                          <span className="text-muted-foreground ml-2">
                            — {role.description}
                          </span>
                        )}
                      </Label>
                    </div>
                  ))}
                </div>
              </ScrollArea>
            )}
            {selectedRoles.length > 0 && (
              <p className="text-xs text-muted-foreground">
                Selected: {selectedRoles.join(", ")}
              </p>
            )}
          </div>
        </div>

        <DialogFooter>
          <Button
            variant="outline"
            onClick={() => onOpenChange(false)}
            disabled={isLoading}
          >
            Cancel
          </Button>
          <Button
            onClick={handleApprove}
            disabled={isLoading}
            className="bg-emerald-600 hover:bg-emerald-700"
          >
            {isLoading && <LoadingSpinner size="sm" className="mr-2" />}
            Approve User
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}

// ===== FILE: components\admin\users\reject-user-dialog.tsx =====

// ===== FILE: components/admin/users/reject-user-dialog.tsx =====
// Dialog for rejecting a pending user registration

"use client"

import { useState } from "react"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import { z } from "zod"
import { toast } from "sonner"
import { UserX } from "lucide-react"

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { Avatar, AvatarFallback } from "@/components/ui/avatar"
import { Alert, AlertDescription } from "@/components/ui/alert"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { rejectUser } from "@/lib/api/admin"
import { getInitials } from "@/lib/utils/formatters"
import type { User } from "@/types"

const rejectSchema = z.object({
  reason: z.string().min(10, "Reason must be at least 10 characters").max(500, "Reason must be less than 500 characters"),
})

type RejectFormData = z.infer<typeof rejectSchema>

interface RejectUserDialogProps {
  user: User | null
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: () => void
}

export function RejectUserDialog({
  user,
  open,
  onOpenChange,
  onSuccess,
}: RejectUserDialogProps) {
  const [isLoading, setIsLoading] = useState(false)

  const {
    register,
    handleSubmit,
    reset,
    formState: { errors },
  } = useForm<RejectFormData>({
    resolver: zodResolver(rejectSchema),
  })

  const onSubmit = async (data: RejectFormData) => {
    if (!user) return

    setIsLoading(true)
    try {
      const response = await rejectUser(user.id, {
        reason: data.reason,
      })

      if (response.success) {
        toast.success(`${user.firstName} ${user.lastName}'s registration has been rejected`)
        reset()
        onSuccess()
      } else {
        toast.error(response.message || "Failed to reject user")
      }
    } catch {
      toast.error("Failed to reject user")
    } finally {
      setIsLoading(false)
    }
  }

  const handleClose = (open: boolean) => {
    if (!open) {
      reset()
    }
    onOpenChange(open)
  }

  if (!user) return null

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <UserX className="h-5 w-5 text-destructive" />
            Reject Registration
          </DialogTitle>
          <DialogDescription>
            Reject this user's registration request. They will be notified and their account will be removed.
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {/* User info */}
          <div className="flex items-center gap-4 rounded-lg border p-4">
            <Avatar className="h-12 w-12">
              <AvatarFallback className="bg-destructive/10 text-destructive">
                {getInitials(user.firstName, user.lastName)}
              </AvatarFallback>
            </Avatar>
            <div>
              <p className="font-medium">
                {user.firstName} {user.lastName}
              </p>
              <p className="text-sm text-muted-foreground">{user.email}</p>
              <p className="text-xs text-muted-foreground">@{user.userName}</p>
            </div>
          </div>

          <Alert variant="destructive">
            <AlertDescription>
              This action cannot be undone. The user will need to request a new invitation to register again.
            </AlertDescription>
          </Alert>

          {/* Rejection reason */}
          <div className="space-y-2">
            <Label htmlFor="reason">Reason for Rejection *</Label>
            <Textarea
              id="reason"
              placeholder="Please provide a reason for rejecting this registration..."
              rows={4}
              {...register("reason")}
            />
            {errors.reason && (
              <p className="text-sm text-destructive">{errors.reason.message}</p>
            )}
            <p className="text-xs text-muted-foreground">
              This reason will be included in the notification email sent to the user.
            </p>
          </div>

          <DialogFooter>
            <Button
              type="button"
              variant="outline"
              onClick={() => handleClose(false)}
              disabled={isLoading}
            >
              Cancel
            </Button>
            <Button
              type="submit"
              variant="destructive"
              disabled={isLoading}
            >
              {isLoading && <LoadingSpinner size="sm" className="mr-2" />}
              Reject Registration
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}

// ===== FILE: components\admin\users\suspend-user-dialog.tsx =====

// ===== FILE: components/admin/users/suspend-user-dialog.tsx =====
// Dialog for suspending an active user

"use client"

import { useState } from "react"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import { z } from "zod"
import { toast } from "sonner"
import { Ban } from "lucide-react"

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { Avatar, AvatarFallback } from "@/components/ui/avatar"
import { Alert, AlertDescription } from "@/components/ui/alert"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { suspendUser } from "@/lib/api/admin"
import { getInitials } from "@/lib/utils/formatters"
import type { User } from "@/types"

const suspendSchema = z.object({
  reason: z.string().min(10, "Reason must be at least 10 characters").max(500, "Reason must be less than 500 characters"),
})

type SuspendFormData = z.infer<typeof suspendSchema>

interface SuspendUserDialogProps {
  user: User | null
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: () => void
}

export function SuspendUserDialog({
  user,
  open,
  onOpenChange,
  onSuccess,
}: SuspendUserDialogProps) {
  const [isLoading, setIsLoading] = useState(false)

  const {
    register,
    handleSubmit,
    reset,
    formState: { errors },
  } = useForm<SuspendFormData>({
    resolver: zodResolver(suspendSchema),
  })

  const onSubmit = async (data: SuspendFormData) => {
    if (!user) return

    setIsLoading(true)
    try {
      const response = await suspendUser(user.id, {
        reason: data.reason,
      })

      if (response.success) {
        toast.success(`${user.firstName} ${user.lastName} has been suspended`)
        reset()
        onSuccess()
      } else {
        toast.error(response.message || "Failed to suspend user")
      }
    } catch {
      toast.error("Failed to suspend user")
    } finally {
      setIsLoading(false)
    }
  }

  const handleClose = (open: boolean) => {
    if (!open) {
      reset()
    }
    onOpenChange(open)
  }

  if (!user) return null

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Ban className="h-5 w-5 text-destructive" />
            Suspend User
          </DialogTitle>
          <DialogDescription>
            Suspend this user's account. They will be immediately logged out and unable to access the system.
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {/* User info */}
          <div className="flex items-center gap-4 rounded-lg border p-4">
            <Avatar className="h-12 w-12">
              <AvatarFallback className="bg-destructive/10 text-destructive">
                {getInitials(user.firstName, user.lastName)}
              </AvatarFallback>
            </Avatar>
            <div>
              <p className="font-medium">
                {user.firstName} {user.lastName}
              </p>
              <p className="text-sm text-muted-foreground">{user.email}</p>
              <p className="text-xs text-muted-foreground">@{user.userName}</p>
            </div>
          </div>

          <Alert variant="default" className="border-amber-500/50 bg-amber-500/10">
            <AlertDescription className="text-amber-700 dark:text-amber-300">
              The user's roles will be preserved. You can reactivate this account later.
            </AlertDescription>
          </Alert>

          {/* Suspension reason */}
          <div className="space-y-2">
            <Label htmlFor="reason">Reason for Suspension *</Label>
            <Textarea
              id="reason"
              placeholder="Please provide a reason for suspending this user..."
              rows={4}
              {...register("reason")}
            />
            {errors.reason && (
              <p className="text-sm text-destructive">{errors.reason.message}</p>
            )}
            <p className="text-xs text-muted-foreground">
              This reason will be logged for audit purposes and included in the notification email.
            </p>
          </div>

          <DialogFooter>
            <Button
              type="button"
              variant="outline"
              onClick={() => handleClose(false)}
              disabled={isLoading}
            >
              Cancel
            </Button>
            <Button
              type="submit"
              variant="destructive"
              disabled={isLoading}
            >
              {isLoading && <LoadingSpinner size="sm" className="mr-2" />}
              Suspend User
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}

// ===== FILE: components\auth\forgot-password-form.tsx =====

"use client"

import { useState } from "react"
import Link from "next/link"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import { ArrowLeft, Mail, CheckCircle } from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { forgotPassword } from "@/lib/api/auth"
import { forgotPasswordSchema, type ForgotPasswordFormData } from "@/lib/validations/auth"
import { LoadingSpinner } from "@/components/common/loading-spinner"

export function ForgotPasswordForm() {
  const [isLoading, setIsLoading] = useState(false)
  const [isEmailSent, setIsEmailSent] = useState(false)

  const {
    register,
    handleSubmit,
    formState: { errors },
    getValues,
  } = useForm<ForgotPasswordFormData>({
    resolver: zodResolver(forgotPasswordSchema),
  })

  const onSubmit = async (data: ForgotPasswordFormData) => {
    setIsLoading(true)
    try {
      const response = await forgotPassword(data)
      if (response.success) {
        setIsEmailSent(true)
        toast.success("Reset email sent!")
      } else {
        toast.error(response.message)
      }
    } catch {
      toast.error("Failed to send reset email")
    } finally {
      setIsLoading(false)
    }
  }

  if (isEmailSent) {
    return (
      <div className="space-y-6 text-center">
        <div className="mx-auto w-fit rounded-full bg-primary/10 p-4">
          <CheckCircle className="h-8 w-8 text-primary" />
        </div>
        <div className="space-y-2">
          <h1 className="text-2xl font-bold tracking-tight">Check your email</h1>
          <p className="text-sm text-muted-foreground">
            {"We've sent a password reset link to"}{" "}
            <span className="font-medium text-foreground">{getValues("email")}</span>
          </p>
        </div>
        <div className="space-y-3">
          <Button variant="outline" className="w-full bg-transparent" onClick={() => setIsEmailSent(false)}>
            Try another email
          </Button>
          <Link href="/login">
            <Button variant="ghost" className="w-full">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Back to login
            </Button>
          </Link>
        </div>
      </div>
    )
  }

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      <div className="space-y-2 text-center">
        <h1 className="text-2xl font-bold tracking-tight">Forgot password?</h1>
        <p className="text-sm text-muted-foreground">{"Enter your email and we'll send you a reset link"}</p>
      </div>

      <div className="space-y-4">
        <div className="space-y-2">
          <Label htmlFor="email">Email</Label>
          <Input id="email" type="email" placeholder="name@example.com" autoComplete="email" {...register("email")} />
          {errors.email && <p className="text-sm text-destructive">{errors.email.message}</p>}
        </div>
      </div>

      <Button type="submit" className="w-full" disabled={isLoading}>
        {isLoading ? <LoadingSpinner size="sm" className="mr-2" /> : <Mail className="mr-2 h-4 w-4" />}
        Send reset link
      </Button>

      <Link href="/login">
        <Button variant="ghost" className="w-full">
          <ArrowLeft className="mr-2 h-4 w-4" />
          Back to login
        </Button>
      </Link>
    </form>
  )
}

// ===== FILE: components\auth\login-form.tsx =====

// ===== FILE: components/auth/login-form.tsx =====
// Updated login form with account status handling

"use client"

import { useState } from "react"
import { useRouter } from "next/navigation"
import Link from "next/link"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import { Eye, EyeOff, LogIn, AlertCircle, Clock, Mail, Ban } from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert"
import { useAuthStore } from "@/lib/store/auth-store"
import { loginSchema, type LoginFormData } from "@/lib/validations/auth"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import type { AccountStatus } from "@/types"

// Helper to get status-specific message and icon
function getAccountStatusInfo(status: AccountStatus | null) {
  switch (status) {
    case "PENDING_VERIFICATION":
      return {
        icon: Mail,
        title: "Email Not Verified",
        description: "Please check your email and click the verification link before logging in.",
        variant: "default" as const,
      }
    case "PENDING_APPROVAL":
      return {
        icon: Clock,
        title: "Awaiting Approval",
        description: "Your email has been verified. Your account is pending approval by an administrator. You'll receive an email when your account is approved.",
        variant: "default" as const,
      }
    case "SUSPENDED":
      return {
        icon: Ban,
        title: "Account Suspended",
        description: "Your account has been suspended. Please contact an administrator for assistance.",
        variant: "destructive" as const,
      }
    case "DEACTIVATED":
      return {
        icon: Ban,
        title: "Account Deactivated",
        description: "Your account has been deactivated. Please contact an administrator if you believe this is an error.",
        variant: "destructive" as const,
      }
    default:
      return null
  }
}

export function LoginForm() {
  const router = useRouter()
  const [showPassword, setShowPassword] = useState(false)
  const login = useAuthStore((state) => state.login)
  const isLoading = useAuthStore((state) => state.isLoading)
  const error = useAuthStore((state) => state.error)
  const loginAccountStatus = useAuthStore((state) => state.loginAccountStatus)
  const clearError = useAuthStore((state) => state.clearError)
  const clearLoginStatus = useAuthStore((state) => state.clearLoginStatus)

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<LoginFormData>({
    resolver: zodResolver(loginSchema),
  })

  const onSubmit = async (data: LoginFormData) => {
    clearError()
    clearLoginStatus()
    
    const result = await login(data)
    
    if (result.success) {
      toast.success("Welcome back!")
      router.push("/dashboard")
    } else if (result.accountNotActive) {
      // Status-specific message is shown in the alert
      // Don't show a toast for account status issues
    } else {
      toast.error(result.message || "Login failed")
    }
  }

  const statusInfo = getAccountStatusInfo(loginAccountStatus)

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      <div className="space-y-2 text-center">
        <h1 className="text-2xl font-bold tracking-tight">Welcome back</h1>
        <p className="text-sm text-muted-foreground">Enter your credentials to access your account</p>
      </div>

      {/* Account Status Alert */}
      {statusInfo && (
        <Alert variant={statusInfo.variant}>
          <statusInfo.icon className="h-4 w-4" />
          <AlertTitle>{statusInfo.title}</AlertTitle>
          <AlertDescription>{statusInfo.description}</AlertDescription>
        </Alert>
      )}

      {/* General Error Alert (for non-status errors) */}
      {error && !loginAccountStatus && (
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Error</AlertTitle>
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}

      <div className="space-y-4">
        <div className="space-y-2">
          <Label htmlFor="email">Email</Label>
          <Input 
            id="email" 
            type="email" 
            placeholder="name@example.com" 
            autoComplete="email" 
            {...register("email")} 
          />
          {errors.email && <p className="text-sm text-destructive">{errors.email.message}</p>}
        </div>

        <div className="space-y-2">
          <div className="flex items-center justify-between">
            <Label htmlFor="password">Password</Label>
            <Link href="/forgot-password" className="text-sm text-primary hover:underline">
              Forgot password?
            </Link>
          </div>
          <div className="relative">
            <Input
              id="password"
              type={showPassword ? "text" : "password"}
              placeholder="Enter your password"
              autoComplete="current-password"
              {...register("password")}
            />
            <Button
              type="button"
              variant="ghost"
              size="icon"
              className="absolute right-0 top-0 h-full px-3 hover:bg-transparent"
              onClick={() => setShowPassword(!showPassword)}
            >
              {showPassword ? (
                <EyeOff className="h-4 w-4 text-muted-foreground" />
              ) : (
                <Eye className="h-4 w-4 text-muted-foreground" />
              )}
              <span className="sr-only">{showPassword ? "Hide password" : "Show password"}</span>
            </Button>
          </div>
          {errors.password && <p className="text-sm text-destructive">{errors.password.message}</p>}
        </div>
      </div>

      <Button type="submit" className="w-full" disabled={isLoading}>
        {isLoading ? <LoadingSpinner size="sm" className="mr-2" /> : <LogIn className="mr-2 h-4 w-4" />}
        Sign in
      </Button>

      {/* Show resend verification link if pending verification */}
      {loginAccountStatus === "PENDING_VERIFICATION" && (
        <p className="text-center text-sm text-muted-foreground">
          {"Didn't receive the email? "}
          <Link href="/verify-email" className="text-primary hover:underline">
            Resend verification
          </Link>
        </p>
      )}

      <p className="text-center text-sm text-muted-foreground">
        {"Don't have an account? "}
        <Link href="/register" className="text-primary hover:underline">
          Sign up
        </Link>
      </p>
    </form>
  )
}

// ===== FILE: components\auth\register-form.tsx =====

// ===== FILE: components/auth/register-form.tsx =====
// Updated register form with invite token support

"use client"

import { useState, useEffect } from "react"
import { useRouter, useSearchParams } from "next/navigation"
import Link from "next/link"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import { Eye, EyeOff, UserPlus, AlertCircle, Mail, Lock } from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { useAuthStore } from "@/lib/store/auth-store"
import { registerSchema, type RegisterFormData } from "@/lib/validations/auth"
import { LoadingSpinner, FullPageLoader } from "@/components/common/loading-spinner"
import { checkRegistration } from "@/lib/api/auth"

export function RegisterForm() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const inviteToken = searchParams.get("invite")

  // State for invite validation
  const [isCheckingInvite, setIsCheckingInvite] = useState(!!inviteToken)
  const [inviteValid, setInviteValid] = useState(false)
  const [inviteEmail, setInviteEmail] = useState<string | null>(null)
  const [inviteError, setInviteError] = useState<string | null>(null)

  // State for registration success
  const [registrationSuccess, setRegistrationSuccess] = useState(false)

  const [showPassword, setShowPassword] = useState(false)
  const [showConfirmPassword, setShowConfirmPassword] = useState(false)
  const registerUser = useAuthStore((state) => state.register)
  const isLoading = useAuthStore((state) => state.isLoading)
  const error = useAuthStore((state) => state.error)
  const clearError = useAuthStore((state) => state.clearError)

  const {
    register,
    handleSubmit,
    setValue,
    formState: { errors },
  } = useForm<RegisterFormData>({
    resolver: zodResolver(registerSchema),
  })

  // Check invite token on mount
  useEffect(() => {
    const validateInvite = async () => {
      if (!inviteToken) {
        setIsCheckingInvite(false)
        return
      }

      try {
        const response = await checkRegistration(inviteToken)
        
        if (response.available && response.email) {
          setInviteValid(true)
          setInviteEmail(response.email)
          setValue("email", response.email)
        } else {
          setInviteError(response.message || "Invalid or expired invite link")
        }
      } catch {
        setInviteError("Failed to validate invite link")
      } finally {
        setIsCheckingInvite(false)
      }
    }

    validateInvite()
  }, [inviteToken, setValue])

  const onSubmit = async (data: RegisterFormData) => {
    if (!inviteToken) {
      toast.error("Invalid registration - no invite token")
      return
    }

    clearError()
    const result = await registerUser({
      userName: data.userName,
      email: data.email,
      password: data.password,
      firstName: data.firstName,
      lastName: data.lastName,
      inviteToken: inviteToken,
    })

    if (result.success) {
      setRegistrationSuccess(true)
    } else {
      toast.error(result.message || "Registration failed")
    }
  }

  // Loading state while checking invite
  if (isCheckingInvite) {
    return <FullPageLoader message="Validating your invitation..." />
  }

  // No invite token - show registration unavailable message
  if (!inviteToken) {
    return (
      <div className="space-y-6 text-center">
        <div className="mx-auto w-fit rounded-full bg-muted p-4">
          <Lock className="h-8 w-8 text-muted-foreground" />
        </div>
        <div className="space-y-2">
          <h1 className="text-2xl font-bold tracking-tight">Registration Unavailable</h1>
          <p className="text-sm text-muted-foreground">
            Registration is by invitation only. Please contact your administrator to request an invitation.
          </p>
        </div>
        <Link href="/login">
          <Button variant="outline" className="w-full">
            Back to Login
          </Button>
        </Link>
      </div>
    )
  }

  // Invalid invite token
  if (inviteError) {
    return (
      <div className="space-y-6 text-center">
        <div className="mx-auto w-fit rounded-full bg-destructive/10 p-4">
          <AlertCircle className="h-8 w-8 text-destructive" />
        </div>
        <div className="space-y-2">
          <h1 className="text-2xl font-bold tracking-tight">Invalid Invitation</h1>
          <p className="text-sm text-muted-foreground">{inviteError}</p>
        </div>
        <div className="space-y-3">
          <p className="text-sm text-muted-foreground">
            If you believe this is an error, please contact your administrator for a new invitation.
          </p>
          <Link href="/login">
            <Button variant="outline" className="w-full">
              Back to Login
            </Button>
          </Link>
        </div>
      </div>
    )
  }

  // Registration successful - show check email message
  if (registrationSuccess) {
    return (
      <div className="space-y-6 text-center">
        <div className="mx-auto w-fit rounded-full bg-primary/10 p-4">
          <Mail className="h-8 w-8 text-primary" />
        </div>
        <div className="space-y-2">
          <h1 className="text-2xl font-bold tracking-tight">Pending Approval</h1>
          <p className="text-sm text-muted-foreground">
            Your Account Has Been Created Now Wait for Administrator Approval. <span className="font-medium">{inviteEmail}</span>.
          </p>
        </div>
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-base">What's next?</CardTitle>
          </CardHeader>
          <CardContent className="space-y-2 text-sm text-muted-foreground">
            <div className="flex items-start gap-3">
              <div className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-primary/10 text-xs font-medium text-primary">
                1
              </div>
              <p>Wait for an administrator to approve your account</p>
            </div>
            <div className="flex items-start gap-3">
              <div className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-primary/10 text-xs font-medium text-primary">
                2
              </div>
              <p>You'll receive an email when your account is ready</p>
            </div>
          </CardContent>
        </Card>
        <Link href="/login">
          <Button variant="outline" className="w-full">
            Back to Login
          </Button>
        </Link>
      </div>
    )
  }

  // Valid invite - show registration form
  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      <div className="space-y-2 text-center">
        <h1 className="text-2xl font-bold tracking-tight">Create an account</h1>
        <p className="text-sm text-muted-foreground">
          You've been invited to join. Complete your registration below.
        </p>
      </div>

      {error && (
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Error</AlertTitle>
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}

      <div className="space-y-4">
        <div className="grid grid-cols-2 gap-4">
          <div className="space-y-2">
            <Label htmlFor="firstName">First name</Label>
            <Input 
              id="firstName" 
              placeholder="John" 
              autoComplete="given-name" 
              {...register("firstName")} 
            />
            {errors.firstName && (
              <p className="text-sm text-destructive">{errors.firstName.message}</p>
            )}
          </div>
          <div className="space-y-2">
            <Label htmlFor="lastName">Last name</Label>
            <Input 
              id="lastName" 
              placeholder="Doe" 
              autoComplete="family-name" 
              {...register("lastName")} 
            />
            {errors.lastName && (
              <p className="text-sm text-destructive">{errors.lastName.message}</p>
            )}
          </div>
        </div>

        <div className="space-y-2">
          <Label htmlFor="userName">Username</Label>
          <Input 
            id="userName" 
            placeholder="johndoe" 
            autoComplete="username" 
            {...register("userName")} 
          />
          {errors.userName && (
            <p className="text-sm text-destructive">{errors.userName.message}</p>
          )}
        </div>

        <div className="space-y-2">
          <Label htmlFor="email">Email</Label>
          <Input
            id="email"
            type="email"
            autoComplete="email"
            disabled
            className="bg-muted"
            {...register("email")}
          />
          <p className="text-xs text-muted-foreground">
            Email is pre-filled from your invitation and cannot be changed
          </p>
        </div>

        <div className="space-y-2">
          <Label htmlFor="password">Password</Label>
          <div className="relative">
            <Input
              id="password"
              type={showPassword ? "text" : "password"}
              placeholder="Create a password"
              autoComplete="new-password"
              {...register("password")}
            />
            <Button
              type="button"
              variant="ghost"
              size="icon"
              className="absolute right-0 top-0 h-full px-3 hover:bg-transparent"
              onClick={() => setShowPassword(!showPassword)}
            >
              {showPassword ? (
                <EyeOff className="h-4 w-4 text-muted-foreground" />
              ) : (
                <Eye className="h-4 w-4 text-muted-foreground" />
              )}
            </Button>
          </div>
          {errors.password && (
            <p className="text-sm text-destructive">{errors.password.message}</p>
          )}
        </div>

        <div className="space-y-2">
          <Label htmlFor="confirmPassword">Confirm password</Label>
          <div className="relative">
            <Input
              id="confirmPassword"
              type={showConfirmPassword ? "text" : "password"}
              placeholder="Confirm your password"
              autoComplete="new-password"
              {...register("confirmPassword")}
            />
            <Button
              type="button"
              variant="ghost"
              size="icon"
              className="absolute right-0 top-0 h-full px-3 hover:bg-transparent"
              onClick={() => setShowConfirmPassword(!showConfirmPassword)}
            >
              {showConfirmPassword ? (
                <EyeOff className="h-4 w-4 text-muted-foreground" />
              ) : (
                <Eye className="h-4 w-4 text-muted-foreground" />
              )}
            </Button>
          </div>
          {errors.confirmPassword && (
            <p className="text-sm text-destructive">{errors.confirmPassword.message}</p>
          )}
        </div>
      </div>

      <Button type="submit" className="w-full" disabled={isLoading}>
        {isLoading ? (
          <LoadingSpinner size="sm" className="mr-2" />
        ) : (
          <UserPlus className="mr-2 h-4 w-4" />
        )}
        Create account
      </Button>

      <p className="text-center text-sm text-muted-foreground">
        Already have an account?{" "}
        <Link href="/login" className="text-primary hover:underline">
          Sign in
        </Link>
      </p>
    </form>
  )
}

// ===== FILE: components\auth\reset-password-form.tsx =====

"use client"

import { useState, useEffect } from "react"
import { useRouter, useSearchParams } from "next/navigation"
import Link from "next/link"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import { Eye, EyeOff, KeyRound, CheckCircle, XCircle } from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { resetPassword, validateResetToken } from "@/lib/api/auth"
import { resetPasswordSchema, type ResetPasswordFormData } from "@/lib/validations/auth"
import { LoadingSpinner, FullPageLoader } from "@/components/common/loading-spinner"

export function ResetPasswordForm() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const token = searchParams.get("token")

  const [isLoading, setIsLoading] = useState(false)
  const [isValidating, setIsValidating] = useState(true)
  const [isValidToken, setIsValidToken] = useState(false)
  const [isSuccess, setIsSuccess] = useState(false)
  const [showPassword, setShowPassword] = useState(false)
  const [showConfirmPassword, setShowConfirmPassword] = useState(false)

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<ResetPasswordFormData>({
    resolver: zodResolver(resetPasswordSchema),
  })

  useEffect(() => {
    const validateToken = async () => {
      if (!token) {
        setIsValidating(false)
        return
      }

      try {
        const response = await validateResetToken(token)
        setIsValidToken(response.success)
      } catch {
        setIsValidToken(false)
      } finally {
        setIsValidating(false)
      }
    }

    validateToken()
  }, [token])

  const onSubmit = async (data: ResetPasswordFormData) => {
    if (!token) return

    setIsLoading(true)
    try {
      const response = await resetPassword({
        token,
        newPassword: data.newPassword,
      })
      if (response.success) {
        setIsSuccess(true)
        toast.success("Password reset successfully!")
      } else {
        toast.error(response.message)
      }
    } catch {
      toast.error("Failed to reset password")
    } finally {
      setIsLoading(false)
    }
  }

  if (isValidating) {
    return <FullPageLoader message="Validating reset link..." />
  }

  if (!token || !isValidToken) {
    return (
      <div className="space-y-6 text-center">
        <div className="mx-auto w-fit rounded-full bg-destructive/10 p-4">
          <XCircle className="h-8 w-8 text-destructive" />
        </div>
        <div className="space-y-2">
          <h1 className="text-2xl font-bold tracking-tight">Invalid link</h1>
          <p className="text-sm text-muted-foreground">
            This password reset link is invalid or has expired. Please request a new one.
          </p>
        </div>
        <Link href="/auth/forgot-password">
          <Button className="w-full">Request new link</Button>
        </Link>
      </div>
    )
  }

  if (isSuccess) {
    return (
      <div className="space-y-6 text-center">
        <div className="mx-auto w-fit rounded-full bg-primary/10 p-4">
          <CheckCircle className="h-8 w-8 text-primary" />
        </div>
        <div className="space-y-2">
          <h1 className="text-2xl font-bold tracking-tight">Password reset!</h1>
          <p className="text-sm text-muted-foreground">
            Your password has been successfully reset. You can now login with your new password.
          </p>
        </div>
        <Link href="/login">
          <Button className="w-full">Continue to login</Button>
        </Link>
      </div>
    )
  }

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      <div className="space-y-2 text-center">
        <h1 className="text-2xl font-bold tracking-tight">Reset password</h1>
        <p className="text-sm text-muted-foreground">Enter your new password below</p>
      </div>

      <div className="space-y-4">
        <div className="space-y-2">
          <Label htmlFor="newPassword">New password</Label>
          <div className="relative">
            <Input
              id="newPassword"
              type={showPassword ? "text" : "password"}
              placeholder="Enter new password"
              autoComplete="new-password"
              {...register("newPassword")}
            />
            <Button
              type="button"
              variant="ghost"
              size="icon"
              className="absolute right-0 top-0 h-full px-3 hover:bg-transparent"
              onClick={() => setShowPassword(!showPassword)}
            >
              {showPassword ? (
                <EyeOff className="h-4 w-4 text-muted-foreground" />
              ) : (
                <Eye className="h-4 w-4 text-muted-foreground" />
              )}
            </Button>
          </div>
          {errors.newPassword && <p className="text-sm text-destructive">{errors.newPassword.message}</p>}
        </div>

        <div className="space-y-2">
          <Label htmlFor="confirmPassword">Confirm password</Label>
          <div className="relative">
            <Input
              id="confirmPassword"
              type={showConfirmPassword ? "text" : "password"}
              placeholder="Confirm new password"
              autoComplete="new-password"
              {...register("confirmPassword")}
            />
            <Button
              type="button"
              variant="ghost"
              size="icon"
              className="absolute right-0 top-0 h-full px-3 hover:bg-transparent"
              onClick={() => setShowConfirmPassword(!showConfirmPassword)}
            >
              {showConfirmPassword ? (
                <EyeOff className="h-4 w-4 text-muted-foreground" />
              ) : (
                <Eye className="h-4 w-4 text-muted-foreground" />
              )}
            </Button>
          </div>
          {errors.confirmPassword && <p className="text-sm text-destructive">{errors.confirmPassword.message}</p>}
        </div>
      </div>

      <Button type="submit" className="w-full" disabled={isLoading}>
        {isLoading ? <LoadingSpinner size="sm" className="mr-2" /> : <KeyRound className="mr-2 h-4 w-4" />}
        Reset password
      </Button>
    </form>
  )
}

// ===== FILE: components\auth\verify-email-form.tsx =====

// ===== FILE: components/auth/verify-email-form.tsx =====
// Updated verify email form with pending approval support

"use client"

import { useState, useEffect } from "react"
import { useSearchParams } from "next/navigation"
import Link from "next/link"
import { CheckCircle, XCircle, Mail, Clock } from "lucide-react"

import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { verifyEmail, resendVerification } from "@/lib/api/auth"
import { FullPageLoader, LoadingSpinner } from "@/components/common/loading-spinner"
import { toast } from "sonner"
import type { AccountStatus } from "@/types"

export function VerifyEmailForm() {
  const searchParams = useSearchParams()
  const token = searchParams.get("token")

  const [isVerifying, setIsVerifying] = useState(!!token)
  const [verificationStatus, setVerificationStatus] = useState<"success" | "pending_approval" | "error" | null>(null)
  const [accountStatus, setAccountStatus] = useState<AccountStatus | null>(null)
  const [errorMessage, setErrorMessage] = useState("")
  const [email, setEmail] = useState("")
  const [isResending, setIsResending] = useState(false)

  useEffect(() => {
    const verify = async () => {
      if (!token) return

      try {
        const response = await verifyEmail(token)
        
        if (response.success) {
          setAccountStatus(response.accountStatus || null)
          
          // Check account status to determine which message to show
          if (response.accountStatus === "ACTIVE") {
            setVerificationStatus("success")
          } else if (response.accountStatus === "PENDING_APPROVAL") {
            setVerificationStatus("pending_approval")
          } else {
            setVerificationStatus("success")
          }
        } else {
          setVerificationStatus("error")
          setErrorMessage(response.message)
        }
      } catch {
        setVerificationStatus("error")
        setErrorMessage("Failed to verify email")
      } finally {
        setIsVerifying(false)
      }
    }

    verify()
  }, [token])

  const handleResend = async () => {
    if (!email) {
      toast.error("Please enter your email")
      return
    }

    setIsResending(true)
    try {
      const response = await resendVerification(email)
      if (response.success) {
        toast.success("Verification email sent!")
      } else {
        toast.error(response.message)
      }
    } catch {
      toast.error("Failed to resend verification email")
    } finally {
      setIsResending(false)
    }
  }

  if (isVerifying) {
    return <FullPageLoader message="Verifying your email..." />
  }

  // Email verified and account is ACTIVE
  if (verificationStatus === "success") {
    return (
      <div className="space-y-6 text-center">
        <div className="mx-auto w-fit rounded-full bg-primary/10 p-4">
          <CheckCircle className="h-8 w-8 text-primary" />
        </div>
        <div className="space-y-2">
          <h1 className="text-2xl font-bold tracking-tight">Email Verified!</h1>
          <p className="text-sm text-muted-foreground">
            Your email has been successfully verified. You can now log in to your account.
          </p>
        </div>
        <Link href="/login">
          <Button className="w-full">Continue to Login</Button>
        </Link>
      </div>
    )
  }

  // Email verified but pending admin approval
  if (verificationStatus === "pending_approval") {
    return (
      <div className="space-y-6 text-center">
        <div className="mx-auto w-fit rounded-full bg-amber-500/10 p-4">
          <Clock className="h-8 w-8 text-amber-500" />
        </div>
        <div className="space-y-2">
          <h1 className="text-2xl font-bold tracking-tight">Email Verified!</h1>
          <p className="text-sm text-muted-foreground">
            Your email has been successfully verified. Your account is now pending approval by an administrator.
          </p>
        </div>
        
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-base">What happens next?</CardTitle>
          </CardHeader>
          <CardContent className="space-y-3 text-sm text-muted-foreground">
            <div className="flex items-start gap-3">
              <div className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-primary text-xs font-medium text-primary-foreground">
                ✓
              </div>
              <p className="text-left">Email verification complete</p>
            </div>
            <div className="flex items-start gap-3">
              <div className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-amber-500/10 text-xs font-medium text-amber-500">
                2
              </div>
              <p className="text-left">An administrator will review your registration</p>
            </div>
            <div className="flex items-start gap-3">
              <div className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-muted text-xs font-medium text-muted-foreground">
                3
              </div>
              <p className="text-left">You'll receive an email when your account is approved</p>
            </div>
          </CardContent>
        </Card>

        <p className="text-sm text-muted-foreground">
          This usually takes 1-2 business days. You'll be notified by email once approved.
        </p>

        <Link href="/login">
          <Button variant="outline" className="w-full">
            Back to Login
          </Button>
        </Link>
      </div>
    )
  }

  // Verification error
  if (verificationStatus === "error") {
    return (
      <div className="space-y-6 text-center">
        <div className="mx-auto w-fit rounded-full bg-destructive/10 p-4">
          <XCircle className="h-8 w-8 text-destructive" />
        </div>
        <div className="space-y-2">
          <h1 className="text-2xl font-bold tracking-tight">Verification Failed</h1>
          <p className="text-sm text-muted-foreground">
            {errorMessage || "This verification link is invalid or has expired."}
          </p>
        </div>
        <div className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="email">Enter your email to resend verification</Label>
            <Input
              id="email"
              type="email"
              placeholder="name@example.com"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
            />
          </div>
          <Button className="w-full" onClick={handleResend} disabled={isResending}>
            {isResending ? (
              <LoadingSpinner size="sm" className="mr-2" />
            ) : (
              <Mail className="mr-2 h-4 w-4" />
            )}
            Resend Verification Email
          </Button>
        </div>
        <Link href="/login">
          <Button variant="ghost" className="w-full">
            Back to Login
          </Button>
        </Link>
      </div>
    )
  }

  // No token provided - show resend form
  return (
    <div className="space-y-6">
      <div className="space-y-2 text-center">
        <h1 className="text-2xl font-bold tracking-tight">Verify Your Email</h1>
        <p className="text-sm text-muted-foreground">
          Enter your email to receive a verification link
        </p>
      </div>
      <div className="space-y-4">
        <div className="space-y-2">
          <Label htmlFor="email">Email</Label>
          <Input
            id="email"
            type="email"
            placeholder="name@example.com"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
          />
        </div>
        <Button className="w-full" onClick={handleResend} disabled={isResending}>
          {isResending ? (
            <LoadingSpinner size="sm" className="mr-2" />
          ) : (
            <Mail className="mr-2 h-4 w-4" />
          )}
          Send Verification Email
        </Button>
      </div>
      <Link href="/login">
        <Button variant="ghost" className="w-full">
          Back to Login
        </Button>
      </Link>
    </div>
  )
}

// ===== FILE: components\business\clients\client-form.tsx =====

"use client"

// ===== Client Form Component =====

import { useEffect, useState } from "react"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"

import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { RNCInput } from "@/components/business/common/rnc-input"
import { createClientSchema, type CreateClientFormData } from "@/lib/validations/business"
import { getLegalTypes } from "@/lib/api/business/clients"
import type { Client, LegalType } from "@/lib/types/business"

interface ClientFormProps {
  client?: Client | null
  onSubmit: (data: CreateClientFormData) => Promise<void>
  isLoading?: boolean
}

export function ClientForm({ client, onSubmit, isLoading = false }: ClientFormProps) {
  const [legalTypes, setLegalTypes] = useState<LegalType[]>([])
  const [isLoadingTypes, setIsLoadingTypes] = useState(true)

  const form = useForm<CreateClientFormData>({
    resolver: zodResolver(createClientSchema),
    defaultValues: {
      name: client?.name || "",
      legalName: client?.legalName || "",
      legalTypeId: client?.legalTypeId || "",
      rnc: client?.rnc || "",
      primaryEmail: client?.primaryEmail || "",
      secondaryEmail: client?.secondaryEmail || "",
      primaryPhone: client?.primaryPhone || "",
      secondaryPhone: client?.secondaryPhone || "",
      contactPerson: client?.contactPerson || "",
      billingAddressLine1: client?.billingAddressLine1 || "",
      billingAddressLine2: client?.billingAddressLine2 || "",
      billingCity: client?.billingCity || "",
      billingProvince: client?.billingProvince || "",
      billingPostalCode: client?.billingPostalCode || "",
      serviceAddressLine1: client?.serviceAddressLine1 || "",
      serviceAddressLine2: client?.serviceAddressLine2 || "",
      serviceCity: client?.serviceCity || "",
      serviceProvince: client?.serviceProvince || "",
      servicePostalCode: client?.servicePostalCode || "",
      notes: client?.notes || "",
    },
  })

  useEffect(() => {
    async function loadLegalTypes() {
      try {
        const types = await getLegalTypes()
        setLegalTypes(types)
      } catch (error) {
        console.error("Failed to load legal types:", error)
      } finally {
        setIsLoadingTypes(false)
      }
    }
    loadLegalTypes()
  }, [])

  const selectedLegalType = legalTypes.find((lt) => lt.id === form.watch("legalTypeId"))

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
        <Tabs defaultValue="general" className="w-full">
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="general">General</TabsTrigger>
            <TabsTrigger value="contact">Contacto</TabsTrigger>
            <TabsTrigger value="address">Direcciones</TabsTrigger>
          </TabsList>

          {/* General Tab */}
          <TabsContent value="general" className="space-y-4 pt-4">
            <div className="grid gap-4 sm:grid-cols-2">
              <FormField
                control={form.control}
                name="name"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Nombre comercial *</FormLabel>
                    <FormControl>
                      <Input placeholder="Nombre del cliente" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="legalName"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Razón social</FormLabel>
                    <FormControl>
                      <Input placeholder="Razón social legal" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <div className="grid gap-4 sm:grid-cols-2">
              <FormField
                control={form.control}
                name="legalTypeId"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Tipo legal *</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value} disabled={isLoadingTypes}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Seleccionar tipo" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {legalTypes.map((type) => (
                          <SelectItem key={type.id} value={type.id}>
                            {type.name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="rnc"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>RNC {selectedLegalType?.requiresRnc && "*"}</FormLabel>
                    <FormControl>
                      <RNCInput value={field.value} onChange={field.onChange} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <FormField
              control={form.control}
              name="notes"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Notas internas</FormLabel>
                  <FormControl>
                    <Textarea placeholder="Notas adicionales sobre el cliente..." {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
          </TabsContent>

          {/* Contact Tab */}
          <TabsContent value="contact" className="space-y-4 pt-4">
            <FormField
              control={form.control}
              name="contactPerson"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Persona de contacto</FormLabel>
                  <FormControl>
                    <Input placeholder="Nombre del contacto principal" {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="grid gap-4 sm:grid-cols-2">
              <FormField
                control={form.control}
                name="primaryEmail"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Email principal</FormLabel>
                    <FormControl>
                      <Input type="email" placeholder="email@ejemplo.com" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="secondaryEmail"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Email secundario</FormLabel>
                    <FormControl>
                      <Input type="email" placeholder="email2@ejemplo.com" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <div className="grid gap-4 sm:grid-cols-2">
              <FormField
                control={form.control}
                name="primaryPhone"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Teléfono principal</FormLabel>
                    <FormControl>
                      <Input type="tel" placeholder="809-000-0000" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="secondaryPhone"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Teléfono secundario</FormLabel>
                    <FormControl>
                      <Input type="tel" placeholder="809-000-0000" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
          </TabsContent>

          {/* Address Tab */}
          <TabsContent value="address" className="space-y-6 pt-4">
            {/* Billing Address */}
            <div className="space-y-4">
              <h4 className="font-medium">Dirección de facturación</h4>
              <FormField
                control={form.control}
                name="billingAddressLine1"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Dirección línea 1</FormLabel>
                    <FormControl>
                      <Input placeholder="Calle, número, edificio..." {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="billingAddressLine2"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Dirección línea 2</FormLabel>
                    <FormControl>
                      <Input placeholder="Suite, piso, apartamento..." {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <div className="grid gap-4 sm:grid-cols-3">
                <FormField
                  control={form.control}
                  name="billingCity"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Ciudad</FormLabel>
                      <FormControl>
                        <Input placeholder="Santo Domingo" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                <FormField
                  control={form.control}
                  name="billingProvince"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Provincia</FormLabel>
                      <FormControl>
                        <Input placeholder="Distrito Nacional" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                <FormField
                  control={form.control}
                  name="billingPostalCode"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Código postal</FormLabel>
                      <FormControl>
                        <Input placeholder="10000" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </div>
            </div>

            {/* Service Address */}
            <div className="space-y-4">
              <h4 className="font-medium">Dirección de servicio</h4>
              <FormField
                control={form.control}
                name="serviceAddressLine1"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Dirección línea 1</FormLabel>
                    <FormControl>
                      <Input placeholder="Calle, número, edificio..." {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="serviceAddressLine2"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Dirección línea 2</FormLabel>
                    <FormControl>
                      <Input placeholder="Suite, piso, apartamento..." {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <div className="grid gap-4 sm:grid-cols-3">
                <FormField
                  control={form.control}
                  name="serviceCity"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Ciudad</FormLabel>
                      <FormControl>
                        <Input placeholder="Santo Domingo" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                <FormField
                  control={form.control}
                  name="serviceProvince"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Provincia</FormLabel>
                      <FormControl>
                        <Input placeholder="Distrito Nacional" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                <FormField
                  control={form.control}
                  name="servicePostalCode"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Código postal</FormLabel>
                      <FormControl>
                        <Input placeholder="10000" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </div>
            </div>
          </TabsContent>
        </Tabs>

        <div className="flex justify-end gap-2 pt-4 border-t">
          <Button type="submit" disabled={isLoading}>
            {isLoading ? "Guardando..." : client ? "Actualizar cliente" : "Crear cliente"}
          </Button>
        </div>
      </form>
    </Form>
  )
}

// ===== FILE: components\business\clients\client-table.tsx =====

"use client"

// ===== Client Data Table =====

import { MoreHorizontal, Eye, Pencil, FileText, Receipt, Ban } from "lucide-react"
import Link from "next/link"

import { Button } from "@/components/ui/button"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { StatusBadge } from "@/components/business/common/status-badge"
import { PermissionGate } from "@/components/common/permission-gate"
import { formatDateDO, formatRNC } from "@/lib/utils/business"
import type { Client } from "@/lib/types/business"

interface ClientTableProps {
  clients: Client[]
  onEdit: (client: Client) => void
  onDeactivate: (client: Client) => void
}

export function ClientTable({ clients, onEdit, onDeactivate }: ClientTableProps) {
  return (
    <div className="rounded-lg border border-border">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Nombre</TableHead>
            <TableHead>RNC</TableHead>
            <TableHead>Tipo Legal</TableHead>
            <TableHead>Email</TableHead>
            <TableHead>Teléfono</TableHead>
            <TableHead>Estado</TableHead>
            <TableHead>Creado</TableHead>
            <TableHead className="w-[50px]" />
          </TableRow>
        </TableHeader>
        <TableBody>
          {clients.map((client) => (
            <TableRow key={client.id}>
              <TableCell>
                <div>
                  <Link href={`/business/clients/${client.id}`} className="font-medium hover:underline">
                    {client.name}
                  </Link>
                  {client.legalName && client.legalName !== client.name && (
                    <p className="text-sm text-muted-foreground">{client.legalName}</p>
                  )}
                </div>
              </TableCell>
              <TableCell className="font-mono text-sm">{client.rnc ? formatRNC(client.rnc) : "-"}</TableCell>
              <TableCell>{client.legalTypeName}</TableCell>
              <TableCell className="text-sm">{client.primaryEmail || "-"}</TableCell>
              <TableCell className="text-sm">{client.primaryPhone || "-"}</TableCell>
              <TableCell>
                <StatusBadge type="client" status={client.status} />
              </TableCell>
              <TableCell className="text-sm text-muted-foreground">{formatDateDO(client.createdAt)}</TableCell>
              <TableCell>
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="ghost" size="icon">
                      <MoreHorizontal className="h-4 w-4" />
                      <span className="sr-only">Abrir menú</span>
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuItem asChild>
                      <Link href={`/business/clients/${client.id}`}>
                        <Eye className="mr-2 h-4 w-4" />
                        Ver detalles
                      </Link>
                    </DropdownMenuItem>
                    <PermissionGate permissions={["BUSINESS_CLIENT_UPDATE"]}>
                      <DropdownMenuItem onClick={() => onEdit(client)}>
                        <Pencil className="mr-2 h-4 w-4" />
                        Editar
                      </DropdownMenuItem>
                    </PermissionGate>
                    <DropdownMenuSeparator />
                    <DropdownMenuItem asChild>
                      <Link href={`/business/contracts?clientId=${client.id}`}>
                        <FileText className="mr-2 h-4 w-4" />
                        Ver contratos
                      </Link>
                    </DropdownMenuItem>
                    <DropdownMenuItem asChild>
                      <Link href={`/business/invoices?clientId=${client.id}`}>
                        <Receipt className="mr-2 h-4 w-4" />
                        Ver facturas
                      </Link>
                    </DropdownMenuItem>
                    {client.status === "ACTIVE" && (
                      <>
                        <DropdownMenuSeparator />
                        <PermissionGate permissions={["BUSINESS_CLIENT_DELETE"]}>
                          <DropdownMenuItem
                            onClick={() => onDeactivate(client)}
                            className="text-destructive focus:text-destructive"
                          >
                            <Ban className="mr-2 h-4 w-4" />
                            Desactivar
                          </DropdownMenuItem>
                        </PermissionGate>
                      </>
                    )}
                  </DropdownMenuContent>
                </DropdownMenu>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  )
}

// ===== FILE: components\business\clients\create-client-dialog.tsx =====

"use client"

// ===== Create Client Dialog =====

import { useState } from "react"
import { toast } from "sonner"

import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { ClientForm } from "./client-form"
import { createClient } from "@/lib/api/business/clients"
import type { CreateClientFormData } from "@/lib/validations/business"

interface CreateClientDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess?: () => void
}

export function CreateClientDialog({ open, onOpenChange, onSuccess }: CreateClientDialogProps) {
  const [isLoading, setIsLoading] = useState(false)

  async function handleSubmit(data: CreateClientFormData) {
    setIsLoading(true)
    try {
      const response = await createClient(data)
      if (response.success) {
        toast.success("Cliente creado exitosamente")
        onOpenChange(false)
        onSuccess?.()
      } else {
        toast.error(response.message || "Error al crear cliente")
      }
    } catch {
      toast.error("Error al crear cliente")
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Nuevo Cliente</DialogTitle>
          <DialogDescription>Complete la información del nuevo cliente</DialogDescription>
        </DialogHeader>
        <ClientForm onSubmit={handleSubmit} isLoading={isLoading} />
      </DialogContent>
    </Dialog>
  )
}

// ===== FILE: components\business\clients\edit-client-dialog.tsx =====

"use client"

// ===== Edit Client Dialog =====

import { useState } from "react"
import { toast } from "sonner"

import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { ClientForm } from "./client-form"
import { updateClient } from "@/lib/api/business/clients"
import type { Client } from "@/lib/types/business"
import type { CreateClientFormData } from "@/lib/validations/business"

interface EditClientDialogProps {
  client: Client | null
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess?: () => void
}

export function EditClientDialog({ client, open, onOpenChange, onSuccess }: EditClientDialogProps) {
  const [isLoading, setIsLoading] = useState(false)

  async function handleSubmit(data: CreateClientFormData) {
    if (!client) return

    setIsLoading(true)
    try {
      const response = await updateClient(client.id, data)
      if (response.success) {
        toast.success("Cliente actualizado exitosamente")
        onOpenChange(false)
        onSuccess?.()
      } else {
        toast.error(response.message || "Error al actualizar cliente")
      }
    } catch {
      toast.error("Error al actualizar cliente")
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Editar Cliente</DialogTitle>
          <DialogDescription>Modifique la información del cliente</DialogDescription>
        </DialogHeader>
        {client && <ClientForm client={client} onSubmit={handleSubmit} isLoading={isLoading} />}
      </DialogContent>
    </Dialog>
  )
}

// ===== FILE: components\business\common\client-selector.tsx =====

"use client"

// ===== Searchable Client Selector =====

import { useState, useEffect } from "react"
import { Check, ChevronsUpDown, Building2 } from "lucide-react"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from "@/components/ui/command"
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover"
import { getClients } from "@/lib/api/business/clients"
import type { Client } from "@/lib/types/business"

interface ClientSelectorProps {
  value?: string
  onValueChange: (value: string, client?: Client) => void
  placeholder?: string
  disabled?: boolean
  className?: string
}

export function ClientSelector({
  value,
  onValueChange,
  placeholder = "Seleccionar cliente...",
  disabled = false,
  className,
}: ClientSelectorProps) {
  const [open, setOpen] = useState(false)
  const [clients, setClients] = useState<Client[]>([])
  const [isLoading, setIsLoading] = useState(false)

  useEffect(() => {
    async function loadClients() {
      setIsLoading(true)
      try {
        const response = await getClients(0, 100, "ACTIVE")
        setClients(response.content)
      } catch (error) {
        console.error("Failed to load clients:", error)
      } finally {
        setIsLoading(false)
      }
    }
    loadClients()
  }, [])

  const selectedClient = clients.find((c) => c.id === value)

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        <Button
          variant="outline"
          role="combobox"
          aria-expanded={open}
          disabled={disabled}
          className={cn("w-full justify-between", className)}
        >
          {selectedClient ? (
            <span className="flex items-center gap-2">
              <Building2 className="h-4 w-4 text-muted-foreground" />
              {selectedClient.name}
            </span>
          ) : (
            <span className="text-muted-foreground">{placeholder}</span>
          )}
          <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-[400px] p-0" align="start">
        <Command>
          <CommandInput placeholder="Buscar cliente..." />
          <CommandList>
            <CommandEmpty>{isLoading ? "Cargando..." : "No se encontraron clientes."}</CommandEmpty>
            <CommandGroup>
              {clients.map((client) => (
                <CommandItem
                  key={client.id}
                  value={client.name}
                  onSelect={() => {
                    onValueChange(client.id, client)
                    setOpen(false)
                  }}
                >
                  <Check className={cn("mr-2 h-4 w-4", value === client.id ? "opacity-100" : "opacity-0")} />
                  <div className="flex flex-col">
                    <span>{client.name}</span>
                    {client.rnc && <span className="text-xs text-muted-foreground">RNC: {client.rnc}</span>}
                  </div>
                </CommandItem>
              ))}
            </CommandGroup>
          </CommandList>
        </Command>
      </PopoverContent>
    </Popover>
  )
}

// ===== FILE: components\business\common\currency-input.tsx =====

"use client"

import type React from "react"

// ===== Currency Input Component (DOP) =====

import { forwardRef, useState, useEffect } from "react"
import { Input } from "@/components/ui/input"
import { cn } from "@/lib/utils"

interface CurrencyInputProps extends Omit<React.InputHTMLAttributes<HTMLInputElement>, "onChange" | "value"> {
  value?: number
  onChange?: (value: number) => void
  currency?: string
}

export const CurrencyInput = forwardRef<HTMLInputElement, CurrencyInputProps>(
  ({ value, onChange, currency = "RD$", className, ...props }, ref) => {
    const [displayValue, setDisplayValue] = useState("")

    useEffect(() => {
      if (value !== undefined) {
        setDisplayValue(formatForDisplay(value))
      }
    }, [value])

    function formatForDisplay(num: number): string {
      return new Intl.NumberFormat("es-DO", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      }).format(num)
    }

    function parseFromDisplay(str: string): number {
      // Remove thousands separators and convert decimal separator
      const cleaned = str.replace(/[^\d,.-]/g, "").replace(",", ".")
      const parsed = Number.parseFloat(cleaned)
      return isNaN(parsed) ? 0 : parsed
    }

    function handleChange(e: React.ChangeEvent<HTMLInputElement>) {
      const rawValue = e.target.value
      setDisplayValue(rawValue)
    }

    function handleBlur() {
      const numValue = parseFromDisplay(displayValue)
      setDisplayValue(formatForDisplay(numValue))
      onChange?.(numValue)
    }

    return (
      <div className="relative">
        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground text-sm">{currency}</span>
        <Input
          ref={ref}
          type="text"
          inputMode="decimal"
          value={displayValue}
          onChange={handleChange}
          onBlur={handleBlur}
          className={cn("pl-12 text-right tabular-nums", className)}
          {...props}
        />
      </div>
    )
  },
)

CurrencyInput.displayName = "CurrencyInput"

// ===== FILE: components\business\common\money-display.tsx =====

// ===== Money Display Component =====

import { cn } from "@/lib/utils"
import { formatDOP, formatAmount } from "@/lib/utils/business"

interface MoneyDisplayProps {
  amount: number
  currency?: string
  showSymbol?: boolean
  className?: string
  size?: "sm" | "md" | "lg"
}

export function MoneyDisplay({
  amount,
  currency = "DOP",
  showSymbol = true,
  className,
  size = "md",
}: MoneyDisplayProps) {
  const formatted = showSymbol ? formatDOP(amount) : formatAmount(amount)

  const sizeClasses = {
    sm: "text-sm",
    md: "text-base",
    lg: "text-2xl font-bold",
  }

  return <span className={cn("tabular-nums", sizeClasses[size], className)}>{formatted}</span>
}

// ===== FILE: components\business\common\rnc-input.tsx =====

"use client"

import type React from "react"

// ===== RNC Input Component with Validation =====

import { forwardRef, useState, useEffect } from "react"
import { Input } from "@/components/ui/input"
import { cn } from "@/lib/utils"
import { validateRNC, formatRNC } from "@/lib/utils/business"

interface RNCInputProps extends Omit<React.InputHTMLAttributes<HTMLInputElement>, "onChange" | "value"> {
  value?: string
  onChange?: (value: string) => void
  showValidation?: boolean
}

export const RNCInput = forwardRef<HTMLInputElement, RNCInputProps>(
  ({ value = "", onChange, showValidation = true, className, ...props }, ref) => {
    const [displayValue, setDisplayValue] = useState("")
    const [isValid, setIsValid] = useState(true)

    useEffect(() => {
      if (value) {
        setDisplayValue(formatRNC(value))
        setIsValid(validateRNC(value))
      } else {
        setDisplayValue("")
        setIsValid(true)
      }
    }, [value])

    function handleChange(e: React.ChangeEvent<HTMLInputElement>) {
      const rawValue = e.target.value.replace(/[^\d-]/g, "")
      setDisplayValue(rawValue)

      // Clean for API
      const cleaned = rawValue.replace(/-/g, "")
      onChange?.(cleaned)

      if (cleaned.length > 0) {
        setIsValid(validateRNC(cleaned))
      } else {
        setIsValid(true)
      }
    }

    function handleBlur() {
      if (displayValue) {
        const cleaned = displayValue.replace(/-/g, "")
        setDisplayValue(formatRNC(cleaned))
      }
    }

    return (
      <Input
        ref={ref}
        type="text"
        value={displayValue}
        onChange={handleChange}
        onBlur={handleBlur}
        placeholder="000-00000-0"
        className={cn(
          "font-mono",
          showValidation && !isValid && displayValue.length > 0 && "border-red-500 focus-visible:ring-red-500",
          className,
        )}
        {...props}
      />
    )
  },
)

RNCInput.displayName = "RNCInput"

// ===== FILE: components\business\common\service-selector.tsx =====

"use client"

// ===== Searchable Service Selector =====

import { useState, useEffect } from "react"
import { Check, ChevronsUpDown, Briefcase } from "lucide-react"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from "@/components/ui/command"
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover"
import { getServices } from "@/lib/api/business/services"
import type { ServiceCatalog } from "@/lib/types/business"

interface ServiceSelectorProps {
  value?: string
  onValueChange: (value: string, service?: ServiceCatalog) => void
  placeholder?: string
  disabled?: boolean
  className?: string
}

export function ServiceSelector({
  value,
  onValueChange,
  placeholder = "Seleccionar servicio...",
  disabled = false,
  className,
}: ServiceSelectorProps) {
  const [open, setOpen] = useState(false)
  const [services, setServices] = useState<ServiceCatalog[]>([])
  const [isLoading, setIsLoading] = useState(false)

  useEffect(() => {
    async function loadServices() {
      setIsLoading(true)
      try {
        const data = await getServices(true)
        setServices(data)
      } catch (error) {
        console.error("Failed to load services:", error)
      } finally {
        setIsLoading(false)
      }
    }
    loadServices()
  }, [])

  const selectedService = services.find((s) => s.id === value)

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        <Button
          variant="outline"
          role="combobox"
          aria-expanded={open}
          disabled={disabled}
          className={cn("w-full justify-between", className)}
        >
          {selectedService ? (
            <span className="flex items-center gap-2">
              <Briefcase className="h-4 w-4 text-muted-foreground" />
              {selectedService.code} - {selectedService.name}
            </span>
          ) : (
            <span className="text-muted-foreground">{placeholder}</span>
          )}
          <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-[400px] p-0" align="start">
        <Command>
          <CommandInput placeholder="Buscar servicio..." />
          <CommandList>
            <CommandEmpty>{isLoading ? "Cargando..." : "No se encontraron servicios."}</CommandEmpty>
            <CommandGroup>
              {services.map((service) => (
                <CommandItem
                  key={service.id}
                  value={`${service.code} ${service.name}`}
                  onSelect={() => {
                    onValueChange(service.id, service)
                    setOpen(false)
                  }}
                >
                  <Check className={cn("mr-2 h-4 w-4", value === service.id ? "opacity-100" : "opacity-0")} />
                  <div className="flex flex-col">
                    <span>
                      <span className="font-mono text-xs text-muted-foreground mr-2">{service.code}</span>
                      {service.name}
                    </span>
                    <span className="text-xs text-muted-foreground">{service.billingUnitName}</span>
                  </div>
                </CommandItem>
              ))}
            </CommandGroup>
          </CommandList>
        </Command>
      </PopoverContent>
    </Popover>
  )
}

// ===== FILE: components\business\common\status-badge.tsx =====

// ===== Generic Status Badge Component =====

import { Badge } from "@/components/ui/badge"
import { cn } from "@/lib/utils"
import type { ClientStatus, ContractStatus, InvoiceStatus, PaymentStatus } from "@/lib/types/business"
import {
  getClientStatusColor,
  getClientStatusLabel,
  getContractStatusColor,
  getContractStatusLabel,
  getInvoiceStatusColor,
  getInvoiceStatusLabel,
  getPaymentStatusColor,
  getPaymentStatusLabel,
} from "@/lib/utils/business"

type StatusType = "client" | "contract" | "invoice" | "payment"
type StatusValue = ClientStatus | ContractStatus | InvoiceStatus | PaymentStatus

interface StatusBadgeProps {
  type: StatusType
  status: StatusValue
  className?: string
}

export function StatusBadge({ type, status, className }: StatusBadgeProps) {
  let colorClass: string
  let label: string

  switch (type) {
    case "client":
      colorClass = getClientStatusColor(status as ClientStatus)
      label = getClientStatusLabel(status as ClientStatus)
      break
    case "contract":
      colorClass = getContractStatusColor(status as ContractStatus)
      label = getContractStatusLabel(status as ContractStatus)
      break
    case "invoice":
      colorClass = getInvoiceStatusColor(status as InvoiceStatus)
      label = getInvoiceStatusLabel(status as InvoiceStatus)
      break
    case "payment":
      colorClass = getPaymentStatusColor(status as PaymentStatus)
      label = getPaymentStatusLabel(status as PaymentStatus)
      break
    default:
      colorClass = "text-gray-500 bg-gray-500/10"
      label = status
  }

  return (
    <Badge variant="outline" className={cn("border font-medium", colorClass, className)}>
      {label}
    </Badge>
  )
}

// ===== FILE: components\business\contracts\contract-table.tsx =====

"use client"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { Button } from "@/components/ui/button"
import { Checkbox } from "@/components/ui/checkbox"
import { MoreHorizontal, Eye, Pencil, FileText, XCircle, CheckCircle, RotateCcw } from "lucide-react"
import type { Contract } from "@/lib/types/business"
import { StatusBadge } from "../common/status-badge"
import { MoneyDisplay } from "../common/money-display"
import { formatDate } from "@/lib/utils/business"
import Link from "next/link"

interface ContractTableProps {
  contracts: Contract[]
  selectedIds: string[]
  onSelectChange: (ids: string[]) => void
  onEdit: (contract: Contract) => void
  onCancel: (contract: Contract) => void
  onActivate: (contract: Contract) => void
  onRenew: (contract: Contract) => void
}

export function ContractTable({
  contracts,
  selectedIds,
  onSelectChange,
  onEdit,
  onCancel,
  onActivate,
  onRenew,
}: ContractTableProps) {
  const allSelected = contracts.length > 0 && selectedIds.length === contracts.length
  const someSelected = selectedIds.length > 0 && selectedIds.length < contracts.length

  const toggleAll = () => {
    if (allSelected) {
      onSelectChange([])
    } else {
      onSelectChange(contracts.map((c) => c.id))
    }
  }

  const toggleOne = (id: string) => {
    if (selectedIds.includes(id)) {
      onSelectChange(selectedIds.filter((i) => i !== id))
    } else {
      onSelectChange([...selectedIds, id])
    }
  }

  return (
    <div className="rounded-md border">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead className="w-12">
              <Checkbox
                checked={allSelected}
                onCheckedChange={toggleAll}
                aria-label="Seleccionar todos"
                className={someSelected ? "opacity-50" : ""}
              />
            </TableHead>
            <TableHead>Número</TableHead>
            <TableHead>Cliente</TableHead>
            <TableHead>Tipo</TableHead>
            <TableHead>Vigencia</TableHead>
            <TableHead className="text-right">Valor Mensual</TableHead>
            <TableHead>Estado</TableHead>
            <TableHead className="w-12"></TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {contracts.map((contract) => (
            <TableRow key={contract.id}>
              <TableCell>
                <Checkbox
                  checked={selectedIds.includes(contract.id)}
                  onCheckedChange={() => toggleOne(contract.id)}
                  aria-label={`Seleccionar contrato ${contract.contractNumber}`}
                />
              </TableCell>
              <TableCell className="font-medium">
                <Link href={`/business/contracts/${contract.id}`} className="text-emerald-600 hover:underline">
                  {contract.contractNumber}
                </Link>
              </TableCell>
              <TableCell>
                <div>
                  <p className="font-medium">{contract.client?.companyName}</p>
                  <p className="text-sm text-muted-foreground">{contract.client?.rnc}</p>
                </div>
              </TableCell>
              <TableCell>
                <span className="capitalize">{contract.contractType === "fixed" ? "Precio Fijo" : "Por Hora"}</span>
              </TableCell>
              <TableCell>
                <div className="text-sm">
                  <p>{formatDate(contract.startDate)}</p>
                  <p className="text-muted-foreground">
                    {contract.endDate ? formatDate(contract.endDate) : "Indefinido"}
                  </p>
                </div>
              </TableCell>
              <TableCell className="text-right">
                <MoneyDisplay amount={contract.monthlyValue} />
              </TableCell>
              <TableCell>
                <StatusBadge status={contract.status} type="contract" />
              </TableCell>
              <TableCell>
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="ghost" size="icon">
                      <MoreHorizontal className="h-4 w-4" />
                      <span className="sr-only">Acciones</span>
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuItem asChild>
                      <Link href={`/business/contracts/${contract.id}`}>
                        <Eye className="mr-2 h-4 w-4" />
                        Ver Detalle
                      </Link>
                    </DropdownMenuItem>
                    {contract.status === "draft" && (
                      <DropdownMenuItem onClick={() => onEdit(contract)}>
                        <Pencil className="mr-2 h-4 w-4" />
                        Editar
                      </DropdownMenuItem>
                    )}
                    <DropdownMenuItem asChild>
                      <Link href={`/business/invoices?contractId=${contract.id}`}>
                        <FileText className="mr-2 h-4 w-4" />
                        Ver Facturas
                      </Link>
                    </DropdownMenuItem>
                    <DropdownMenuSeparator />
                    {contract.status === "draft" && (
                      <DropdownMenuItem onClick={() => onActivate(contract)}>
                        <CheckCircle className="mr-2 h-4 w-4" />
                        Activar
                      </DropdownMenuItem>
                    )}
                    {contract.status === "active" && (
                      <DropdownMenuItem onClick={() => onRenew(contract)}>
                        <RotateCcw className="mr-2 h-4 w-4" />
                        Renovar
                      </DropdownMenuItem>
                    )}
                    {(contract.status === "draft" || contract.status === "active") && (
                      <DropdownMenuItem onClick={() => onCancel(contract)} className="text-destructive">
                        <XCircle className="mr-2 h-4 w-4" />
                        Cancelar
                      </DropdownMenuItem>
                    )}
                  </DropdownMenuContent>
                </DropdownMenu>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  )
}

// ===== FILE: components\business\contracts\contract-wizard.tsx =====

"use client"

import { TableCell } from "@/components/ui/table"

import { TableBody } from "@/components/ui/table"

import { TableHead } from "@/components/ui/table"

import { TableRow } from "@/components/ui/table"

import { TableHeader } from "@/components/ui/table"

import { Table } from "@/components/ui/table"

import { useState } from "react"
import { useForm, useFieldArray } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Switch } from "@/components/ui/switch"
import { Separator } from "@/components/ui/separator"
import { Check, ChevronLeft, ChevronRight, Plus, Trash2 } from "lucide-react"
import { cn } from "@/lib/utils"
import { contractSchema, type ContractFormData } from "@/lib/validations/business"
import { ClientSelector } from "../common/client-selector"
import { ServiceSelector } from "../common/service-selector"
import { CurrencyInput } from "../common/currency-input"
import { MoneyDisplay } from "../common/money-display"
import { calculateITBIS, calculateSubtotal, calculateTotal } from "@/lib/utils/business"

interface ContractWizardProps {
  onSubmit: (data: ContractFormData) => Promise<void>
  onCancel: () => void
  isLoading?: boolean
}

const steps = [
  { id: 1, name: "Cliente", description: "Seleccionar cliente" },
  { id: 2, name: "Servicios", description: "Agregar líneas de servicio" },
  { id: 3, name: "Términos", description: "Definir condiciones" },
  { id: 4, name: "Revisión", description: "Confirmar contrato" },
]

export function ContractWizard({ onSubmit, onCancel, isLoading }: ContractWizardProps) {
  const [currentStep, setCurrentStep] = useState(1)

  const form = useForm<ContractFormData>({
    resolver: zodResolver(contractSchema),
    defaultValues: {
      clientId: "",
      contractType: "fixed",
      startDate: new Date().toISOString().split("T")[0],
      endDate: "",
      autoRenew: true,
      renewalNoticeDays: 30,
      billingDay: 1,
      paymentTermDays: 30,
      lines: [],
      notes: "",
    },
  })

  const { fields, append, remove } = useFieldArray({
    control: form.control,
    name: "lines",
  })

  const watchLines = form.watch("lines")
  const subtotal = calculateSubtotal(watchLines.map((l) => ({ ...l, subtotal: l.quantity * l.unitPrice })))
  const itbis = calculateITBIS(
    watchLines.map((l) => ({
      ...l,
      subtotal: l.quantity * l.unitPrice,
      itbisAmount: l.applyItbis ? l.quantity * l.unitPrice * 0.18 : 0,
    })),
  )
  const total = calculateTotal(subtotal, itbis)

  const nextStep = async () => {
    let fieldsToValidate: (keyof ContractFormData)[] = []

    switch (currentStep) {
      case 1:
        fieldsToValidate = ["clientId"]
        break
      case 2:
        fieldsToValidate = ["lines"]
        break
      case 3:
        fieldsToValidate = ["startDate", "billingDay", "paymentTermDays"]
        break
    }

    const isValid = await form.trigger(fieldsToValidate)
    if (isValid) {
      setCurrentStep((prev) => Math.min(prev + 1, 4))
    }
  }

  const prevStep = () => {
    setCurrentStep((prev) => Math.max(prev - 1, 1))
  }

  const handleSubmit = form.handleSubmit(async (data) => {
    await onSubmit(data)
  })

  const addServiceLine = () => {
    append({
      serviceId: "",
      description: "",
      quantity: 1,
      unitPrice: 0,
      applyItbis: true,
    })
  }

  return (
    <div className="space-y-6">
      {/* Step Indicator */}
      <nav aria-label="Progreso">
        <ol className="flex items-center">
          {steps.map((step, index) => (
            <li key={step.id} className={cn("relative", index !== steps.length - 1 && "flex-1")}>
              <div className="flex items-center">
                <span
                  className={cn(
                    "flex h-10 w-10 items-center justify-center rounded-full border-2 text-sm font-medium",
                    step.id < currentStep
                      ? "border-emerald-600 bg-emerald-600 text-white"
                      : step.id === currentStep
                        ? "border-emerald-600 text-emerald-600"
                        : "border-muted-foreground/25 text-muted-foreground",
                  )}
                >
                  {step.id < currentStep ? <Check className="h-5 w-5" /> : step.id}
                </span>
                {index !== steps.length - 1 && (
                  <div
                    className={cn(
                      "ml-4 h-0.5 w-full",
                      step.id < currentStep ? "bg-emerald-600" : "bg-muted-foreground/25",
                    )}
                  />
                )}
              </div>
              <div className="mt-2">
                <span className="text-sm font-medium">{step.name}</span>
                <p className="text-xs text-muted-foreground">{step.description}</p>
              </div>
            </li>
          ))}
        </ol>
      </nav>

      <Form {...form}>
        <form onSubmit={handleSubmit}>
          {/* Step 1: Client Selection */}
          {currentStep === 1 && (
            <Card>
              <CardHeader>
                <CardTitle>Seleccionar Cliente</CardTitle>
                <CardDescription>Seleccione el cliente para este contrato</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <FormField
                  control={form.control}
                  name="clientId"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Cliente *</FormLabel>
                      <FormControl>
                        <ClientSelector value={field.value} onChange={field.onChange} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="contractType"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Tipo de Contrato *</FormLabel>
                      <Select onValueChange={field.onChange} value={field.value}>
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Seleccionar tipo" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          <SelectItem value="fixed">Precio Fijo</SelectItem>
                          <SelectItem value="hourly">Por Hora</SelectItem>
                        </SelectContent>
                      </Select>
                      <FormDescription>
                        Precio Fijo: tarifa mensual fija. Por Hora: facturación según horas trabajadas.
                      </FormDescription>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </CardContent>
            </Card>
          )}

          {/* Step 2: Service Lines */}
          {currentStep === 2 && (
            <Card>
              <CardHeader>
                <CardTitle>Líneas de Servicio</CardTitle>
                <CardDescription>Agregue los servicios incluidos en este contrato</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                {fields.map((field, index) => (
                  <div key={field.id} className="rounded-lg border p-4 space-y-4">
                    <div className="flex items-center justify-between">
                      <h4 className="font-medium">Línea {index + 1}</h4>
                      <Button type="button" variant="ghost" size="icon" onClick={() => remove(index)}>
                        <Trash2 className="h-4 w-4 text-destructive" />
                      </Button>
                    </div>

                    <div className="grid gap-4 md:grid-cols-2">
                      <FormField
                        control={form.control}
                        name={`lines.${index}.serviceId`}
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Servicio *</FormLabel>
                            <FormControl>
                              <ServiceSelector value={field.value} onChange={field.onChange} />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      <FormField
                        control={form.control}
                        name={`lines.${index}.description`}
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Descripción</FormLabel>
                            <FormControl>
                              <Input {...field} placeholder="Descripción adicional" />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      <FormField
                        control={form.control}
                        name={`lines.${index}.quantity`}
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Cantidad *</FormLabel>
                            <FormControl>
                              <Input
                                type="number"
                                min={1}
                                {...field}
                                onChange={(e) => field.onChange(Number(e.target.value))}
                              />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      <FormField
                        control={form.control}
                        name={`lines.${index}.unitPrice`}
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Precio Unitario *</FormLabel>
                            <FormControl>
                              <CurrencyInput value={field.value} onChange={field.onChange} />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>

                    <FormField
                      control={form.control}
                      name={`lines.${index}.applyItbis`}
                      render={({ field }) => (
                        <FormItem className="flex items-center justify-between rounded-lg border p-3">
                          <div className="space-y-0.5">
                            <FormLabel>Aplicar ITBIS (18%)</FormLabel>
                            <FormDescription>Incluir impuesto en esta línea</FormDescription>
                          </div>
                          <FormControl>
                            <Switch checked={field.value} onCheckedChange={field.onChange} />
                          </FormControl>
                        </FormItem>
                      )}
                    />

                    <div className="text-right text-sm">
                      <span className="text-muted-foreground">Subtotal: </span>
                      <MoneyDisplay amount={(watchLines[index]?.quantity || 0) * (watchLines[index]?.unitPrice || 0)} />
                    </div>
                  </div>
                ))}

                <Button type="button" variant="outline" onClick={addServiceLine} className="w-full bg-transparent">
                  <Plus className="mr-2 h-4 w-4" />
                  Agregar Línea
                </Button>

                {fields.length > 0 && (
                  <>
                    <Separator />
                    <div className="space-y-2 text-right">
                      <div className="flex justify-end gap-4">
                        <span className="text-muted-foreground">Subtotal:</span>
                        <MoneyDisplay amount={subtotal} className="font-medium" />
                      </div>
                      <div className="flex justify-end gap-4">
                        <span className="text-muted-foreground">ITBIS (18%):</span>
                        <MoneyDisplay amount={itbis} className="font-medium" />
                      </div>
                      <div className="flex justify-end gap-4 text-lg">
                        <span className="font-semibold">Total Mensual:</span>
                        <MoneyDisplay amount={total} className="font-bold text-emerald-600" />
                      </div>
                    </div>
                  </>
                )}

                {form.formState.errors.lines && (
                  <p className="text-sm text-destructive">
                    {form.formState.errors.lines.message || "Debe agregar al menos una línea de servicio"}
                  </p>
                )}
              </CardContent>
            </Card>
          )}

          {/* Step 3: Contract Terms */}
          {currentStep === 3 && (
            <Card>
              <CardHeader>
                <CardTitle>Términos del Contrato</CardTitle>
                <CardDescription>Configure las condiciones de vigencia y facturación</CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="grid gap-4 md:grid-cols-2">
                  <FormField
                    control={form.control}
                    name="startDate"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Fecha de Inicio *</FormLabel>
                        <FormControl>
                          <Input type="date" {...field} />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="endDate"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Fecha de Fin</FormLabel>
                        <FormControl>
                          <Input type="date" {...field} />
                        </FormControl>
                        <FormDescription>Dejar vacío para contrato indefinido</FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                <FormField
                  control={form.control}
                  name="autoRenew"
                  render={({ field }) => (
                    <FormItem className="flex items-center justify-between rounded-lg border p-4">
                      <div className="space-y-0.5">
                        <FormLabel>Renovación Automática</FormLabel>
                        <FormDescription>El contrato se renovará automáticamente al vencer</FormDescription>
                      </div>
                      <FormControl>
                        <Switch checked={field.value} onCheckedChange={field.onChange} />
                      </FormControl>
                    </FormItem>
                  )}
                />

                {form.watch("autoRenew") && (
                  <FormField
                    control={form.control}
                    name="renewalNoticeDays"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Días de Aviso para Renovación</FormLabel>
                        <FormControl>
                          <Input
                            type="number"
                            min={1}
                            {...field}
                            onChange={(e) => field.onChange(Number(e.target.value))}
                          />
                        </FormControl>
                        <FormDescription>Días de anticipación para notificar sobre la renovación</FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                )}

                <Separator />

                <div className="grid gap-4 md:grid-cols-2">
                  <FormField
                    control={form.control}
                    name="billingDay"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Día de Facturación *</FormLabel>
                        <FormControl>
                          <Input
                            type="number"
                            min={1}
                            max={28}
                            {...field}
                            onChange={(e) => field.onChange(Number(e.target.value))}
                          />
                        </FormControl>
                        <FormDescription>Día del mes en que se genera la factura (1-28)</FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="paymentTermDays"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Días de Crédito *</FormLabel>
                        <FormControl>
                          <Input
                            type="number"
                            min={0}
                            {...field}
                            onChange={(e) => field.onChange(Number(e.target.value))}
                          />
                        </FormControl>
                        <FormDescription>Días para pago después de emitida la factura</FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                <FormField
                  control={form.control}
                  name="notes"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Notas Internas</FormLabel>
                      <FormControl>
                        <Textarea {...field} placeholder="Notas o comentarios sobre este contrato..." rows={3} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </CardContent>
            </Card>
          )}

          {/* Step 4: Review */}
          {currentStep === 4 && (
            <Card>
              <CardHeader>
                <CardTitle>Revisión del Contrato</CardTitle>
                <CardDescription>Revise los detalles antes de crear el contrato</CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="grid gap-6 md:grid-cols-2">
                  <div className="space-y-4">
                    <h4 className="font-semibold">Información General</h4>
                    <dl className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <dt className="text-muted-foreground">Tipo de Contrato:</dt>
                        <dd className="font-medium">
                          {form.watch("contractType") === "fixed" ? "Precio Fijo" : "Por Hora"}
                        </dd>
                      </div>
                      <div className="flex justify-between">
                        <dt className="text-muted-foreground">Fecha de Inicio:</dt>
                        <dd className="font-medium">{form.watch("startDate")}</dd>
                      </div>
                      <div className="flex justify-between">
                        <dt className="text-muted-foreground">Fecha de Fin:</dt>
                        <dd className="font-medium">{form.watch("endDate") || "Indefinido"}</dd>
                      </div>
                      <div className="flex justify-between">
                        <dt className="text-muted-foreground">Renovación Automática:</dt>
                        <dd className="font-medium">{form.watch("autoRenew") ? "Sí" : "No"}</dd>
                      </div>
                    </dl>
                  </div>

                  <div className="space-y-4">
                    <h4 className="font-semibold">Facturación</h4>
                    <dl className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <dt className="text-muted-foreground">Día de Facturación:</dt>
                        <dd className="font-medium">{form.watch("billingDay")}</dd>
                      </div>
                      <div className="flex justify-between">
                        <dt className="text-muted-foreground">Días de Crédito:</dt>
                        <dd className="font-medium">{form.watch("paymentTermDays")}</dd>
                      </div>
                    </dl>
                  </div>
                </div>

                <Separator />

                <div className="space-y-4">
                  <h4 className="font-semibold">Líneas de Servicio ({fields.length})</h4>
                  <div className="rounded-lg border">
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead>Servicio</TableHead>
                          <TableHead className="text-right">Cantidad</TableHead>
                          <TableHead className="text-right">Precio Unit.</TableHead>
                          <TableHead className="text-right">ITBIS</TableHead>
                          <TableHead className="text-right">Subtotal</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {watchLines.map((line, index) => (
                          <TableRow key={index}>
                            <TableCell>{line.description || `Servicio ${index + 1}`}</TableCell>
                            <TableCell className="text-right">{line.quantity}</TableCell>
                            <TableCell className="text-right">
                              <MoneyDisplay amount={line.unitPrice} />
                            </TableCell>
                            <TableCell className="text-right">{line.applyItbis ? "18%" : "N/A"}</TableCell>
                            <TableCell className="text-right">
                              <MoneyDisplay amount={line.quantity * line.unitPrice} />
                            </TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </div>
                </div>

                <div className="flex justify-end">
                  <div className="w-64 space-y-2">
                    <div className="flex justify-between text-sm">
                      <span className="text-muted-foreground">Subtotal:</span>
                      <MoneyDisplay amount={subtotal} />
                    </div>
                    <div className="flex justify-between text-sm">
                      <span className="text-muted-foreground">ITBIS (18%):</span>
                      <MoneyDisplay amount={itbis} />
                    </div>
                    <Separator />
                    <div className="flex justify-between text-lg font-bold">
                      <span>Total Mensual:</span>
                      <MoneyDisplay amount={total} className="text-emerald-600" />
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Navigation Buttons */}
          <div className="flex justify-between pt-6">
            <Button type="button" variant="outline" onClick={onCancel}>
              Cancelar
            </Button>
            <div className="flex gap-2">
              {currentStep > 1 && (
                <Button type="button" variant="outline" onClick={prevStep}>
                  <ChevronLeft className="mr-2 h-4 w-4" />
                  Anterior
                </Button>
              )}
              {currentStep < 4 ? (
                <Button type="button" onClick={nextStep}>
                  Siguiente
                  <ChevronRight className="ml-2 h-4 w-4" />
                </Button>
              ) : (
                <Button type="submit" disabled={isLoading}>
                  {isLoading ? "Creando..." : "Crear Contrato"}
                </Button>
              )}
            </div>
          </div>
        </form>
      </Form>
    </div>
  )
}

// ===== FILE: components\business\invoices\create-invoice-dialog.tsx =====

"use client"

import { useState } from "react"
import { useForm, useFieldArray } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Switch } from "@/components/ui/switch"
import { Separator } from "@/components/ui/separator"
import { Plus, Trash2 } from "lucide-react"
import { invoiceSchema, type InvoiceFormData } from "@/lib/validations/business"
import { ClientSelector } from "../common/client-selector"
import { ServiceSelector } from "../common/service-selector"
import { CurrencyInput } from "../common/currency-input"
import { MoneyDisplay } from "../common/money-display"

interface CreateInvoiceDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSubmit: (data: InvoiceFormData) => Promise<void>
}

export function CreateInvoiceDialog({ open, onOpenChange, onSubmit }: CreateInvoiceDialogProps) {
  const [isLoading, setIsLoading] = useState(false)

  const form = useForm<InvoiceFormData>({
    resolver: zodResolver(invoiceSchema),
    defaultValues: {
      clientId: "",
      contractId: "",
      ncfType: "B01",
      issueDate: new Date().toISOString().split("T")[0],
      dueDate: "",
      lines: [{ serviceId: "", description: "", quantity: 1, unitPrice: 0, applyItbis: true }],
      notes: "",
    },
  })

  const { fields, append, remove } = useFieldArray({
    control: form.control,
    name: "lines",
  })

  const watchLines = form.watch("lines")
  const subtotal = watchLines.reduce((sum, line) => sum + line.quantity * line.unitPrice, 0)
  const itbis = watchLines.reduce(
    (sum, line) => (line.applyItbis ? sum + line.quantity * line.unitPrice * 0.18 : sum),
    0,
  )
  const total = subtotal + itbis

  const handleSubmit = form.handleSubmit(async (data) => {
    setIsLoading(true)
    try {
      await onSubmit(data)
      form.reset()
      onOpenChange(false)
    } finally {
      setIsLoading(false)
    }
  })

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Nueva Factura</DialogTitle>
          <DialogDescription>Cree una nueva factura para un cliente</DialogDescription>
        </DialogHeader>

        <Form {...form}>
          <form onSubmit={handleSubmit} className="space-y-6">
            <div className="grid gap-4 md:grid-cols-2">
              <FormField
                control={form.control}
                name="clientId"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Cliente *</FormLabel>
                    <FormControl>
                      <ClientSelector value={field.value} onChange={field.onChange} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="ncfType"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Tipo de NCF *</FormLabel>
                    <Select onValueChange={field.onChange} value={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Seleccionar tipo" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value="B01">B01 - Crédito Fiscal</SelectItem>
                        <SelectItem value="B02">B02 - Consumidor Final</SelectItem>
                        <SelectItem value="B14">B14 - Régimen Especial</SelectItem>
                        <SelectItem value="B15">B15 - Gubernamental</SelectItem>
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="issueDate"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Fecha de Emisión *</FormLabel>
                    <FormControl>
                      <Input type="date" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="dueDate"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Fecha de Vencimiento *</FormLabel>
                    <FormControl>
                      <Input type="date" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <Separator />

            <div className="space-y-4">
              <h4 className="font-medium">Líneas de la Factura</h4>

              {fields.map((field, index) => (
                <div key={field.id} className="rounded-lg border p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium">Línea {index + 1}</span>
                    {fields.length > 1 && (
                      <Button type="button" variant="ghost" size="icon" onClick={() => remove(index)}>
                        <Trash2 className="h-4 w-4 text-destructive" />
                      </Button>
                    )}
                  </div>

                  <div className="grid gap-4 md:grid-cols-2">
                    <FormField
                      control={form.control}
                      name={`lines.${index}.serviceId`}
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Servicio</FormLabel>
                          <FormControl>
                            <ServiceSelector value={field.value} onChange={field.onChange} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name={`lines.${index}.description`}
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Descripción *</FormLabel>
                          <FormControl>
                            <Input {...field} placeholder="Descripción del servicio" />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name={`lines.${index}.quantity`}
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Cantidad *</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min={1}
                              {...field}
                              onChange={(e) => field.onChange(Number(e.target.value))}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name={`lines.${index}.unitPrice`}
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Precio Unitario *</FormLabel>
                          <FormControl>
                            <CurrencyInput value={field.value} onChange={field.onChange} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <FormField
                    control={form.control}
                    name={`lines.${index}.applyItbis`}
                    render={({ field }) => (
                      <FormItem className="flex items-center gap-2">
                        <FormControl>
                          <Switch checked={field.value} onCheckedChange={field.onChange} />
                        </FormControl>
                        <FormLabel className="!mt-0">Aplicar ITBIS (18%)</FormLabel>
                      </FormItem>
                    )}
                  />
                </div>
              ))}

              <Button
                type="button"
                variant="outline"
                onClick={() => append({ serviceId: "", description: "", quantity: 1, unitPrice: 0, applyItbis: true })}
                className="w-full bg-transparent"
              >
                <Plus className="mr-2 h-4 w-4" />
                Agregar Línea
              </Button>
            </div>

            <Separator />

            <div className="flex justify-end">
              <div className="w-64 space-y-2">
                <div className="flex justify-between text-sm">
                  <span className="text-muted-foreground">Subtotal:</span>
                  <MoneyDisplay amount={subtotal} />
                </div>
                <div className="flex justify-between text-sm">
                  <span className="text-muted-foreground">ITBIS (18%):</span>
                  <MoneyDisplay amount={itbis} />
                </div>
                <Separator />
                <div className="flex justify-between font-bold">
                  <span>Total:</span>
                  <MoneyDisplay amount={total} className="text-emerald-600" />
                </div>
              </div>
            </div>

            <FormField
              control={form.control}
              name="notes"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Notas</FormLabel>
                  <FormControl>
                    <Textarea {...field} placeholder="Notas o comentarios..." rows={2} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <DialogFooter>
              <Button type="button" variant="outline" onClick={() => onOpenChange(false)}>
                Cancelar
              </Button>
              <Button type="submit" disabled={isLoading}>
                {isLoading ? "Creando..." : "Crear Factura"}
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  )
}

// ===== FILE: components\business\invoices\invoice-table.tsx =====

"use client"

import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { Button } from "@/components/ui/button"
import { Checkbox } from "@/components/ui/checkbox"
import { MoreHorizontal, Eye, Send, DollarSign, XCircle, Download, Mail } from "lucide-react"
import type { Invoice } from "@/lib/types/business"
import { StatusBadge } from "../common/status-badge"
import { MoneyDisplay } from "../common/money-display"
import { formatDate } from "@/lib/utils/business"
import Link from "next/link"

interface InvoiceTableProps {
  invoices: Invoice[]
  selectedIds: string[]
  onSelectChange: (ids: string[]) => void
  onSend: (invoice: Invoice) => void
  onRegisterPayment: (invoice: Invoice) => void
  onCancel: (invoice: Invoice) => void
}

export function InvoiceTable({
  invoices,
  selectedIds,
  onSelectChange,
  onSend,
  onRegisterPayment,
  onCancel,
}: InvoiceTableProps) {
  const allSelected = invoices.length > 0 && selectedIds.length === invoices.length
  const someSelected = selectedIds.length > 0 && selectedIds.length < invoices.length

  const toggleAll = () => {
    if (allSelected) {
      onSelectChange([])
    } else {
      onSelectChange(invoices.map((i) => i.id))
    }
  }

  const toggleOne = (id: string) => {
    if (selectedIds.includes(id)) {
      onSelectChange(selectedIds.filter((i) => i !== id))
    } else {
      onSelectChange([...selectedIds, id])
    }
  }

  const isOverdue = (invoice: Invoice) => {
    return invoice.status === "sent" && new Date(invoice.dueDate) < new Date()
  }

  return (
    <div className="rounded-md border">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead className="w-12">
              <Checkbox
                checked={allSelected}
                onCheckedChange={toggleAll}
                aria-label="Seleccionar todas"
                className={someSelected ? "opacity-50" : ""}
              />
            </TableHead>
            <TableHead>NCF</TableHead>
            <TableHead>Cliente</TableHead>
            <TableHead>Contrato</TableHead>
            <TableHead>Emisión</TableHead>
            <TableHead>Vencimiento</TableHead>
            <TableHead className="text-right">Total</TableHead>
            <TableHead className="text-right">Pendiente</TableHead>
            <TableHead>Estado</TableHead>
            <TableHead className="w-12"></TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {invoices.map((invoice) => (
            <TableRow key={invoice.id} className={isOverdue(invoice) ? "bg-destructive/5" : ""}>
              <TableCell>
                <Checkbox
                  checked={selectedIds.includes(invoice.id)}
                  onCheckedChange={() => toggleOne(invoice.id)}
                  aria-label={`Seleccionar factura ${invoice.ncf}`}
                />
              </TableCell>
              <TableCell className="font-medium">
                <Link href={`/business/invoices/${invoice.id}`} className="text-emerald-600 hover:underline">
                  {invoice.ncf || invoice.invoiceNumber}
                </Link>
              </TableCell>
              <TableCell>
                <div>
                  <p className="font-medium">{invoice.client?.companyName}</p>
                  <p className="text-sm text-muted-foreground">{invoice.client?.rnc}</p>
                </div>
              </TableCell>
              <TableCell>
                <Link href={`/business/contracts/${invoice.contractId}`} className="text-sm hover:underline">
                  {invoice.contract?.contractNumber}
                </Link>
              </TableCell>
              <TableCell>{formatDate(invoice.issueDate)}</TableCell>
              <TableCell>
                <span className={isOverdue(invoice) ? "text-destructive font-medium" : ""}>
                  {formatDate(invoice.dueDate)}
                </span>
              </TableCell>
              <TableCell className="text-right">
                <MoneyDisplay amount={invoice.total} />
              </TableCell>
              <TableCell className="text-right">
                <MoneyDisplay amount={invoice.balanceDue} className={invoice.balanceDue > 0 ? "text-amber-600" : ""} />
              </TableCell>
              <TableCell>
                <StatusBadge status={isOverdue(invoice) ? "overdue" : invoice.status} type="invoice" />
              </TableCell>
              <TableCell>
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="ghost" size="icon">
                      <MoreHorizontal className="h-4 w-4" />
                      <span className="sr-only">Acciones</span>
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuItem asChild>
                      <Link href={`/business/invoices/${invoice.id}`}>
                        <Eye className="mr-2 h-4 w-4" />
                        Ver Detalle
                      </Link>
                    </DropdownMenuItem>
                    <DropdownMenuItem>
                      <Download className="mr-2 h-4 w-4" />
                      Descargar PDF
                    </DropdownMenuItem>
                    {invoice.status === "draft" && (
                      <>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={() => onSend(invoice)}>
                          <Send className="mr-2 h-4 w-4" />
                          Enviar al Cliente
                        </DropdownMenuItem>
                      </>
                    )}
                    {(invoice.status === "sent" || isOverdue(invoice)) && (
                      <>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={() => onRegisterPayment(invoice)}>
                          <DollarSign className="mr-2 h-4 w-4" />
                          Registrar Pago
                        </DropdownMenuItem>
                        <DropdownMenuItem>
                          <Mail className="mr-2 h-4 w-4" />
                          Enviar Recordatorio
                        </DropdownMenuItem>
                      </>
                    )}
                    {invoice.status === "draft" && (
                      <>
                        <DropdownMenuSeparator />
                        <DropdownMenuItem onClick={() => onCancel(invoice)} className="text-destructive">
                          <XCircle className="mr-2 h-4 w-4" />
                          Anular
                        </DropdownMenuItem>
                      </>
                    )}
                  </DropdownMenuContent>
                </DropdownMenu>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  )
}

// ===== FILE: components\business\payments\payment-table.tsx =====

"use client"

import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from "@/components/ui/dropdown-menu"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { MoreHorizontal, Eye, FileText, Printer } from "lucide-react"
import type { Payment } from "@/lib/types/business"
import { MoneyDisplay } from "../common/money-display"
import { formatDate, getPaymentMethodLabel } from "@/lib/utils/business"
import Link from "next/link"

interface PaymentTableProps {
  payments: Payment[]
  onViewReceipt: (payment: Payment) => void
}

export function PaymentTable({ payments, onViewReceipt }: PaymentTableProps) {
  return (
    <div className="rounded-md border">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Fecha</TableHead>
            <TableHead>Cliente</TableHead>
            <TableHead>Factura</TableHead>
            <TableHead>Método</TableHead>
            <TableHead>Referencia</TableHead>
            <TableHead className="text-right">Monto</TableHead>
            <TableHead>Recibo</TableHead>
            <TableHead className="w-12"></TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {payments.map((payment) => (
            <TableRow key={payment.id}>
              <TableCell>{formatDate(payment.paymentDate)}</TableCell>
              <TableCell>
                <div>
                  <p className="font-medium">{payment.invoice?.client?.companyName}</p>
                </div>
              </TableCell>
              <TableCell>
                <Link
                  href={`/business/invoices/${payment.invoiceId}`}
                  className="text-emerald-600 hover:underline text-sm"
                >
                  {payment.invoice?.ncf || payment.invoice?.invoiceNumber}
                </Link>
              </TableCell>
              <TableCell>
                <Badge variant="outline">{getPaymentMethodLabel(payment.paymentMethod)}</Badge>
              </TableCell>
              <TableCell className="text-sm text-muted-foreground">{payment.reference || "-"}</TableCell>
              <TableCell className="text-right">
                <MoneyDisplay amount={payment.amount} className="font-medium text-emerald-600" />
              </TableCell>
              <TableCell>
                {payment.receipt ? (
                  <Button variant="ghost" size="sm" onClick={() => onViewReceipt(payment)}>
                    {payment.receipt.receiptNumber}
                  </Button>
                ) : (
                  <span className="text-sm text-muted-foreground">-</span>
                )}
              </TableCell>
              <TableCell>
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="ghost" size="icon">
                      <MoreHorizontal className="h-4 w-4" />
                      <span className="sr-only">Acciones</span>
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuItem asChild>
                      <Link href={`/business/invoices/${payment.invoiceId}`}>
                        <Eye className="mr-2 h-4 w-4" />
                        Ver Factura
                      </Link>
                    </DropdownMenuItem>
                    {payment.receipt && (
                      <DropdownMenuItem onClick={() => onViewReceipt(payment)}>
                        <FileText className="mr-2 h-4 w-4" />
                        Ver Recibo
                      </DropdownMenuItem>
                    )}
                    <DropdownMenuItem>
                      <Printer className="mr-2 h-4 w-4" />
                      Imprimir
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  )
}

// ===== FILE: components\business\payments\register-payment-dialog.tsx =====

"use client"

import { useState } from "react"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Separator } from "@/components/ui/separator"
import { paymentSchema, type PaymentFormData } from "@/lib/validations/business"
import type { Invoice } from "@/lib/types/business"
import { CurrencyInput } from "../common/currency-input"
import { MoneyDisplay } from "../common/money-display"
import { formatDate } from "@/lib/utils/business"

interface RegisterPaymentDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  invoice: Invoice | null
  onSubmit: (data: PaymentFormData) => Promise<void>
}

export function RegisterPaymentDialog({ open, onOpenChange, invoice, onSubmit }: RegisterPaymentDialogProps) {
  const [isLoading, setIsLoading] = useState(false)

  const form = useForm<PaymentFormData>({
    resolver: zodResolver(paymentSchema),
    defaultValues: {
      invoiceId: invoice?.id || "",
      amount: invoice?.balanceDue || 0,
      paymentDate: new Date().toISOString().split("T")[0],
      paymentMethod: "transfer",
      reference: "",
      notes: "",
    },
  })

  const watchAmount = form.watch("amount")

  const handleSubmit = form.handleSubmit(async (data) => {
    setIsLoading(true)
    try {
      await onSubmit({ ...data, invoiceId: invoice?.id || "" })
      form.reset()
      onOpenChange(false)
    } finally {
      setIsLoading(false)
    }
  })

  if (!invoice) return null

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle>Registrar Pago</DialogTitle>
          <DialogDescription>Registre un pago para la factura {invoice.ncf || invoice.invoiceNumber}</DialogDescription>
        </DialogHeader>

        {/* Invoice Summary */}
        <div className="rounded-lg border p-4 space-y-2 bg-muted/50">
          <div className="flex justify-between text-sm">
            <span className="text-muted-foreground">Cliente:</span>
            <span className="font-medium">{invoice.client?.companyName}</span>
          </div>
          <div className="flex justify-between text-sm">
            <span className="text-muted-foreground">Vencimiento:</span>
            <span>{formatDate(invoice.dueDate)}</span>
          </div>
          <Separator />
          <div className="flex justify-between text-sm">
            <span className="text-muted-foreground">Total Factura:</span>
            <MoneyDisplay amount={invoice.total} />
          </div>
          <div className="flex justify-between text-sm">
            <span className="text-muted-foreground">Pagado:</span>
            <MoneyDisplay amount={invoice.total - invoice.balanceDue} />
          </div>
          <div className="flex justify-between font-medium">
            <span>Pendiente:</span>
            <MoneyDisplay amount={invoice.balanceDue} className="text-amber-600" />
          </div>
        </div>

        <Form {...form}>
          <form onSubmit={handleSubmit} className="space-y-4">
            <FormField
              control={form.control}
              name="amount"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Monto a Pagar *</FormLabel>
                  <FormControl>
                    <CurrencyInput value={field.value} onChange={field.onChange} />
                  </FormControl>
                  <FormDescription>
                    {watchAmount < invoice.balanceDue
                      ? `Pago parcial. Quedará pendiente: RD$ ${(invoice.balanceDue - watchAmount).toLocaleString("es-DO")}`
                      : watchAmount === invoice.balanceDue
                        ? "Pago total"
                        : "El monto excede el balance pendiente"}
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="grid gap-4 grid-cols-2">
              <FormField
                control={form.control}
                name="paymentDate"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Fecha de Pago *</FormLabel>
                    <FormControl>
                      <Input type="date" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="paymentMethod"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Método de Pago *</FormLabel>
                    <Select onValueChange={field.onChange} value={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Seleccionar" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value="transfer">Transferencia</SelectItem>
                        <SelectItem value="check">Cheque</SelectItem>
                        <SelectItem value="cash">Efectivo</SelectItem>
                        <SelectItem value="card">Tarjeta</SelectItem>
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <FormField
              control={form.control}
              name="reference"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Referencia</FormLabel>
                  <FormControl>
                    <Input {...field} placeholder="Número de transferencia, cheque, etc." />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="notes"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Notas</FormLabel>
                  <FormControl>
                    <Textarea {...field} placeholder="Notas adicionales..." rows={2} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <DialogFooter>
              <Button type="button" variant="outline" onClick={() => onOpenChange(false)}>
                Cancelar
              </Button>
              <Button type="submit" disabled={isLoading || watchAmount > invoice.balanceDue}>
                {isLoading ? "Registrando..." : "Registrar Pago"}
              </Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  )
}

// ===== FILE: components\business\pricing\global-prices-table.tsx =====

"use client"

// ===== Global Prices Table =====

import { useState, useEffect } from "react"
import { toast } from "sonner"
import { DollarSign, History } from "lucide-react"

import { Button } from "@/components/ui/button"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { Badge } from "@/components/ui/badge"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { EmptyState } from "@/components/common/empty-state"
import { PermissionGate } from "@/components/common/permission-gate"
import { formatDOP, formatDateDO } from "@/lib/utils/business"
import { getAllGlobalPrices } from "@/lib/api/business/pricing"
import { getServices } from "@/lib/api/business/services"
import type { GlobalServicePrice, ServiceCatalog } from "@/lib/types/business"

interface GlobalPricesTableProps {
  onSetPrice: (service: ServiceCatalog) => void
  onViewHistory: (service: ServiceCatalog) => void
}

export function GlobalPricesTable({ onSetPrice, onViewHistory }: GlobalPricesTableProps) {
  const [prices, setPrices] = useState<GlobalServicePrice[]>([])
  const [services, setServices] = useState<ServiceCatalog[]>([])
  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    async function loadData() {
      try {
        const [pricesData, servicesData] = await Promise.all([getAllGlobalPrices(), getServices(true)])
        setPrices(pricesData)
        setServices(servicesData)
      } catch {
        toast.error("Error al cargar precios")
      } finally {
        setIsLoading(false)
      }
    }
    loadData()
  }, [])

  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-12">
        <LoadingSpinner />
      </div>
    )
  }

  // Combine services with their prices
  const servicesWithPrices = services.map((service) => ({
    service,
    price: prices.find((p) => p.serviceId === service.id),
  }))

  if (servicesWithPrices.length === 0) {
    return <EmptyState icon={DollarSign} title="Sin servicios" description="No hay servicios en el catálogo" />
  }

  return (
    <div className="rounded-lg border">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Código</TableHead>
            <TableHead>Servicio</TableHead>
            <TableHead>Unidad</TableHead>
            <TableHead>Precio actual</TableHead>
            <TableHead>Vigente desde</TableHead>
            <TableHead className="w-[120px]">Acciones</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {servicesWithPrices.map(({ service, price }) => (
            <TableRow key={service.id}>
              <TableCell className="font-mono text-sm">{service.code}</TableCell>
              <TableCell className="font-medium">{service.name}</TableCell>
              <TableCell>{service.billingUnitName}</TableCell>
              <TableCell>
                {price ? (
                  <span className="font-medium">{formatDOP(price.price)}</span>
                ) : (
                  <Badge variant="secondary">Sin precio</Badge>
                )}
              </TableCell>
              <TableCell className="text-sm text-muted-foreground">
                {price ? formatDateDO(price.effectiveFrom) : "-"}
              </TableCell>
              <TableCell>
                <div className="flex gap-1">
                  <PermissionGate permissions={["BUSINESS_PRICE_UPDATE"]}>
                    <Button variant="ghost" size="icon" onClick={() => onSetPrice(service)} title="Establecer precio">
                      <DollarSign className="h-4 w-4" />
                    </Button>
                  </PermissionGate>
                  <Button variant="ghost" size="icon" onClick={() => onViewHistory(service)} title="Ver historial">
                    <History className="h-4 w-4" />
                  </Button>
                </div>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  )
}

// ===== FILE: components\business\pricing\price-calculator.tsx =====

"use client"

// ===== Price Calculator Component =====

import { useState } from "react"
import { Calculator } from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { ClientSelector } from "@/components/business/common/client-selector"
import { ServiceSelector } from "@/components/business/common/service-selector"
import { MoneyDisplay } from "@/components/business/common/money-display"
import { Badge } from "@/components/ui/badge"
import { resolvePrice } from "@/lib/api/business/pricing"
import { calculateLineTotal } from "@/lib/utils/business"
import type { ResolvedPrice, ServiceCatalog } from "@/lib/types/business"

export function PriceCalculator() {
  const [clientId, setClientId] = useState("")
  const [serviceId, setServiceId] = useState("")
  const [selectedService, setSelectedService] = useState<ServiceCatalog | null>(null)
  const [quantity, setQuantity] = useState(1)
  const [resolvedPrice, setResolvedPrice] = useState<ResolvedPrice | null>(null)
  const [isCalculating, setIsCalculating] = useState(false)

  async function handleCalculate() {
    if (!clientId || !serviceId) {
      toast.error("Seleccione un cliente y un servicio")
      return
    }

    setIsCalculating(true)
    try {
      const price = await resolvePrice(serviceId, clientId)
      setResolvedPrice(price)
    } catch {
      toast.error("Error al calcular precio")
    } finally {
      setIsCalculating(false)
    }
  }

  const calculation =
    resolvedPrice && selectedService
      ? calculateLineTotal(quantity, resolvedPrice.price, selectedService.itbisApplicable)
      : null

  return (
    <div className="space-y-6">
      <div className="grid gap-4 md:grid-cols-2">
        <div className="space-y-2">
          <Label>Cliente</Label>
          <ClientSelector value={clientId} onValueChange={setClientId} />
        </div>
        <div className="space-y-2">
          <Label>Servicio</Label>
          <ServiceSelector
            value={serviceId}
            onValueChange={(id, service) => {
              setServiceId(id)
              setSelectedService(service || null)
            }}
          />
        </div>
      </div>

      <div className="flex items-end gap-4">
        <div className="space-y-2 flex-1 max-w-[200px]">
          <Label>Cantidad</Label>
          <Input
            type="number"
            min="1"
            step="0.01"
            value={quantity}
            onChange={(e) => setQuantity(Number(e.target.value))}
          />
        </div>
        <Button onClick={handleCalculate} disabled={isCalculating || !clientId || !serviceId}>
          <Calculator className="mr-2 h-4 w-4" />
          {isCalculating ? "Calculando..." : "Calcular"}
        </Button>
      </div>

      {resolvedPrice && calculation && (
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">Resultado</CardTitle>
            <CardDescription className="flex items-center gap-2">
              Precio resuelto desde:{" "}
              <Badge variant={resolvedPrice.source === "CLIENT" ? "default" : "secondary"}>
                {resolvedPrice.source === "CLIENT" ? "Precio de Cliente" : "Precio Global"}
              </Badge>
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid gap-4 sm:grid-cols-2">
              <div>
                <p className="text-sm text-muted-foreground">Precio unitario</p>
                <MoneyDisplay amount={resolvedPrice.price} className="text-lg font-medium" />
              </div>
              <div>
                <p className="text-sm text-muted-foreground">Cantidad</p>
                <p className="text-lg font-medium">
                  {quantity} {selectedService?.billingUnitName}
                </p>
              </div>
            </div>

            <div className="border-t pt-4 space-y-2">
              <div className="flex justify-between">
                <span className="text-muted-foreground">Subtotal</span>
                <MoneyDisplay amount={calculation.subtotal} />
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">ITBIS (18%)</span>
                <MoneyDisplay amount={calculation.itbis} />
              </div>
              <div className="flex justify-between text-lg font-bold border-t pt-2">
                <span>Total</span>
                <MoneyDisplay amount={calculation.total} size="lg" />
              </div>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  )
}

// ===== FILE: components\business\pricing\price-history-sheet.tsx =====

"use client"

// ===== Price History Sheet =====

import { useState, useEffect } from "react"
import { toast } from "sonner"

import { Sheet, SheetContent, SheetDescription, SheetHeader, SheetTitle } from "@/components/ui/sheet"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { Badge } from "@/components/ui/badge"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { formatDOP, formatDateDO } from "@/lib/utils/business"
import { getGlobalPriceHistory } from "@/lib/api/business/pricing"
import type { ServiceCatalog, GlobalServicePrice } from "@/lib/types/business"

interface PriceHistorySheetProps {
  service: ServiceCatalog | null
  open: boolean
  onOpenChange: (open: boolean) => void
}

export function PriceHistorySheet({ service, open, onOpenChange }: PriceHistorySheetProps) {
  const [history, setHistory] = useState<GlobalServicePrice[]>([])
  const [isLoading, setIsLoading] = useState(false)

  useEffect(() => {
    if (service && open) {
      setIsLoading(true)
      getGlobalPriceHistory(service.id)
        .then(setHistory)
        .catch(() => toast.error("Error al cargar historial"))
        .finally(() => setIsLoading(false))
    }
  }, [service, open])

  return (
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetContent className="w-full sm:max-w-lg">
        <SheetHeader>
          <SheetTitle>Historial de Precios</SheetTitle>
          <SheetDescription>
            {service && (
              <>
                Servicio: <strong>{service.name}</strong> ({service.code})
              </>
            )}
          </SheetDescription>
        </SheetHeader>

        <div className="mt-6">
          {isLoading ? (
            <div className="flex items-center justify-center py-12">
              <LoadingSpinner />
            </div>
          ) : history.length === 0 ? (
            <p className="text-center text-muted-foreground py-12">No hay historial de precios</p>
          ) : (
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Precio</TableHead>
                  <TableHead>Vigente desde</TableHead>
                  <TableHead>Estado</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {history.map((price, index) => (
                  <TableRow key={price.id}>
                    <TableCell className="font-medium">{formatDOP(price.price)}</TableCell>
                    <TableCell>{formatDateDO(price.effectiveFrom)}</TableCell>
                    <TableCell>
                      {index === 0 && price.active ? (
                        <Badge variant="default" className="bg-emerald-500">
                          Actual
                        </Badge>
                      ) : (
                        <Badge variant="secondary">Histórico</Badge>
                      )}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          )}
        </div>
      </SheetContent>
    </Sheet>
  )
}

// ===== FILE: components\business\pricing\set-price-dialog.tsx =====

"use client"

// ===== Set Global Price Dialog =====

import { useState } from "react"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import { toast } from "sonner"
import { CalendarIcon } from "lucide-react"
import { format } from "date-fns"
import { es } from "date-fns/locale"

import { Button } from "@/components/ui/button"
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form"
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover"
import { Calendar } from "@/components/ui/calendar"
import { CurrencyInput } from "@/components/business/common/currency-input"
import { cn } from "@/lib/utils"
import { setGlobalPriceSchema, type SetGlobalPriceFormData } from "@/lib/validations/business"
import { setGlobalPrice, getGlobalPrice } from "@/lib/api/business/pricing"
import { formatDOP } from "@/lib/utils/business"
import type { ServiceCatalog, GlobalServicePrice } from "@/lib/types/business"
import { useEffect } from "react"

interface SetPriceDialogProps {
  service: ServiceCatalog | null
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess?: () => void
}

export function SetPriceDialog({ service, open, onOpenChange, onSuccess }: SetPriceDialogProps) {
  const [isLoading, setIsLoading] = useState(false)
  const [currentPrice, setCurrentPrice] = useState<GlobalServicePrice | null>(null)

  const form = useForm<SetGlobalPriceFormData>({
    resolver: zodResolver(setGlobalPriceSchema),
    defaultValues: {
      serviceId: service?.id || "",
      price: 0,
      effectiveFrom: new Date().toISOString().split("T")[0],
    },
  })

  useEffect(() => {
    if (service && open) {
      form.setValue("serviceId", service.id)
      // Load current price
      getGlobalPrice(service.id)
        .then((price) => {
          setCurrentPrice(price)
          if (price) {
            form.setValue("price", price.price)
          }
        })
        .catch(() => setCurrentPrice(null))
    }
  }, [service, open, form])

  async function handleSubmit(data: SetGlobalPriceFormData) {
    setIsLoading(true)
    try {
      const response = await setGlobalPrice(data)
      if (response.success) {
        toast.success("Precio actualizado exitosamente")
        onOpenChange(false)
        onSuccess?.()
      } else {
        toast.error(response.message || "Error al actualizar precio")
      }
    } catch {
      toast.error("Error al actualizar precio")
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Establecer Precio Global</DialogTitle>
          <DialogDescription>
            {service && (
              <>
                Servicio: <strong>{service.name}</strong> ({service.code})
              </>
            )}
          </DialogDescription>
        </DialogHeader>

        {currentPrice && (
          <div className="rounded-lg bg-muted p-4 space-y-1">
            <p className="text-sm text-muted-foreground">Precio actual</p>
            <p className="text-xl font-bold">{formatDOP(currentPrice.price)}</p>
            <p className="text-xs text-muted-foreground">
              Vigente desde: {format(new Date(currentPrice.effectiveFrom), "dd/MM/yyyy", { locale: es })}
            </p>
          </div>
        )}

        <Form {...form}>
          <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="price"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Nuevo precio *</FormLabel>
                  <FormControl>
                    <CurrencyInput value={field.value} onChange={field.onChange} />
                  </FormControl>
                  <FormDescription>Precio por {service?.billingUnitName}</FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="effectiveFrom"
              render={({ field }) => (
                <FormItem className="flex flex-col">
                  <FormLabel>Fecha de vigencia *</FormLabel>
                  <Popover>
                    <PopoverTrigger asChild>
                      <FormControl>
                        <Button
                          variant="outline"
                          className={cn("w-full pl-3 text-left font-normal", !field.value && "text-muted-foreground")}
                        >
                          {field.value ? (
                            format(new Date(field.value), "PPP", { locale: es })
                          ) : (
                            <span>Seleccionar fecha</span>
                          )}
                          <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                        </Button>
                      </FormControl>
                    </PopoverTrigger>
                    <PopoverContent className="w-auto p-0" align="start">
                      <Calendar
                        mode="single"
                        selected={field.value ? new Date(field.value) : undefined}
                        onSelect={(date) => field.onChange(date?.toISOString().split("T")[0])}
                        locale={es}
                        initialFocus
                      />
                    </PopoverContent>
                  </Popover>
                  <FormDescription>El nuevo precio entrará en vigencia a partir de esta fecha</FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="flex justify-end gap-2 pt-4">
              <Button type="button" variant="outline" onClick={() => onOpenChange(false)}>
                Cancelar
              </Button>
              <Button type="submit" disabled={isLoading}>
                {isLoading ? "Guardando..." : "Guardar precio"}
              </Button>
            </div>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  )
}

// ===== FILE: components\business\services\create-service-dialog.tsx =====

"use client"

// ===== Create Service Dialog =====

import { useState, useEffect } from "react"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"
import { Checkbox } from "@/components/ui/checkbox"
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { createServiceSchema, type CreateServiceFormData } from "@/lib/validations/business"
import { createService, getBillingUnits } from "@/lib/api/business/services"
import type { BillingUnit } from "@/lib/types/business"

interface CreateServiceDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess?: () => void
}

export function CreateServiceDialog({ open, onOpenChange, onSuccess }: CreateServiceDialogProps) {
  const [isLoading, setIsLoading] = useState(false)
  const [billingUnits, setBillingUnits] = useState<BillingUnit[]>([])

  const form = useForm<CreateServiceFormData>({
    resolver: zodResolver(createServiceSchema),
    defaultValues: {
      code: "",
      name: "",
      description: "",
      billingUnitId: "",
      itbisApplicable: true,
    },
  })

  useEffect(() => {
    async function loadBillingUnits() {
      try {
        const units = await getBillingUnits()
        setBillingUnits(units)
      } catch (error) {
        console.error("Failed to load billing units:", error)
      }
    }
    if (open) {
      loadBillingUnits()
    }
  }, [open])

  async function handleSubmit(data: CreateServiceFormData) {
    setIsLoading(true)
    try {
      const response = await createService(data)
      if (response.success) {
        toast.success("Servicio creado exitosamente")
        form.reset()
        onOpenChange(false)
        onSuccess?.()
      } else {
        toast.error(response.message || "Error al crear servicio")
      }
    } catch {
      toast.error("Error al crear servicio")
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Nuevo Servicio</DialogTitle>
          <DialogDescription>Agregue un nuevo servicio al catálogo</DialogDescription>
        </DialogHeader>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-4">
            <div className="grid gap-4 sm:grid-cols-2">
              <FormField
                control={form.control}
                name="code"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Código *</FormLabel>
                    <FormControl>
                      <Input placeholder="SEG-FIJA" className="font-mono uppercase" {...field} />
                    </FormControl>
                    <FormDescription>Letras mayúsculas, números y guiones</FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="name"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Nombre *</FormLabel>
                    <FormControl>
                      <Input placeholder="Seguridad Fija" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <FormField
              control={form.control}
              name="description"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Descripción</FormLabel>
                  <FormControl>
                    <Textarea placeholder="Descripción del servicio..." {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="billingUnitId"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Unidad de facturación *</FormLabel>
                  <Select onValueChange={field.onChange} defaultValue={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Seleccionar unidad" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {billingUnits.map((unit) => (
                        <SelectItem key={unit.id} value={unit.id}>
                          {unit.name} ({unit.code})
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="itbisApplicable"
              render={({ field }) => (
                <FormItem className="flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4">
                  <FormControl>
                    <Checkbox checked={field.value} onCheckedChange={field.onChange} />
                  </FormControl>
                  <div className="space-y-1 leading-none">
                    <FormLabel>Aplica ITBIS</FormLabel>
                    <FormDescription>El servicio está sujeto al 18% de ITBIS</FormDescription>
                  </div>
                </FormItem>
              )}
            />

            <div className="flex justify-end gap-2 pt-4">
              <Button type="button" variant="outline" onClick={() => onOpenChange(false)}>
                Cancelar
              </Button>
              <Button type="submit" disabled={isLoading}>
                {isLoading ? "Creando..." : "Crear servicio"}
              </Button>
            </div>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  )
}

// ===== FILE: components\business\services\service-table.tsx =====

"use client"

// ===== Service Catalog Table =====

import { MoreHorizontal, Pencil, DollarSign, History, Ban, Check, X } from "lucide-react"

import { Button } from "@/components/ui/button"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { Badge } from "@/components/ui/badge"
import { PermissionGate } from "@/components/common/permission-gate"
import type { ServiceCatalog } from "@/lib/types/business"

interface ServiceTableProps {
  services: ServiceCatalog[]
  onEdit: (service: ServiceCatalog) => void
  onSetPrice: (service: ServiceCatalog) => void
  onViewHistory: (service: ServiceCatalog) => void
  onDeactivate: (service: ServiceCatalog) => void
}

export function ServiceTable({ services, onEdit, onSetPrice, onViewHistory, onDeactivate }: ServiceTableProps) {
  return (
    <div className="rounded-lg border border-border">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Código</TableHead>
            <TableHead>Nombre</TableHead>
            <TableHead>Descripción</TableHead>
            <TableHead>Unidad</TableHead>
            <TableHead>ITBIS</TableHead>
            <TableHead>Estado</TableHead>
            <TableHead className="w-[50px]" />
          </TableRow>
        </TableHeader>
        <TableBody>
          {services.map((service) => (
            <TableRow key={service.id} className={!service.active ? "opacity-50" : ""}>
              <TableCell className="font-mono text-sm">{service.code}</TableCell>
              <TableCell className="font-medium">{service.name}</TableCell>
              <TableCell className="max-w-[200px] truncate text-sm text-muted-foreground">
                {service.description || "-"}
              </TableCell>
              <TableCell>{service.billingUnitName}</TableCell>
              <TableCell>
                {service.itbisApplicable ? (
                  <Check className="h-4 w-4 text-emerald-500" />
                ) : (
                  <X className="h-4 w-4 text-muted-foreground" />
                )}
              </TableCell>
              <TableCell>
                <Badge variant={service.active ? "default" : "secondary"}>
                  {service.active ? "Activo" : "Inactivo"}
                </Badge>
              </TableCell>
              <TableCell>
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="ghost" size="icon">
                      <MoreHorizontal className="h-4 w-4" />
                      <span className="sr-only">Abrir menú</span>
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <PermissionGate permissions={["BUSINESS_SERVICE_UPDATE"]}>
                      <DropdownMenuItem onClick={() => onEdit(service)}>
                        <Pencil className="mr-2 h-4 w-4" />
                        Editar
                      </DropdownMenuItem>
                    </PermissionGate>
                    <DropdownMenuSeparator />
                    <PermissionGate permissions={["BUSINESS_PRICE_UPDATE"]}>
                      <DropdownMenuItem onClick={() => onSetPrice(service)}>
                        <DollarSign className="mr-2 h-4 w-4" />
                        Establecer precio
                      </DropdownMenuItem>
                    </PermissionGate>
                    <DropdownMenuItem onClick={() => onViewHistory(service)}>
                      <History className="mr-2 h-4 w-4" />
                      Historial de precios
                    </DropdownMenuItem>
                    {service.active && (
                      <>
                        <DropdownMenuSeparator />
                        <PermissionGate permissions={["BUSINESS_SERVICE_DELETE"]}>
                          <DropdownMenuItem
                            onClick={() => onDeactivate(service)}
                            className="text-destructive focus:text-destructive"
                          >
                            <Ban className="mr-2 h-4 w-4" />
                            Desactivar
                          </DropdownMenuItem>
                        </PermissionGate>
                      </>
                    )}
                  </DropdownMenuContent>
                </DropdownMenu>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  )
}

// ===== FILE: components\common\account-status-badge.tsx =====

// ===== FILE: components/common/account-status-badge.tsx =====
// Reusable account status badge component

import { Clock, Mail, CheckCircle, Ban, AlertCircle } from "lucide-react"
import { Badge } from "@/components/ui/badge"
import type { AccountStatus } from "@/types"

interface AccountStatusBadgeProps {
  status: AccountStatus
  showIcon?: boolean
  size?: "default" | "sm"
}

export function AccountStatusBadge({ 
  status, 
  showIcon = true,
  size = "default"
}: AccountStatusBadgeProps) {
  const sizeClasses = size === "sm" ? "text-xs py-0" : ""
  const iconSize = size === "sm" ? "h-3 w-3" : "h-3.5 w-3.5"

  switch (status) {
    case "PENDING_VERIFICATION":
      return (
        <Badge 
          variant="outline" 
          className={`bg-blue-500/10 text-blue-500 border-blue-500/20 ${sizeClasses}`}
        >
          {showIcon && <Mail className={`mr-1 ${iconSize}`} />}
          Pending Verification
        </Badge>
      )
    case "PENDING_APPROVAL":
      return (
        <Badge 
          variant="outline" 
          className={`bg-amber-500/10 text-amber-500 border-amber-500/20 ${sizeClasses}`}
        >
          {showIcon && <Clock className={`mr-1 ${iconSize}`} />}
          Pending Approval
        </Badge>
      )
    case "ACTIVE":
      return (
        <Badge 
          variant="outline" 
          className={`bg-emerald-500/10 text-emerald-500 border-emerald-500/20 ${sizeClasses}`}
        >
          {showIcon && <CheckCircle className={`mr-1 ${iconSize}`} />}
          Active
        </Badge>
      )
    case "SUSPENDED":
      return (
        <Badge 
          variant="outline" 
          className={`bg-red-500/10 text-red-500 border-red-500/20 ${sizeClasses}`}
        >
          {showIcon && <Ban className={`mr-1 ${iconSize}`} />}
          Suspended
        </Badge>
      )
    case "DEACTIVATED":
      return (
        <Badge 
          variant="outline" 
          className={`bg-gray-500/10 text-gray-500 border-gray-500/20 ${sizeClasses}`}
        >
          {showIcon && <Ban className={`mr-1 ${iconSize}`} />}
          Deactivated
        </Badge>
      )
    default:
      return (
        <Badge variant="outline" className={sizeClasses}>
          {showIcon && <AlertCircle className={`mr-1 ${iconSize}`} />}
          {status}
        </Badge>
      )
  }
}

// Helper function to get status color for other components
export function getAccountStatusColor(status: AccountStatus): string {
  switch (status) {
    case "PENDING_VERIFICATION":
      return "text-blue-500"
    case "PENDING_APPROVAL":
      return "text-amber-500"
    case "ACTIVE":
      return "text-emerald-500"
    case "SUSPENDED":
      return "text-red-500"
    case "DEACTIVATED":
      return "text-gray-500"
    default:
      return "text-muted-foreground"
  }
}

// Helper function to get status description
export function getAccountStatusDescription(status: AccountStatus): string {
  switch (status) {
    case "PENDING_VERIFICATION":
      return "User has registered but hasn't verified their email address yet."
    case "PENDING_APPROVAL":
      return "User has verified their email and is waiting for administrator approval."
    case "ACTIVE":
      return "User account is active and has full access to the system."
    case "SUSPENDED":
      return "User account has been temporarily suspended. Roles are preserved."
    case "DEACTIVATED":
      return "User account has been permanently deactivated. Roles have been cleared."
    default:
      return "Unknown account status."
  }
}

// ===== FILE: components\common\confirm-dialog.tsx =====

"use client"

import type { ReactNode } from "react"
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog"
import { LoadingSpinner } from "./loading-spinner"

interface ConfirmDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  title: ReactNode
  description: ReactNode
  confirmText?: string
  cancelText?: string
  onConfirm: () => void | Promise<void>
  variant?: "default" | "destructive"
  isLoading?: boolean
}

export function ConfirmDialog({
  open,
  onOpenChange,
  title,
  description,
  confirmText = "Confirm",
  cancelText = "Cancel",
  onConfirm,
  variant = "default",
  isLoading = false,
}: ConfirmDialogProps) {
  const handleConfirm = async () => {
    await onConfirm()
  }

  return (
    <AlertDialog open={open} onOpenChange={onOpenChange}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>{title}</AlertDialogTitle>

          <AlertDialogDescription asChild>
            {typeof description === "string" ? <span>{description}</span> : description}
          </AlertDialogDescription>
        </AlertDialogHeader>

        <AlertDialogFooter>
          <AlertDialogCancel disabled={isLoading}>{cancelText}</AlertDialogCancel>
          <AlertDialogAction
            onClick={handleConfirm}
            disabled={isLoading}
            className={variant === "destructive" ? "bg-destructive text-destructive-foreground hover:bg-destructive/90" : ""}
          >
            {isLoading && <LoadingSpinner size="sm" className="mr-2" />}
            {confirmText}
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  )
}

// ===== FILE: components\common\empty-state.tsx =====

import type React from "react"
import { cn } from "@/lib/utils"
import type { LucideIcon } from "lucide-react"

interface EmptyStateProps {
  icon: LucideIcon
  title: string
  description: string
  action?: React.ReactNode
  className?: string
}

export function EmptyState({ icon: Icon, title, description, action, className }: EmptyStateProps) {
  return (
    <div className={cn("flex flex-col items-center justify-center py-12 text-center", className)}>
      <div className="rounded-full bg-muted p-4">
        <Icon className="h-8 w-8 text-muted-foreground" />
      </div>
      <h3 className="mt-4 text-lg font-semibold">{title}</h3>
      <p className="mt-2 max-w-sm text-sm text-muted-foreground">{description}</p>
      {action && <div className="mt-6">{action}</div>}
    </div>
  )
}

// ===== FILE: components\common\loading-spinner.tsx =====

import { cn } from "@/lib/utils"
import { Loader2 } from "lucide-react"

interface LoadingSpinnerProps {
  size?: "sm" | "md" | "lg"
  className?: string
}

export function LoadingSpinner({ size = "md", className }: LoadingSpinnerProps) {
  const sizeClasses = {
    sm: "h-4 w-4",
    md: "h-6 w-6",
    lg: "h-8 w-8",
  }

  return <Loader2 className={cn("animate-spin text-primary", sizeClasses[size], className)} />
}

interface FullPageLoaderProps {
  message?: string
}

export function FullPageLoader({ message = "Loading..." }: FullPageLoaderProps) {
  return (
    <div className="flex min-h-screen flex-col items-center justify-center gap-4">
      <LoadingSpinner size="lg" />
      <p className="text-sm text-muted-foreground">{message}</p>
    </div>
  )
}

// ===== FILE: components\common\permission-gate.tsx =====

"use client"

import { useAuthStore } from "@/lib/store/auth-store"
import type { ReactNode } from "react"

interface PermissionGateProps {
  children: ReactNode
  permission?: string
  permissions?: string[]
  role?: string
  roles?: string[]
  requireAll?: boolean
  fallback?: ReactNode
}

export function PermissionGate({
  children,
  permission,
  permissions = [],
  role,
  roles = [],
  requireAll = false,
  fallback = null,
}: PermissionGateProps) {
  const { hasPermission, hasAnyPermission, hasRole, hasAnyRole, user } = useAuthStore()

  // Collect all permissions to check
  const allPermissions = permission ? [permission, ...permissions] : permissions

  // Collect all roles to check
  const allRoles = role ? [role, ...roles] : roles

  let hasAccess = true

  // Check permissions
  if (allPermissions.length > 0) {
    if (requireAll) {
      hasAccess = allPermissions.every((p) => hasPermission(p))
    } else {
      hasAccess = hasAnyPermission(allPermissions)
    }
  }

  // Check roles
  if (allRoles.length > 0 && hasAccess) {
    if (requireAll) {
      hasAccess = allRoles.every((r) => hasRole(r))
    } else {
      hasAccess = hasAnyRole(allRoles)
    }
  }

  // SUPERADMIN always has access
  if (user?.roles.includes("SUPERADMIN")) {
    hasAccess = true
  }

  if (!hasAccess) {
    return <>{fallback}</>
  }

  return <>{children}</>
}

// ===== FILE: components\common\role-badge.tsx =====

import { Badge } from "@/components/ui/badge"
import { getRoleColor } from "@/lib/utils/permissions"
import { cn } from "@/lib/utils"

interface RoleBadgeProps {
  role: string
  className?: string
}

export function RoleBadge({ role, className }: RoleBadgeProps) {
  return (
    <Badge variant="outline" className={cn(getRoleColor(role), "font-medium", className)}>
      {role.replace(/_/g, " ")}
    </Badge>
  )
}

// ===== FILE: components\dashboard\activity-item.tsx =====

import { Avatar, AvatarFallback } from "@/components/ui/avatar"
import { getInitials, formatRelativeTime } from "@/lib/utils/formatters"
import { RoleBadge } from "@/components/common/role-badge"

interface ActivityItemProps {
  user: {
    firstName: string
    lastName: string
  }
  action: string
  target?: string
  role?: string
  timestamp: string
}

export function ActivityItem({ user, action, target, role, timestamp }: ActivityItemProps) {
  return (
    <div className="flex items-start gap-4 py-3">
      <Avatar className="h-9 w-9">
        <AvatarFallback className="bg-primary/10 text-primary text-xs">
          {getInitials(user.firstName, user.lastName)}
        </AvatarFallback>
      </Avatar>
      <div className="flex-1 space-y-1">
        <p className="text-sm">
          <span className="font-medium">
            {user.firstName} {user.lastName}
          </span>{" "}
          {action}
          {target && <span className="font-medium"> {target}</span>}
        </p>
        <div className="flex items-center gap-2">
          <p className="text-xs text-muted-foreground">{formatRelativeTime(timestamp)}</p>
          {role && <RoleBadge role={role} className="text-[10px]" />}
        </div>
      </div>
    </div>
  )
}

// ===== FILE: components\dashboard\stats-card.tsx =====

import { cn } from "@/lib/utils"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import type { LucideIcon } from "lucide-react"

interface StatsCardProps {
  title: string
  value: string | number
  description?: string
  icon: LucideIcon
  trend?: {
    value: number
    isPositive: boolean
  }
  className?: string
}

export function StatsCard({ title, value, description, icon: Icon, trend, className }: StatsCardProps) {
  return (
    <Card className={cn("", className)}>
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-sm font-medium text-muted-foreground">{title}</CardTitle>
        <Icon className="h-4 w-4 text-muted-foreground" />
      </CardHeader>
      <CardContent>
        <div className="text-2xl font-bold">{value}</div>
        {(description || trend) && (
          <p className="text-xs text-muted-foreground mt-1">
            {trend && (
              <span className={cn("font-medium", trend.isPositive ? "text-emerald-500" : "text-red-500")}>
                {trend.isPositive ? "+" : ""}
                {trend.value}%{" "}
              </span>
            )}
            {description}
          </p>
        )}
      </CardContent>
    </Card>
  )
}

// ===== FILE: components\layout\header.tsx =====

"use client"

import { useTheme } from "next-themes"
import { Moon, Sun, Bell, Search } from "lucide-react"

import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { Avatar, AvatarFallback } from "@/components/ui/avatar"
import { useAuthStore } from "@/lib/store/auth-store"
import { getInitials } from "@/lib/utils/formatters"
import { RoleBadge } from "@/components/common/role-badge"
import Link from "next/link"

interface HeaderProps {
  title?: string
}

export function Header({ title }: HeaderProps) {
  const { theme, setTheme } = useTheme()
  const user = useAuthStore((state) => state.user)
  const logout = useAuthStore((state) => state.logout)

  return (
    <header className="sticky top-0 z-40 flex h-16 items-center justify-between border-b border-border bg-background/95 px-6 backdrop-blur supports-[backdrop-filter]:bg-background/60">
      <div className="flex items-center gap-4">
        {title && <h1 className="text-xl font-semibold">{title}</h1>}
        <div className="hidden md:flex">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
            <Input placeholder="Search..." className="w-64 pl-9 bg-secondary/50" />
          </div>
        </div>
      </div>

      <div className="flex items-center gap-2">
        {/* Theme Toggle */}
        <Button variant="ghost" size="icon" onClick={() => setTheme(theme === "dark" ? "light" : "dark")}>
          <Sun className="h-5 w-5 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0" />
          <Moon className="absolute h-5 w-5 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100" />
          <span className="sr-only">Toggle theme</span>
        </Button>

        {/* Notifications */}
        <Button variant="ghost" size="icon" className="relative">
          <Bell className="h-5 w-5" />
          <span className="absolute -right-0.5 -top-0.5 flex h-4 w-4 items-center justify-center rounded-full bg-primary text-[10px] font-medium text-primary-foreground">
            3
          </span>
          <span className="sr-only">Notifications</span>
        </Button>

        {/* User Menu */}
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" className="relative h-10 w-10 rounded-full">
              <Avatar className="h-10 w-10">
                <AvatarFallback className="bg-primary/10 text-primary">
                  {user ? getInitials(user.firstName, user.lastName) : "?"}
                </AvatarFallback>
              </Avatar>
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent className="w-56" align="end" forceMount>
            <DropdownMenuLabel className="font-normal">
              <div className="flex flex-col space-y-2">
                <p className="text-sm font-medium leading-none">
                  {user?.firstName} {user?.lastName}
                </p>
                <p className="text-xs leading-none text-muted-foreground">{user?.email}</p>
                <div className="flex flex-wrap gap-1 pt-1">
                  {user?.roles.map((role) => (
                    <RoleBadge key={role} role={role} className="text-[10px]" />
                  ))}
                </div>
              </div>
            </DropdownMenuLabel>
            <DropdownMenuSeparator />
            <DropdownMenuItem asChild>
              <Link href="/profile">Profile</Link>
            </DropdownMenuItem>
            <DropdownMenuItem asChild>
              <Link href="/settings">Settings</Link>
            </DropdownMenuItem>
            <DropdownMenuSeparator />
            <DropdownMenuItem onClick={logout} className="text-destructive">
              Log out
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      </div>
    </header>
  )
}

// ===== FILE: components\layout\protected-route.tsx =====

"use client"

import type React from "react"

import { useEffect } from "react"
import { useRouter } from "next/navigation"
import { useAuthStore } from "@/lib/store/auth-store"
import { FullPageLoader } from "@/components/common/loading-spinner"

interface ProtectedRouteProps {
  children: React.ReactNode
  permission?: string
  permissions?: string[]
  role?: string
  roles?: string[]
  requireAll?: boolean
}

export function ProtectedRoute({
  children,
  permission,
  permissions = [],
  role,
  roles = [],
  requireAll = false,
}: ProtectedRouteProps) {
  const router = useRouter()
  const isAuthenticated = useAuthStore((state) => state.isAuthenticated)
  const isLoading = useAuthStore((state) => state.isLoading)
  const hasPermission = useAuthStore((state) => state.hasPermission)
  const hasAnyPermission = useAuthStore((state) => state.hasAnyPermission)
  const hasRole = useAuthStore((state) => state.hasRole)
  const hasAnyRole = useAuthStore((state) => state.hasAnyRole)
  const user = useAuthStore((state) => state.user)

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      router.push("/login")
    }
  }, [isAuthenticated, isLoading, router])

  if (isLoading) {
    return <FullPageLoader message="Checking authentication..." />
  }

  if (!isAuthenticated) {
    return <FullPageLoader message="Redirecting to login..." />
  }

  // Check permissions
  const allPermissions = permission ? [permission, ...permissions] : permissions
  const allRoles = role ? [role, ...roles] : roles

  let hasAccess = true

  if (allPermissions.length > 0) {
    if (requireAll) {
      hasAccess = allPermissions.every((p) => hasPermission(p))
    } else {
      hasAccess = hasAnyPermission(allPermissions)
    }
  }

  if (allRoles.length > 0 && hasAccess) {
    if (requireAll) {
      hasAccess = allRoles.every((r) => hasRole(r))
    } else {
      hasAccess = hasAnyRole(allRoles)
    }
  }

  // SUPERADMIN always has access
  if (user?.roles.includes("SUPERADMIN")) {
    hasAccess = true
  }

  if (!hasAccess) {
    return (
      <div className="flex min-h-screen flex-col items-center justify-center gap-4">
        <h1 className="text-2xl font-bold">Access Denied</h1>
        <p className="text-muted-foreground">You do not have permission to view this page.</p>
      </div>
    )
  }

  return <>{children}</>
}

// ===== FILE: components\layout\sidebar.tsx =====

"use client"

import type React from "react"

import {
  Home,
  Users,
  Shield,
  ChevronLeft,
  ChevronRight,
  LogOut,
  UserCheck,
  Mail,
  LayoutDashboard,
  Building2,
  Briefcase,
  DollarSign,
  FileText,
  Receipt,
  CreditCard,
  BarChart3,
  Settings,
} from "lucide-react"
import Link from "next/link"
import { usePathname } from "next/navigation"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { ScrollArea } from "@/components/ui/scroll-area"
import { useAuthStore } from "@/lib/store/auth-store"
import { PermissionGate } from "@/components/common/permission-gate"
import Image from "next/image"

interface SidebarProps {
  isCollapsed: boolean
  onToggle: () => void
}

// Main navigation items
const mainNavItems = [
  {
    title: "Dashboard",
    href: "/dashboard",
    icon: Home,
  },
]

// Admin navigation items
const adminNavItems = [
  {
    title: "Users",
    href: "/users",
    icon: Users,
    permissions: ["AUTH_USER_READ", "VIEW_USERS"],
  },
  {
    title: "Roles",
    href: "/roles",
    icon: Shield,
    permissions: ["AUTH_ROLE_READ", "VIEW_ROLES"],
  },
  {
    title: "User Approval",
    href: "/admin/user-approval",
    icon: UserCheck,
    permissions: ["AUTH_USER_APPROVE", "AUTH_USER_ACTIVATE"],
  },
  {
    title: "Invite Management",
    href: "/admin/invites",
    icon: Mail,
    permissions: ["AUTH_INVITE_LIST", "AUTH_INVITE_READ"],
  },
]

const businessNavItems = [
  {
    title: "Overview",
    href: "/business",
    icon: LayoutDashboard,
    permissions: ["BUSINESS_CLIENT_READ"],
  },
  {
    title: "Clients",
    href: "/business/clients",
    icon: Building2,
    permissions: ["BUSINESS_CLIENT_READ"],
  },
  {
    title: "Services",
    href: "/business/services",
    icon: Briefcase,
    permissions: ["BUSINESS_SERVICE_READ"],
  },
  {
    title: "Pricing",
    href: "/business/pricing",
    icon: DollarSign,
    permissions: ["BUSINESS_PRICE_READ"],
  },
  {
    title: "Contracts",
    href: "/business/contracts",
    icon: FileText,
    permissions: ["BUSINESS_CONTRACT_READ"],
  },
  {
    title: "Invoices",
    href: "/business/invoices",
    icon: Receipt,
    permissions: ["BUSINESS_INVOICE_READ"],
  },
  {
    title: "Payments",
    href: "/business/payments",
    icon: CreditCard,
    permissions: ["BUSINESS_PAYMENT_READ"],
  },
  {
    title: "Reports",
    href: "/business/reports",
    icon: BarChart3,
    permissions: ["BUSINESS_REPORT_READ"],
  },
  {
    title: "Settings",
    href: "/business/settings",
    icon: Settings,
    permissions: ["BUSINESS_CONFIG_MANAGE"],
  },
]

export function Sidebar({ isCollapsed, onToggle }: SidebarProps) {
  const pathname = usePathname()
  const logout = useAuthStore((state) => state.logout)

  const NavItem = ({
    item,
    isActive,
  }: {
    item: { title: string; href: string; icon: React.ElementType }
    isActive: boolean
  }) => (
    <Link
      href={item.href}
      className={cn(
        "flex items-center gap-3 rounded-lg px-3 py-2 text-sm transition-colors",
        isActive ? "bg-primary/10 text-primary" : "text-muted-foreground hover:bg-muted hover:text-foreground",
        isCollapsed && "justify-center px-2",
      )}
    >
      <item.icon className="h-4 w-4 shrink-0" />
      {!isCollapsed && <span>{item.title}</span>}
    </Link>
  )

  const isPathActive = (href: string) => {
    if (href === "/business") {
      return pathname === "/business"
    }
    return pathname === href || pathname.startsWith(href + "/")
  }

  return (
    <aside
      className={cn(
        "flex h-full flex-col border-r border-border bg-card transition-all duration-300",
        isCollapsed ? "w-16" : "w-64",
      )}
    >
      {/* Header - Updated to use ASEPRE logo */}
      <div className="flex h-16 items-center justify-between px-4 border-b border-border">
        {!isCollapsed && (
          <Link href="/dashboard" className="flex items-center gap-2">
            <Image src="/images/asepre-logo.png" alt="ASEPRE" width={40} height={40} className="rounded-lg" />
            <span className="font-bold">ASEPRE</span>
          </Link>
        )}
        {isCollapsed && (
          <Link href="/dashboard" className="mx-auto">
            <Image src="/images/asepre-logo.png" alt="ASEPRE" width={32} height={32} className="rounded-lg" />
          </Link>
        )}
        <Button variant="ghost" size="icon" onClick={onToggle} className={cn(isCollapsed && "hidden")}>
          {isCollapsed ? <ChevronRight className="h-4 w-4" /> : <ChevronLeft className="h-4 w-4" />}
        </Button>
      </div>

      {/* Navigation */}
      <ScrollArea className="flex-1 px-3 py-4">
        <nav className="space-y-6">
          {/* Main */}
          <div className="space-y-1">
            {!isCollapsed && (
              <p className="px-3 text-xs font-medium text-muted-foreground uppercase tracking-wider">Main</p>
            )}
            {mainNavItems.map((item) => (
              <NavItem key={item.href} item={item} isActive={pathname === item.href} />
            ))}
          </div>

          <div className="space-y-1">
            {!isCollapsed && (
              <p className="px-3 text-xs font-medium text-muted-foreground uppercase tracking-wider">Business</p>
            )}
            {businessNavItems.map((item) => (
              <PermissionGate key={item.href} permissions={item.permissions}>
                <NavItem item={item} isActive={isPathActive(item.href)} />
              </PermissionGate>
            ))}
          </div>

          {/* Administration */}
          <div className="space-y-1">
            {!isCollapsed && (
              <p className="px-3 text-xs font-medium text-muted-foreground uppercase tracking-wider">Administration</p>
            )}
            {adminNavItems.map((item) => (
              <PermissionGate key={item.href} permissions={item.permissions}>
                <NavItem item={item} isActive={pathname === item.href} />
              </PermissionGate>
            ))}
          </div>
        </nav>
      </ScrollArea>

      {/* Footer */}
      <div className="border-t border-border p-3">
        <Button
          variant="ghost"
          className={cn(
            "w-full justify-start gap-3 text-muted-foreground hover:text-foreground",
            isCollapsed && "justify-center px-2",
          )}
          onClick={logout}
        >
          <LogOut className="h-4 w-4" />
          {!isCollapsed && <span>Logout</span>}
        </Button>
      </div>
    </aside>
  )
}

// ===== FILE: components\providers\auth-provider.tsx =====

"use client"

import type React from "react"

import { useEffect, useState } from "react"
import { useAuthStore } from "@/lib/store/auth-store"
import { getTokens } from "@/lib/api/client"
import { FullPageLoader } from "@/components/common/loading-spinner"

interface AuthProviderProps {
  children: React.ReactNode
}

export function AuthProvider({ children }: AuthProviderProps) {
  const [isInitialized, setIsInitialized] = useState(false)
  const refreshAuth = useAuthStore((state) => state.refreshAuth)

  useEffect(() => {
    const initAuth = async () => {
      const { accessToken } = getTokens()
      if (accessToken) {
        await refreshAuth()
      }
      setIsInitialized(true)
    }

    initAuth()
  }, [refreshAuth])

  if (!isInitialized) {
    return <FullPageLoader message="Initializing..." />
  }

  return <>{children}</>
}

// ===== FILE: components\providers\theme-provider.tsx =====

"use client"

import type * as React from "react"
import { ThemeProvider as NextThemesProvider } from "next-themes"

export function ThemeProvider({ children, ...props }: React.ComponentProps<typeof NextThemesProvider>) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>
}

// ===== FILE: components\roles\create-role-dialog.tsx =====

"use client"

import { useState } from "react"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import { toast } from "sonner"

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { Slider } from "@/components/ui/slider"
import { ScrollArea } from "@/components/ui/scroll-area"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { PermissionTree } from "./permission-tree"
import { createRoleSchema, type CreateRoleFormData } from "@/lib/validations/roles"
import { createRole } from "@/lib/api/roles"

// Available permissions (in production, fetch from API)
const AVAILABLE_PERMISSIONS = [
  "AUTH_USER_CREATE",
  "AUTH_USER_READ",
  "AUTH_USER_UPDATE",
  "AUTH_USER_DELETE",
  "AUTH_USER_LIST",
  "AUTH_ROLE_CREATE",
  "AUTH_ROLE_READ",
  "AUTH_ROLE_UPDATE",
  "AUTH_ROLE_DELETE",
  "AUTH_ROLE_ASSIGN",
  "AUTH_ROLE_REVOKE",
  "AUTH_PERMISSION_READ",
  "MANAGE_ROLES",
  "READ_USER",
  "UPDATE_USER",
  "DELETE_USER",
  "CREATE_USER",
]

interface CreateRoleDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: () => void
}

export function CreateRoleDialog({ open, onOpenChange, onSuccess }: CreateRoleDialogProps) {
  const [selectedPermissions, setSelectedPermissions] = useState<string[]>([])

  const {
    register,
    handleSubmit,
    reset,
    setValue,
    watch,
    formState: { errors, isSubmitting },
  } = useForm<CreateRoleFormData>({
    resolver: zodResolver(createRoleSchema),
    defaultValues: {
      level: 50,
      permissions: [],
    },
  })

  const level = watch("level")

  const onSubmit = async (data: CreateRoleFormData) => {
    try {
      const response = await createRole({
        ...data,
        permissions: selectedPermissions,
      })

      if (response.success) {
        toast.success("Role created successfully")
        reset()
        setSelectedPermissions([])
        onSuccess()
        onOpenChange(false)
      } else {
        toast.error(response.message)
      }
    } catch {
      toast.error("Failed to create role")
    }
  }

  const handlePermissionChange = (permissions: string[]) => {
    setSelectedPermissions(permissions)
    setValue("permissions", permissions)
  }

  const handleClose = () => {
    reset()
    setSelectedPermissions([])
    onOpenChange(false)
  }

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-2xl max-h-[90vh]">
        <DialogHeader>
          <DialogTitle>Create New Role</DialogTitle>
          <DialogDescription>Define a new role with specific permissions</DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit(onSubmit)}>
          <ScrollArea className="max-h-[60vh] pr-4">
            <div className="space-y-6 pb-4">
              {/* Role Name */}
              <div className="space-y-2">
                <Label htmlFor="name">Role Name</Label>
                <Input id="name" placeholder="ROLE_NAME" {...register("name")} />
                <p className="text-xs text-muted-foreground">
                  Use uppercase letters and underscores only (e.g., CONTENT_MANAGER)
                </p>
                {errors.name && <p className="text-sm text-destructive">{errors.name.message}</p>}
              </div>

              {/* Description */}
              <div className="space-y-2">
                <Label htmlFor="description">Description</Label>
                <Textarea
                  id="description"
                  placeholder="Describe what this role is for..."
                  {...register("description")}
                />
                {errors.description && <p className="text-sm text-destructive">{errors.description.message}</p>}
              </div>

              {/* Level */}
              <div className="space-y-4">
                <div className="flex items-center justify-between">
                  <Label>Hierarchy Level</Label>
                  <span className="text-sm font-medium">{level}</span>
                </div>
                <Slider
                  value={[level]}
                  onValueChange={(value) => setValue("level", value[0])}
                  min={1}
                  max={100}
                  step={1}
                />
                <p className="text-xs text-muted-foreground">
                  Lower numbers have higher authority. SUPERADMIN is level 1.
                </p>
              </div>

              {/* Permissions */}
              <div className="space-y-4">
                <div className="flex items-center justify-between">
                  <Label>Permissions</Label>
                  <span className="text-sm text-muted-foreground">{selectedPermissions.length} selected</span>
                </div>
                <PermissionTree
                  permissions={AVAILABLE_PERMISSIONS}
                  selectedPermissions={selectedPermissions}
                  onPermissionChange={handlePermissionChange}
                />
                {errors.permissions && <p className="text-sm text-destructive">{errors.permissions.message}</p>}
              </div>
            </div>
          </ScrollArea>

          <DialogFooter className="mt-4">
            <Button type="button" variant="outline" onClick={handleClose}>
              Cancel
            </Button>
            <Button type="submit" disabled={isSubmitting}>
              {isSubmitting && <LoadingSpinner size="sm" className="mr-2" />}
              Create Role
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}

// ===== FILE: components\roles\edit-role-dialog.tsx =====

"use client"

import { useState, useEffect } from "react"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import { toast } from "sonner"

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Badge } from "@/components/ui/badge"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { PermissionTree } from "./permission-tree"
import { RoleBadge } from "@/components/common/role-badge"
import { updateRoleSchema, type UpdateRoleFormData } from "@/lib/validations/roles"
import { updateRole } from "@/lib/api/roles"
import type { Role } from "@/types"

// Available permissions (in production, fetch from API)
const AVAILABLE_PERMISSIONS = [
  "AUTH_USER_CREATE",
  "AUTH_USER_READ",
  "AUTH_USER_UPDATE",
  "AUTH_USER_DELETE",
  "AUTH_USER_LIST",
  "AUTH_ROLE_CREATE",
  "AUTH_ROLE_READ",
  "AUTH_ROLE_UPDATE",
  "AUTH_ROLE_DELETE",
  "AUTH_ROLE_ASSIGN",
  "AUTH_ROLE_REVOKE",
  "AUTH_PERMISSION_READ",
  "MANAGE_ROLES",
  "READ_USER",
  "UPDATE_USER",
  "DELETE_USER",
  "CREATE_USER",
]

interface EditRoleDialogProps {
  role: Role | null
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: () => void
}

export function EditRoleDialog({ role, open, onOpenChange, onSuccess }: EditRoleDialogProps) {
  const [selectedPermissions, setSelectedPermissions] = useState<string[]>([])

  const {
    register,
    handleSubmit,
    reset,
    setValue,
    formState: { errors, isSubmitting },
  } = useForm<UpdateRoleFormData>({
    resolver: zodResolver(updateRoleSchema),
  })

  useEffect(() => {
    if (role) {
      reset({
        description: role.description,
        permissions: role.permissions,
      })
      setSelectedPermissions(role.permissions)
    }
  }, [role, reset])

  const onSubmit = async (data: UpdateRoleFormData) => {
    if (!role) return

    try {
      const response = await updateRole(role.id, {
        description: data.description,
        permissions: selectedPermissions,
      })

      if (response.success) {
        toast.success("Role updated successfully")
        onSuccess()
        onOpenChange(false)
      } else {
        toast.error(response.message)
      }
    } catch {
      toast.error("Failed to update role")
    }
  }

  const handlePermissionChange = (permissions: string[]) => {
    setSelectedPermissions(permissions)
    setValue("permissions", permissions)
  }

  if (!role) return null

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-2xl max-h-[90vh]">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            Edit Role
            <RoleBadge role={role.name} />
          </DialogTitle>
          <DialogDescription>Update the role description and permissions</DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit(onSubmit)}>
          <ScrollArea className="max-h-[60vh] pr-4">
            <div className="space-y-6 pb-4">
              {/* Role Info (Read-only) */}
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Role Name</Label>
                  <Input value={role.name} disabled className="bg-muted" />
                </div>
                <div className="space-y-2">
                  <Label>Level</Label>
                  <Input value={role.level.toString()} disabled className="bg-muted" />
                </div>
              </div>

              {role.isSystem && (
                <Badge variant="secondary" className="gap-1">
                  System role - some fields cannot be modified
                </Badge>
              )}

              {/* Description */}
              <div className="space-y-2">
                <Label htmlFor="description">Description</Label>
                <Textarea
                  id="description"
                  placeholder="Describe what this role is for..."
                  {...register("description")}
                  disabled={role.isSystem}
                />
                {errors.description && <p className="text-sm text-destructive">{errors.description.message}</p>}
              </div>

              {/* Permissions */}
              <div className="space-y-4">
                <div className="flex items-center justify-between">
                  <Label>Permissions</Label>
                  <span className="text-sm text-muted-foreground">{selectedPermissions.length} selected</span>
                </div>
                <PermissionTree
                  permissions={AVAILABLE_PERMISSIONS}
                  selectedPermissions={selectedPermissions}
                  onPermissionChange={handlePermissionChange}
                  disabled={role.isSystem}
                />
                {errors.permissions && <p className="text-sm text-destructive">{errors.permissions.message}</p>}
              </div>
            </div>
          </ScrollArea>

          <DialogFooter className="mt-4">
            <Button type="button" variant="outline" onClick={() => onOpenChange(false)}>
              Cancel
            </Button>
            <Button type="submit" disabled={isSubmitting || role.isSystem}>
              {isSubmitting && <LoadingSpinner size="sm" className="mr-2" />}
              Save Changes
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}

// ===== FILE: components\roles\permission-tree.tsx =====

"use client"

import { useState } from "react"
import { ChevronRight, ChevronDown, Check, Minus } from "lucide-react"
import { cn } from "@/lib/utils"
import { Checkbox } from "@/components/ui/checkbox"
import { groupPermissionsByModule, formatPermission } from "@/lib/utils/permissions"

interface PermissionTreeProps {
  permissions: string[]
  selectedPermissions: string[]
  onPermissionChange: (permissions: string[]) => void
  disabled?: boolean
}

export function PermissionTree({
  permissions,
  selectedPermissions,
  onPermissionChange,
  disabled = false,
}: PermissionTreeProps) {
  const [expandedModules, setExpandedModules] = useState<string[]>([])
  const groupedPermissions = groupPermissionsByModule(permissions)

  const toggleModule = (module: string) => {
    setExpandedModules((prev) => (prev.includes(module) ? prev.filter((m) => m !== module) : [...prev, module]))
  }

  const isModuleFullySelected = (modulePermissions: string[]) => {
    return modulePermissions.every((p) => selectedPermissions.includes(p))
  }

  const isModulePartiallySelected = (modulePermissions: string[]) => {
    const selectedCount = modulePermissions.filter((p) => selectedPermissions.includes(p)).length
    return selectedCount > 0 && selectedCount < modulePermissions.length
  }

  const toggleModulePermissions = (modulePermissions: string[]) => {
    if (disabled) return

    if (isModuleFullySelected(modulePermissions)) {
      // Remove all module permissions
      onPermissionChange(selectedPermissions.filter((p) => !modulePermissions.includes(p)))
    } else {
      // Add all module permissions
      const newPermissions = new Set([...selectedPermissions, ...modulePermissions])
      onPermissionChange(Array.from(newPermissions))
    }
  }

  const togglePermission = (permission: string) => {
    if (disabled) return

    if (selectedPermissions.includes(permission)) {
      onPermissionChange(selectedPermissions.filter((p) => p !== permission))
    } else {
      onPermissionChange([...selectedPermissions, permission])
    }
  }

  return (
    <div className="space-y-1">
      {Object.entries(groupedPermissions).map(([module, modulePermissions]) => {
        const isExpanded = expandedModules.includes(module)
        const isFullySelected = isModuleFullySelected(modulePermissions)
        const isPartiallySelected = isModulePartiallySelected(modulePermissions)

        return (
          <div key={module} className="rounded-lg border border-border">
            {/* Module Header */}
            <div
              className={cn(
                "flex items-center gap-2 px-3 py-2 cursor-pointer hover:bg-muted/50",
                isExpanded && "border-b border-border",
              )}
              onClick={() => toggleModule(module)}
            >
              <button type="button" className="p-0.5 hover:bg-muted rounded">
                {isExpanded ? <ChevronDown className="h-4 w-4" /> : <ChevronRight className="h-4 w-4" />}
              </button>
              <div
                className="flex items-center gap-2 flex-1"
                onClick={(e) => {
                  e.stopPropagation()
                  toggleModulePermissions(modulePermissions)
                }}
              >
                <div
                  className={cn(
                    "h-4 w-4 rounded border flex items-center justify-center",
                    isFullySelected
                      ? "bg-primary border-primary"
                      : isPartiallySelected
                        ? "bg-primary/50 border-primary"
                        : "border-input",
                    disabled && "opacity-50 cursor-not-allowed",
                  )}
                >
                  {isFullySelected && <Check className="h-3 w-3 text-primary-foreground" />}
                  {isPartiallySelected && !isFullySelected && <Minus className="h-3 w-3 text-primary-foreground" />}
                </div>
                <span className="font-medium text-sm">{module}</span>
                <span className="text-xs text-muted-foreground">
                  ({modulePermissions.filter((p) => selectedPermissions.includes(p)).length}/{modulePermissions.length})
                </span>
              </div>
            </div>

            {/* Module Permissions */}
            {isExpanded && (
              <div className="px-3 py-2 space-y-2 bg-muted/30">
                {modulePermissions.map((permission) => (
                  <div key={permission} className="flex items-center gap-2 ml-6">
                    <Checkbox
                      id={permission}
                      checked={selectedPermissions.includes(permission)}
                      onCheckedChange={() => togglePermission(permission)}
                      disabled={disabled}
                    />
                    <label
                      htmlFor={permission}
                      className={cn("text-sm cursor-pointer", disabled && "cursor-not-allowed opacity-50")}
                    >
                      {formatPermission(permission)}
                    </label>
                  </div>
                ))}
              </div>
            )}
          </div>
        )
      })}
    </div>
  )
}

// ===== FILE: components\roles\role-card.tsx =====

"use client"

import { MoreHorizontal, Edit, Trash2, Users, Lock } from "lucide-react"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { Badge } from "@/components/ui/badge"
import { RoleBadge } from "@/components/common/role-badge"
import { PermissionGate } from "@/components/common/permission-gate"
import type { Role } from "@/types"
import { formatRelativeTime } from "@/lib/utils/formatters"

interface RoleCardProps {
  role: Role
  onEdit: (role: Role) => void
  onDelete: (role: Role) => void
  onViewUsers: (role: Role) => void
}

export function RoleCard({ role, onEdit, onDelete, onViewUsers }: RoleCardProps) {
  return (
    <Card className="relative">
      {role.isSystem && (
        <div className="absolute top-3 right-12">
          <Badge variant="secondary" className="gap-1">
            <Lock className="h-3 w-3" />
            System
          </Badge>
        </div>
      )}

      <CardHeader className="flex flex-row items-start justify-between space-y-0 pb-2">
        <div className="space-y-1">
          <CardTitle className="flex items-center gap-2">
            <RoleBadge role={role.name} />
          </CardTitle>
          <CardDescription className="text-xs">Level {role.level}</CardDescription>
        </div>
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" size="icon" className="h-8 w-8">
              <MoreHorizontal className="h-4 w-4" />
              <span className="sr-only">Open menu</span>
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuItem onClick={() => onViewUsers(role)}>
              <Users className="mr-2 h-4 w-4" />
              View Users
            </DropdownMenuItem>
            {!role.isSystem && (
              <>
                <PermissionGate permissions={["AUTH_ROLE_UPDATE"]} roles={["SUPERADMIN"]}>
                  <DropdownMenuItem onClick={() => onEdit(role)}>
                    <Edit className="mr-2 h-4 w-4" />
                    Edit Role
                  </DropdownMenuItem>
                </PermissionGate>
                <DropdownMenuSeparator />
                <PermissionGate permissions={["AUTH_ROLE_DELETE"]} roles={["SUPERADMIN"]}>
                  <DropdownMenuItem onClick={() => onDelete(role)} className="text-destructive">
                    <Trash2 className="mr-2 h-4 w-4" />
                    Delete Role
                  </DropdownMenuItem>
                </PermissionGate>
              </>
            )}
          </DropdownMenuContent>
        </DropdownMenu>
      </CardHeader>

      <CardContent className="space-y-4">
        <p className="text-sm text-muted-foreground">{role.description}</p>

        <div className="space-y-2">
          <div className="flex items-center justify-between text-sm">
            <span className="text-muted-foreground">Permissions</span>
            <span className="font-medium">{role.permissions.length}</span>
          </div>
          <div className="flex flex-wrap gap-1">
            {role.permissions.slice(0, 3).map((permission) => (
              <Badge key={permission} variant="outline" className="text-xs">
                {permission}
              </Badge>
            ))}
            {role.permissions.length > 3 && (
              <Badge variant="secondary" className="text-xs">
                +{role.permissions.length - 3} more
              </Badge>
            )}
          </div>
        </div>

        <div className="pt-2 border-t border-border">
          <p className="text-xs text-muted-foreground">Updated {formatRelativeTime(role.updatedAt)}</p>
        </div>
      </CardContent>
    </Card>
  )
}

// ===== FILE: components\ui\accordion.tsx =====

'use client'

import * as React from 'react'
import * as AccordionPrimitive from '@radix-ui/react-accordion'
import { ChevronDownIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function Accordion({
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Root>) {
  return <AccordionPrimitive.Root data-slot="accordion" {...props} />
}

function AccordionItem({
  className,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Item>) {
  return (
    <AccordionPrimitive.Item
      data-slot="accordion-item"
      className={cn('border-b last:border-b-0', className)}
      {...props}
    />
  )
}

function AccordionTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Trigger>) {
  return (
    <AccordionPrimitive.Header className="flex">
      <AccordionPrimitive.Trigger
        data-slot="accordion-trigger"
        className={cn(
          'focus-visible:border-ring focus-visible:ring-ring/50 flex flex-1 items-start justify-between gap-4 rounded-md py-4 text-left text-sm font-medium transition-all outline-none hover:underline focus-visible:ring-[3px] disabled:pointer-events-none disabled:opacity-50 [&[data-state=open]>svg]:rotate-180',
          className,
        )}
        {...props}
      >
        {children}
        <ChevronDownIcon className="text-muted-foreground pointer-events-none size-4 shrink-0 translate-y-0.5 transition-transform duration-200" />
      </AccordionPrimitive.Trigger>
    </AccordionPrimitive.Header>
  )
}

function AccordionContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Content>) {
  return (
    <AccordionPrimitive.Content
      data-slot="accordion-content"
      className="data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down overflow-hidden text-sm"
      {...props}
    >
      <div className={cn('pt-0 pb-4', className)}>{children}</div>
    </AccordionPrimitive.Content>
  )
}

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }

// ===== FILE: components\ui\alert-dialog.tsx =====

'use client'

import * as React from 'react'
import * as AlertDialogPrimitive from '@radix-ui/react-alert-dialog'

import { cn } from '@/lib/utils'
import { buttonVariants } from '@/components/ui/button'

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        'data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50',
        className,
      )}
      {...props}
    />
  )
}

function AlertDialogContent({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          'bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg',
          className,
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn('flex flex-col gap-2 text-center sm:text-left', className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        'flex flex-col-reverse gap-2 sm:flex-row sm:justify-end',
        className,
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn('text-lg font-semibold', className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn('text-muted-foreground text-sm', className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: 'outline' }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}

// ===== FILE: components\ui\alert.tsx =====

import * as React from 'react'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'

const alertVariants = cva(
  'relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current',
  {
    variants: {
      variant: {
        default: 'bg-card text-card-foreground',
        destructive:
          'text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90',
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  },
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<'div'> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        'col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight',
        className,
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        'text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed',
        className,
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }

// ===== FILE: components\ui\aspect-ratio.tsx =====

'use client'

import * as AspectRatioPrimitive from '@radix-ui/react-aspect-ratio'

function AspectRatio({
  ...props
}: React.ComponentProps<typeof AspectRatioPrimitive.Root>) {
  return <AspectRatioPrimitive.Root data-slot="aspect-ratio" {...props} />
}

export { AspectRatio }

// ===== FILE: components\ui\avatar.tsx =====

'use client'

import * as React from 'react'
import * as AvatarPrimitive from '@radix-ui/react-avatar'

import { cn } from '@/lib/utils'

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        'relative flex size-8 shrink-0 overflow-hidden rounded-full',
        className,
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn('aspect-square size-full', className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        'bg-muted flex size-full items-center justify-center rounded-full',
        className,
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }

// ===== FILE: components\ui\badge.tsx =====

import * as React from 'react'
import { Slot } from '@radix-ui/react-slot'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'

const badgeVariants = cva(
  'inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden',
  {
    variants: {
      variant: {
        default:
          'border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90',
        secondary:
          'border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90',
        destructive:
          'border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60',
        outline:
          'text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground',
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  },
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<'span'> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : 'span'

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }

// ===== FILE: components\ui\breadcrumb.tsx =====

import * as React from 'react'
import { Slot } from '@radix-ui/react-slot'
import { ChevronRight, MoreHorizontal } from 'lucide-react'

import { cn } from '@/lib/utils'

function Breadcrumb({ ...props }: React.ComponentProps<'nav'>) {
  return <nav aria-label="breadcrumb" data-slot="breadcrumb" {...props} />
}

function BreadcrumbList({ className, ...props }: React.ComponentProps<'ol'>) {
  return (
    <ol
      data-slot="breadcrumb-list"
      className={cn(
        'text-muted-foreground flex flex-wrap items-center gap-1.5 text-sm break-words sm:gap-2.5',
        className,
      )}
      {...props}
    />
  )
}

function BreadcrumbItem({ className, ...props }: React.ComponentProps<'li'>) {
  return (
    <li
      data-slot="breadcrumb-item"
      className={cn('inline-flex items-center gap-1.5', className)}
      {...props}
    />
  )
}

function BreadcrumbLink({
  asChild,
  className,
  ...props
}: React.ComponentProps<'a'> & {
  asChild?: boolean
}) {
  const Comp = asChild ? Slot : 'a'

  return (
    <Comp
      data-slot="breadcrumb-link"
      className={cn('hover:text-foreground transition-colors', className)}
      {...props}
    />
  )
}

function BreadcrumbPage({ className, ...props }: React.ComponentProps<'span'>) {
  return (
    <span
      data-slot="breadcrumb-page"
      role="link"
      aria-disabled="true"
      aria-current="page"
      className={cn('text-foreground font-normal', className)}
      {...props}
    />
  )
}

function BreadcrumbSeparator({
  children,
  className,
  ...props
}: React.ComponentProps<'li'>) {
  return (
    <li
      data-slot="breadcrumb-separator"
      role="presentation"
      aria-hidden="true"
      className={cn('[&>svg]:size-3.5', className)}
      {...props}
    >
      {children ?? <ChevronRight />}
    </li>
  )
}

function BreadcrumbEllipsis({
  className,
  ...props
}: React.ComponentProps<'span'>) {
  return (
    <span
      data-slot="breadcrumb-ellipsis"
      role="presentation"
      aria-hidden="true"
      className={cn('flex size-9 items-center justify-center', className)}
      {...props}
    >
      <MoreHorizontal className="size-4" />
      <span className="sr-only">More</span>
    </span>
  )
}

export {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
  BreadcrumbEllipsis,
}

// ===== FILE: components\ui\button-group.tsx =====

import { Slot } from '@radix-ui/react-slot'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'
import { Separator } from '@/components/ui/separator'

const buttonGroupVariants = cva(
  "flex w-fit items-stretch [&>*]:focus-visible:z-10 [&>*]:focus-visible:relative [&>[data-slot=select-trigger]:not([class*='w-'])]:w-fit [&>input]:flex-1 has-[select[aria-hidden=true]:last-child]:[&>[data-slot=select-trigger]:last-of-type]:rounded-r-md has-[>[data-slot=button-group]]:gap-2",
  {
    variants: {
      orientation: {
        horizontal:
          '[&>*:not(:first-child)]:rounded-l-none [&>*:not(:first-child)]:border-l-0 [&>*:not(:last-child)]:rounded-r-none',
        vertical:
          'flex-col [&>*:not(:first-child)]:rounded-t-none [&>*:not(:first-child)]:border-t-0 [&>*:not(:last-child)]:rounded-b-none',
      },
    },
    defaultVariants: {
      orientation: 'horizontal',
    },
  },
)

function ButtonGroup({
  className,
  orientation,
  ...props
}: React.ComponentProps<'div'> & VariantProps<typeof buttonGroupVariants>) {
  return (
    <div
      role="group"
      data-slot="button-group"
      data-orientation={orientation}
      className={cn(buttonGroupVariants({ orientation }), className)}
      {...props}
    />
  )
}

function ButtonGroupText({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<'div'> & {
  asChild?: boolean
}) {
  const Comp = asChild ? Slot : 'div'

  return (
    <Comp
      className={cn(
        "bg-muted flex items-center gap-2 rounded-md border px-4 text-sm font-medium shadow-xs [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function ButtonGroupSeparator({
  className,
  orientation = 'vertical',
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="button-group-separator"
      orientation={orientation}
      className={cn(
        'bg-input relative !m-0 self-stretch data-[orientation=vertical]:h-auto',
        className,
      )}
      {...props}
    />
  )
}

export {
  ButtonGroup,
  ButtonGroupSeparator,
  ButtonGroupText,
  buttonGroupVariants,
}

// ===== FILE: components\ui\button.tsx =====

import * as React from 'react'
import { Slot } from '@radix-ui/react-slot'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: 'bg-primary text-primary-foreground hover:bg-primary/90',
        destructive:
          'bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60',
        outline:
          'border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50',
        secondary:
          'bg-secondary text-secondary-foreground hover:bg-secondary/80',
        ghost:
          'hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50',
        link: 'text-primary underline-offset-4 hover:underline',
      },
      size: {
        default: 'h-9 px-4 py-2 has-[>svg]:px-3',
        sm: 'h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5',
        lg: 'h-10 rounded-md px-6 has-[>svg]:px-4',
        icon: 'size-9',
        'icon-sm': 'size-8',
        'icon-lg': 'size-10',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  },
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<'button'> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : 'button'

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }

// ===== FILE: components\ui\calendar.tsx =====

'use client'

import * as React from 'react'
import {
  ChevronDownIcon,
  ChevronLeftIcon,
  ChevronRightIcon,
} from 'lucide-react'
import { DayButton, DayPicker, getDefaultClassNames } from 'react-day-picker'

import { cn } from '@/lib/utils'
import { Button, buttonVariants } from '@/components/ui/button'

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  captionLayout = 'label',
  buttonVariant = 'ghost',
  formatters,
  components,
  ...props
}: React.ComponentProps<typeof DayPicker> & {
  buttonVariant?: React.ComponentProps<typeof Button>['variant']
}) {
  const defaultClassNames = getDefaultClassNames()

  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn(
        'bg-background group/calendar p-3 [--cell-size:--spacing(8)] [[data-slot=card-content]_&]:bg-transparent [[data-slot=popover-content]_&]:bg-transparent',
        String.raw`rtl:**:[.rdp-button\_next>svg]:rotate-180`,
        String.raw`rtl:**:[.rdp-button\_previous>svg]:rotate-180`,
        className,
      )}
      captionLayout={captionLayout}
      formatters={{
        formatMonthDropdown: (date) =>
          date.toLocaleString('default', { month: 'short' }),
        ...formatters,
      }}
      classNames={{
        root: cn('w-fit', defaultClassNames.root),
        months: cn(
          'flex gap-4 flex-col md:flex-row relative',
          defaultClassNames.months,
        ),
        month: cn('flex flex-col w-full gap-4', defaultClassNames.month),
        nav: cn(
          'flex items-center gap-1 w-full absolute top-0 inset-x-0 justify-between',
          defaultClassNames.nav,
        ),
        button_previous: cn(
          buttonVariants({ variant: buttonVariant }),
          'size-(--cell-size) aria-disabled:opacity-50 p-0 select-none',
          defaultClassNames.button_previous,
        ),
        button_next: cn(
          buttonVariants({ variant: buttonVariant }),
          'size-(--cell-size) aria-disabled:opacity-50 p-0 select-none',
          defaultClassNames.button_next,
        ),
        month_caption: cn(
          'flex items-center justify-center h-(--cell-size) w-full px-(--cell-size)',
          defaultClassNames.month_caption,
        ),
        dropdowns: cn(
          'w-full flex items-center text-sm font-medium justify-center h-(--cell-size) gap-1.5',
          defaultClassNames.dropdowns,
        ),
        dropdown_root: cn(
          'relative has-focus:border-ring border border-input shadow-xs has-focus:ring-ring/50 has-focus:ring-[3px] rounded-md',
          defaultClassNames.dropdown_root,
        ),
        dropdown: cn(
          'absolute bg-popover inset-0 opacity-0',
          defaultClassNames.dropdown,
        ),
        caption_label: cn(
          'select-none font-medium',
          captionLayout === 'label'
            ? 'text-sm'
            : 'rounded-md pl-2 pr-1 flex items-center gap-1 text-sm h-8 [&>svg]:text-muted-foreground [&>svg]:size-3.5',
          defaultClassNames.caption_label,
        ),
        table: 'w-full border-collapse',
        weekdays: cn('flex', defaultClassNames.weekdays),
        weekday: cn(
          'text-muted-foreground rounded-md flex-1 font-normal text-[0.8rem] select-none',
          defaultClassNames.weekday,
        ),
        week: cn('flex w-full mt-2', defaultClassNames.week),
        week_number_header: cn(
          'select-none w-(--cell-size)',
          defaultClassNames.week_number_header,
        ),
        week_number: cn(
          'text-[0.8rem] select-none text-muted-foreground',
          defaultClassNames.week_number,
        ),
        day: cn(
          'relative w-full h-full p-0 text-center [&:first-child[data-selected=true]_button]:rounded-l-md [&:last-child[data-selected=true]_button]:rounded-r-md group/day aspect-square select-none',
          defaultClassNames.day,
        ),
        range_start: cn(
          'rounded-l-md bg-accent',
          defaultClassNames.range_start,
        ),
        range_middle: cn('rounded-none', defaultClassNames.range_middle),
        range_end: cn('rounded-r-md bg-accent', defaultClassNames.range_end),
        today: cn(
          'bg-accent text-accent-foreground rounded-md data-[selected=true]:rounded-none',
          defaultClassNames.today,
        ),
        outside: cn(
          'text-muted-foreground aria-selected:text-muted-foreground',
          defaultClassNames.outside,
        ),
        disabled: cn(
          'text-muted-foreground opacity-50',
          defaultClassNames.disabled,
        ),
        hidden: cn('invisible', defaultClassNames.hidden),
        ...classNames,
      }}
      components={{
        Root: ({ className, rootRef, ...props }) => {
          return (
            <div
              data-slot="calendar"
              ref={rootRef}
              className={cn(className)}
              {...props}
            />
          )
        },
        Chevron: ({ className, orientation, ...props }) => {
          if (orientation === 'left') {
            return (
              <ChevronLeftIcon className={cn('size-4', className)} {...props} />
            )
          }

          if (orientation === 'right') {
            return (
              <ChevronRightIcon
                className={cn('size-4', className)}
                {...props}
              />
            )
          }

          return (
            <ChevronDownIcon className={cn('size-4', className)} {...props} />
          )
        },
        DayButton: CalendarDayButton,
        WeekNumber: ({ children, ...props }) => {
          return (
            <td {...props}>
              <div className="flex size-(--cell-size) items-center justify-center text-center">
                {children}
              </div>
            </td>
          )
        },
        ...components,
      }}
      {...props}
    />
  )
}

function CalendarDayButton({
  className,
  day,
  modifiers,
  ...props
}: React.ComponentProps<typeof DayButton>) {
  const defaultClassNames = getDefaultClassNames()

  const ref = React.useRef<HTMLButtonElement>(null)
  React.useEffect(() => {
    if (modifiers.focused) ref.current?.focus()
  }, [modifiers.focused])

  return (
    <Button
      ref={ref}
      variant="ghost"
      size="icon"
      data-day={day.date.toLocaleDateString()}
      data-selected-single={
        modifiers.selected &&
        !modifiers.range_start &&
        !modifiers.range_end &&
        !modifiers.range_middle
      }
      data-range-start={modifiers.range_start}
      data-range-end={modifiers.range_end}
      data-range-middle={modifiers.range_middle}
      className={cn(
        'data-[selected-single=true]:bg-primary data-[selected-single=true]:text-primary-foreground data-[range-middle=true]:bg-accent data-[range-middle=true]:text-accent-foreground data-[range-start=true]:bg-primary data-[range-start=true]:text-primary-foreground data-[range-end=true]:bg-primary data-[range-end=true]:text-primary-foreground group-data-[focused=true]/day:border-ring group-data-[focused=true]/day:ring-ring/50 dark:hover:text-accent-foreground flex aspect-square size-auto w-full min-w-(--cell-size) flex-col gap-1 leading-none font-normal group-data-[focused=true]/day:relative group-data-[focused=true]/day:z-10 group-data-[focused=true]/day:ring-[3px] data-[range-end=true]:rounded-md data-[range-end=true]:rounded-r-md data-[range-middle=true]:rounded-none data-[range-start=true]:rounded-md data-[range-start=true]:rounded-l-md [&>span]:text-xs [&>span]:opacity-70',
        defaultClassNames.day,
        className,
      )}
      {...props}
    />
  )
}

export { Calendar, CalendarDayButton }

// ===== FILE: components\ui\card.tsx =====

import * as React from 'react'

import { cn } from '@/lib/utils'

function Card({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card"
      className={cn(
        'bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm',
        className,
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        '@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6',
        className,
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-title"
      className={cn('leading-none font-semibold', className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-description"
      className={cn('text-muted-foreground text-sm', className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        'col-start-2 row-span-2 row-start-1 self-start justify-self-end',
        className,
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-content"
      className={cn('px-6', className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-footer"
      className={cn('flex items-center px-6 [.border-t]:pt-6', className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}

// ===== FILE: components\ui\carousel.tsx =====

'use client'

import * as React from 'react'
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from 'embla-carousel-react'
import { ArrowLeft, ArrowRight } from 'lucide-react'

import { cn } from '@/lib/utils'
import { Button } from '@/components/ui/button'

type CarouselApi = UseEmblaCarouselType[1]
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>
type CarouselOptions = UseCarouselParameters[0]
type CarouselPlugin = UseCarouselParameters[1]

type CarouselProps = {
  opts?: CarouselOptions
  plugins?: CarouselPlugin
  orientation?: 'horizontal' | 'vertical'
  setApi?: (api: CarouselApi) => void
}

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0]
  api: ReturnType<typeof useEmblaCarousel>[1]
  scrollPrev: () => void
  scrollNext: () => void
  canScrollPrev: boolean
  canScrollNext: boolean
} & CarouselProps

const CarouselContext = React.createContext<CarouselContextProps | null>(null)

function useCarousel() {
  const context = React.useContext(CarouselContext)

  if (!context) {
    throw new Error('useCarousel must be used within a <Carousel />')
  }

  return context
}

function Carousel({
  orientation = 'horizontal',
  opts,
  setApi,
  plugins,
  className,
  children,
  ...props
}: React.ComponentProps<'div'> & CarouselProps) {
  const [carouselRef, api] = useEmblaCarousel(
    {
      ...opts,
      axis: orientation === 'horizontal' ? 'x' : 'y',
    },
    plugins,
  )
  const [canScrollPrev, setCanScrollPrev] = React.useState(false)
  const [canScrollNext, setCanScrollNext] = React.useState(false)

  const onSelect = React.useCallback((api: CarouselApi) => {
    if (!api) return
    setCanScrollPrev(api.canScrollPrev())
    setCanScrollNext(api.canScrollNext())
  }, [])

  const scrollPrev = React.useCallback(() => {
    api?.scrollPrev()
  }, [api])

  const scrollNext = React.useCallback(() => {
    api?.scrollNext()
  }, [api])

  const handleKeyDown = React.useCallback(
    (event: React.KeyboardEvent<HTMLDivElement>) => {
      if (event.key === 'ArrowLeft') {
        event.preventDefault()
        scrollPrev()
      } else if (event.key === 'ArrowRight') {
        event.preventDefault()
        scrollNext()
      }
    },
    [scrollPrev, scrollNext],
  )

  React.useEffect(() => {
    if (!api || !setApi) return
    setApi(api)
  }, [api, setApi])

  React.useEffect(() => {
    if (!api) return
    onSelect(api)
    api.on('reInit', onSelect)
    api.on('select', onSelect)

    return () => {
      api?.off('select', onSelect)
    }
  }, [api, onSelect])

  return (
    <CarouselContext.Provider
      value={{
        carouselRef,
        api: api,
        opts,
        orientation:
          orientation || (opts?.axis === 'y' ? 'vertical' : 'horizontal'),
        scrollPrev,
        scrollNext,
        canScrollPrev,
        canScrollNext,
      }}
    >
      <div
        onKeyDownCapture={handleKeyDown}
        className={cn('relative', className)}
        role="region"
        aria-roledescription="carousel"
        data-slot="carousel"
        {...props}
      >
        {children}
      </div>
    </CarouselContext.Provider>
  )
}

function CarouselContent({ className, ...props }: React.ComponentProps<'div'>) {
  const { carouselRef, orientation } = useCarousel()

  return (
    <div
      ref={carouselRef}
      className="overflow-hidden"
      data-slot="carousel-content"
    >
      <div
        className={cn(
          'flex',
          orientation === 'horizontal' ? '-ml-4' : '-mt-4 flex-col',
          className,
        )}
        {...props}
      />
    </div>
  )
}

function CarouselItem({ className, ...props }: React.ComponentProps<'div'>) {
  const { orientation } = useCarousel()

  return (
    <div
      role="group"
      aria-roledescription="slide"
      data-slot="carousel-item"
      className={cn(
        'min-w-0 shrink-0 grow-0 basis-full',
        orientation === 'horizontal' ? 'pl-4' : 'pt-4',
        className,
      )}
      {...props}
    />
  )
}

function CarouselPrevious({
  className,
  variant = 'outline',
  size = 'icon',
  ...props
}: React.ComponentProps<typeof Button>) {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel()

  return (
    <Button
      data-slot="carousel-previous"
      variant={variant}
      size={size}
      className={cn(
        'absolute size-8 rounded-full',
        orientation === 'horizontal'
          ? 'top-1/2 -left-12 -translate-y-1/2'
          : '-top-12 left-1/2 -translate-x-1/2 rotate-90',
        className,
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft />
      <span className="sr-only">Previous slide</span>
    </Button>
  )
}

function CarouselNext({
  className,
  variant = 'outline',
  size = 'icon',
  ...props
}: React.ComponentProps<typeof Button>) {
  const { orientation, scrollNext, canScrollNext } = useCarousel()

  return (
    <Button
      data-slot="carousel-next"
      variant={variant}
      size={size}
      className={cn(
        'absolute size-8 rounded-full',
        orientation === 'horizontal'
          ? 'top-1/2 -right-12 -translate-y-1/2'
          : '-bottom-12 left-1/2 -translate-x-1/2 rotate-90',
        className,
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight />
      <span className="sr-only">Next slide</span>
    </Button>
  )
}

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
}

// ===== FILE: components\ui\chart.tsx =====

'use client'

import * as React from 'react'
import * as RechartsPrimitive from 'recharts'

import { cn } from '@/lib/utils'

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: '', dark: '.dark' } as const

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode
    icon?: React.ComponentType
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  )
}

type ChartContextProps = {
  config: ChartConfig
}

const ChartContext = React.createContext<ChartContextProps | null>(null)

function useChart() {
  const context = React.useContext(ChartContext)

  if (!context) {
    throw new Error('useChart must be used within a <ChartContainer />')
  }

  return context
}

function ChartContainer({
  id,
  className,
  children,
  config,
  ...props
}: React.ComponentProps<'div'> & {
  config: ChartConfig
  children: React.ComponentProps<
    typeof RechartsPrimitive.ResponsiveContainer
  >['children']
}) {
  const uniqueId = React.useId()
  const chartId = `chart-${id || uniqueId.replace(/:/g, '')}`

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-slot="chart"
        data-chart={chartId}
        className={cn(
          "[&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border flex aspect-video justify-center text-xs [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-hidden [&_.recharts-sector]:outline-hidden [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-surface]:outline-hidden",
          className,
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  )
}

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([, config]) => config.theme || config.color,
  )

  if (!colorConfig.length) {
    return null
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color
    return color ? `  --color-${key}: ${color};` : null
  })
  .join('\n')}
}
`,
          )
          .join('\n'),
      }}
    />
  )
}

const ChartTooltip = RechartsPrimitive.Tooltip

function ChartTooltipContent({
  active,
  payload,
  className,
  indicator = 'dot',
  hideLabel = false,
  hideIndicator = false,
  label,
  labelFormatter,
  labelClassName,
  formatter,
  color,
  nameKey,
  labelKey,
}: React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
  React.ComponentProps<'div'> & {
    hideLabel?: boolean
    hideIndicator?: boolean
    indicator?: 'line' | 'dot' | 'dashed'
    nameKey?: string
    labelKey?: string
  }) {
  const { config } = useChart()

  const tooltipLabel = React.useMemo(() => {
    if (hideLabel || !payload?.length) {
      return null
    }

    const [item] = payload
    const key = `${labelKey || item?.dataKey || item?.name || 'value'}`
    const itemConfig = getPayloadConfigFromPayload(config, item, key)
    const value =
      !labelKey && typeof label === 'string'
        ? config[label as keyof typeof config]?.label || label
        : itemConfig?.label

    if (labelFormatter) {
      return (
        <div className={cn('font-medium', labelClassName)}>
          {labelFormatter(value, payload)}
        </div>
      )
    }

    if (!value) {
      return null
    }

    return <div className={cn('font-medium', labelClassName)}>{value}</div>
  }, [
    label,
    labelFormatter,
    payload,
    hideLabel,
    labelClassName,
    config,
    labelKey,
  ])

  if (!active || !payload?.length) {
    return null
  }

  const nestLabel = payload.length === 1 && indicator !== 'dot'

  return (
    <div
      className={cn(
        'border-border/50 bg-background grid min-w-[8rem] items-start gap-1.5 rounded-lg border px-2.5 py-1.5 text-xs shadow-xl',
        className,
      )}
    >
      {!nestLabel ? tooltipLabel : null}
      <div className="grid gap-1.5">
        {payload.map((item, index) => {
          const key = `${nameKey || item.name || item.dataKey || 'value'}`
          const itemConfig = getPayloadConfigFromPayload(config, item, key)
          const indicatorColor = color || item.payload.fill || item.color

          return (
            <div
              key={item.dataKey}
              className={cn(
                '[&>svg]:text-muted-foreground flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5',
                indicator === 'dot' && 'items-center',
              )}
            >
              {formatter && item?.value !== undefined && item.name ? (
                formatter(item.value, item.name, item, index, item.payload)
              ) : (
                <>
                  {itemConfig?.icon ? (
                    <itemConfig.icon />
                  ) : (
                    !hideIndicator && (
                      <div
                        className={cn(
                          'shrink-0 rounded-[2px] border-(--color-border) bg-(--color-bg)',
                          {
                            'h-2.5 w-2.5': indicator === 'dot',
                            'w-1': indicator === 'line',
                            'w-0 border-[1.5px] border-dashed bg-transparent':
                              indicator === 'dashed',
                            'my-0.5': nestLabel && indicator === 'dashed',
                          },
                        )}
                        style={
                          {
                            '--color-bg': indicatorColor,
                            '--color-border': indicatorColor,
                          } as React.CSSProperties
                        }
                      />
                    )
                  )}
                  <div
                    className={cn(
                      'flex flex-1 justify-between leading-none',
                      nestLabel ? 'items-end' : 'items-center',
                    )}
                  >
                    <div className="grid gap-1.5">
                      {nestLabel ? tooltipLabel : null}
                      <span className="text-muted-foreground">
                        {itemConfig?.label || item.name}
                      </span>
                    </div>
                    {item.value && (
                      <span className="text-foreground font-mono font-medium tabular-nums">
                        {item.value.toLocaleString()}
                      </span>
                    )}
                  </div>
                </>
              )}
            </div>
          )
        })}
      </div>
    </div>
  )
}

const ChartLegend = RechartsPrimitive.Legend

function ChartLegendContent({
  className,
  hideIcon = false,
  payload,
  verticalAlign = 'bottom',
  nameKey,
}: React.ComponentProps<'div'> &
  Pick<RechartsPrimitive.LegendProps, 'payload' | 'verticalAlign'> & {
    hideIcon?: boolean
    nameKey?: string
  }) {
  const { config } = useChart()

  if (!payload?.length) {
    return null
  }

  return (
    <div
      className={cn(
        'flex items-center justify-center gap-4',
        verticalAlign === 'top' ? 'pb-3' : 'pt-3',
        className,
      )}
    >
      {payload.map((item) => {
        const key = `${nameKey || item.dataKey || 'value'}`
        const itemConfig = getPayloadConfigFromPayload(config, item, key)

        return (
          <div
            key={item.value}
            className={
              '[&>svg]:text-muted-foreground flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3'
            }
          >
            {itemConfig?.icon && !hideIcon ? (
              <itemConfig.icon />
            ) : (
              <div
                className="h-2 w-2 shrink-0 rounded-[2px]"
                style={{
                  backgroundColor: item.color,
                }}
              />
            )}
            {itemConfig?.label}
          </div>
        )
      })}
    </div>
  )
}

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string,
) {
  if (typeof payload !== 'object' || payload === null) {
    return undefined
  }

  const payloadPayload =
    'payload' in payload &&
    typeof payload.payload === 'object' &&
    payload.payload !== null
      ? payload.payload
      : undefined

  let configLabelKey: string = key

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === 'string'
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === 'string'
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config]
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
}

// ===== FILE: components\ui\checkbox.tsx =====

'use client'

import * as React from 'react'
import * as CheckboxPrimitive from '@radix-ui/react-checkbox'
import { CheckIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        'peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50',
        className,
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator
        data-slot="checkbox-indicator"
        className="flex items-center justify-center text-current transition-none"
      >
        <CheckIcon className="size-3.5" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }

// ===== FILE: components\ui\collapsible.tsx =====

'use client'

import * as CollapsiblePrimitive from '@radix-ui/react-collapsible'

function Collapsible({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.Root>) {
  return <CollapsiblePrimitive.Root data-slot="collapsible" {...props} />
}

function CollapsibleTrigger({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleTrigger>) {
  return (
    <CollapsiblePrimitive.CollapsibleTrigger
      data-slot="collapsible-trigger"
      {...props}
    />
  )
}

function CollapsibleContent({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleContent>) {
  return (
    <CollapsiblePrimitive.CollapsibleContent
      data-slot="collapsible-content"
      {...props}
    />
  )
}

export { Collapsible, CollapsibleTrigger, CollapsibleContent }

// ===== FILE: components\ui\command.tsx =====

'use client'

import * as React from 'react'
import { Command as CommandPrimitive } from 'cmdk'
import { SearchIcon } from 'lucide-react'

import { cn } from '@/lib/utils'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'

function Command({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive>) {
  return (
    <CommandPrimitive
      data-slot="command"
      className={cn(
        'bg-popover text-popover-foreground flex h-full w-full flex-col overflow-hidden rounded-md',
        className,
      )}
      {...props}
    />
  )
}

function CommandDialog({
  title = 'Command Palette',
  description = 'Search for a command to run...',
  children,
  className,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof Dialog> & {
  title?: string
  description?: string
  className?: string
  showCloseButton?: boolean
}) {
  return (
    <Dialog {...props}>
      <DialogHeader className="sr-only">
        <DialogTitle>{title}</DialogTitle>
        <DialogDescription>{description}</DialogDescription>
      </DialogHeader>
      <DialogContent
        className={cn('overflow-hidden p-0', className)}
        showCloseButton={showCloseButton}
      >
        <Command className="[&_[cmdk-group-heading]]:text-muted-foreground **:data-[slot=command-input-wrapper]:h-12 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group]]:px-2 [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

function CommandInput({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Input>) {
  return (
    <div
      data-slot="command-input-wrapper"
      className="flex h-9 items-center gap-2 border-b px-3"
    >
      <SearchIcon className="size-4 shrink-0 opacity-50" />
      <CommandPrimitive.Input
        data-slot="command-input"
        className={cn(
          'placeholder:text-muted-foreground flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-hidden disabled:cursor-not-allowed disabled:opacity-50',
          className,
        )}
        {...props}
      />
    </div>
  )
}

function CommandList({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.List>) {
  return (
    <CommandPrimitive.List
      data-slot="command-list"
      className={cn(
        'max-h-[300px] scroll-py-1 overflow-x-hidden overflow-y-auto',
        className,
      )}
      {...props}
    />
  )
}

function CommandEmpty({
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Empty>) {
  return (
    <CommandPrimitive.Empty
      data-slot="command-empty"
      className="py-6 text-center text-sm"
      {...props}
    />
  )
}

function CommandGroup({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Group>) {
  return (
    <CommandPrimitive.Group
      data-slot="command-group"
      className={cn(
        'text-foreground [&_[cmdk-group-heading]]:text-muted-foreground overflow-hidden p-1 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium',
        className,
      )}
      {...props}
    />
  )
}

function CommandSeparator({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Separator>) {
  return (
    <CommandPrimitive.Separator
      data-slot="command-separator"
      className={cn('bg-border -mx-1 h-px', className)}
      {...props}
    />
  )
}

function CommandItem({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Item>) {
  return (
    <CommandPrimitive.Item
      data-slot="command-item"
      className={cn(
        "data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled=true]:pointer-events-none data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function CommandShortcut({
  className,
  ...props
}: React.ComponentProps<'span'>) {
  return (
    <span
      data-slot="command-shortcut"
      className={cn(
        'text-muted-foreground ml-auto text-xs tracking-widest',
        className,
      )}
      {...props}
    />
  )
}

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
}

// ===== FILE: components\ui\context-menu.tsx =====

'use client'

import * as React from 'react'
import * as ContextMenuPrimitive from '@radix-ui/react-context-menu'
import { CheckIcon, ChevronRightIcon, CircleIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function ContextMenu({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Root>) {
  return <ContextMenuPrimitive.Root data-slot="context-menu" {...props} />
}

function ContextMenuTrigger({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Trigger>) {
  return (
    <ContextMenuPrimitive.Trigger data-slot="context-menu-trigger" {...props} />
  )
}

function ContextMenuGroup({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Group>) {
  return (
    <ContextMenuPrimitive.Group data-slot="context-menu-group" {...props} />
  )
}

function ContextMenuPortal({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Portal>) {
  return (
    <ContextMenuPrimitive.Portal data-slot="context-menu-portal" {...props} />
  )
}

function ContextMenuSub({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Sub>) {
  return <ContextMenuPrimitive.Sub data-slot="context-menu-sub" {...props} />
}

function ContextMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.RadioGroup>) {
  return (
    <ContextMenuPrimitive.RadioGroup
      data-slot="context-menu-radio-group"
      {...props}
    />
  )
}

function ContextMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <ContextMenuPrimitive.SubTrigger
      data-slot="context-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto" />
    </ContextMenuPrimitive.SubTrigger>
  )
}

function ContextMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.SubContent>) {
  return (
    <ContextMenuPrimitive.SubContent
      data-slot="context-menu-sub-content"
      className={cn(
        'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-context-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg',
        className,
      )}
      {...props}
    />
  )
}

function ContextMenuContent({
  className,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Content>) {
  return (
    <ContextMenuPrimitive.Portal>
      <ContextMenuPrimitive.Content
        data-slot="context-menu-content"
        className={cn(
          'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-context-menu-content-available-height) min-w-[8rem] origin-(--radix-context-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md',
          className,
        )}
        {...props}
      />
    </ContextMenuPrimitive.Portal>
  )
}

function ContextMenuItem({
  className,
  inset,
  variant = 'default',
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Item> & {
  inset?: boolean
  variant?: 'default' | 'destructive'
}) {
  return (
    <ContextMenuPrimitive.Item
      data-slot="context-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function ContextMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.CheckboxItem>) {
  return (
    <ContextMenuPrimitive.CheckboxItem
      data-slot="context-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <ContextMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </ContextMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </ContextMenuPrimitive.CheckboxItem>
  )
}

function ContextMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.RadioItem>) {
  return (
    <ContextMenuPrimitive.RadioItem
      data-slot="context-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <ContextMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </ContextMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </ContextMenuPrimitive.RadioItem>
  )
}

function ContextMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <ContextMenuPrimitive.Label
      data-slot="context-menu-label"
      data-inset={inset}
      className={cn(
        'text-foreground px-2 py-1.5 text-sm font-medium data-[inset]:pl-8',
        className,
      )}
      {...props}
    />
  )
}

function ContextMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Separator>) {
  return (
    <ContextMenuPrimitive.Separator
      data-slot="context-menu-separator"
      className={cn('bg-border -mx-1 my-1 h-px', className)}
      {...props}
    />
  )
}

function ContextMenuShortcut({
  className,
  ...props
}: React.ComponentProps<'span'>) {
  return (
    <span
      data-slot="context-menu-shortcut"
      className={cn(
        'text-muted-foreground ml-auto text-xs tracking-widest',
        className,
      )}
      {...props}
    />
  )
}

export {
  ContextMenu,
  ContextMenuTrigger,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuCheckboxItem,
  ContextMenuRadioItem,
  ContextMenuLabel,
  ContextMenuSeparator,
  ContextMenuShortcut,
  ContextMenuGroup,
  ContextMenuPortal,
  ContextMenuSub,
  ContextMenuSubContent,
  ContextMenuSubTrigger,
  ContextMenuRadioGroup,
}

// ===== FILE: components\ui\dialog.tsx =====

'use client'

import * as React from 'react'
import * as DialogPrimitive from '@radix-ui/react-dialog'
import { XIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        'data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50',
        className,
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content> & {
  showCloseButton?: boolean
}) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          'bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg',
          className,
        )}
        {...props}
      >
        {children}
        {showCloseButton && (
          <DialogPrimitive.Close
            data-slot="dialog-close"
            className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4"
          >
            <XIcon />
            <span className="sr-only">Close</span>
          </DialogPrimitive.Close>
        )}
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

function DialogHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="dialog-header"
      className={cn('flex flex-col gap-2 text-center sm:text-left', className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        'flex flex-col-reverse gap-2 sm:flex-row sm:justify-end',
        className,
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn('text-lg leading-none font-semibold', className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn('text-muted-foreground text-sm', className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}

// ===== FILE: components\ui\drawer.tsx =====

'use client'

import * as React from 'react'
import { Drawer as DrawerPrimitive } from 'vaul'

import { cn } from '@/lib/utils'

function Drawer({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Root>) {
  return <DrawerPrimitive.Root data-slot="drawer" {...props} />
}

function DrawerTrigger({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Trigger>) {
  return <DrawerPrimitive.Trigger data-slot="drawer-trigger" {...props} />
}

function DrawerPortal({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Portal>) {
  return <DrawerPrimitive.Portal data-slot="drawer-portal" {...props} />
}

function DrawerClose({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Close>) {
  return <DrawerPrimitive.Close data-slot="drawer-close" {...props} />
}

function DrawerOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Overlay>) {
  return (
    <DrawerPrimitive.Overlay
      data-slot="drawer-overlay"
      className={cn(
        'data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50',
        className,
      )}
      {...props}
    />
  )
}

function DrawerContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Content>) {
  return (
    <DrawerPortal data-slot="drawer-portal">
      <DrawerOverlay />
      <DrawerPrimitive.Content
        data-slot="drawer-content"
        className={cn(
          'group/drawer-content bg-background fixed z-50 flex h-auto flex-col',
          'data-[vaul-drawer-direction=top]:inset-x-0 data-[vaul-drawer-direction=top]:top-0 data-[vaul-drawer-direction=top]:mb-24 data-[vaul-drawer-direction=top]:max-h-[80vh] data-[vaul-drawer-direction=top]:rounded-b-lg data-[vaul-drawer-direction=top]:border-b',
          'data-[vaul-drawer-direction=bottom]:inset-x-0 data-[vaul-drawer-direction=bottom]:bottom-0 data-[vaul-drawer-direction=bottom]:mt-24 data-[vaul-drawer-direction=bottom]:max-h-[80vh] data-[vaul-drawer-direction=bottom]:rounded-t-lg data-[vaul-drawer-direction=bottom]:border-t',
          'data-[vaul-drawer-direction=right]:inset-y-0 data-[vaul-drawer-direction=right]:right-0 data-[vaul-drawer-direction=right]:w-3/4 data-[vaul-drawer-direction=right]:border-l data-[vaul-drawer-direction=right]:sm:max-w-sm',
          'data-[vaul-drawer-direction=left]:inset-y-0 data-[vaul-drawer-direction=left]:left-0 data-[vaul-drawer-direction=left]:w-3/4 data-[vaul-drawer-direction=left]:border-r data-[vaul-drawer-direction=left]:sm:max-w-sm',
          className,
        )}
        {...props}
      >
        <div className="bg-muted mx-auto mt-4 hidden h-2 w-[100px] shrink-0 rounded-full group-data-[vaul-drawer-direction=bottom]/drawer-content:block" />
        {children}
      </DrawerPrimitive.Content>
    </DrawerPortal>
  )
}

function DrawerHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="drawer-header"
      className={cn(
        'flex flex-col gap-0.5 p-4 group-data-[vaul-drawer-direction=bottom]/drawer-content:text-center group-data-[vaul-drawer-direction=top]/drawer-content:text-center md:gap-1.5 md:text-left',
        className,
      )}
      {...props}
    />
  )
}

function DrawerFooter({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="drawer-footer"
      className={cn('mt-auto flex flex-col gap-2 p-4', className)}
      {...props}
    />
  )
}

function DrawerTitle({
  className,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Title>) {
  return (
    <DrawerPrimitive.Title
      data-slot="drawer-title"
      className={cn('text-foreground font-semibold', className)}
      {...props}
    />
  )
}

function DrawerDescription({
  className,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Description>) {
  return (
    <DrawerPrimitive.Description
      data-slot="drawer-description"
      className={cn('text-muted-foreground text-sm', className)}
      {...props}
    />
  )
}

export {
  Drawer,
  DrawerPortal,
  DrawerOverlay,
  DrawerTrigger,
  DrawerClose,
  DrawerContent,
  DrawerHeader,
  DrawerFooter,
  DrawerTitle,
  DrawerDescription,
}

// ===== FILE: components\ui\dropdown-menu.tsx =====

'use client'

import * as React from 'react'
import * as DropdownMenuPrimitive from '@radix-ui/react-dropdown-menu'
import { CheckIcon, ChevronRightIcon, CircleIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function DropdownMenu({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}

function DropdownMenuPortal({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return (
    <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
  )
}

function DropdownMenuTrigger({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return (
    <DropdownMenuPrimitive.Trigger
      data-slot="dropdown-menu-trigger"
      {...props}
    />
  )
}

function DropdownMenuContent({
  className,
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md',
          className,
        )}
        {...props}
      />
    </DropdownMenuPrimitive.Portal>
  )
}

function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}

function DropdownMenuItem({
  className,
  inset,
  variant = 'default',
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: 'default' | 'destructive'
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}

function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}

function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}

function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        'px-2 py-1.5 text-sm font-medium data-[inset]:pl-8',
        className,
      )}
      {...props}
    />
  )
}

function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn('bg-border -mx-1 my-1 h-px', className)}
      {...props}
    />
  )
}

function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<'span'>) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        'text-muted-foreground ml-auto text-xs tracking-widest',
        className,
      )}
      {...props}
    />
  )
}

function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg',
        className,
      )}
      {...props}
    />
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}

// ===== FILE: components\ui\empty.tsx =====

import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'

function Empty({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="empty"
      className={cn(
        'flex min-w-0 flex-1 flex-col items-center justify-center gap-6 rounded-lg border-dashed p-6 text-center text-balance md:p-12',
        className,
      )}
      {...props}
    />
  )
}

function EmptyHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="empty-header"
      className={cn(
        'flex max-w-sm flex-col items-center gap-2 text-center',
        className,
      )}
      {...props}
    />
  )
}

const emptyMediaVariants = cva(
  'flex shrink-0 items-center justify-center mb-2 [&_svg]:pointer-events-none [&_svg]:shrink-0',
  {
    variants: {
      variant: {
        default: 'bg-transparent',
        icon: "bg-muted text-foreground flex size-10 shrink-0 items-center justify-center rounded-lg [&_svg:not([class*='size-'])]:size-6",
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  },
)

function EmptyMedia({
  className,
  variant = 'default',
  ...props
}: React.ComponentProps<'div'> & VariantProps<typeof emptyMediaVariants>) {
  return (
    <div
      data-slot="empty-icon"
      data-variant={variant}
      className={cn(emptyMediaVariants({ variant, className }))}
      {...props}
    />
  )
}

function EmptyTitle({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="empty-title"
      className={cn('text-lg font-medium tracking-tight', className)}
      {...props}
    />
  )
}

function EmptyDescription({ className, ...props }: React.ComponentProps<'p'>) {
  return (
    <div
      data-slot="empty-description"
      className={cn(
        'text-muted-foreground [&>a:hover]:text-primary text-sm/relaxed [&>a]:underline [&>a]:underline-offset-4',
        className,
      )}
      {...props}
    />
  )
}

function EmptyContent({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="empty-content"
      className={cn(
        'flex w-full max-w-sm min-w-0 flex-col items-center gap-4 text-sm text-balance',
        className,
      )}
      {...props}
    />
  )
}

export {
  Empty,
  EmptyHeader,
  EmptyTitle,
  EmptyDescription,
  EmptyContent,
  EmptyMedia,
}

// ===== FILE: components\ui\field.tsx =====

'use client'

import { useMemo } from 'react'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'
import { Label } from '@/components/ui/label'
import { Separator } from '@/components/ui/separator'

function FieldSet({ className, ...props }: React.ComponentProps<'fieldset'>) {
  return (
    <fieldset
      data-slot="field-set"
      className={cn(
        'flex flex-col gap-6',
        'has-[>[data-slot=checkbox-group]]:gap-3 has-[>[data-slot=radio-group]]:gap-3',
        className,
      )}
      {...props}
    />
  )
}

function FieldLegend({
  className,
  variant = 'legend',
  ...props
}: React.ComponentProps<'legend'> & { variant?: 'legend' | 'label' }) {
  return (
    <legend
      data-slot="field-legend"
      data-variant={variant}
      className={cn(
        'mb-3 font-medium',
        'data-[variant=legend]:text-base',
        'data-[variant=label]:text-sm',
        className,
      )}
      {...props}
    />
  )
}

function FieldGroup({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="field-group"
      className={cn(
        'group/field-group @container/field-group flex w-full flex-col gap-7 data-[slot=checkbox-group]:gap-3 [&>[data-slot=field-group]]:gap-4',
        className,
      )}
      {...props}
    />
  )
}

const fieldVariants = cva(
  'group/field flex w-full gap-3 data-[invalid=true]:text-destructive',
  {
    variants: {
      orientation: {
        vertical: ['flex-col [&>*]:w-full [&>.sr-only]:w-auto'],
        horizontal: [
          'flex-row items-center',
          '[&>[data-slot=field-label]]:flex-auto',
          'has-[>[data-slot=field-content]]:items-start has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px',
        ],
        responsive: [
          'flex-col [&>*]:w-full [&>.sr-only]:w-auto @md/field-group:flex-row @md/field-group:items-center @md/field-group:[&>*]:w-auto',
          '@md/field-group:[&>[data-slot=field-label]]:flex-auto',
          '@md/field-group:has-[>[data-slot=field-content]]:items-start @md/field-group:has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px',
        ],
      },
    },
    defaultVariants: {
      orientation: 'vertical',
    },
  },
)

function Field({
  className,
  orientation = 'vertical',
  ...props
}: React.ComponentProps<'div'> & VariantProps<typeof fieldVariants>) {
  return (
    <div
      role="group"
      data-slot="field"
      data-orientation={orientation}
      className={cn(fieldVariants({ orientation }), className)}
      {...props}
    />
  )
}

function FieldContent({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="field-content"
      className={cn(
        'group/field-content flex flex-1 flex-col gap-1.5 leading-snug',
        className,
      )}
      {...props}
    />
  )
}

function FieldLabel({
  className,
  ...props
}: React.ComponentProps<typeof Label>) {
  return (
    <Label
      data-slot="field-label"
      className={cn(
        'group/field-label peer/field-label flex w-fit gap-2 leading-snug group-data-[disabled=true]/field:opacity-50',
        'has-[>[data-slot=field]]:w-full has-[>[data-slot=field]]:flex-col has-[>[data-slot=field]]:rounded-md has-[>[data-slot=field]]:border [&>*]:data-[slot=field]:p-4',
        'has-data-[state=checked]:bg-primary/5 has-data-[state=checked]:border-primary dark:has-data-[state=checked]:bg-primary/10',
        className,
      )}
      {...props}
    />
  )
}

function FieldTitle({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="field-label"
      className={cn(
        'flex w-fit items-center gap-2 text-sm leading-snug font-medium group-data-[disabled=true]/field:opacity-50',
        className,
      )}
      {...props}
    />
  )
}

function FieldDescription({ className, ...props }: React.ComponentProps<'p'>) {
  return (
    <p
      data-slot="field-description"
      className={cn(
        'text-muted-foreground text-sm leading-normal font-normal group-has-[[data-orientation=horizontal]]/field:text-balance',
        'last:mt-0 nth-last-2:-mt-1 [[data-variant=legend]+&]:-mt-1.5',
        '[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4',
        className,
      )}
      {...props}
    />
  )
}

function FieldSeparator({
  children,
  className,
  ...props
}: React.ComponentProps<'div'> & {
  children?: React.ReactNode
}) {
  return (
    <div
      data-slot="field-separator"
      data-content={!!children}
      className={cn(
        'relative -my-2 h-5 text-sm group-data-[variant=outline]/field-group:-mb-2',
        className,
      )}
      {...props}
    >
      <Separator className="absolute inset-0 top-1/2" />
      {children && (
        <span
          className="bg-background text-muted-foreground relative mx-auto block w-fit px-2"
          data-slot="field-separator-content"
        >
          {children}
        </span>
      )}
    </div>
  )
}

function FieldError({
  className,
  children,
  errors,
  ...props
}: React.ComponentProps<'div'> & {
  errors?: Array<{ message?: string } | undefined>
}) {
  const content = useMemo(() => {
    if (children) {
      return children
    }

    if (!errors) {
      return null
    }

    if (errors.length === 1 && errors[0]?.message) {
      return errors[0].message
    }

    return (
      <ul className="ml-4 flex list-disc flex-col gap-1">
        {errors.map(
          (error, index) =>
            error?.message && <li key={index}>{error.message}</li>,
        )}
      </ul>
    )
  }, [children, errors])

  if (!content) {
    return null
  }

  return (
    <div
      role="alert"
      data-slot="field-error"
      className={cn('text-destructive text-sm font-normal', className)}
      {...props}
    >
      {content}
    </div>
  )
}

export {
  Field,
  FieldLabel,
  FieldDescription,
  FieldError,
  FieldGroup,
  FieldLegend,
  FieldSeparator,
  FieldSet,
  FieldContent,
  FieldTitle,
}

// ===== FILE: components\ui\form.tsx =====

'use client'

import * as React from 'react'
import * as LabelPrimitive from '@radix-ui/react-label'
import { Slot } from '@radix-ui/react-slot'
import {
  Controller,
  FormProvider,
  useFormContext,
  useFormState,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from 'react-hook-form'

import { cn } from '@/lib/utils'
import { Label } from '@/components/ui/label'

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue,
)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState } = useFormContext()
  const formState = useFormState({ name: fieldContext.name })
  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error('useFormField should be used within <FormField>')
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue,
)

function FormItem({ className, ...props }: React.ComponentProps<'div'>) {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div
        data-slot="form-item"
        className={cn('grid gap-2', className)}
        {...props}
      />
    </FormItemContext.Provider>
  )
}

function FormLabel({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  const { error, formItemId } = useFormField()

  return (
    <Label
      data-slot="form-label"
      data-error={!!error}
      className={cn('data-[error=true]:text-destructive', className)}
      htmlFor={formItemId}
      {...props}
    />
  )
}

function FormControl({ ...props }: React.ComponentProps<typeof Slot>) {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      data-slot="form-control"
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
}

function FormDescription({ className, ...props }: React.ComponentProps<'p'>) {
  const { formDescriptionId } = useFormField()

  return (
    <p
      data-slot="form-description"
      id={formDescriptionId}
      className={cn('text-muted-foreground text-sm', className)}
      {...props}
    />
  )
}

function FormMessage({ className, ...props }: React.ComponentProps<'p'>) {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message ?? '') : props.children

  if (!body) {
    return null
  }

  return (
    <p
      data-slot="form-message"
      id={formMessageId}
      className={cn('text-destructive text-sm', className)}
      {...props}
    >
      {body}
    </p>
  )
}

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}

// ===== FILE: components\ui\hover-card.tsx =====

'use client'

import * as React from 'react'
import * as HoverCardPrimitive from '@radix-ui/react-hover-card'

import { cn } from '@/lib/utils'

function HoverCard({
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Root>) {
  return <HoverCardPrimitive.Root data-slot="hover-card" {...props} />
}

function HoverCardTrigger({
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Trigger>) {
  return (
    <HoverCardPrimitive.Trigger data-slot="hover-card-trigger" {...props} />
  )
}

function HoverCardContent({
  className,
  align = 'center',
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Content>) {
  return (
    <HoverCardPrimitive.Portal data-slot="hover-card-portal">
      <HoverCardPrimitive.Content
        data-slot="hover-card-content"
        align={align}
        sideOffset={sideOffset}
        className={cn(
          'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-64 origin-(--radix-hover-card-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden',
          className,
        )}
        {...props}
      />
    </HoverCardPrimitive.Portal>
  )
}

export { HoverCard, HoverCardTrigger, HoverCardContent }

// ===== FILE: components\ui\input-group.tsx =====

'use client'

import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'

function InputGroup({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="input-group"
      role="group"
      className={cn(
        'group/input-group border-input dark:bg-input/30 relative flex w-full items-center rounded-md border shadow-xs transition-[color,box-shadow] outline-none',
        'h-9 has-[>textarea]:h-auto',

        // Variants based on alignment.
        'has-[>[data-align=inline-start]]:[&>input]:pl-2',
        'has-[>[data-align=inline-end]]:[&>input]:pr-2',
        'has-[>[data-align=block-start]]:h-auto has-[>[data-align=block-start]]:flex-col has-[>[data-align=block-start]]:[&>input]:pb-3',
        'has-[>[data-align=block-end]]:h-auto has-[>[data-align=block-end]]:flex-col has-[>[data-align=block-end]]:[&>input]:pt-3',

        // Focus state.
        'has-[[data-slot=input-group-control]:focus-visible]:border-ring has-[[data-slot=input-group-control]:focus-visible]:ring-ring/50 has-[[data-slot=input-group-control]:focus-visible]:ring-[3px]',

        // Error state.
        'has-[[data-slot][aria-invalid=true]]:ring-destructive/20 has-[[data-slot][aria-invalid=true]]:border-destructive dark:has-[[data-slot][aria-invalid=true]]:ring-destructive/40',

        className,
      )}
      {...props}
    />
  )
}

const inputGroupAddonVariants = cva(
  "text-muted-foreground flex h-auto cursor-text items-center justify-center gap-2 py-1.5 text-sm font-medium select-none [&>svg:not([class*='size-'])]:size-4 [&>kbd]:rounded-[calc(var(--radius)-5px)] group-data-[disabled=true]/input-group:opacity-50",
  {
    variants: {
      align: {
        'inline-start':
          'order-first pl-3 has-[>button]:ml-[-0.45rem] has-[>kbd]:ml-[-0.35rem]',
        'inline-end':
          'order-last pr-3 has-[>button]:mr-[-0.4rem] has-[>kbd]:mr-[-0.35rem]',
        'block-start':
          'order-first w-full justify-start px-3 pt-3 [.border-b]:pb-3 group-has-[>input]/input-group:pt-2.5',
        'block-end':
          'order-last w-full justify-start px-3 pb-3 [.border-t]:pt-3 group-has-[>input]/input-group:pb-2.5',
      },
    },
    defaultVariants: {
      align: 'inline-start',
    },
  },
)

function InputGroupAddon({
  className,
  align = 'inline-start',
  ...props
}: React.ComponentProps<'div'> & VariantProps<typeof inputGroupAddonVariants>) {
  return (
    <div
      role="group"
      data-slot="input-group-addon"
      data-align={align}
      className={cn(inputGroupAddonVariants({ align }), className)}
      onClick={(e) => {
        if ((e.target as HTMLElement).closest('button')) {
          return
        }
        e.currentTarget.parentElement?.querySelector('input')?.focus()
      }}
      {...props}
    />
  )
}

const inputGroupButtonVariants = cva(
  'text-sm shadow-none flex gap-2 items-center',
  {
    variants: {
      size: {
        xs: "h-6 gap-1 px-2 rounded-[calc(var(--radius)-5px)] [&>svg:not([class*='size-'])]:size-3.5 has-[>svg]:px-2",
        sm: 'h-8 px-2.5 gap-1.5 rounded-md has-[>svg]:px-2.5',
        'icon-xs':
          'size-6 rounded-[calc(var(--radius)-5px)] p-0 has-[>svg]:p-0',
        'icon-sm': 'size-8 p-0 has-[>svg]:p-0',
      },
    },
    defaultVariants: {
      size: 'xs',
    },
  },
)

function InputGroupButton({
  className,
  type = 'button',
  variant = 'ghost',
  size = 'xs',
  ...props
}: Omit<React.ComponentProps<typeof Button>, 'size'> &
  VariantProps<typeof inputGroupButtonVariants>) {
  return (
    <Button
      type={type}
      data-size={size}
      variant={variant}
      className={cn(inputGroupButtonVariants({ size }), className)}
      {...props}
    />
  )
}

function InputGroupText({ className, ...props }: React.ComponentProps<'span'>) {
  return (
    <span
      className={cn(
        "text-muted-foreground flex items-center gap-2 text-sm [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function InputGroupInput({
  className,
  ...props
}: React.ComponentProps<'input'>) {
  return (
    <Input
      data-slot="input-group-control"
      className={cn(
        'flex-1 rounded-none border-0 bg-transparent shadow-none focus-visible:ring-0 dark:bg-transparent',
        className,
      )}
      {...props}
    />
  )
}

function InputGroupTextarea({
  className,
  ...props
}: React.ComponentProps<'textarea'>) {
  return (
    <Textarea
      data-slot="input-group-control"
      className={cn(
        'flex-1 resize-none rounded-none border-0 bg-transparent py-3 shadow-none focus-visible:ring-0 dark:bg-transparent',
        className,
      )}
      {...props}
    />
  )
}

export {
  InputGroup,
  InputGroupAddon,
  InputGroupButton,
  InputGroupText,
  InputGroupInput,
  InputGroupTextarea,
}

// ===== FILE: components\ui\input-otp.tsx =====

'use client'

import * as React from 'react'
import { OTPInput, OTPInputContext } from 'input-otp'
import { MinusIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function InputOTP({
  className,
  containerClassName,
  ...props
}: React.ComponentProps<typeof OTPInput> & {
  containerClassName?: string
}) {
  return (
    <OTPInput
      data-slot="input-otp"
      containerClassName={cn(
        'flex items-center gap-2 has-disabled:opacity-50',
        containerClassName,
      )}
      className={cn('disabled:cursor-not-allowed', className)}
      {...props}
    />
  )
}

function InputOTPGroup({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="input-otp-group"
      className={cn('flex items-center', className)}
      {...props}
    />
  )
}

function InputOTPSlot({
  index,
  className,
  ...props
}: React.ComponentProps<'div'> & {
  index: number
}) {
  const inputOTPContext = React.useContext(OTPInputContext)
  const { char, hasFakeCaret, isActive } = inputOTPContext?.slots[index] ?? {}

  return (
    <div
      data-slot="input-otp-slot"
      data-active={isActive}
      className={cn(
        'data-[active=true]:border-ring data-[active=true]:ring-ring/50 data-[active=true]:aria-invalid:ring-destructive/20 dark:data-[active=true]:aria-invalid:ring-destructive/40 aria-invalid:border-destructive data-[active=true]:aria-invalid:border-destructive dark:bg-input/30 border-input relative flex h-9 w-9 items-center justify-center border-y border-r text-sm shadow-xs transition-all outline-none first:rounded-l-md first:border-l last:rounded-r-md data-[active=true]:z-10 data-[active=true]:ring-[3px]',
        className,
      )}
      {...props}
    >
      {char}
      {hasFakeCaret && (
        <div className="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div className="animate-caret-blink bg-foreground h-4 w-px duration-1000" />
        </div>
      )}
    </div>
  )
}

function InputOTPSeparator({ ...props }: React.ComponentProps<'div'>) {
  return (
    <div data-slot="input-otp-separator" role="separator" {...props}>
      <MinusIcon />
    </div>
  )
}

export { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }

// ===== FILE: components\ui\input.tsx =====

import * as React from 'react'

import { cn } from '@/lib/utils'

function Input({ className, type, ...props }: React.ComponentProps<'input'>) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        'file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm',
        'focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]',
        'aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive',
        className,
      )}
      {...props}
    />
  )
}

export { Input }

// ===== FILE: components\ui\item.tsx =====

import * as React from 'react'
import { Slot } from '@radix-ui/react-slot'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'
import { Separator } from '@/components/ui/separator'

function ItemGroup({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      role="list"
      data-slot="item-group"
      className={cn('group/item-group flex flex-col', className)}
      {...props}
    />
  )
}

function ItemSeparator({
  className,
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="item-separator"
      orientation="horizontal"
      className={cn('my-0', className)}
      {...props}
    />
  )
}

const itemVariants = cva(
  'group/item flex items-center border border-transparent text-sm rounded-md transition-colors [a&]:hover:bg-accent/50 [a&]:transition-colors duration-100 flex-wrap outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]',
  {
    variants: {
      variant: {
        default: 'bg-transparent',
        outline: 'border-border',
        muted: 'bg-muted/50',
      },
      size: {
        default: 'p-4 gap-4 ',
        sm: 'py-3 px-4 gap-2.5',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  },
)

function Item({
  className,
  variant = 'default',
  size = 'default',
  asChild = false,
  ...props
}: React.ComponentProps<'div'> &
  VariantProps<typeof itemVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : 'div'
  return (
    <Comp
      data-slot="item"
      data-variant={variant}
      data-size={size}
      className={cn(itemVariants({ variant, size, className }))}
      {...props}
    />
  )
}

const itemMediaVariants = cva(
  'flex shrink-0 items-center justify-center gap-2 group-has-[[data-slot=item-description]]/item:self-start [&_svg]:pointer-events-none group-has-[[data-slot=item-description]]/item:translate-y-0.5',
  {
    variants: {
      variant: {
        default: 'bg-transparent',
        icon: "size-8 border rounded-sm bg-muted [&_svg:not([class*='size-'])]:size-4",
        image:
          'size-10 rounded-sm overflow-hidden [&_img]:size-full [&_img]:object-cover',
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  },
)

function ItemMedia({
  className,
  variant = 'default',
  ...props
}: React.ComponentProps<'div'> & VariantProps<typeof itemMediaVariants>) {
  return (
    <div
      data-slot="item-media"
      data-variant={variant}
      className={cn(itemMediaVariants({ variant, className }))}
      {...props}
    />
  )
}

function ItemContent({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="item-content"
      className={cn(
        'flex flex-1 flex-col gap-1 [&+[data-slot=item-content]]:flex-none',
        className,
      )}
      {...props}
    />
  )
}

function ItemTitle({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="item-title"
      className={cn(
        'flex w-fit items-center gap-2 text-sm leading-snug font-medium',
        className,
      )}
      {...props}
    />
  )
}

function ItemDescription({ className, ...props }: React.ComponentProps<'p'>) {
  return (
    <p
      data-slot="item-description"
      className={cn(
        'text-muted-foreground line-clamp-2 text-sm leading-normal font-normal text-balance',
        '[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4',
        className,
      )}
      {...props}
    />
  )
}

function ItemActions({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="item-actions"
      className={cn('flex items-center gap-2', className)}
      {...props}
    />
  )
}

function ItemHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="item-header"
      className={cn(
        'flex basis-full items-center justify-between gap-2',
        className,
      )}
      {...props}
    />
  )
}

function ItemFooter({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="item-footer"
      className={cn(
        'flex basis-full items-center justify-between gap-2',
        className,
      )}
      {...props}
    />
  )
}

export {
  Item,
  ItemMedia,
  ItemContent,
  ItemActions,
  ItemGroup,
  ItemSeparator,
  ItemTitle,
  ItemDescription,
  ItemHeader,
  ItemFooter,
}

// ===== FILE: components\ui\kbd.tsx =====

import { cn } from '@/lib/utils'

function Kbd({ className, ...props }: React.ComponentProps<'kbd'>) {
  return (
    <kbd
      data-slot="kbd"
      className={cn(
        'bg-muted w-fit text-muted-foreground pointer-events-none inline-flex h-5 min-w-5 items-center justify-center gap-1 rounded-sm px-1 font-sans text-xs font-medium select-none',
        "[&_svg:not([class*='size-'])]:size-3",
        '[[data-slot=tooltip-content]_&]:bg-background/20 [[data-slot=tooltip-content]_&]:text-background dark:[[data-slot=tooltip-content]_&]:bg-background/10',
        className,
      )}
      {...props}
    />
  )
}

function KbdGroup({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <kbd
      data-slot="kbd-group"
      className={cn('inline-flex items-center gap-1', className)}
      {...props}
    />
  )
}

export { Kbd, KbdGroup }

// ===== FILE: components\ui\label.tsx =====

'use client'

import * as React from 'react'
import * as LabelPrimitive from '@radix-ui/react-label'

import { cn } from '@/lib/utils'

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        'flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50',
        className,
      )}
      {...props}
    />
  )
}

export { Label }

// ===== FILE: components\ui\menubar.tsx =====

'use client'

import * as React from 'react'
import * as MenubarPrimitive from '@radix-ui/react-menubar'
import { CheckIcon, ChevronRightIcon, CircleIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function Menubar({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Root>) {
  return (
    <MenubarPrimitive.Root
      data-slot="menubar"
      className={cn(
        'bg-background flex h-9 items-center gap-1 rounded-md border p-1 shadow-xs',
        className,
      )}
      {...props}
    />
  )
}

function MenubarMenu({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {
  return <MenubarPrimitive.Menu data-slot="menubar-menu" {...props} />
}

function MenubarGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Group>) {
  return <MenubarPrimitive.Group data-slot="menubar-group" {...props} />
}

function MenubarPortal({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {
  return <MenubarPrimitive.Portal data-slot="menubar-portal" {...props} />
}

function MenubarRadioGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {
  return (
    <MenubarPrimitive.RadioGroup data-slot="menubar-radio-group" {...props} />
  )
}

function MenubarTrigger({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Trigger>) {
  return (
    <MenubarPrimitive.Trigger
      data-slot="menubar-trigger"
      className={cn(
        'focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex items-center rounded-sm px-2 py-1 text-sm font-medium outline-hidden select-none',
        className,
      )}
      {...props}
    />
  )
}

function MenubarContent({
  className,
  align = 'start',
  alignOffset = -4,
  sideOffset = 8,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Content>) {
  return (
    <MenubarPortal>
      <MenubarPrimitive.Content
        data-slot="menubar-content"
        align={align}
        alignOffset={alignOffset}
        sideOffset={sideOffset}
        className={cn(
          'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[12rem] origin-(--radix-menubar-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-md',
          className,
        )}
        {...props}
      />
    </MenubarPortal>
  )
}

function MenubarItem({
  className,
  inset,
  variant = 'default',
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Item> & {
  inset?: boolean
  variant?: 'default' | 'destructive'
}) {
  return (
    <MenubarPrimitive.Item
      data-slot="menubar-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function MenubarCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.CheckboxItem>) {
  return (
    <MenubarPrimitive.CheckboxItem
      data-slot="menubar-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-xs py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <MenubarPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </MenubarPrimitive.ItemIndicator>
      </span>
      {children}
    </MenubarPrimitive.CheckboxItem>
  )
}

function MenubarRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.RadioItem>) {
  return (
    <MenubarPrimitive.RadioItem
      data-slot="menubar-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-xs py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <MenubarPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </MenubarPrimitive.ItemIndicator>
      </span>
      {children}
    </MenubarPrimitive.RadioItem>
  )
}

function MenubarLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <MenubarPrimitive.Label
      data-slot="menubar-label"
      data-inset={inset}
      className={cn(
        'px-2 py-1.5 text-sm font-medium data-[inset]:pl-8',
        className,
      )}
      {...props}
    />
  )
}

function MenubarSeparator({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Separator>) {
  return (
    <MenubarPrimitive.Separator
      data-slot="menubar-separator"
      className={cn('bg-border -mx-1 my-1 h-px', className)}
      {...props}
    />
  )
}

function MenubarShortcut({
  className,
  ...props
}: React.ComponentProps<'span'>) {
  return (
    <span
      data-slot="menubar-shortcut"
      className={cn(
        'text-muted-foreground ml-auto text-xs tracking-widest',
        className,
      )}
      {...props}
    />
  )
}

function MenubarSub({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {
  return <MenubarPrimitive.Sub data-slot="menubar-sub" {...props} />
}

function MenubarSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <MenubarPrimitive.SubTrigger
      data-slot="menubar-sub-trigger"
      data-inset={inset}
      className={cn(
        'focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-none select-none data-[inset]:pl-8',
        className,
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto h-4 w-4" />
    </MenubarPrimitive.SubTrigger>
  )
}

function MenubarSubContent({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.SubContent>) {
  return (
    <MenubarPrimitive.SubContent
      data-slot="menubar-sub-content"
      className={cn(
        'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-menubar-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg',
        className,
      )}
      {...props}
    />
  )
}

export {
  Menubar,
  MenubarPortal,
  MenubarMenu,
  MenubarTrigger,
  MenubarContent,
  MenubarGroup,
  MenubarSeparator,
  MenubarLabel,
  MenubarItem,
  MenubarShortcut,
  MenubarCheckboxItem,
  MenubarRadioGroup,
  MenubarRadioItem,
  MenubarSub,
  MenubarSubTrigger,
  MenubarSubContent,
}

// ===== FILE: components\ui\navigation-menu.tsx =====

import * as React from 'react'
import * as NavigationMenuPrimitive from '@radix-ui/react-navigation-menu'
import { cva } from 'class-variance-authority'
import { ChevronDownIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function NavigationMenu({
  className,
  children,
  viewport = true,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Root> & {
  viewport?: boolean
}) {
  return (
    <NavigationMenuPrimitive.Root
      data-slot="navigation-menu"
      data-viewport={viewport}
      className={cn(
        'group/navigation-menu relative flex max-w-max flex-1 items-center justify-center',
        className,
      )}
      {...props}
    >
      {children}
      {viewport && <NavigationMenuViewport />}
    </NavigationMenuPrimitive.Root>
  )
}

function NavigationMenuList({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.List>) {
  return (
    <NavigationMenuPrimitive.List
      data-slot="navigation-menu-list"
      className={cn(
        'group flex flex-1 list-none items-center justify-center gap-1',
        className,
      )}
      {...props}
    />
  )
}

function NavigationMenuItem({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Item>) {
  return (
    <NavigationMenuPrimitive.Item
      data-slot="navigation-menu-item"
      className={cn('relative', className)}
      {...props}
    />
  )
}

const navigationMenuTriggerStyle = cva(
  'group inline-flex h-9 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground disabled:pointer-events-none disabled:opacity-50 data-[state=open]:hover:bg-accent data-[state=open]:text-accent-foreground data-[state=open]:focus:bg-accent data-[state=open]:bg-accent/50 focus-visible:ring-ring/50 outline-none transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1',
)

function NavigationMenuTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Trigger>) {
  return (
    <NavigationMenuPrimitive.Trigger
      data-slot="navigation-menu-trigger"
      className={cn(navigationMenuTriggerStyle(), 'group', className)}
      {...props}
    >
      {children}{' '}
      <ChevronDownIcon
        className="relative top-[1px] ml-1 size-3 transition duration-300 group-data-[state=open]:rotate-180"
        aria-hidden="true"
      />
    </NavigationMenuPrimitive.Trigger>
  )
}

function NavigationMenuContent({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Content>) {
  return (
    <NavigationMenuPrimitive.Content
      data-slot="navigation-menu-content"
      className={cn(
        'data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 top-0 left-0 w-full p-2 pr-2.5 md:absolute md:w-auto',
        'group-data-[viewport=false]/navigation-menu:bg-popover group-data-[viewport=false]/navigation-menu:text-popover-foreground group-data-[viewport=false]/navigation-menu:data-[state=open]:animate-in group-data-[viewport=false]/navigation-menu:data-[state=closed]:animate-out group-data-[viewport=false]/navigation-menu:data-[state=closed]:zoom-out-95 group-data-[viewport=false]/navigation-menu:data-[state=open]:zoom-in-95 group-data-[viewport=false]/navigation-menu:data-[state=open]:fade-in-0 group-data-[viewport=false]/navigation-menu:data-[state=closed]:fade-out-0 group-data-[viewport=false]/navigation-menu:top-full group-data-[viewport=false]/navigation-menu:mt-1.5 group-data-[viewport=false]/navigation-menu:overflow-hidden group-data-[viewport=false]/navigation-menu:rounded-md group-data-[viewport=false]/navigation-menu:border group-data-[viewport=false]/navigation-menu:shadow group-data-[viewport=false]/navigation-menu:duration-200 **:data-[slot=navigation-menu-link]:focus:ring-0 **:data-[slot=navigation-menu-link]:focus:outline-none',
        className,
      )}
      {...props}
    />
  )
}

function NavigationMenuViewport({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Viewport>) {
  return (
    <div
      className={'absolute top-full left-0 isolate z-50 flex justify-center'}
    >
      <NavigationMenuPrimitive.Viewport
        data-slot="navigation-menu-viewport"
        className={cn(
          'origin-top-center bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border shadow md:w-[var(--radix-navigation-menu-viewport-width)]',
          className,
        )}
        {...props}
      />
    </div>
  )
}

function NavigationMenuLink({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Link>) {
  return (
    <NavigationMenuPrimitive.Link
      data-slot="navigation-menu-link"
      className={cn(
        "data-[active=true]:focus:bg-accent data-[active=true]:hover:bg-accent data-[active=true]:bg-accent/50 data-[active=true]:text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus-visible:ring-ring/50 [&_svg:not([class*='text-'])]:text-muted-foreground flex flex-col gap-1 rounded-sm p-2 text-sm transition-all outline-none focus-visible:ring-[3px] focus-visible:outline-1 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function NavigationMenuIndicator({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Indicator>) {
  return (
    <NavigationMenuPrimitive.Indicator
      data-slot="navigation-menu-indicator"
      className={cn(
        'data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden',
        className,
      )}
      {...props}
    >
      <div className="bg-border relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm shadow-md" />
    </NavigationMenuPrimitive.Indicator>
  )
}

export {
  NavigationMenu,
  NavigationMenuList,
  NavigationMenuItem,
  NavigationMenuContent,
  NavigationMenuTrigger,
  NavigationMenuLink,
  NavigationMenuIndicator,
  NavigationMenuViewport,
  navigationMenuTriggerStyle,
}

// ===== FILE: components\ui\pagination.tsx =====

import * as React from 'react'
import {
  ChevronLeftIcon,
  ChevronRightIcon,
  MoreHorizontalIcon,
} from 'lucide-react'

import { cn } from '@/lib/utils'
import { Button, buttonVariants } from '@/components/ui/button'

function Pagination({ className, ...props }: React.ComponentProps<'nav'>) {
  return (
    <nav
      role="navigation"
      aria-label="pagination"
      data-slot="pagination"
      className={cn('mx-auto flex w-full justify-center', className)}
      {...props}
    />
  )
}

function PaginationContent({
  className,
  ...props
}: React.ComponentProps<'ul'>) {
  return (
    <ul
      data-slot="pagination-content"
      className={cn('flex flex-row items-center gap-1', className)}
      {...props}
    />
  )
}

function PaginationItem({ ...props }: React.ComponentProps<'li'>) {
  return <li data-slot="pagination-item" {...props} />
}

type PaginationLinkProps = {
  isActive?: boolean
} & Pick<React.ComponentProps<typeof Button>, 'size'> &
  React.ComponentProps<'a'>

function PaginationLink({
  className,
  isActive,
  size = 'icon',
  ...props
}: PaginationLinkProps) {
  return (
    <a
      aria-current={isActive ? 'page' : undefined}
      data-slot="pagination-link"
      data-active={isActive}
      className={cn(
        buttonVariants({
          variant: isActive ? 'outline' : 'ghost',
          size,
        }),
        className,
      )}
      {...props}
    />
  )
}

function PaginationPrevious({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) {
  return (
    <PaginationLink
      aria-label="Go to previous page"
      size="default"
      className={cn('gap-1 px-2.5 sm:pl-2.5', className)}
      {...props}
    >
      <ChevronLeftIcon />
      <span className="hidden sm:block">Previous</span>
    </PaginationLink>
  )
}

function PaginationNext({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) {
  return (
    <PaginationLink
      aria-label="Go to next page"
      size="default"
      className={cn('gap-1 px-2.5 sm:pr-2.5', className)}
      {...props}
    >
      <span className="hidden sm:block">Next</span>
      <ChevronRightIcon />
    </PaginationLink>
  )
}

function PaginationEllipsis({
  className,
  ...props
}: React.ComponentProps<'span'>) {
  return (
    <span
      aria-hidden
      data-slot="pagination-ellipsis"
      className={cn('flex size-9 items-center justify-center', className)}
      {...props}
    >
      <MoreHorizontalIcon className="size-4" />
      <span className="sr-only">More pages</span>
    </span>
  )
}

export {
  Pagination,
  PaginationContent,
  PaginationLink,
  PaginationItem,
  PaginationPrevious,
  PaginationNext,
  PaginationEllipsis,
}

// ===== FILE: components\ui\popover.tsx =====

'use client'

import * as React from 'react'
import * as PopoverPrimitive from '@radix-ui/react-popover'

import { cn } from '@/lib/utils'

function Popover({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Root>) {
  return <PopoverPrimitive.Root data-slot="popover" {...props} />
}

function PopoverTrigger({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Trigger>) {
  return <PopoverPrimitive.Trigger data-slot="popover-trigger" {...props} />
}

function PopoverContent({
  className,
  align = 'center',
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Content>) {
  return (
    <PopoverPrimitive.Portal>
      <PopoverPrimitive.Content
        data-slot="popover-content"
        align={align}
        sideOffset={sideOffset}
        className={cn(
          'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-72 origin-(--radix-popover-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden',
          className,
        )}
        {...props}
      />
    </PopoverPrimitive.Portal>
  )
}

function PopoverAnchor({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Anchor>) {
  return <PopoverPrimitive.Anchor data-slot="popover-anchor" {...props} />
}

export { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }

// ===== FILE: components\ui\progress.tsx =====

'use client'

import * as React from 'react'
import * as ProgressPrimitive from '@radix-ui/react-progress'

import { cn } from '@/lib/utils'

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        'bg-primary/20 relative h-2 w-full overflow-hidden rounded-full',
        className,
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }

// ===== FILE: components\ui\radio-group.tsx =====

'use client'

import * as React from 'react'
import * as RadioGroupPrimitive from '@radix-ui/react-radio-group'
import { CircleIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function RadioGroup({
  className,
  ...props
}: React.ComponentProps<typeof RadioGroupPrimitive.Root>) {
  return (
    <RadioGroupPrimitive.Root
      data-slot="radio-group"
      className={cn('grid gap-3', className)}
      {...props}
    />
  )
}

function RadioGroupItem({
  className,
  ...props
}: React.ComponentProps<typeof RadioGroupPrimitive.Item>) {
  return (
    <RadioGroupPrimitive.Item
      data-slot="radio-group-item"
      className={cn(
        'border-input text-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 aspect-square size-4 shrink-0 rounded-full border shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50',
        className,
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator
        data-slot="radio-group-indicator"
        className="relative flex items-center justify-center"
      >
        <CircleIcon className="fill-primary absolute top-1/2 left-1/2 size-2 -translate-x-1/2 -translate-y-1/2" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  )
}

export { RadioGroup, RadioGroupItem }

// ===== FILE: components\ui\resizable.tsx =====

'use client'

import * as React from 'react'
import { GripVerticalIcon } from 'lucide-react'
import * as ResizablePrimitive from 'react-resizable-panels'

import { cn } from '@/lib/utils'

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        'flex h-full w-full data-[panel-group-direction=vertical]:flex-col',
        className,
      )}
      {...props}
    />
  )
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        'bg-border focus-visible:ring-ring relative flex w-px items-center justify-center after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:translate-x-0 data-[panel-group-direction=vertical]:after:-translate-y-1/2 [&[data-panel-group-direction=vertical]>div]:rotate-90',
        className,
      )}
      {...props}
    >
      {withHandle && (
        <div className="bg-border z-10 flex h-4 w-3 items-center justify-center rounded-xs border">
          <GripVerticalIcon className="size-2.5" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  )
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }

// ===== FILE: components\ui\scroll-area.tsx =====

'use client'

import * as React from 'react'
import * as ScrollAreaPrimitive from '@radix-ui/react-scroll-area'

import { cn } from '@/lib/utils'

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn('relative', className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  )
}

function ScrollBar({
  className,
  orientation = 'vertical',
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        'flex touch-none p-px transition-colors select-none',
        orientation === 'vertical' &&
          'h-full w-2.5 border-l border-l-transparent',
        orientation === 'horizontal' &&
          'h-2.5 flex-col border-t border-t-transparent',
        className,
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  )
}

export { ScrollArea, ScrollBar }

// ===== FILE: components\ui\select.tsx =====

'use client'

import * as React from 'react'
import * as SelectPrimitive from '@radix-ui/react-select'
import { CheckIcon, ChevronDownIcon, ChevronUpIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  size = 'default',
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: 'sm' | 'default'
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = 'popper',
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md',
          position === 'popper' &&
            'data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1',
          className,
        )}
        position={position}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            'p-1',
            position === 'popper' &&
              'h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1',
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn('text-muted-foreground px-2 py-1.5 text-xs', className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className,
      )}
      {...props}
    >
      <span className="absolute right-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn('bg-border pointer-events-none -mx-1 my-1 h-px', className)}
      {...props}
    />
  )
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn(
        'flex cursor-default items-center justify-center py-1',
        className,
      )}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  )
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn(
        'flex cursor-default items-center justify-center py-1',
        className,
      )}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  )
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
}

// ===== FILE: components\ui\separator.tsx =====

'use client'

import * as React from 'react'
import * as SeparatorPrimitive from '@radix-ui/react-separator'

import { cn } from '@/lib/utils'

function Separator({
  className,
  orientation = 'horizontal',
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        'bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px',
        className,
      )}
      {...props}
    />
  )
}

export { Separator }

// ===== FILE: components\ui\sheet.tsx =====

'use client'

import * as React from 'react'
import * as SheetPrimitive from '@radix-ui/react-dialog'
import { XIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function Sheet({ ...props }: React.ComponentProps<typeof SheetPrimitive.Root>) {
  return <SheetPrimitive.Root data-slot="sheet" {...props} />
}

function SheetTrigger({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Trigger>) {
  return <SheetPrimitive.Trigger data-slot="sheet-trigger" {...props} />
}

function SheetClose({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Close>) {
  return <SheetPrimitive.Close data-slot="sheet-close" {...props} />
}

function SheetPortal({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Portal>) {
  return <SheetPrimitive.Portal data-slot="sheet-portal" {...props} />
}

function SheetOverlay({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Overlay>) {
  return (
    <SheetPrimitive.Overlay
      data-slot="sheet-overlay"
      className={cn(
        'data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50',
        className,
      )}
      {...props}
    />
  )
}

function SheetContent({
  className,
  children,
  side = 'right',
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Content> & {
  side?: 'top' | 'right' | 'bottom' | 'left'
}) {
  return (
    <SheetPortal>
      <SheetOverlay />
      <SheetPrimitive.Content
        data-slot="sheet-content"
        className={cn(
          'bg-background data-[state=open]:animate-in data-[state=closed]:animate-out fixed z-50 flex flex-col gap-4 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500',
          side === 'right' &&
            'data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right inset-y-0 right-0 h-full w-3/4 border-l sm:max-w-sm',
          side === 'left' &&
            'data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left inset-y-0 left-0 h-full w-3/4 border-r sm:max-w-sm',
          side === 'top' &&
            'data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top inset-x-0 top-0 h-auto border-b',
          side === 'bottom' &&
            'data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom inset-x-0 bottom-0 h-auto border-t',
          className,
        )}
        {...props}
      >
        {children}
        <SheetPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-secondary absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none">
          <XIcon className="size-4" />
          <span className="sr-only">Close</span>
        </SheetPrimitive.Close>
      </SheetPrimitive.Content>
    </SheetPortal>
  )
}

function SheetHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sheet-header"
      className={cn('flex flex-col gap-1.5 p-4', className)}
      {...props}
    />
  )
}

function SheetFooter({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sheet-footer"
      className={cn('mt-auto flex flex-col gap-2 p-4', className)}
      {...props}
    />
  )
}

function SheetTitle({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Title>) {
  return (
    <SheetPrimitive.Title
      data-slot="sheet-title"
      className={cn('text-foreground font-semibold', className)}
      {...props}
    />
  )
}

function SheetDescription({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Description>) {
  return (
    <SheetPrimitive.Description
      data-slot="sheet-description"
      className={cn('text-muted-foreground text-sm', className)}
      {...props}
    />
  )
}

export {
  Sheet,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}

// ===== FILE: components\ui\sidebar.tsx =====

'use client'

import * as React from 'react'
import { Slot } from '@radix-ui/react-slot'
import { cva, VariantProps } from 'class-variance-authority'
import { PanelLeftIcon } from 'lucide-react'

import { useIsMobile } from '@/hooks/use-mobile'
import { cn } from '@/lib/utils'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Separator } from '@/components/ui/separator'
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
} from '@/components/ui/sheet'
import { Skeleton } from '@/components/ui/skeleton'
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip'

const SIDEBAR_COOKIE_NAME = 'sidebar_state'
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7
const SIDEBAR_WIDTH = '16rem'
const SIDEBAR_WIDTH_MOBILE = '18rem'
const SIDEBAR_WIDTH_ICON = '3rem'
const SIDEBAR_KEYBOARD_SHORTCUT = 'b'

type SidebarContextProps = {
  state: 'expanded' | 'collapsed'
  open: boolean
  setOpen: (open: boolean) => void
  openMobile: boolean
  setOpenMobile: (open: boolean) => void
  isMobile: boolean
  toggleSidebar: () => void
}

const SidebarContext = React.createContext<SidebarContextProps | null>(null)

function useSidebar() {
  const context = React.useContext(SidebarContext)
  if (!context) {
    throw new Error('useSidebar must be used within a SidebarProvider.')
  }

  return context
}

function SidebarProvider({
  defaultOpen = true,
  open: openProp,
  onOpenChange: setOpenProp,
  className,
  style,
  children,
  ...props
}: React.ComponentProps<'div'> & {
  defaultOpen?: boolean
  open?: boolean
  onOpenChange?: (open: boolean) => void
}) {
  const isMobile = useIsMobile()
  const [openMobile, setOpenMobile] = React.useState(false)

  // This is the internal state of the sidebar.
  // We use openProp and setOpenProp for control from outside the component.
  const [_open, _setOpen] = React.useState(defaultOpen)
  const open = openProp ?? _open
  const setOpen = React.useCallback(
    (value: boolean | ((value: boolean) => boolean)) => {
      const openState = typeof value === 'function' ? value(open) : value
      if (setOpenProp) {
        setOpenProp(openState)
      } else {
        _setOpen(openState)
      }

      // This sets the cookie to keep the sidebar state.
      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`
    },
    [setOpenProp, open],
  )

  // Helper to toggle the sidebar.
  const toggleSidebar = React.useCallback(() => {
    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)
  }, [isMobile, setOpen, setOpenMobile])

  // Adds a keyboard shortcut to toggle the sidebar.
  React.useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (
        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
        (event.metaKey || event.ctrlKey)
      ) {
        event.preventDefault()
        toggleSidebar()
      }
    }

    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [toggleSidebar])

  // We add a state so that we can do data-state="expanded" or "collapsed".
  // This makes it easier to style the sidebar with Tailwind classes.
  const state = open ? 'expanded' : 'collapsed'

  const contextValue = React.useMemo<SidebarContextProps>(
    () => ({
      state,
      open,
      setOpen,
      isMobile,
      openMobile,
      setOpenMobile,
      toggleSidebar,
    }),
    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar],
  )

  return (
    <SidebarContext.Provider value={contextValue}>
      <TooltipProvider delayDuration={0}>
        <div
          data-slot="sidebar-wrapper"
          style={
            {
              '--sidebar-width': SIDEBAR_WIDTH,
              '--sidebar-width-icon': SIDEBAR_WIDTH_ICON,
              ...style,
            } as React.CSSProperties
          }
          className={cn(
            'group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full',
            className,
          )}
          {...props}
        >
          {children}
        </div>
      </TooltipProvider>
    </SidebarContext.Provider>
  )
}

function Sidebar({
  side = 'left',
  variant = 'sidebar',
  collapsible = 'offcanvas',
  className,
  children,
  ...props
}: React.ComponentProps<'div'> & {
  side?: 'left' | 'right'
  variant?: 'sidebar' | 'floating' | 'inset'
  collapsible?: 'offcanvas' | 'icon' | 'none'
}) {
  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()

  if (collapsible === 'none') {
    return (
      <div
        data-slot="sidebar"
        className={cn(
          'bg-sidebar text-sidebar-foreground flex h-full w-(--sidebar-width) flex-col',
          className,
        )}
        {...props}
      >
        {children}
      </div>
    )
  }

  if (isMobile) {
    return (
      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
        <SheetContent
          data-sidebar="sidebar"
          data-slot="sidebar"
          data-mobile="true"
          className="bg-sidebar text-sidebar-foreground w-(--sidebar-width) p-0 [&>button]:hidden"
          style={
            {
              '--sidebar-width': SIDEBAR_WIDTH_MOBILE,
            } as React.CSSProperties
          }
          side={side}
        >
          <SheetHeader className="sr-only">
            <SheetTitle>Sidebar</SheetTitle>
            <SheetDescription>Displays the mobile sidebar.</SheetDescription>
          </SheetHeader>
          <div className="flex h-full w-full flex-col">{children}</div>
        </SheetContent>
      </Sheet>
    )
  }

  return (
    <div
      className="group peer text-sidebar-foreground hidden md:block"
      data-state={state}
      data-collapsible={state === 'collapsed' ? collapsible : ''}
      data-variant={variant}
      data-side={side}
      data-slot="sidebar"
    >
      {/* This is what handles the sidebar gap on desktop */}
      <div
        data-slot="sidebar-gap"
        className={cn(
          'relative w-(--sidebar-width) bg-transparent transition-[width] duration-200 ease-linear',
          'group-data-[collapsible=offcanvas]:w-0',
          'group-data-[side=right]:rotate-180',
          variant === 'floating' || variant === 'inset'
            ? 'group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4)))]'
            : 'group-data-[collapsible=icon]:w-(--sidebar-width-icon)',
        )}
      />
      <div
        data-slot="sidebar-container"
        className={cn(
          'fixed inset-y-0 z-10 hidden h-svh w-(--sidebar-width) transition-[left,right,width] duration-200 ease-linear md:flex',
          side === 'left'
            ? 'left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]'
            : 'right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]',
          // Adjust the padding for floating and inset variants.
          variant === 'floating' || variant === 'inset'
            ? 'p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4))+2px)]'
            : 'group-data-[collapsible=icon]:w-(--sidebar-width-icon) group-data-[side=left]:border-r group-data-[side=right]:border-l',
          className,
        )}
        {...props}
      >
        <div
          data-sidebar="sidebar"
          data-slot="sidebar-inner"
          className="bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm"
        >
          {children}
        </div>
      </div>
    </div>
  )
}

function SidebarTrigger({
  className,
  onClick,
  ...props
}: React.ComponentProps<typeof Button>) {
  const { toggleSidebar } = useSidebar()

  return (
    <Button
      data-sidebar="trigger"
      data-slot="sidebar-trigger"
      variant="ghost"
      size="icon"
      className={cn('size-7', className)}
      onClick={(event) => {
        onClick?.(event)
        toggleSidebar()
      }}
      {...props}
    >
      <PanelLeftIcon />
      <span className="sr-only">Toggle Sidebar</span>
    </Button>
  )
}

function SidebarRail({ className, ...props }: React.ComponentProps<'button'>) {
  const { toggleSidebar } = useSidebar()

  return (
    <button
      data-sidebar="rail"
      data-slot="sidebar-rail"
      aria-label="Toggle Sidebar"
      tabIndex={-1}
      onClick={toggleSidebar}
      title="Toggle Sidebar"
      className={cn(
        'hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex',
        'in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize',
        '[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize',
        'hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full',
        '[[data-side=left][data-collapsible=offcanvas]_&]:-right-2',
        '[[data-side=right][data-collapsible=offcanvas]_&]:-left-2',
        className,
      )}
      {...props}
    />
  )
}

function SidebarInset({ className, ...props }: React.ComponentProps<'main'>) {
  return (
    <main
      data-slot="sidebar-inset"
      className={cn(
        'bg-background relative flex w-full flex-1 flex-col',
        'md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2',
        className,
      )}
      {...props}
    />
  )
}

function SidebarInput({
  className,
  ...props
}: React.ComponentProps<typeof Input>) {
  return (
    <Input
      data-slot="sidebar-input"
      data-sidebar="input"
      className={cn('bg-background h-8 w-full shadow-none', className)}
      {...props}
    />
  )
}

function SidebarHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sidebar-header"
      data-sidebar="header"
      className={cn('flex flex-col gap-2 p-2', className)}
      {...props}
    />
  )
}

function SidebarFooter({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sidebar-footer"
      data-sidebar="footer"
      className={cn('flex flex-col gap-2 p-2', className)}
      {...props}
    />
  )
}

function SidebarSeparator({
  className,
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="sidebar-separator"
      data-sidebar="separator"
      className={cn('bg-sidebar-border mx-2 w-auto', className)}
      {...props}
    />
  )
}

function SidebarContent({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sidebar-content"
      data-sidebar="content"
      className={cn(
        'flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden',
        className,
      )}
      {...props}
    />
  )
}

function SidebarGroup({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sidebar-group"
      data-sidebar="group"
      className={cn('relative flex w-full min-w-0 flex-col p-2', className)}
      {...props}
    />
  )
}

function SidebarGroupLabel({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<'div'> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : 'div'

  return (
    <Comp
      data-slot="sidebar-group-label"
      data-sidebar="group-label"
      className={cn(
        'text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0',
        'group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0',
        className,
      )}
      {...props}
    />
  )
}

function SidebarGroupAction({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<'button'> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : 'button'

  return (
    <Comp
      data-slot="sidebar-group-action"
      data-sidebar="group-action"
      className={cn(
        'text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0',
        // Increases the hit area of the button on mobile.
        'after:absolute after:-inset-2 md:after:hidden',
        'group-data-[collapsible=icon]:hidden',
        className,
      )}
      {...props}
    />
  )
}

function SidebarGroupContent({
  className,
  ...props
}: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sidebar-group-content"
      data-sidebar="group-content"
      className={cn('w-full text-sm', className)}
      {...props}
    />
  )
}

function SidebarMenu({ className, ...props }: React.ComponentProps<'ul'>) {
  return (
    <ul
      data-slot="sidebar-menu"
      data-sidebar="menu"
      className={cn('flex w-full min-w-0 flex-col gap-1', className)}
      {...props}
    />
  )
}

function SidebarMenuItem({ className, ...props }: React.ComponentProps<'li'>) {
  return (
    <li
      data-slot="sidebar-menu-item"
      data-sidebar="menu-item"
      className={cn('group/menu-item relative', className)}
      {...props}
    />
  )
}

const sidebarMenuButtonVariants = cva(
  'peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0',
  {
    variants: {
      variant: {
        default: 'hover:bg-sidebar-accent hover:text-sidebar-accent-foreground',
        outline:
          'bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]',
      },
      size: {
        default: 'h-8 text-sm',
        sm: 'h-7 text-xs',
        lg: 'h-12 text-sm group-data-[collapsible=icon]:p-0!',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  },
)

function SidebarMenuButton({
  asChild = false,
  isActive = false,
  variant = 'default',
  size = 'default',
  tooltip,
  className,
  ...props
}: React.ComponentProps<'button'> & {
  asChild?: boolean
  isActive?: boolean
  tooltip?: string | React.ComponentProps<typeof TooltipContent>
} & VariantProps<typeof sidebarMenuButtonVariants>) {
  const Comp = asChild ? Slot : 'button'
  const { isMobile, state } = useSidebar()

  const button = (
    <Comp
      data-slot="sidebar-menu-button"
      data-sidebar="menu-button"
      data-size={size}
      data-active={isActive}
      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
      {...props}
    />
  )

  if (!tooltip) {
    return button
  }

  if (typeof tooltip === 'string') {
    tooltip = {
      children: tooltip,
    }
  }

  return (
    <Tooltip>
      <TooltipTrigger asChild>{button}</TooltipTrigger>
      <TooltipContent
        side="right"
        align="center"
        hidden={state !== 'collapsed' || isMobile}
        {...tooltip}
      />
    </Tooltip>
  )
}

function SidebarMenuAction({
  className,
  asChild = false,
  showOnHover = false,
  ...props
}: React.ComponentProps<'button'> & {
  asChild?: boolean
  showOnHover?: boolean
}) {
  const Comp = asChild ? Slot : 'button'

  return (
    <Comp
      data-slot="sidebar-menu-action"
      data-sidebar="menu-action"
      className={cn(
        'text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0',
        // Increases the hit area of the button on mobile.
        'after:absolute after:-inset-2 md:after:hidden',
        'peer-data-[size=sm]/menu-button:top-1',
        'peer-data-[size=default]/menu-button:top-1.5',
        'peer-data-[size=lg]/menu-button:top-2.5',
        'group-data-[collapsible=icon]:hidden',
        showOnHover &&
          'peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0',
        className,
      )}
      {...props}
    />
  )
}

function SidebarMenuBadge({
  className,
  ...props
}: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sidebar-menu-badge"
      data-sidebar="menu-badge"
      className={cn(
        'text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none',
        'peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground',
        'peer-data-[size=sm]/menu-button:top-1',
        'peer-data-[size=default]/menu-button:top-1.5',
        'peer-data-[size=lg]/menu-button:top-2.5',
        'group-data-[collapsible=icon]:hidden',
        className,
      )}
      {...props}
    />
  )
}

function SidebarMenuSkeleton({
  className,
  showIcon = false,
  ...props
}: React.ComponentProps<'div'> & {
  showIcon?: boolean
}) {
  // Random width between 50 to 90%.
  const width = React.useMemo(() => {
    return `${Math.floor(Math.random() * 40) + 50}%`
  }, [])

  return (
    <div
      data-slot="sidebar-menu-skeleton"
      data-sidebar="menu-skeleton"
      className={cn('flex h-8 items-center gap-2 rounded-md px-2', className)}
      {...props}
    >
      {showIcon && (
        <Skeleton
          className="size-4 rounded-md"
          data-sidebar="menu-skeleton-icon"
        />
      )}
      <Skeleton
        className="h-4 max-w-(--skeleton-width) flex-1"
        data-sidebar="menu-skeleton-text"
        style={
          {
            '--skeleton-width': width,
          } as React.CSSProperties
        }
      />
    </div>
  )
}

function SidebarMenuSub({ className, ...props }: React.ComponentProps<'ul'>) {
  return (
    <ul
      data-slot="sidebar-menu-sub"
      data-sidebar="menu-sub"
      className={cn(
        'border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5',
        'group-data-[collapsible=icon]:hidden',
        className,
      )}
      {...props}
    />
  )
}

function SidebarMenuSubItem({
  className,
  ...props
}: React.ComponentProps<'li'>) {
  return (
    <li
      data-slot="sidebar-menu-sub-item"
      data-sidebar="menu-sub-item"
      className={cn('group/menu-sub-item relative', className)}
      {...props}
    />
  )
}

function SidebarMenuSubButton({
  asChild = false,
  size = 'md',
  isActive = false,
  className,
  ...props
}: React.ComponentProps<'a'> & {
  asChild?: boolean
  size?: 'sm' | 'md'
  isActive?: boolean
}) {
  const Comp = asChild ? Slot : 'a'

  return (
    <Comp
      data-slot="sidebar-menu-sub-button"
      data-sidebar="menu-sub-button"
      data-size={size}
      data-active={isActive}
      className={cn(
        'text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline-hidden focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0',
        'data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground',
        size === 'sm' && 'text-xs',
        size === 'md' && 'text-sm',
        'group-data-[collapsible=icon]:hidden',
        className,
      )}
      {...props}
    />
  )
}

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar,
}

// ===== FILE: components\ui\skeleton.tsx =====

import { cn } from '@/lib/utils'

function Skeleton({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="skeleton"
      className={cn('bg-accent animate-pulse rounded-md', className)}
      {...props}
    />
  )
}

export { Skeleton }

// ===== FILE: components\ui\slider.tsx =====

'use client'

import * as React from 'react'
import * as SliderPrimitive from '@radix-ui/react-slider'

import { cn } from '@/lib/utils'

function Slider({
  className,
  defaultValue,
  value,
  min = 0,
  max = 100,
  ...props
}: React.ComponentProps<typeof SliderPrimitive.Root>) {
  const _values = React.useMemo(
    () =>
      Array.isArray(value)
        ? value
        : Array.isArray(defaultValue)
          ? defaultValue
          : [min, max],
    [value, defaultValue, min, max],
  )

  return (
    <SliderPrimitive.Root
      data-slot="slider"
      defaultValue={defaultValue}
      value={value}
      min={min}
      max={max}
      className={cn(
        'relative flex w-full touch-none items-center select-none data-[disabled]:opacity-50 data-[orientation=vertical]:h-full data-[orientation=vertical]:min-h-44 data-[orientation=vertical]:w-auto data-[orientation=vertical]:flex-col',
        className,
      )}
      {...props}
    >
      <SliderPrimitive.Track
        data-slot="slider-track"
        className={
          'bg-muted relative grow overflow-hidden rounded-full data-[orientation=horizontal]:h-1.5 data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-1.5'
        }
      >
        <SliderPrimitive.Range
          data-slot="slider-range"
          className={
            'bg-primary absolute data-[orientation=horizontal]:h-full data-[orientation=vertical]:w-full'
          }
        />
      </SliderPrimitive.Track>
      {Array.from({ length: _values.length }, (_, index) => (
        <SliderPrimitive.Thumb
          data-slot="slider-thumb"
          key={index}
          className="border-primary ring-ring/50 block size-4 shrink-0 rounded-full border bg-white shadow-sm transition-[color,box-shadow] hover:ring-4 focus-visible:ring-4 focus-visible:outline-hidden disabled:pointer-events-none disabled:opacity-50"
        />
      ))}
    </SliderPrimitive.Root>
  )
}

export { Slider }

// ===== FILE: components\ui\sonner.tsx =====

'use client'

import { useTheme } from 'next-themes'
import { Toaster as Sonner, ToasterProps } from 'sonner'

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = 'system' } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps['theme']}
      className="toaster group"
      style={
        {
          '--normal-bg': 'var(--popover)',
          '--normal-text': 'var(--popover-foreground)',
          '--normal-border': 'var(--border)',
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }

// ===== FILE: components\ui\spinner.tsx =====

import { Loader2Icon } from 'lucide-react'

import { cn } from '@/lib/utils'

function Spinner({ className, ...props }: React.ComponentProps<'svg'>) {
  return (
    <Loader2Icon
      role="status"
      aria-label="Loading"
      className={cn('size-4 animate-spin', className)}
      {...props}
    />
  )
}

export { Spinner }

// ===== FILE: components\ui\switch.tsx =====

'use client'

import * as React from 'react'
import * as SwitchPrimitive from '@radix-ui/react-switch'

import { cn } from '@/lib/utils'

function Switch({
  className,
  ...props
}: React.ComponentProps<typeof SwitchPrimitive.Root>) {
  return (
    <SwitchPrimitive.Root
      data-slot="switch"
      className={cn(
        'peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent shadow-xs transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50',
        className,
      )}
      {...props}
    >
      <SwitchPrimitive.Thumb
        data-slot="switch-thumb"
        className={
          'bg-background dark:data-[state=unchecked]:bg-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0'
        }
      />
    </SwitchPrimitive.Root>
  )
}

export { Switch }

// ===== FILE: components\ui\table.tsx =====

'use client'

import * as React from 'react'

import { cn } from '@/lib/utils'

function Table({ className, ...props }: React.ComponentProps<'table'>) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn('w-full caption-bottom text-sm', className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<'thead'>) {
  return (
    <thead
      data-slot="table-header"
      className={cn('[&_tr]:border-b', className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<'tbody'>) {
  return (
    <tbody
      data-slot="table-body"
      className={cn('[&_tr:last-child]:border-0', className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<'tfoot'>) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        'bg-muted/50 border-t font-medium [&>tr]:last:border-b-0',
        className,
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<'tr'>) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        'hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors',
        className,
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<'th'>) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        'text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]',
        className,
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<'td'>) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        'p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]',
        className,
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<'caption'>) {
  return (
    <caption
      data-slot="table-caption"
      className={cn('text-muted-foreground mt-4 text-sm', className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

// ===== FILE: components\ui\tabs.tsx =====

'use client'

import * as React from 'react'
import * as TabsPrimitive from '@radix-ui/react-tabs'

import { cn } from '@/lib/utils'

function Tabs({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      className={cn('flex flex-col gap-2', className)}
      {...props}
    />
  )
}

function TabsList({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      className={cn(
        'bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-[3px]',
        className,
      )}
      {...props}
    />
  )
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn('flex-1 outline-none', className)}
      {...props}
    />
  )
}

export { Tabs, TabsList, TabsTrigger, TabsContent }

// ===== FILE: components\ui\textarea.tsx =====

import * as React from 'react'

import { cn } from '@/lib/utils'

function Textarea({ className, ...props }: React.ComponentProps<'textarea'>) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        'border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm',
        className,
      )}
      {...props}
    />
  )
}

export { Textarea }

// ===== FILE: components\ui\toast.tsx =====

'use client'

import * as React from 'react'
import * as ToastPrimitives from '@radix-ui/react-toast'
import { cva, type VariantProps } from 'class-variance-authority'
import { X } from 'lucide-react'

import { cn } from '@/lib/utils'

const ToastProvider = ToastPrimitives.Provider

const ToastViewport = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Viewport>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Viewport
    ref={ref}
    className={cn(
      'fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]',
      className,
    )}
    {...props}
  />
))
ToastViewport.displayName = ToastPrimitives.Viewport.displayName

const toastVariants = cva(
  'group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full',
  {
    variants: {
      variant: {
        default: 'border bg-background text-foreground',
        destructive:
          'destructive group border-destructive bg-destructive text-destructive-foreground',
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  },
)

const Toast = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &
    VariantProps<typeof toastVariants>
>(({ className, variant, ...props }, ref) => {
  return (
    <ToastPrimitives.Root
      ref={ref}
      className={cn(toastVariants({ variant }), className)}
      {...props}
    />
  )
})
Toast.displayName = ToastPrimitives.Root.displayName

const ToastAction = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Action>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Action
    ref={ref}
    className={cn(
      'inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive',
      className,
    )}
    {...props}
  />
))
ToastAction.displayName = ToastPrimitives.Action.displayName

const ToastClose = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Close>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Close
    ref={ref}
    className={cn(
      'absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600',
      className,
    )}
    toast-close=""
    {...props}
  >
    <X className="h-4 w-4" />
  </ToastPrimitives.Close>
))
ToastClose.displayName = ToastPrimitives.Close.displayName

const ToastTitle = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Title>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Title
    ref={ref}
    className={cn('text-sm font-semibold', className)}
    {...props}
  />
))
ToastTitle.displayName = ToastPrimitives.Title.displayName

const ToastDescription = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Description>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Description
    ref={ref}
    className={cn('text-sm opacity-90', className)}
    {...props}
  />
))
ToastDescription.displayName = ToastPrimitives.Description.displayName

type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>

type ToastActionElement = React.ReactElement<typeof ToastAction>

export {
  type ToastProps,
  type ToastActionElement,
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
}

// ===== FILE: components\ui\toaster.tsx =====

'use client'

import { useToast } from '@/hooks/use-toast'
import {
  Toast,
  ToastClose,
  ToastDescription,
  ToastProvider,
  ToastTitle,
  ToastViewport,
} from '@/components/ui/toast'

export function Toaster() {
  const { toasts } = useToast()

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props}>
            <div className="grid gap-1">
              {title && <ToastTitle>{title}</ToastTitle>}
              {description && (
                <ToastDescription>{description}</ToastDescription>
              )}
            </div>
            {action}
            <ToastClose />
          </Toast>
        )
      })}
      <ToastViewport />
    </ToastProvider>
  )
}

// ===== FILE: components\ui\toggle-group.tsx =====

'use client'

import * as React from 'react'
import * as ToggleGroupPrimitive from '@radix-ui/react-toggle-group'
import { type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'
import { toggleVariants } from '@/components/ui/toggle'

const ToggleGroupContext = React.createContext<
  VariantProps<typeof toggleVariants>
>({
  size: 'default',
  variant: 'default',
})

function ToggleGroup({
  className,
  variant,
  size,
  children,
  ...props
}: React.ComponentProps<typeof ToggleGroupPrimitive.Root> &
  VariantProps<typeof toggleVariants>) {
  return (
    <ToggleGroupPrimitive.Root
      data-slot="toggle-group"
      data-variant={variant}
      data-size={size}
      className={cn(
        'group/toggle-group flex w-fit items-center rounded-md data-[variant=outline]:shadow-xs',
        className,
      )}
      {...props}
    >
      <ToggleGroupContext.Provider value={{ variant, size }}>
        {children}
      </ToggleGroupContext.Provider>
    </ToggleGroupPrimitive.Root>
  )
}

function ToggleGroupItem({
  className,
  children,
  variant,
  size,
  ...props
}: React.ComponentProps<typeof ToggleGroupPrimitive.Item> &
  VariantProps<typeof toggleVariants>) {
  const context = React.useContext(ToggleGroupContext)

  return (
    <ToggleGroupPrimitive.Item
      data-slot="toggle-group-item"
      data-variant={context.variant || variant}
      data-size={context.size || size}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        'min-w-0 flex-1 shrink-0 rounded-none shadow-none first:rounded-l-md last:rounded-r-md focus:z-10 focus-visible:z-10 data-[variant=outline]:border-l-0 data-[variant=outline]:first:border-l',
        className,
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  )
}

export { ToggleGroup, ToggleGroupItem }

// ===== FILE: components\ui\toggle.tsx =====

'use client'

import * as React from 'react'
import * as TogglePrimitive from '@radix-ui/react-toggle'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'

const toggleVariants = cva(
  "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium hover:bg-muted hover:text-muted-foreground disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 [&_svg]:shrink-0 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] outline-none transition-[color,box-shadow] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive whitespace-nowrap",
  {
    variants: {
      variant: {
        default: 'bg-transparent',
        outline:
          'border border-input bg-transparent shadow-xs hover:bg-accent hover:text-accent-foreground',
      },
      size: {
        default: 'h-9 px-2 min-w-9',
        sm: 'h-8 px-1.5 min-w-8',
        lg: 'h-10 px-2.5 min-w-10',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  },
)

function Toggle({
  className,
  variant,
  size,
  ...props
}: React.ComponentProps<typeof TogglePrimitive.Root> &
  VariantProps<typeof toggleVariants>) {
  return (
    <TogglePrimitive.Root
      data-slot="toggle"
      className={cn(toggleVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Toggle, toggleVariants }

// ===== FILE: components\ui\tooltip.tsx =====

'use client'

import * as React from 'react'
import * as TooltipPrimitive from '@radix-ui/react-tooltip'

import { cn } from '@/lib/utils'

function TooltipProvider({
  delayDuration = 0,
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return (
    <TooltipPrimitive.Provider
      data-slot="tooltip-provider"
      delayDuration={delayDuration}
      {...props}
    />
  )
}

function Tooltip({
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return (
    <TooltipProvider>
      <TooltipPrimitive.Root data-slot="tooltip" {...props} />
    </TooltipProvider>
  )
}

function TooltipTrigger({
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />
}

function TooltipContent({
  className,
  sideOffset = 0,
  children,
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          'bg-foreground text-background animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-fit origin-(--radix-tooltip-content-transform-origin) rounded-md px-3 py-1.5 text-xs text-balance',
          className,
        )}
        {...props}
      >
        {children}
        <TooltipPrimitive.Arrow className="bg-foreground fill-foreground z-50 size-2.5 translate-y-[calc(-50%_-_2px)] rotate-45 rounded-[2px]" />
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  )
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }

// ===== FILE: components\ui\use-mobile.tsx =====

import * as React from 'react'

const MOBILE_BREAKPOINT = 768

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    }
    mql.addEventListener('change', onChange)
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    return () => mql.removeEventListener('change', onChange)
  }, [])

  return !!isMobile
}

// ===== FILE: components\ui\use-toast.ts =====

'use client'

// Inspired by react-hot-toast library
import * as React from 'react'

import type { ToastActionElement, ToastProps } from '@/components/ui/toast'

const TOAST_LIMIT = 1
const TOAST_REMOVE_DELAY = 1000000

type ToasterToast = ToastProps & {
  id: string
  title?: React.ReactNode
  description?: React.ReactNode
  action?: ToastActionElement
}

const actionTypes = {
  ADD_TOAST: 'ADD_TOAST',
  UPDATE_TOAST: 'UPDATE_TOAST',
  DISMISS_TOAST: 'DISMISS_TOAST',
  REMOVE_TOAST: 'REMOVE_TOAST',
} as const

let count = 0

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER
  return count.toString()
}

type ActionType = typeof actionTypes

type Action =
  | {
      type: ActionType['ADD_TOAST']
      toast: ToasterToast
    }
  | {
      type: ActionType['UPDATE_TOAST']
      toast: Partial<ToasterToast>
    }
  | {
      type: ActionType['DISMISS_TOAST']
      toastId?: ToasterToast['id']
    }
  | {
      type: ActionType['REMOVE_TOAST']
      toastId?: ToasterToast['id']
    }

interface State {
  toasts: ToasterToast[]
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId)
    dispatch({
      type: 'REMOVE_TOAST',
      toastId: toastId,
    })
  }, TOAST_REMOVE_DELAY)

  toastTimeouts.set(toastId, timeout)
}

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case 'ADD_TOAST':
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      }

    case 'UPDATE_TOAST':
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t,
        ),
      }

    case 'DISMISS_TOAST': {
      const { toastId } = action

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId)
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id)
        })
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t,
        ),
      }
    }
    case 'REMOVE_TOAST':
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        }
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      }
  }
}

const listeners: Array<(state: State) => void> = []

let memoryState: State = { toasts: [] }

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action)
  listeners.forEach((listener) => {
    listener(memoryState)
  })
}

type Toast = Omit<ToasterToast, 'id'>

function toast({ ...props }: Toast) {
  const id = genId()

  const update = (props: ToasterToast) =>
    dispatch({
      type: 'UPDATE_TOAST',
      toast: { ...props, id },
    })
  const dismiss = () => dispatch({ type: 'DISMISS_TOAST', toastId: id })

  dispatch({
    type: 'ADD_TOAST',
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss()
      },
    },
  })

  return {
    id: id,
    dismiss,
    update,
  }
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState)

  React.useEffect(() => {
    listeners.push(setState)
    return () => {
      const index = listeners.indexOf(setState)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }, [state])

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: 'DISMISS_TOAST', toastId }),
  }
}

export { useToast, toast }

// ===== FILE: components\users\assign-roles-dialog.tsx =====

"use client"

import { useState, useEffect } from "react"
import { toast } from "sonner"
import { Check, X } from "lucide-react"

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Checkbox } from "@/components/ui/checkbox"
import { Label } from "@/components/ui/label"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import { RoleBadge } from "@/components/common/role-badge"
import type { User, Role } from "@/types"
import { getRoles, assignRole, revokeRole } from "@/lib/api/roles"

interface AssignRolesDialogProps {
  user: User | null
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: () => void
}

export function AssignRolesDialog({ user, open, onOpenChange, onSuccess }: AssignRolesDialogProps) {
  const [roles, setRoles] = useState<Role[]>([])
  const [selectedRoles, setSelectedRoles] = useState<string[]>([])
  const [isLoading, setIsLoading] = useState(false)
  const [isSaving, setIsSaving] = useState(false)

  useEffect(() => {
    if (open) {
      loadRoles()
    }
  }, [open])

  useEffect(() => {
    if (user) {
      setSelectedRoles(user.roles)
    }
  }, [user])

  const loadRoles = async () => {
    setIsLoading(true)
    try {
      const data = await getRoles()
      setRoles(data)
    } catch {
      toast.error("Failed to load roles")
    } finally {
      setIsLoading(false)
    }
  }

  const handleRoleToggle = (roleName: string) => {
    setSelectedRoles((prev) => (prev.includes(roleName) ? prev.filter((r) => r !== roleName) : [...prev, roleName]))
  }

  const handleSave = async () => {
    if (!user) return

    setIsSaving(true)
    try {
      // Find roles to add and remove
      const rolesToAdd = selectedRoles.filter((r) => !user.roles.includes(r))
      const rolesToRemove = user.roles.filter((r) => !selectedRoles.includes(r))

      // Process all changes
      const promises: Promise<unknown>[] = []

      for (const roleName of rolesToAdd) {
        promises.push(assignRole({ userId: user.id, roleName }))
      }

      for (const roleName of rolesToRemove) {
        promises.push(revokeRole({ userId: user.id, roleName }))
      }

      await Promise.all(promises)

      toast.success("Roles updated successfully")
      onSuccess()
      onOpenChange(false)
    } catch {
      toast.error("Failed to update roles")
    } finally {
      setIsSaving(false)
    }
  }

  if (!user) return null

  const hasChanges = selectedRoles.length !== user.roles.length || !selectedRoles.every((r) => user.roles.includes(r))

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>Assign Roles</DialogTitle>
          <DialogDescription>
            Manage roles for {user.firstName} {user.lastName}
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          {/* Current Roles */}
          <div className="space-y-2">
            <Label className="text-muted-foreground">Current Roles</Label>
            <div className="flex flex-wrap gap-2">
              {user.roles.map((role) => (
                <RoleBadge key={role} role={role} />
              ))}
            </div>
          </div>

          {/* Role Selection */}
          <div className="space-y-2">
            <Label>Available Roles</Label>
            {isLoading ? (
              <div className="flex justify-center py-4">
                <LoadingSpinner />
              </div>
            ) : (
              <div className="space-y-2 max-h-64 overflow-y-auto">
                {roles.map((role) => (
                  <div key={role.id} className="flex items-center justify-between rounded-lg border border-border p-3">
                    <div className="flex items-center gap-3">
                      <Checkbox
                        id={`role-${role.id}`}
                        checked={selectedRoles.includes(role.name)}
                        onCheckedChange={() => handleRoleToggle(role.name)}
                        disabled={role.isSystem && role.name === "SUPERADMIN"}
                      />
                      <div>
                        <Label htmlFor={`role-${role.id}`} className="font-medium cursor-pointer">
                          <RoleBadge role={role.name} />
                        </Label>
                        <p className="text-xs text-muted-foreground mt-1">{role.description}</p>
                      </div>
                    </div>
                    {selectedRoles.includes(role.name) !== user.roles.includes(role.name) && (
                      <div className="flex items-center gap-1">
                        {selectedRoles.includes(role.name) ? (
                          <Check className="h-4 w-4 text-emerald-500" />
                        ) : (
                          <X className="h-4 w-4 text-destructive" />
                        )}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        <DialogFooter>
          <Button type="button" variant="outline" onClick={() => onOpenChange(false)}>
            Cancel
          </Button>
          <Button onClick={handleSave} disabled={isSaving || !hasChanges}>
            {isSaving && <LoadingSpinner size="sm" className="mr-2" />}
            Save Changes
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}

// ===== FILE: components\users\deleted-users-table.tsx =====

// ===== FILE: components/users/deleted-users-table.tsx =====
// Table component for displaying deleted users with restore and permanent delete actions

"use client"

import { useState } from "react"
import {
  type ColumnDef,
  type ColumnFiltersState,
  type SortingState,
  flexRender,
  getCoreRowModel,
  getFilteredRowModel,
  getPaginationRowModel,
  getSortedRowModel,
  useReactTable,
} from "@tanstack/react-table"
import {
  MoreHorizontal,
  ArrowUpDown,
  Search,
  RotateCcw,
  Trash2,
  AlertTriangle,
  Calendar,
} from "lucide-react"

import { Button } from "@/components/ui/button"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { Input } from "@/components/ui/input"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { Avatar, AvatarFallback } from "@/components/ui/avatar"
import { Badge } from "@/components/ui/badge"
import { Alert, AlertDescription } from "@/components/ui/alert"
import type { User } from "@/types"
import { getInitials, formatRelativeTime, formatDateTime } from "@/lib/utils/formatters"

interface DeletedUsersTableProps {
  users: User[]
  onRestore: (user: User) => void
  onPermanentDelete: (user: User) => void
}

export function DeletedUsersTable({ users, onRestore, onPermanentDelete }: DeletedUsersTableProps) {
  const [sorting, setSorting] = useState<SortingState>([
    { id: "deletedAt", desc: true } // Sort by deletion date by default
  ])
  const [columnFilters, setColumnFilters] = useState<ColumnFiltersState>([])

  const columns: ColumnDef<User>[] = [
    {
      accessorKey: "name",
      header: ({ column }) => (
        <Button variant="ghost" onClick={() => column.toggleSorting(column.getIsSorted() === "asc")}>
          User
          <ArrowUpDown className="ml-2 h-4 w-4" />
        </Button>
      ),
      cell: ({ row }) => {
        const user = row.original
        return (
          <div className="flex items-center gap-3">
            <Avatar className="h-8 w-8 opacity-60">
              <AvatarFallback className="bg-muted text-muted-foreground text-xs">
                {getInitials(user.firstName, user.lastName)}
              </AvatarFallback>
            </Avatar>
            <div>
              <p className="font-medium text-muted-foreground line-through">
                {user.firstName} {user.lastName}
              </p>
              <p className="text-xs text-muted-foreground">@{user.userName}</p>
            </div>
          </div>
        )
      },
      filterFn: (row, id, value) => {
        const user = row.original
        const searchValue = value.toLowerCase()
        return (
          user.firstName.toLowerCase().includes(searchValue) ||
          user.lastName.toLowerCase().includes(searchValue) ||
          user.userName.toLowerCase().includes(searchValue)
        )
      },
    },
    {
      accessorKey: "email",
      header: ({ column }) => (
        <Button variant="ghost" onClick={() => column.toggleSorting(column.getIsSorted() === "asc")}>
          Email
          <ArrowUpDown className="ml-2 h-4 w-4" />
        </Button>
      ),
      cell: ({ row }) => (
        <span className="text-muted-foreground">{row.getValue("email")}</span>
      ),
    },
    {
      accessorKey: "accountStatus",
      header: "Status Before Deletion",
      cell: ({ row }) => {
        const status = row.getValue("accountStatus") as string
        return (
          <Badge variant="outline" className="bg-muted/50 text-muted-foreground">
            {status?.replace(/_/g, " ") || "Unknown"}
          </Badge>
        )
      },
    },
    {
      accessorKey: "deletedAt",
      header: ({ column }) => (
        <Button variant="ghost" onClick={() => column.toggleSorting(column.getIsSorted() === "asc")}>
          <Calendar className="mr-2 h-4 w-4" />
          Deleted
          <ArrowUpDown className="ml-2 h-4 w-4" />
        </Button>
      ),
      cell: ({ row }) => {
        const deletedAt = row.getValue("deletedAt") as string | null
        if (!deletedAt) return <span className="text-muted-foreground">Unknown</span>
        return (
          <span className="text-muted-foreground" title={formatDateTime(deletedAt)}>
            {formatRelativeTime(deletedAt)}
          </span>
        )
      },
    },
    {
      id: "actions",
      enableHiding: false,
      cell: ({ row }) => {
        const user = row.original
        return (
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" className="h-8 w-8 p-0">
                <span className="sr-only">Open menu</span>
                <MoreHorizontal className="h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuLabel>Actions</DropdownMenuLabel>
              <DropdownMenuItem onClick={() => onRestore(user)}>
                <RotateCcw className="mr-2 h-4 w-4" />
                Restore User
              </DropdownMenuItem>
              <DropdownMenuSeparator />
              <DropdownMenuItem 
                onClick={() => onPermanentDelete(user)} 
                className="text-destructive focus:text-destructive"
              >
                <Trash2 className="mr-2 h-4 w-4" />
                Permanently Delete
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        )
      },
    },
  ]

  const table = useReactTable({
    data: users,
    columns,
    onSortingChange: setSorting,
    onColumnFiltersChange: setColumnFilters,
    getCoreRowModel: getCoreRowModel(),
    getPaginationRowModel: getPaginationRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
    state: {
      sorting,
      columnFilters,
    },
  })

  return (
    <div className="space-y-4">
      {/* Warning Alert */}
      <Alert variant="destructive" className="border-amber-500/50 bg-amber-500/10">
        <AlertTriangle className="h-4 w-4 text-amber-500" />
        <AlertDescription className="text-amber-500">
          These users have been soft-deleted. You can restore them or permanently delete them.
          <strong> Permanent deletion cannot be undone.</strong>
        </AlertDescription>
      </Alert>

      {/* Toolbar */}
      <div className="flex items-center gap-2">
        <div className="relative flex-1 max-w-sm">
          <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
          <Input
            placeholder="Search deleted users..."
            value={(table.getColumn("name")?.getFilterValue() as string) ?? ""}
            onChange={(event) => table.getColumn("name")?.setFilterValue(event.target.value)}
            className="pl-9"
          />
        </div>
      </div>

      {/* Table */}
      <div className="rounded-md border">
        <Table>
          <TableHeader>
            {table.getHeaderGroups().map((headerGroup) => (
              <TableRow key={headerGroup.id}>
                {headerGroup.headers.map((header) => (
                  <TableHead key={header.id}>
                    {header.isPlaceholder ? null : flexRender(header.column.columnDef.header, header.getContext())}
                  </TableHead>
                ))}
              </TableRow>
            ))}
          </TableHeader>
          <TableBody>
            {table.getRowModel().rows?.length ? (
              table.getRowModel().rows.map((row) => (
                <TableRow key={row.id} className="bg-muted/30">
                  {row.getVisibleCells().map((cell) => (
                    <TableCell key={cell.id}>{flexRender(cell.column.columnDef.cell, cell.getContext())}</TableCell>
                  ))}
                </TableRow>
              ))
            ) : (
              <TableRow>
                <TableCell colSpan={columns.length} className="h-24 text-center">
                  No deleted users found.
                </TableCell>
              </TableRow>
            )}
          </TableBody>
        </Table>
      </div>

      {/* Pagination */}
      <div className="flex items-center justify-between">
        <p className="text-sm text-muted-foreground">
          Showing {table.getRowModel().rows.length} of {users.length} deleted users
        </p>
        <div className="flex items-center gap-2">
          <Button
            variant="outline"
            size="sm"
            onClick={() => table.previousPage()}
            disabled={!table.getCanPreviousPage()}
          >
            Previous
          </Button>
          <Button 
            variant="outline" 
            size="sm" 
            onClick={() => table.nextPage()} 
            disabled={!table.getCanNextPage()}
          >
            Next
          </Button>
        </div>
      </div>
    </div>
  )
}

// ===== FILE: components\users\edit-user-dialog.tsx =====

"use client"

import { useEffect } from "react"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import { toast } from "sonner"

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { LoadingSpinner } from "@/components/common/loading-spinner"
import type { User } from "@/types"
import { updateUserSchema, type UpdateUserFormData } from "@/lib/validations/users"
import { updateUser } from "@/lib/api/users"

interface EditUserDialogProps {
  user: User | null
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: () => void
}

export function EditUserDialog({ user, open, onOpenChange, onSuccess }: EditUserDialogProps) {
  const {
    register,
    handleSubmit,
    reset,
    formState: { errors, isSubmitting },
  } = useForm<UpdateUserFormData>({
    resolver: zodResolver(updateUserSchema),
  })

  useEffect(() => {
    if (user) {
      reset({
        firstName: user.firstName,
        lastName: user.lastName,
        userName: user.userName,
      })
    }
  }, [user, reset])

  const onSubmit = async (data: UpdateUserFormData) => {
    if (!user) return

    try {
      const response = await updateUser(user.id, data)
      if (response.success) {
        toast.success("User updated successfully")
        onSuccess()
        onOpenChange(false)
      } else {
        toast.error(response.message)
      }
    } catch {
      toast.error("Failed to update user")
    }
  }

  if (!user) return null

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>Edit User</DialogTitle>
          <DialogDescription>Update the user information below</DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="firstName">First Name</Label>
              <Input id="firstName" {...register("firstName")} />
              {errors.firstName && <p className="text-sm text-destructive">{errors.firstName.message}</p>}
            </div>
            <div className="space-y-2">
              <Label htmlFor="lastName">Last Name</Label>
              <Input id="lastName" {...register("lastName")} />
              {errors.lastName && <p className="text-sm text-destructive">{errors.lastName.message}</p>}
            </div>
          </div>

          <div className="space-y-2">
            <Label htmlFor="userName">Username</Label>
            <Input id="userName" {...register("userName")} />
            {errors.userName && <p className="text-sm text-destructive">{errors.userName.message}</p>}
          </div>

          <div className="space-y-2">
            <Label htmlFor="email">Email</Label>
            <Input id="email" value={user.email} disabled className="bg-muted" />
            <p className="text-xs text-muted-foreground">Email cannot be changed</p>
          </div>

          <DialogFooter>
            <Button type="button" variant="outline" onClick={() => onOpenChange(false)}>
              Cancel
            </Button>
            <Button type="submit" disabled={isSubmitting}>
              {isSubmitting && <LoadingSpinner size="sm" className="mr-2" />}
              Save Changes
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}

// ===== FILE: components\users\user-details-dialog.tsx =====

"use client"

import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { Avatar, AvatarFallback } from "@/components/ui/avatar"
import { Badge } from "@/components/ui/badge"
import { RoleBadge } from "@/components/common/role-badge"
import { Separator } from "@/components/ui/separator"
import type { User } from "@/types"
import { getInitials, formatDateTime, formatRelativeTime } from "@/lib/utils/formatters"
import { Mail, MailCheck, Lock, Unlock, Calendar, Clock } from "lucide-react"

interface UserDetailsDialogProps {
  user: User | null
  open: boolean
  onOpenChange: (open: boolean) => void
}

export function UserDetailsDialog({ user, open, onOpenChange }: UserDetailsDialogProps) {
  if (!user) return null

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-lg">
        <DialogHeader>
          <DialogTitle>User Details</DialogTitle>
          <DialogDescription>Detailed information about the user account</DialogDescription>
        </DialogHeader>

        <div className="space-y-6">
          {/* User Header */}
          <div className="flex items-center gap-4">
            <Avatar className="h-16 w-16">
              <AvatarFallback className="bg-primary/10 text-primary text-xl">
                {getInitials(user.firstName, user.lastName)}
              </AvatarFallback>
            </Avatar>
            <div>
              <h3 className="text-lg font-semibold">
                {user.firstName} {user.lastName}
              </h3>
              <p className="text-sm text-muted-foreground">@{user.userName}</p>
              <div className="flex items-center gap-2 mt-1">
                {user.isLocked ? (
                  <Badge variant="destructive" className="gap-1">
                    <Lock className="h-3 w-3" />
                    Locked
                  </Badge>
                ) : (
                  <Badge variant="outline" className="gap-1 text-emerald-500 border-emerald-500/20">
                    <Unlock className="h-3 w-3" />
                    Active
                  </Badge>
                )}
              </div>
            </div>
          </div>

          <Separator />

          {/* Contact Info */}
          <div className="space-y-3">
            <h4 className="text-sm font-medium text-muted-foreground">Contact</h4>
            <div className="flex items-center gap-2">
              {user.emailVerified ? (
                <MailCheck className="h-4 w-4 text-emerald-500" />
              ) : (
                <Mail className="h-4 w-4 text-amber-500" />
              )}
              <span className="text-sm">{user.email}</span>
              <Badge variant={user.emailVerified ? "secondary" : "outline"} className="text-xs">
                {user.emailVerified ? "Verified" : "Unverified"}
              </Badge>
            </div>
          </div>

          <Separator />

          {/* Roles */}
          <div className="space-y-3">
            <h4 className="text-sm font-medium text-muted-foreground">Roles</h4>
            <div className="flex flex-wrap gap-2">
              {user.roles.map((role) => (
                <RoleBadge key={role} role={role} />
              ))}
            </div>
          </div>

          <Separator />

          {/* Permissions */}
          <div className="space-y-3">
            <h4 className="text-sm font-medium text-muted-foreground">Permissions ({user.permissions.length})</h4>
            <div className="max-h-32 overflow-y-auto">
              <div className="flex flex-wrap gap-1">
                {user.permissions.length > 0 ? (
                  user.permissions.map((permission) => (
                    <Badge key={permission} variant="secondary" className="text-xs">
                      {permission}
                    </Badge>
                  ))
                ) : (
                  <p className="text-sm text-muted-foreground">No specific permissions</p>
                )}
              </div>
            </div>
          </div>

          <Separator />

          {/* Timestamps */}
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-1">
              <div className="flex items-center gap-2 text-muted-foreground">
                <Calendar className="h-4 w-4" />
                <span className="text-xs">Created</span>
              </div>
              <p className="text-sm">{formatDateTime(user.createdAt)}</p>
            </div>
            <div className="space-y-1">
              <div className="flex items-center gap-2 text-muted-foreground">
                <Clock className="h-4 w-4" />
                <span className="text-xs">Last Login</span>
              </div>
              <p className="text-sm">{user.lastLoginAt ? formatRelativeTime(user.lastLoginAt) : "Never"}</p>
            </div>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  )
}

// ===== FILE: components\users\users-table.tsx =====

"use client"

import { useState } from "react"
import {
  type ColumnDef,
  type ColumnFiltersState,
  type SortingState,
  type VisibilityState,
  flexRender,
  getCoreRowModel,
  getFilteredRowModel,
  getPaginationRowModel,
  getSortedRowModel,
  useReactTable,
} from "@tanstack/react-table"
import {
  MoreHorizontal,
  ArrowUpDown,
  Search,
  UserPlus,
  Mail,
  MailCheck,
  Lock,
  Unlock,
  Trash2,
  Edit,
  Eye,
} from "lucide-react"

import { Button } from "@/components/ui/button"
import { Checkbox } from "@/components/ui/checkbox"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { Input } from "@/components/ui/input"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { Avatar, AvatarFallback } from "@/components/ui/avatar"
import { Badge } from "@/components/ui/badge"
import { RoleBadge } from "@/components/common/role-badge"
import { PermissionGate } from "@/components/common/permission-gate"
import type { User } from "@/types"
import { getInitials, formatRelativeTime } from "@/lib/utils/formatters"

interface UsersTableProps {
  users: User[]
  onEdit: (user: User) => void
  onDelete: (user: User) => void
  onViewDetails: (user: User) => void
  onAssignRoles: (user: User) => void
}

export function UsersTable({ users, onEdit, onDelete, onViewDetails, onAssignRoles }: UsersTableProps) {
  const [sorting, setSorting] = useState<SortingState>([])
  const [columnFilters, setColumnFilters] = useState<ColumnFiltersState>([])
  const [columnVisibility, setColumnVisibility] = useState<VisibilityState>({})
  const [rowSelection, setRowSelection] = useState({})

  const columns: ColumnDef<User>[] = [
    {
      id: "select",
      header: ({ table }) => (
        <Checkbox
          checked={table.getIsAllPageRowsSelected() || (table.getIsSomePageRowsSelected() && "indeterminate")}
          onCheckedChange={(value) => table.toggleAllPageRowsSelected(!!value)}
          aria-label="Select all"
        />
      ),
      cell: ({ row }) => (
        <Checkbox
          checked={row.getIsSelected()}
          onCheckedChange={(value) => row.toggleSelected(!!value)}
          aria-label="Select row"
        />
      ),
      enableSorting: false,
      enableHiding: false,
    },
    {
      accessorKey: "user",
      header: "User",
      cell: ({ row }) => {
        const user = row.original
        return (
          <div className="flex items-center gap-3">
            <Avatar className="h-9 w-9">
              <AvatarFallback className="bg-primary/10 text-primary text-xs">
                {getInitials(user.firstName, user.lastName)}
              </AvatarFallback>
            </Avatar>
            <div>
              <p className="font-medium">
                {user.firstName} {user.lastName}
              </p>
              <p className="text-sm text-muted-foreground">@{user.userName}</p>
            </div>
          </div>
        )
      },
    },
    {
      accessorKey: "email",
      header: ({ column }) => (
        <Button variant="ghost" onClick={() => column.toggleSorting(column.getIsSorted() === "asc")}>
          Email
          <ArrowUpDown className="ml-2 h-4 w-4" />
        </Button>
      ),
      cell: ({ row }) => {
        const user = row.original
        return (
          <div className="flex items-center gap-2">
            <span className="text-sm">{user.email}</span>
            {user.emailVerified ? (
              <MailCheck className="h-4 w-4 text-emerald-500" />
            ) : (
              <Mail className="h-4 w-4 text-amber-500" />
            )}
          </div>
        )
      },
    },
    {
      accessorKey: "roles",
      header: "Roles",
      cell: ({ row }) => {
        const roles = row.original.roles
        return (
          <div className="flex flex-wrap gap-1">
            {roles.slice(0, 2).map((role) => (
              <RoleBadge key={role} role={role} className="text-[10px]" />
            ))}
            {roles.length > 2 && (
              <Badge variant="secondary" className="text-[10px]">
                +{roles.length - 2}
              </Badge>
            )}
          </div>
        )
      },
    },
    {
      accessorKey: "status",
      header: "Status",
      cell: ({ row }) => {
        const user = row.original
        return (
          <div className="flex items-center gap-2">
            {user.isLocked ? (
              <Badge variant="destructive" className="gap-1">
                <Lock className="h-3 w-3" />
                Locked
              </Badge>
            ) : (
              <Badge variant="outline" className="gap-1 text-emerald-500 border-emerald-500/20">
                <Unlock className="h-3 w-3" />
                Active
              </Badge>
            )}
          </div>
        )
      },
    },
    {
      accessorKey: "lastLoginAt",
      header: ({ column }) => (
        <Button variant="ghost" onClick={() => column.toggleSorting(column.getIsSorted() === "asc")}>
          Last Login
          <ArrowUpDown className="ml-2 h-4 w-4" />
        </Button>
      ),
      cell: ({ row }) => {
        const lastLogin = row.original.lastLoginAt
        return (
          <span className="text-sm text-muted-foreground">{lastLogin ? formatRelativeTime(lastLogin) : "Never"}</span>
        )
      },
    },
    {
      id: "actions",
      enableHiding: false,
      cell: ({ row }) => {
        const user = row.original
        return (
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" className="h-8 w-8 p-0">
                <span className="sr-only">Open menu</span>
                <MoreHorizontal className="h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuLabel>Actions</DropdownMenuLabel>
              <DropdownMenuItem onClick={() => onViewDetails(user)}>
                <Eye className="mr-2 h-4 w-4" />
                View Details
              </DropdownMenuItem>
              <PermissionGate permissions={["AUTH_USER_UPDATE", "UPDATE_USER"]}>
                <DropdownMenuItem onClick={() => onEdit(user)}>
                  <Edit className="mr-2 h-4 w-4" />
                  Edit User
                </DropdownMenuItem>
              </PermissionGate>
              <PermissionGate permissions={["AUTH_ROLE_ASSIGN", "MANAGE_ROLES"]}>
                <DropdownMenuItem onClick={() => onAssignRoles(user)}>
                  <UserPlus className="mr-2 h-4 w-4" />
                  Assign Roles
                </DropdownMenuItem>
              </PermissionGate>
              <DropdownMenuSeparator />
              <PermissionGate permissions={["AUTH_USER_DELETE", "DELETE_USER"]}>
                <DropdownMenuItem onClick={() => onDelete(user)} className="text-destructive">
                  <Trash2 className="mr-2 h-4 w-4" />
                  Delete User
                </DropdownMenuItem>
              </PermissionGate>
            </DropdownMenuContent>
          </DropdownMenu>
        )
      },
    },
  ]

  const table = useReactTable({
    data: users,
    columns,
    onSortingChange: setSorting,
    onColumnFiltersChange: setColumnFilters,
    getCoreRowModel: getCoreRowModel(),
    getPaginationRowModel: getPaginationRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
    onColumnVisibilityChange: setColumnVisibility,
    onRowSelectionChange: setRowSelection,
    state: {
      sorting,
      columnFilters,
      columnVisibility,
      rowSelection,
    },
  })

  return (
    <div className="space-y-4">
      {/* Toolbar */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
            <Input
              placeholder="Search users..."
              value={(table.getColumn("email")?.getFilterValue() as string) ?? ""}
              onChange={(event) => table.getColumn("email")?.setFilterValue(event.target.value)}
              className="w-64 pl-9"
            />
          </div>
        </div>
        <div className="flex items-center gap-2">
          {Object.keys(rowSelection).length > 0 && (
            <span className="text-sm text-muted-foreground">{Object.keys(rowSelection).length} selected</span>
          )}
        </div>
      </div>

      {/* Table */}
      <div className="rounded-lg border border-border">
        <Table>
          <TableHeader>
            {table.getHeaderGroups().map((headerGroup) => (
              <TableRow key={headerGroup.id}>
                {headerGroup.headers.map((header) => (
                  <TableHead key={header.id}>
                    {header.isPlaceholder ? null : flexRender(header.column.columnDef.header, header.getContext())}
                  </TableHead>
                ))}
              </TableRow>
            ))}
          </TableHeader>
          <TableBody>
            {table.getRowModel().rows?.length ? (
              table.getRowModel().rows.map((row) => (
                <TableRow key={row.id} data-state={row.getIsSelected() && "selected"}>
                  {row.getVisibleCells().map((cell) => (
                    <TableCell key={cell.id}>{flexRender(cell.column.columnDef.cell, cell.getContext())}</TableCell>
                  ))}
                </TableRow>
              ))
            ) : (
              <TableRow>
                <TableCell colSpan={columns.length} className="h-24 text-center">
                  No users found.
                </TableCell>
              </TableRow>
            )}
          </TableBody>
        </Table>
      </div>

      {/* Pagination */}
      <div className="flex items-center justify-between">
        <p className="text-sm text-muted-foreground">
          Showing {table.getRowModel().rows.length} of {users.length} users
        </p>
        <div className="flex items-center gap-2">
          <Button
            variant="outline"
            size="sm"
            onClick={() => table.previousPage()}
            disabled={!table.getCanPreviousPage()}
          >
            Previous
          </Button>
          <Button variant="outline" size="sm" onClick={() => table.nextPage()} disabled={!table.getCanNextPage()}>
            Next
          </Button>
        </div>
      </div>
    </div>
  )
}

// ===== FILE: lib\utils.ts =====

import { clsx, type ClassValue } from 'clsx'
import { twMerge } from 'tailwind-merge'

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

// ===== FILE: lib\api\admin.ts =====

// ===== FILE: lib/api/admin.ts =====
// Admin API for invite management and user approval

import { apiClient } from "./client"
import type {
  ApiResponse,
  PaginatedResponse,
  Invite,
  CreateInviteRequest,
  User,
  ApproveUserRequest,
  RejectUserRequest,
  SuspendUserRequest,
} from "@/types"

// ============================================
// Invite Management
// ============================================

/**
 * Create a new invite
 * POST /api/v1/admin/invites
 */
export async function createInvite(data: CreateInviteRequest): Promise<ApiResponse<Invite>> {
  return apiClient<ApiResponse<Invite>>("/api/v1/admin/invites", {
    method: "POST",
    body: JSON.stringify(data),
  })
}

/**
 * Get paginated invites with optional status filter
 * GET /api/v1/admin/invites
 */
export async function getInvites(
  page = 0, 
  size = 10,
  status?: string
): Promise<PaginatedResponse<Invite>> {
  let url = `/api/v1/admin/invites?page=${page}&size=${size}`
  if (status) {
    url += `&status=${status}`
  }
  const response = await apiClient<WrappedPaginatedResponse<Invite>>(url)
  // Backend wraps the response in { success, data }, so extract data
  return response.data
}

/**
 * Get a single invite by ID
 * GET /api/v1/admin/invites/{id}
 */
export async function getInviteById(id: number): Promise<Invite> {
  return apiClient<Invite>(`/api/v1/admin/invites/${id}`)
}

/**
 * Revoke an invite
 * DELETE /api/v1/admin/invites/{id}
 */
export async function revokeInvite(id: number): Promise<ApiResponse<null>> {
  return apiClient<ApiResponse<null>>(`/api/v1/admin/invites/${id}`, {
    method: "DELETE",
  })
}

// ============================================
// User Approval Management
// ============================================

// Helper type for wrapped paginated responses from backend
interface WrappedPaginatedResponse<T> {
  success: boolean
  data: PaginatedResponse<T>
}

/**
 * Get users pending approval
 * GET /api/v1/admin/users/pending-approval
 */
export async function getPendingApprovalUsers(
  page = 0,
  size = 10
): Promise<PaginatedResponse<User>> {
  const response = await apiClient<WrappedPaginatedResponse<User>>(
    `/api/v1/admin/users/pending-approval?page=${page}&size=${size}`
  )
  // Backend wraps the response in { success, data }, so extract data
  return response.data
}

/**
 * Get users pending verification
 * GET /api/v1/admin/users/pending-verification
 */
export async function getPendingVerificationUsers(
  page = 0,
  size = 10
): Promise<PaginatedResponse<User>> {
  const response = await apiClient<WrappedPaginatedResponse<User>>(
    `/api/v1/admin/users/pending-verification?page=${page}&size=${size}`
  )
  // Backend wraps the response in { success, data }, so extract data
  return response.data
}

/**
 * Get suspended users
 * GET /api/v1/admin/users/suspended
 */
export async function getSuspendedUsers(
  page = 0,
  size = 10
): Promise<PaginatedResponse<User>> {
  const response = await apiClient<WrappedPaginatedResponse<User>>(
    `/api/v1/admin/users/suspended?page=${page}&size=${size}`
  )
  // Backend wraps the response in { success, data }, so extract data
  return response.data
}

/**
 * Approve a user
 * POST /api/v1/admin/users/{id}/approve
 */
export async function approveUser(
  userId: string, 
  data?: ApproveUserRequest
): Promise<ApiResponse<User>> {
  return apiClient<ApiResponse<User>>(`/api/v1/admin/users/${userId}/approve`, {
    method: "POST",
    body: JSON.stringify(data || {}),
  })
}

/**
 * Reject a user
 * POST /api/v1/admin/users/{id}/reject
 */
export async function rejectUser(
  userId: string, 
  data: RejectUserRequest
): Promise<ApiResponse<null>> {
  return apiClient<ApiResponse<null>>(`/api/v1/admin/users/${userId}/reject`, {
    method: "POST",
    body: JSON.stringify(data),
  })
}

/**
 * Suspend a user
 * POST /api/v1/admin/users/{id}/suspend
 */
export async function suspendUser(
  userId: string, 
  data: SuspendUserRequest
): Promise<ApiResponse<null>> {
  return apiClient<ApiResponse<null>>(`/api/v1/admin/users/${userId}/suspend`, {
    method: "POST",
    body: JSON.stringify(data),
  })
}

/**
 * Reactivate a suspended user
 * POST /api/v1/admin/users/{id}/reactivate
 */
export async function reactivateUser(userId: string): Promise<ApiResponse<User>> {
  return apiClient<ApiResponse<User>>(`/api/v1/admin/users/${userId}/reactivate`, {
    method: "POST",
  })
}

// ===== FILE: lib\api\auth.ts =====

// ===== FILE: lib/api/auth.ts =====
// Updated auth API with invite-only registration support

import { apiClient, setTokens, clearTokens } from "./client"
import type {
  ApiResponse,
  AuthResponse,
  LoginCredentials,
  RegisterCredentials,
  RegistrationCheckResponse,
  VerifyEmailResponse,
  LoginErrorResponse,
} from "@/types"

const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8080"

// ===== Registration Check =====

/**
 * Check if registration is available for an invite token
 * GET /api/v1/auth/registration/check?inviteToken={token}
 */
export async function checkRegistration(inviteToken: string): Promise<RegistrationCheckResponse> {
  const response = await fetch(
    `${API_BASE_URL}/api/v1/auth/registration/check?inviteToken=${encodeURIComponent(inviteToken)}`,
    {
      method: "GET",
      headers: { "Content-Type": "application/json" },
    }
  )
  return response.json()
}

// ===== Login =====

/**
 * Login with email and password
 * Returns tokens only for ACTIVE accounts
 * Returns 403 with accountNotActive for non-ACTIVE accounts
 */
export async function login(credentials: LoginCredentials): Promise<ApiResponse<AuthResponse> | LoginErrorResponse> {
  const response = await fetch(`${API_BASE_URL}/api/v1/auth/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(credentials),
  })

  const data = await response.json()

  // Handle 403 - account not active
  if (response.status === 403 && data.accountNotActive) {
    return data as LoginErrorResponse
  }

  // Successful login - store tokens
  if (data.success && data.data?.accessToken && data.data?.refreshToken) {
    setTokens(data.data.accessToken, data.data.refreshToken)
  }

  return data as ApiResponse<AuthResponse>
}

// ===== Registration =====

/**
 * Register a new user with invite token
 * POST /api/v1/auth/register
 * 
 * NOTE: Registration no longer returns tokens
 * User must verify email and wait for admin approval
 */
export async function register(credentials: RegisterCredentials): Promise<ApiResponse<AuthResponse>> {
  const response = await fetch(`${API_BASE_URL}/api/v1/auth/register`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(credentials),
  })

  return response.json()
  // NOTE: We do NOT set tokens here because user cannot login until approved
}

// ===== Logout =====

export function logout() {
  clearTokens()
}

// ===== Email Verification =====

/**
 * Verify email with token
 * GET /api/v1/auth/verify-email?token={token}
 * 
 * Returns accountStatus which may be:
 * - ACTIVE (if auto-activate is enabled)
 * - PENDING_APPROVAL (waiting for admin)
 */
export async function verifyEmail(token: string): Promise<VerifyEmailResponse> {
  const response = await fetch(
    `${API_BASE_URL}/api/v1/auth/verify-email?token=${encodeURIComponent(token)}`,
    {
      method: "GET",
      headers: { "Content-Type": "application/json" },
    }
  )
  return response.json()
}

/**
 * Resend verification email
 * POST /api/v1/auth/resend-verification
 */
export async function resendVerification(email: string): Promise<ApiResponse<null>> {
  return apiClient<ApiResponse<null>>("/api/v1/auth/resend-verification", {
    method: "POST",
    body: JSON.stringify({ email }),
  })
}

// ===== Password Reset =====

export async function forgotPassword(email: string): Promise<ApiResponse<null>> {
  const response = await fetch(`${API_BASE_URL}/api/v1/auth/forgot-password`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email }),
  })
  return response.json()
}

export async function validateResetToken(token: string): Promise<ApiResponse<null>> {
  const response = await fetch(
    `${API_BASE_URL}/api/v1/auth/reset-password?token=${encodeURIComponent(token)}`,
    {
      method: "GET",
      headers: { "Content-Type": "application/json" },
    }
  )
  return response.json()
}

export async function resetPassword(token: string, newPassword: string): Promise<ApiResponse<null>> {
  const response = await fetch(`${API_BASE_URL}/api/v1/auth/reset-password`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token, newPassword }),
  })
  return response.json()
}

// ===== FILE: lib\api\client.ts =====

import type { ApiResponse, AuthResponse } from "@/types"

const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8080"

// Token management
let accessToken: string | null = null
let refreshToken: string | null = null

export function setTokens(access: string, refresh: string) {
  accessToken = access
  refreshToken = refresh
  if (typeof window !== "undefined") {
    localStorage.setItem("accessToken", access)
    localStorage.setItem("refreshToken", refresh)
  }
}

export function getTokens() {
  if (typeof window !== "undefined" && !accessToken) {
    accessToken = localStorage.getItem("accessToken")
    refreshToken = localStorage.getItem("refreshToken")
  }
  return { accessToken, refreshToken }
}

export function clearTokens() {
  accessToken = null
  refreshToken = null
  if (typeof window !== "undefined") {
    localStorage.removeItem("accessToken")
    localStorage.removeItem("refreshToken")
  }
}

// Decode JWT without library
export function decodeToken(token: string): Record<string, unknown> | null {
  try {
    const base64Url = token.split(".")[1]
    const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/")
    const jsonPayload = decodeURIComponent(
      atob(base64)
        .split("")
        .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
        .join(""),
    )
    return JSON.parse(jsonPayload)
  } catch {
    return null
  }
}

export function isTokenExpired(token: string): boolean {
  const decoded = decodeToken(token)
  if (!decoded || typeof decoded.exp !== "number") return true
  return decoded.exp * 1000 < Date.now()
}

// Refresh token
async function refreshAccessToken(): Promise<boolean> {
  const { refreshToken: refresh } = getTokens()
  if (!refresh) return false

  try {
    const response = await fetch(`${API_BASE_URL}/api/v1/auth/refresh`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ refreshToken: refresh }),
    })

    if (!response.ok) {
      clearTokens()
      return false
    }

    const data: ApiResponse<AuthResponse> = await response.json()
    if (data.success && data.data) {
      setTokens(data.data.accessToken, data.data.refreshToken)
      return true
    }
    return false
  } catch {
    clearTokens()
    return false
  }
}

// Main API client
export async function apiClient<T>(endpoint: string, options: RequestInit = {}): Promise<T> {
  const { accessToken: token } = getTokens()

  // Check if token is expired and refresh if needed
  if (token && isTokenExpired(token)) {
    const refreshed = await refreshAccessToken()
    if (!refreshed) {
      throw new Error("Session expired. Please login again.")
    }
  }

  const { accessToken: currentToken } = getTokens()

  const headers: Record<string, string> = {
    "Content-Type": "application/json",
    ...(options.headers as Record<string, string>),
  }

  if (currentToken) {
    headers["Authorization"] = `Bearer ${currentToken}`
  }

  const response = await fetch(`${API_BASE_URL}${endpoint}`, {
    ...options,
    headers,
  })

  // Handle 401 - try refresh once
  if (response.status === 401 && currentToken) {
    const refreshed = await refreshAccessToken()
    if (refreshed) {
      const { accessToken: newToken } = getTokens()
      headers["Authorization"] = `Bearer ${newToken}`
      const retryResponse = await fetch(`${API_BASE_URL}${endpoint}`, {
        ...options,
        headers,
      })
      return retryResponse.json()
    }
    clearTokens()
    throw new Error("Session expired. Please login again.")
  }

  return response.json()
}

// ===== FILE: lib\api\dashboard.ts =====

import { apiClient } from "./client"
import type { PaginatedResponse } from "@/types"

// Dashboard Types
export interface TrendInfo {
  value: number
  isPositive: boolean
  period: string
}

export interface DashboardStats {
  totalUsers: number
  activeUsers: number
  totalRoles: number
  pendingVerifications: number
  usersTrend: TrendInfo | null
  activeUsersTrend: TrendInfo | null
  verificationsTrend: TrendInfo | null
  totalPermissions: number
  lockedUsers: number
  deletedUsers: number
  loginsToday: number
  failedLoginsToday: number
  activityByType: Record<string, number>
  generatedAt: string
}

export interface ActivityUser {
  firstName: string
  lastName: string
}

export interface ActivityItem {
  id: number
  user: ActivityUser
  action: string
  target: string
  role: string
  timestamp: string
  actionType: string
  targetType?: string
  targetId?: number
}

export interface DashboardSummary {
  stats: DashboardStats
  recentActivity: ActivityItem[]
}

// API Functions

export async function getDashboardStats(): Promise<DashboardStats> {
  const response = await apiClient<{ success: boolean; data: DashboardStats }>("/api/v1/dashboard/stats")
  return response.data
}

export async function getRecentActivity(limit: number = 10): Promise<ActivityItem[]> {
  const response = await apiClient<{ success: boolean; data: ActivityItem[] }>(
    `/api/v1/dashboard/activity?limit=${limit}`
  )
  return response.data
}

export async function getDashboardSummary(activityLimit: number = 10): Promise<DashboardSummary> {
  const response = await apiClient<{ success: boolean; stats: DashboardStats; recentActivity: ActivityItem[] }>(
    `/api/v1/dashboard/summary?activityLimit=${activityLimit}`
  )
  return {
    stats: response.stats,
    recentActivity: response.recentActivity,
  }
}

export async function getAllActivities(
  page: number = 0,
  size: number = 20
): Promise<PaginatedResponse<ActivityItem>> {
  const response = await apiClient<{ success: boolean; data: PaginatedResponse<ActivityItem> }>(
    `/api/v1/dashboard/activity/all?page=${page}&size=${size}`
  )
  return response.data
}

export async function getUserActivities(
  userId: number,
  page: number = 0,
  size: number = 20
): Promise<PaginatedResponse<ActivityItem>> {
  const response = await apiClient<{ success: boolean; data: PaginatedResponse<ActivityItem> }>(
    `/api/v1/dashboard/activity/user/${userId}?page=${page}&size=${size}`
  )
  return response.data
}

// ===== FILE: lib\api\password.ts =====

import { apiClient } from "./client"
import type { ApiResponse } from "@/types"

// ============================================
// Types
// ============================================

export interface ForgotPasswordRequest {
  email: string
}

export interface ResetPasswordRequest {
  token: string
  newPassword: string
}

export interface ChangePasswordRequest {
  currentPassword: string
  newPassword: string
}

export interface ValidateResetTokenResponse {
  valid: boolean
}

// ============================================
// Password Reset Flow (Unauthenticated)
// ============================================

/**
 * Initiate password reset - sends email with reset link
 * POST /api/v1/auth/forgot-password
 */
export async function forgotPassword(email: string): Promise<ApiResponse<null>> {
  return apiClient<ApiResponse<null>>("/api/v1/auth/forgot-password", {
    method: "POST",
    body: JSON.stringify({ email } satisfies ForgotPasswordRequest),
  })
}

/**
 * Validate reset token before showing reset form
 * GET /api/v1/auth/reset-password?token=xxx
 */
export async function validateResetToken(token: string): Promise<ApiResponse<null>> {
  return apiClient<ApiResponse<null>>(`/api/v1/auth/reset-password?token=${encodeURIComponent(token)}`)
}

/**
 * Reset password using token from email
 * POST /api/v1/auth/reset-password
 */
export async function resetPassword(token: string, newPassword: string): Promise<ApiResponse<null>> {
  return apiClient<ApiResponse<null>>("/api/v1/auth/reset-password", {
    method: "POST",
    body: JSON.stringify({ token, newPassword } satisfies ResetPasswordRequest),
  })
}

// ============================================
// Change Password (Authenticated)
// ============================================

/**
 * Change password for authenticated user
 * POST /api/v1/users/me/password
 * 
 * NOTE: This endpoint needs to be implemented in the backend.
 * See the companion Java code below.
 */
export async function changePassword(
  currentPassword: string,
  newPassword: string
): Promise<ApiResponse<null>> {
  return apiClient<ApiResponse<null>>("/api/v1/users/me/password", {
    method: "POST",
    body: JSON.stringify({ currentPassword, newPassword } satisfies ChangePasswordRequest),
  })
}

// ============================================
// Helper function for profile page
// ============================================

/**
 * Wrapper that handles the password change with proper error handling
 */
export async function handlePasswordChange(
  currentPassword: string,
  newPassword: string
): Promise<{ success: boolean; message: string }> {
  try {
    const response = await changePassword(currentPassword, newPassword)
    return {
      success: response.success,
      message: response.message || "Password updated successfully",
    }
  } catch (error) {
    const message = error instanceof Error ? error.message : "Failed to update password"
    return {
      success: false,
      message,
    }
  }
}

// ===== FILE: lib\api\roles.ts =====

import { apiClient } from "./client"
import type { ApiResponse, Role, CreateRoleRequest, UpdateRoleRequest, AssignRoleRequest } from "@/types"

export async function getRoles(): Promise<Role[]> {
  return apiClient<Role[]>("/api/v1/rbac/roles")
}

export async function getRoleById(id: number): Promise<Role> {
  return apiClient<Role>(`/api/v1/rbac/roles/${id}`)
}

export async function createRole(data: CreateRoleRequest): Promise<ApiResponse<Role>> {
  return apiClient<ApiResponse<Role>>("/api/v1/rbac/roles", {
    method: "POST",
    body: JSON.stringify(data),
  })
}

export async function updateRole(id: number, data: UpdateRoleRequest): Promise<ApiResponse<Role>> {
  return apiClient<ApiResponse<Role>>(`/api/v1/rbac/roles/${id}`, {
    method: "PUT",
    body: JSON.stringify(data),
  })
}

export async function deleteRole(id: number): Promise<ApiResponse<null>> {
  return apiClient<ApiResponse<null>>(`/api/v1/rbac/roles/${id}`, {
    method: "DELETE",
  })
}

export async function assignRole(data: AssignRoleRequest): Promise<ApiResponse<null>> {
  return apiClient<ApiResponse<null>>("/api/v1/rbac/roles/assign", {
    method: "POST",
    body: JSON.stringify(data),
  })
}

export async function revokeRole(data: AssignRoleRequest): Promise<ApiResponse<null>> {
  return apiClient<ApiResponse<null>>("/api/v1/rbac/roles/revoke", {
    method: "POST",
    body: JSON.stringify(data),
  })
}

export async function getUserRoles(userId: number): Promise<string[]> {
  return apiClient<string[]>(`/api/v1/rbac/roles/user/${userId}`)
}

export async function getRolePermissions(roleId: number): Promise<string[]> {
  return apiClient<string[]>(`/api/v1/rbac/roles/${roleId}/permissions`)
}

// ===== FILE: lib\api\users.ts =====

// ===== FILE: lib/api/users.ts =====
// Updated users API with restore and deleted users support

import { apiClient } from "./client"
import type { ApiResponse, User, UpdateUserRequest, PaginatedResponse, AccountStatus } from "@/types"

/**
 * Get users with optional filtering by status
 * Soft-deleted users are automatically excluded by the backend
 */
export async function getUsers(
  page = 0,
  size = 10,
  status?: AccountStatus
): Promise<PaginatedResponse<User>> {
  const params = new URLSearchParams({
    page: page.toString(),
    size: size.toString(),
  })

  if (status) {
    params.append("status", status)
  }

  return apiClient<PaginatedResponse<User>>(`/api/v1/users?${params.toString()}`)
}

/**
 * Get only soft-deleted users (SUPERADMIN only)
 */
export async function getDeletedUsers(
  page = 0,
  size = 10
): Promise<PaginatedResponse<User>> {
  return apiClient<PaginatedResponse<User>>(`/api/v1/users/deleted?page=${page}&size=${size}`)
}

/**
 * Restore a soft-deleted user (SUPERADMIN only)
 */
export async function restoreUser(id: string): Promise<ApiResponse<User>> {
  return apiClient<ApiResponse<User>>(`/api/v1/users/deleted/${id}/restore`, {
    method: "POST",
  })
}

/**
 * Permanently delete a user (SUPERADMIN only)
 * User must already be soft-deleted first
 */
export async function permanentlyDeleteUser(id: string): Promise<ApiResponse<null>> {
  return apiClient<ApiResponse<null>>(`/api/v1/users/deleted/${id}/permanent`, {
    method: "DELETE",
  })
}

/**
 * Get user by ID
 */
export async function getUserById(id: string): Promise<User> {
  return apiClient<User>(`/api/v1/users/${id}`)
}

/**
 * Update user
 */
export async function updateUser(id: string, data: UpdateUserRequest): Promise<ApiResponse<User>> {
  return apiClient<ApiResponse<User>>(`/api/v1/users/${id}`, {
    method: "PUT",
    body: JSON.stringify(data),
  })
}

/**
 * Soft delete user
 */
export async function deleteUser(id: string): Promise<ApiResponse<null>> {
  return apiClient<ApiResponse<null>>(`/api/v1/users/${id}`, {
    method: "DELETE",
  })
}

/**
 * Get current authenticated user
 */
export async function getCurrentUser(): Promise<User> {
  return apiClient<User>("/api/v1/users/me")
}

/**
 * Get current user's permissions
 */
export async function getCurrentUserPermissions(): Promise<{
  permissions: string[]
}> {
  return apiClient<{ permissions: string[] }>("/api/v1/users/me/permissions")
}

// ===== FILE: lib\api\business\client.ts =====

// lib/api/business/client.ts

import { apiClient as baseApiClient } from "../client"
import type { BusinessApiResponse } from "@/lib/types/business"

// Preserve the existing export so your current POST/PUT/DELETE calls keep working
export const apiClient = baseApiClient

/**
 * Business API helper: unwraps { success, data, message } and returns data.
 * Throws on success=false, or if data is missing.
 */
export async function businessApiClient<T>(endpoint: string, options?: RequestInit): Promise<T> {
  const res = await baseApiClient<BusinessApiResponse<T>>(endpoint, options)

  if (!res || res.success !== true) {
    throw new Error(res?.message ?? "Business API request failed")
  }

  if (typeof res.data === "undefined") {
    throw new Error("Business API response was successful but contained no data")
  }

  return res.data
}

// ===== FILE: lib\api\business\clients.ts =====

// ===== Business Clients API =====

import { apiClient } from "../client"
import type {
  Client,
  LegalType,
  CreateClientRequest,
  UpdateClientRequest,
  BusinessPaginatedResponse,
  BusinessApiResponse,
  ClientStatus,
} from "@/lib/types/business"
import { businessApiClient } from "./client"

const BASE_PATH = "/api/v1/business/clients"

/**
 * Get clients with optional filtering
 */
export async function getClients(
  page = 0,
  size = 20,
  status?: ClientStatus,
  search?: string,
  legalTypeId?: string,
): Promise<BusinessPaginatedResponse<Client>> {
  const params = new URLSearchParams({
    page: page.toString(),
    size: size.toString(),
  })

  if (status) params.append("status", status)
  if (search) params.append("search", search)
  if (legalTypeId) params.append("legalTypeId", legalTypeId)

   return businessApiClient<BusinessPaginatedResponse<Client>>(`${BASE_PATH}?${params.toString()}`)
}

/**
 * Get client by ID
 */
export async function getClientById(id: string): Promise<Client> {
  return businessApiClient<Client>(`${BASE_PATH}/${id}`)
}

/**
 * Create a new client
 */
export async function createClient(data: CreateClientRequest): Promise<BusinessApiResponse<Client>> {
  return apiClient<BusinessApiResponse<Client>>(BASE_PATH, {
    method: "POST",
    body: JSON.stringify(data),
  })
}

/**
 * Update a client
 */
export async function updateClient(id: string, data: UpdateClientRequest): Promise<BusinessApiResponse<Client>> {
  return apiClient<BusinessApiResponse<Client>>(`${BASE_PATH}/${id}`, {
    method: "PUT",
    body: JSON.stringify(data),
  })
}

/**
 * Delete (soft delete/deactivate) a client
 */
export async function deleteClient(id: string): Promise<BusinessApiResponse<null>> {
  return apiClient<BusinessApiResponse<null>>(`${BASE_PATH}/${id}`, {
    method: "DELETE",
  })
}

/**
 * Get all legal types
 */
export async function getLegalTypes(): Promise<LegalType[]> {
  return businessApiClient<LegalType[]>(`${BASE_PATH}/legal-types`)
}

/**
 * Get client statistics
 */
export async function getClientStats(): Promise<{
  total: number
  active: number
  inactive: number
  suspended: number
}> {
return businessApiClient(`${BASE_PATH}/stats`)
}

// ===== FILE: lib\api\business\contracts.ts =====

// ===== Business Contracts API =====

import { apiClient } from "../client"
import type {
  Contract,
  ContractLine,
  CreateContractRequest,
  UpdateContractRequest,
  CreateContractLineRequest,
  BusinessPaginatedResponse,
  BusinessApiResponse,
  ContractStatus,
} from "@/lib/types/business"
import { businessApiClient } from "./client"

const BASE_PATH = "/api/v1/business/contracts"

/**
 * Get contracts with optional filtering
 */
export async function getContracts(
  page = 0,
  size = 20,
  clientId?: string,
  status?: ContractStatus,
): Promise<BusinessPaginatedResponse<Contract>> {
  const params = new URLSearchParams({
    page: page.toString(),
    size: size.toString(),
  })

  if (clientId) params.append("clientId", clientId)
  if (status) params.append("status", status)

  return businessApiClient<BusinessPaginatedResponse<Contract>>(`${BASE_PATH}?${params.toString()}`)
}

/**
 * Get contract by ID
 */
export async function getContractById(id: string): Promise<Contract> {
  return businessApiClient<Contract>(`${BASE_PATH}/${id}`)
}

/**
 * Create a new contract
 */
export async function createContract(data: CreateContractRequest): Promise<BusinessApiResponse<Contract>> {
  return apiClient<BusinessApiResponse<Contract>>(BASE_PATH, {
    method: "POST",
    body: JSON.stringify(data),
  })
}

/**
 * Update a contract
 */
export async function updateContract(id: string, data: UpdateContractRequest): Promise<BusinessApiResponse<Contract>> {
  return apiClient<BusinessApiResponse<Contract>>(`${BASE_PATH}/${id}`, {
    method: "PUT",
    body: JSON.stringify(data),
  })
}

/**
 * Activate a draft contract
 */
export async function activateContract(id: string): Promise<BusinessApiResponse<Contract>> {
  return apiClient<BusinessApiResponse<Contract>>(`${BASE_PATH}/${id}/activate`, {
    method: "POST",
  })
}

/**
 * Suspend an active contract
 */
export async function suspendContract(id: string): Promise<BusinessApiResponse<Contract>> {
  return apiClient<BusinessApiResponse<Contract>>(`${BASE_PATH}/${id}/suspend`, {
    method: "POST",
  })
}

/**
 * Terminate a contract
 */
export async function terminateContract(id: string): Promise<BusinessApiResponse<Contract>> {
  return apiClient<BusinessApiResponse<Contract>>(`${BASE_PATH}/${id}/terminate`, {
    method: "POST",
  })
}

/**
 * Add a line to a contract
 */
export async function addContractLine(
  contractId: string,
  data: CreateContractLineRequest,
): Promise<BusinessApiResponse<ContractLine>> {
  return apiClient<BusinessApiResponse<ContractLine>>(`${BASE_PATH}/${contractId}/lines`, {
    method: "POST",
    body: JSON.stringify(data),
  })
}

/**
 * Remove a line from a contract
 */
export async function removeContractLine(contractId: string, lineId: string): Promise<BusinessApiResponse<null>> {
  return apiClient<BusinessApiResponse<null>>(`${BASE_PATH}/${contractId}/lines/${lineId}`, {
    method: "DELETE",
  })
}

/**
 * Get contract statistics
 */
export async function getContractStats(): Promise<{
  total: number
  active: number
  draft: number
  expiringSoon: number
}> {
return businessApiClient(`${BASE_PATH}/stats`)
}

// ===== FILE: lib\api\business\dashboard.ts =====

// ===== Business Dashboard API =====

import { apiClient } from "../client"
import type { BusinessDashboardStats, RevenueDataPoint } from "@/lib/types/business"
import { businessApiClient } from "./client"

const BASE_PATH = "/api/v1/business/dashboard"

/**
 * Get dashboard summary statistics
 */
export async function getDashboardStats(): Promise<BusinessDashboardStats> {
  return businessApiClient<BusinessDashboardStats>(`${BASE_PATH}/stats`)
}

/**
 * Get revenue data for chart (last 12 months)
 */
export async function getRevenueData(): Promise<RevenueDataPoint[]> {
  return businessApiClient<RevenueDataPoint[]>(`${BASE_PATH}/revenue`)
}

// ===== FILE: lib\api\business\index.ts =====

// ===== Business API Barrel Export =====

export * from "./clients"
export * from "./services"
export * from "./pricing"
export * from "./contracts"
export * from "./invoices"
export * from "./payments"
export * from "./receipts"
export * from "./dashboard"

// ===== FILE: lib\api\business\invoices.ts =====

// ===== Business Invoices API =====

import { apiClient } from "../client"
import type {
  Invoice,
  CreateInvoiceRequest,
  CancelInvoiceRequest,
  BusinessPaginatedResponse,
  BusinessApiResponse,
  InvoiceStatus,
} from "@/lib/types/business"
import { businessApiClient } from "./client"

const BASE_PATH = "/api/v1/business/invoices"

/**
 * Get invoices with optional filtering
 */
export async function getInvoices(
  page = 0,
  size = 20,
  clientId?: string,
  status?: InvoiceStatus,
  overdue?: boolean,
): Promise<BusinessPaginatedResponse<Invoice>> {
  const params = new URLSearchParams({
    page: page.toString(),
    size: size.toString(),
  })

  if (clientId) params.append("clientId", clientId)
  if (status) params.append("status", status)
  if (overdue !== undefined) params.append("overdue", String(overdue))

  return businessApiClient<BusinessPaginatedResponse<Invoice>>(`${BASE_PATH}?${params.toString()}`)
}

/**
 * Get invoice by ID
 */
export async function getInvoiceById(id: string): Promise<Invoice> {
  return businessApiClient<Invoice>(`${BASE_PATH}/${id}`)
}

/**
 * Create a new invoice
 */
export async function createInvoice(data: CreateInvoiceRequest): Promise<BusinessApiResponse<Invoice>> {
  return apiClient<BusinessApiResponse<Invoice>>(BASE_PATH, {
    method: "POST",
    body: JSON.stringify(data),
  })
}

/**
 * Create invoice from contract
 */
export async function createInvoiceFromContract(contractId: string): Promise<BusinessApiResponse<Invoice>> {
  return apiClient<BusinessApiResponse<Invoice>>(`${BASE_PATH}/from-contract/${contractId}`, {
    method: "POST",
  })
}

/**
 * Issue an invoice (assigns NCF)
 */
export async function issueInvoice(id: string): Promise<BusinessApiResponse<Invoice>> {
  return apiClient<BusinessApiResponse<Invoice>>(`${BASE_PATH}/${id}/issue`, {
    method: "POST",
  })
}

/**
 * Cancel an invoice
 */
export async function cancelInvoice(id: string, data: CancelInvoiceRequest): Promise<BusinessApiResponse<Invoice>> {
  return apiClient<BusinessApiResponse<Invoice>>(`${BASE_PATH}/${id}/cancel`, {
    method: "POST",
    body: JSON.stringify(data),
  })
}

/**
 * Get invoice statistics
 */
export async function getInvoiceStats(): Promise<{
  draft: number
  issued: number
  partial: number
  paid: number
  overdue: number
  totalReceivables: number
}> {
  return apiClient<{
    draft: number
    issued: number
    partial: number
    paid: number
    overdue: number
    totalReceivables: number
  }>(`${BASE_PATH}/stats`)
}

// ===== FILE: lib\api\business\payments.ts =====

// ===== Business Payments API =====

import { apiClient } from "../client"
import type {
  Payment,
  PaymentType,
  RecordPaymentRequest,
  CreatePaymentTypeRequest,
  PaymentAllocationRequest,
  BusinessPaginatedResponse,
  BusinessApiResponse,
} from "@/lib/types/business"

const BASE_PATH = "/api/v1/business/payments"

/**
 * Get payments with optional filtering
 */
export async function getPayments(page = 0, size = 20, clientId?: string): Promise<BusinessPaginatedResponse<Payment>> {
  const params = new URLSearchParams({
    page: page.toString(),
    size: size.toString(),
  })

  if (clientId) params.append("clientId", clientId)

  return apiClient<BusinessPaginatedResponse<Payment>>(`${BASE_PATH}?${params.toString()}`)
}

/**
 * Get payment by ID
 */
export async function getPaymentById(id: string): Promise<Payment> {
  return apiClient<Payment>(`${BASE_PATH}/${id}`)
}

/**
 * Record a new payment
 */
export async function recordPayment(data: RecordPaymentRequest): Promise<BusinessApiResponse<Payment>> {
  return apiClient<BusinessApiResponse<Payment>>(BASE_PATH, {
    method: "POST",
    body: JSON.stringify(data),
  })
}

/**
 * Allocate payment to invoices
 */
export async function allocatePayment(
  id: string,
  allocations: PaymentAllocationRequest[],
): Promise<BusinessApiResponse<Payment>> {
  return apiClient<BusinessApiResponse<Payment>>(`${BASE_PATH}/${id}/allocate`, {
    method: "POST",
    body: JSON.stringify({ allocations }),
  })
}

// ===== Payment Types =====

/**
 * Get all payment types
 */
export async function getPaymentTypes(): Promise<PaymentType[]> {
  return apiClient<PaymentType[]>(`${BASE_PATH}/types`)
}

/**
 * Create a new payment type
 */
export async function createPaymentType(data: CreatePaymentTypeRequest): Promise<BusinessApiResponse<PaymentType>> {
  return apiClient<BusinessApiResponse<PaymentType>>(`${BASE_PATH}/types`, {
    method: "POST",
    body: JSON.stringify(data),
  })
}

/**
 * Update a payment type
 */
export async function updatePaymentType(
  id: string,
  data: Partial<CreatePaymentTypeRequest>,
): Promise<BusinessApiResponse<PaymentType>> {
  return apiClient<BusinessApiResponse<PaymentType>>(`${BASE_PATH}/types/${id}`, {
    method: "PUT",
    body: JSON.stringify(data),
  })
}

/**
 * Delete (deactivate) a payment type
 */
export async function deletePaymentType(id: string): Promise<BusinessApiResponse<null>> {
  return apiClient<BusinessApiResponse<null>>(`${BASE_PATH}/types/${id}`, {
    method: "DELETE",
  })
}

/**
 * Get payment statistics
 */
export async function getPaymentStats(): Promise<{
  totalReceived: number
  fullyAllocated: number
  unallocated: number
}> {
  return apiClient<{
    totalReceived: number
    fullyAllocated: number
    unallocated: number
  }>(`${BASE_PATH}/stats`)
}

// ===== FILE: lib\api\business\pricing.ts =====

// ===== Business Pricing API =====

import { apiClient } from "../client"
import type {
  GlobalServicePrice,
  ClientServicePrice,
  ResolvedPrice,
  SetGlobalPriceRequest,
  SetClientPriceRequest,
  BusinessApiResponse,
} from "@/lib/types/business"
import { businessApiClient } from "./client"

const BASE_PATH = "/api/v1/business/pricing"

// ===== Global Prices =====

/**
 * Set global price for a service
 */
export async function setGlobalPrice(data: SetGlobalPriceRequest): Promise<BusinessApiResponse<GlobalServicePrice>> {
  return apiClient<BusinessApiResponse<GlobalServicePrice>>(`${BASE_PATH}/global`, {
    method: "POST",
    body: JSON.stringify(data),
  })
}

/**
 * Get current global price for a service
 */
export async function getGlobalPrice(serviceId: string): Promise<GlobalServicePrice | null> {
  return apiClient<GlobalServicePrice | null>(`${BASE_PATH}/global/${serviceId}`)
}

/**
 * Get global price history for a service
 */
export async function getGlobalPriceHistory(serviceId: string): Promise<GlobalServicePrice[]> {
  return apiClient<GlobalServicePrice[]>(`${BASE_PATH}/global/${serviceId}/history`)
}

/**
 * Get all current global prices
 */
export async function getAllGlobalPrices(): Promise<GlobalServicePrice[]> {
  return businessApiClient<GlobalServicePrice[]>(`${BASE_PATH}/global`)
}

// ===== Client Prices =====

/**
 * Set client-specific price for a service
 */
export async function setClientPrice(data: SetClientPriceRequest): Promise<BusinessApiResponse<ClientServicePrice>> {
  return apiClient<BusinessApiResponse<ClientServicePrice>>(`${BASE_PATH}/client`, {
    method: "POST",
    body: JSON.stringify(data),
  })
}

/**
 * Get client-specific price for a service
 */
export async function getClientPrice(serviceId: string, clientId: string): Promise<ClientServicePrice | null> {
  return apiClient<ClientServicePrice | null>(`${BASE_PATH}/client/${serviceId}/${clientId}`)
}

/**
 * Get all client-specific prices for a client
 */
export async function getClientPrices(clientId: string): Promise<ClientServicePrice[]> {
 return businessApiClient<ClientServicePrice[]>(`${BASE_PATH}/client/${clientId}/all`)
}

/**
 * Delete client-specific price
 */
export async function deleteClientPrice(id: string): Promise<BusinessApiResponse<null>> {
  return apiClient<BusinessApiResponse<null>>(`${BASE_PATH}/client/${id}`, {
    method: "DELETE",
  })
}

// ===== Price Resolution =====

/**
 * Resolve the effective price for a service and client
 */
export async function resolvePrice(serviceId: string, clientId: string): Promise<ResolvedPrice> {
  const params = new URLSearchParams({ serviceId, clientId })
  return businessApiClient<ResolvedPrice>(`${BASE_PATH}/resolve?${params.toString()}`)
}

// ===== FILE: lib\api\business\receipts.ts =====

// ===== Business Receipts API =====

import { apiClient } from "../client"
import type { Receipt, VoidReceiptRequest, BusinessApiResponse } from "@/lib/types/business"
import { businessApiClient } from "./client"

const BASE_PATH = "/api/v1/business/receipts"

/**
 * Get receipt by ID
 */
export async function getReceiptById(id: string): Promise<Receipt> {
  return businessApiClient<Receipt>(`${BASE_PATH}/${id}`)
}

/**
 * Get receipt by payment ID
 */
export async function getReceiptByPayment(paymentId: string): Promise<Receipt | null> {
  return businessApiClient<Receipt | null>(`${BASE_PATH}/by-payment/${paymentId}`)
}

/**
 * Void a receipt
 */
export async function voidReceipt(id: string, data: VoidReceiptRequest): Promise<BusinessApiResponse<Receipt>> {
  return apiClient<BusinessApiResponse<Receipt>>(`${BASE_PATH}/${id}/void`, {
    method: "POST",
    body: JSON.stringify(data),
  })
}

// ===== FILE: lib\api\business\services.ts =====

// ===== Business Services API =====

import { apiClient } from "../client"
import type {
  ServiceCatalog,
  BillingUnit,
  CreateServiceRequest,
  UpdateServiceRequest,
  BusinessApiResponse,
} from "@/lib/types/business"
import { businessApiClient } from "./client"

const BASE_PATH = "/api/v1/business/services"

/**
 * Get all services
 */
export async function getServices(activeOnly = true): Promise<ServiceCatalog[]> {
  const params = new URLSearchParams()
  if (activeOnly) params.append("activeOnly", "true")

  return businessApiClient<ServiceCatalog[]>(`${BASE_PATH}?${params.toString()}`)
}

/**
 * Get service by ID
 */
export async function getServiceById(id: string): Promise<ServiceCatalog> {
  return businessApiClient<ServiceCatalog>(`${BASE_PATH}/${id}`)
}

/**
 * Create a new service
 */
export async function createService(data: CreateServiceRequest): Promise<BusinessApiResponse<ServiceCatalog>> {
  return apiClient<BusinessApiResponse<ServiceCatalog>>(BASE_PATH, {
    method: "POST",
    body: JSON.stringify(data),
  })
}

/**
 * Update a service
 */
export async function updateService(
  id: string,
  data: UpdateServiceRequest,
): Promise<BusinessApiResponse<ServiceCatalog>> {
  return apiClient<BusinessApiResponse<ServiceCatalog>>(`${BASE_PATH}/${id}`, {
    method: "PUT",
    body: JSON.stringify(data),
  })
}

/**
 * Delete (deactivate) a service
 */
export async function deleteService(id: string): Promise<BusinessApiResponse<null>> {
  return apiClient<BusinessApiResponse<null>>(`${BASE_PATH}/${id}`, {
    method: "DELETE",
  })
}

/**
 * Get all billing units
 */
export async function getBillingUnits(): Promise<BillingUnit[]> {
  return businessApiClient<BillingUnit[]>(`${BASE_PATH}/billing-units`)
}

// ===== FILE: lib\store\auth-store.ts =====

// ===== FILE: lib/store/auth-store.ts =====
// Updated auth store with account status handling

import { create } from "zustand"
import { persist } from "zustand/middleware"
import type { User, LoginCredentials, RegisterCredentials, AccountStatus, LoginErrorResponse } from "@/types"
import * as authApi from "@/lib/api/auth"
import * as usersApi from "@/lib/api/users"
import { getTokens, isTokenExpired } from "@/lib/api/client"

interface LoginResult {
  success: boolean
  accountNotActive?: boolean
  accountStatus?: AccountStatus
  message?: string
}

interface RegisterResult {
  success: boolean
  accountStatus?: AccountStatus
  message?: string
}

interface AuthStore {
  user: User | null
  permissions: string[]
  isAuthenticated: boolean
  isLoading: boolean
  error: string | null
  
  // Account status for login errors
  loginAccountStatus: AccountStatus | null

  // Actions
  login: (credentials: LoginCredentials) => Promise<LoginResult>
  register: (credentials: RegisterCredentials) => Promise<RegisterResult>
  logout: () => void
  refreshAuth: () => Promise<void>
  clearError: () => void
  clearLoginStatus: () => void

  // Permission helpers
  hasPermission: (permission: string) => boolean
  hasRole: (role: string) => boolean
  hasAnyPermission: (permissions: string[]) => boolean
  hasAnyRole: (roles: string[]) => boolean
}

export const useAuthStore = create<AuthStore>()(
  persist(
    (set, get) => ({
      user: null,
      permissions: [],
      isAuthenticated: false,
      isLoading: false,
      error: null,
      loginAccountStatus: null,

      login: async (credentials) => {
        set({ isLoading: true, error: null, loginAccountStatus: null })
        try {
          const response = await authApi.login(credentials)
          
          // Check for account not active error
          if ('accountNotActive' in response && response.accountNotActive) {
            const errorResponse = response as LoginErrorResponse
            set({ 
              error: errorResponse.message, 
              isLoading: false,
              loginAccountStatus: errorResponse.accountStatus || null
            })
            return { 
              success: false, 
              accountNotActive: true,
              accountStatus: errorResponse.accountStatus,
              message: errorResponse.message
            }
          }

          // Successful login
          if ('success' in response && response.success && response.data) {
            // Fetch full user data
            const user = await usersApi.getCurrentUser()
            const permissionsData = await usersApi.getCurrentUserPermissions()

            set({
              user,
              permissions: permissionsData.permissions,
              isAuthenticated: true,
              isLoading: false,
            })
            return { success: true }
          } else {
            const msg = 'message' in response ? response.message : "Login failed"
            set({ error: msg, isLoading: false })
            return { success: false, message: msg }
          }
        } catch (error) {
          const message = error instanceof Error ? error.message : "Login failed"
          set({
            error: message,
            isLoading: false,
          })
          return { success: false, message }
        }
      },

      register: async (credentials) => {
        set({ isLoading: true, error: null })
        try {
          const response = await authApi.register(credentials)
          
          if (response.success) {
            // Registration successful - user needs to verify email
            // Do NOT set authenticated or fetch user data
            set({ isLoading: false })
            return { 
              success: true, 
              accountStatus: response.data?.accountStatus,
              message: response.message
            }
          } else {
            set({ error: response.message, isLoading: false })
            return { success: false, message: response.message }
          }
        } catch (error) {
          const message = error instanceof Error ? error.message : "Registration failed"
          set({
            error: message,
            isLoading: false,
          })
          return { success: false, message }
        }
      },

      logout: () => {
        authApi.logout()
        set({
          user: null,
          permissions: [],
          isAuthenticated: false,
          error: null,
          loginAccountStatus: null,
        })
      },

      refreshAuth: async () => {
        const { accessToken } = getTokens()
        if (!accessToken || isTokenExpired(accessToken)) {
          get().logout()
          return
        }

        try {
          const user = await usersApi.getCurrentUser()
          const permissionsData = await usersApi.getCurrentUserPermissions()
          set({
            user,
            permissions: permissionsData.permissions,
            isAuthenticated: true,
          })
        } catch {
          get().logout()
        }
      },

      clearError: () => set({ error: null }),
      
      clearLoginStatus: () => set({ loginAccountStatus: null }),

      hasPermission: (permission) => {
        const { permissions, user } = get()
        // SUPERADMIN has all permissions
        if (user?.roles.includes("SUPERADMIN")) return true
        return permissions.includes(permission)
      },

      hasRole: (role) => {
        const { user } = get()
        return user?.roles.includes(role) ?? false
      },

      hasAnyPermission: (perms) => {
        const { permissions, user } = get()
        if (user?.roles.includes("SUPERADMIN")) return true
        return perms.some((p) => permissions.includes(p))
      },

      hasAnyRole: (roles) => {
        const { user } = get()
        return roles.some((r) => user?.roles.includes(r))
      },
    }),
    {
      name: "auth-storage",
      partialize: (state) => ({
        user: state.user,
        permissions: state.permissions,
        isAuthenticated: state.isAuthenticated,
      }),
    },
  ),
)

// ===== FILE: lib\types\business.ts =====

// ===== Business Module Types for ASEPRE Private Security Services =====

// Status Enums
export type ClientStatus = "ACTIVE" | "INACTIVE" | "SUSPENDED"
export type ContractStatus = "DRAFT" | "ACTIVE" | "SUSPENDED" | "TERMINATED" | "EXPIRED"
export type InvoiceStatus = "DRAFT" | "ISSUED" | "PARTIAL" | "PAID" | "CANCELLED" | "VOID"
export type PaymentStatus = "PENDING" | "COMPLETED" | "FAILED" | "REFUNDED"
export type PriceSource = "GLOBAL" | "CLIENT" | "MANUAL"
export type BillingFrequency = "WEEKLY" | "BIWEEKLY" | "MONTHLY" | "QUARTERLY" | "ANNUALLY" | "ONE_TIME"
export type ReceiptStatus = "ACTIVE" | "VOID"

// ===== Reference Types =====

export interface LegalType {
  id: string
  code: string
  name: string
  description?: string
  requiresRnc: boolean
  active: boolean
}

export interface BillingUnit {
  id: string
  code: string
  name: string
  description?: string
  active: boolean
}

// ===== Client Types =====

export interface Client {
  id: string
  name: string
  legalName?: string
  legalTypeId: string
  legalTypeCode: string
  legalTypeName: string
  rnc?: string
  primaryEmail?: string
  secondaryEmail?: string
  primaryPhone?: string
  secondaryPhone?: string
  contactPerson?: string
  billingAddressLine1?: string
  billingAddressLine2?: string
  billingCity?: string
  billingProvince?: string
  billingPostalCode?: string
  billingCountry: string
  serviceAddressLine1?: string
  serviceAddressLine2?: string
  serviceCity?: string
  serviceProvince?: string
  servicePostalCode?: string
  serviceCountry?: string
  status: ClientStatus
  notes?: string
  createdAt: string
  updatedAt: string
}

// ===== Service Types =====

export interface ServiceCatalog {
  id: string
  code: string
  name: string
  description?: string
  billingUnitId: string
  billingUnitCode: string
  billingUnitName: string
  itbisApplicable: boolean
  active: boolean
  createdAt: string
}

// ===== Pricing Types =====

export interface GlobalServicePrice {
  id: string
  serviceId: string
  serviceCode: string
  serviceName: string
  price: number
  currency: string
  effectiveFrom: string
  effectiveTo?: string
  active: boolean
  createdAt: string
}

export interface ClientServicePrice {
  id: string
  clientId: string
  clientName: string
  serviceId: string
  serviceCode: string
  serviceName: string
  price: number
  currency: string
  effectiveFrom: string
  effectiveTo?: string
  active: boolean
  createdAt: string
}

export interface ResolvedPrice {
  price: number
  currency: string
  source: PriceSource
  sourceId: string
  serviceId: string
  clientId: string
}

// ===== Contract Types =====

export interface Contract {
  id: string
  contractNumber: string
  clientId: string
  clientName: string
  startDate: string
  endDate?: string
  status: ContractStatus
  terms?: string
  notes?: string
  billingFrequency: BillingFrequency
  billingDayOfMonth?: number
  lines: ContractLine[]
  createdAt: string
  updatedAt: string
}

export interface ContractLine {
  id: string
  serviceId: string
  serviceCode: string
  serviceName: string
  quantity: number
  billingUnitId: string
  billingUnitCode: string
  billingUnitName: string
  unitPrice: number
  currency: string
  priceSource: PriceSource
  priceSourceId?: string
  itbisApplicable: boolean
  scheduleNotes?: string
  active: boolean
  lineTotal: number
}

// ===== Invoice Types =====

export interface Invoice {
  id: string
  invoiceNumber: string
  ncf?: string
  clientId: string
  clientName: string
  clientRnc?: string
  contractId?: string
  contractNumber?: string
  issueDate: string
  dueDate: string
  status: InvoiceStatus
  currency: string
  subtotal: number
  itbisRate: number
  itbisAmount: number
  total: number
  amountPaid: number
  balance: number
  notes?: string
  lines: InvoiceLine[]
  createdAt: string
  cancelledAt?: string
  cancellationReason?: string
}

export interface InvoiceLine {
  id: string
  serviceId?: string
  serviceCode?: string
  serviceName?: string
  contractLineId?: string
  description: string
  quantity: number
  billingUnitId?: string
  billingUnitCode?: string
  unitPrice: number
  lineSubtotal: number
  itbisApplicable: boolean
  itbisAmount: number
  lineTotal: number
  lineOrder: number
}

// ===== Payment Types =====

export interface PaymentType {
  id: string
  code: string
  name: string
  description?: string
  requiresReference: boolean
  active: boolean
}

export interface Payment {
  id: string
  paymentNumber: string
  clientId: string
  clientName: string
  paymentTypeId: string
  paymentTypeCode: string
  paymentTypeName: string
  amount: number
  currency: string
  amountAllocated: number
  amountUnallocated: number
  paymentDate: string
  reference?: string
  notes?: string
  status: PaymentStatus
  allocations: PaymentAllocation[]
  createdAt: string
}

export interface PaymentAllocation {
  id: string
  paymentId: string
  invoiceId: string
  invoiceNumber: string
  amount: number
  createdAt: string
}

export interface Receipt {
  id: string
  receiptNumber: string
  paymentId: string
  paymentNumber: string
  clientId: string
  clientName: string
  amount: number
  currency: string
  receiptDate: string
  status: ReceiptStatus
  voidedAt?: string
  voidReason?: string
}

// ===== Dashboard Types =====

export interface BusinessDashboardStats {
  totalClients: number
  activeClients: number
  activeContracts: number
  pendingInvoices: number
  overdueInvoices: number
  monthlyRevenue: number
  totalReceivables: number
}

export interface RevenueDataPoint {
  month: string
  revenue: number
}

// ===== Request Types =====

export interface CreateClientRequest {
  name: string
  legalName?: string
  legalTypeId: string
  rnc?: string
  primaryEmail?: string
  secondaryEmail?: string
  primaryPhone?: string
  secondaryPhone?: string
  contactPerson?: string
  billingAddressLine1?: string
  billingAddressLine2?: string
  billingCity?: string
  billingProvince?: string
  billingPostalCode?: string
  serviceAddressLine1?: string
  serviceAddressLine2?: string
  serviceCity?: string
  serviceProvince?: string
  servicePostalCode?: string
  notes?: string
}

export interface UpdateClientRequest extends Partial<CreateClientRequest> {
  status?: ClientStatus
}

export interface CreateServiceRequest {
  code: string
  name: string
  description?: string
  billingUnitId: string
  itbisApplicable: boolean
}

export interface UpdateServiceRequest extends Partial<CreateServiceRequest> {
  active?: boolean
}

export interface SetGlobalPriceRequest {
  serviceId: string
  price: number
  effectiveFrom: string
}

export interface SetClientPriceRequest {
  clientId: string
  serviceId: string
  price: number
  effectiveFrom: string
}

export interface CreateContractRequest {
  clientId: string
  startDate: string
  endDate?: string
  terms?: string
  notes?: string
  billingFrequency: BillingFrequency
  billingDayOfMonth?: number
  lines: CreateContractLineRequest[]
}

export interface CreateContractLineRequest {
  serviceId: string
  quantity: number
  billingUnitId?: string
  manualUnitPrice?: number
  itbisApplicable?: boolean
  scheduleNotes?: string
}

export interface UpdateContractRequest {
  startDate?: string
  endDate?: string
  terms?: string
  notes?: string
  billingFrequency?: BillingFrequency
  billingDayOfMonth?: number
}

export interface CreateInvoiceRequest {
  clientId: string
  contractId?: string
  issueDate: string
  dueDate: string
  notes?: string
  lines: CreateInvoiceLineRequest[]
}

export interface CreateInvoiceLineRequest {
  serviceId?: string
  contractLineId?: string
  description: string
  quantity: number
  billingUnitId?: string
  unitPrice: number
  itbisApplicable: boolean
}

export interface RecordPaymentRequest {
  clientId: string
  paymentTypeId: string
  amount: number
  paymentDate: string
  reference?: string
  notes?: string
  allocations?: PaymentAllocationRequest[]
  generateReceipt?: boolean
}

export interface PaymentAllocationRequest {
  invoiceId: string
  amount: number
}

export interface CreatePaymentTypeRequest {
  code: string
  name: string
  description?: string
  requiresReference: boolean
}

export interface CancelInvoiceRequest {
  reason: string
}

export interface VoidReceiptRequest {
  reason: string
}

// ===== Response Types =====

export interface BusinessPaginatedResponse<T> {
  content: T[]
  totalElements: number
  totalPages: number
  size: number
  number: number
  first: boolean
  last: boolean
  empty: boolean
}

export interface BusinessApiResponse<T> {
  success: boolean
  message: string
  data?: T
}

// ===== FILE: lib\utils\business.ts =====

// ===== Business Module Utility Functions =====

import type { ClientStatus, ContractStatus, InvoiceStatus, PaymentStatus, BillingFrequency } from "@/lib/types/business"

// ===== Currency Formatting (Dominican Peso) =====

/**
 * Format amount as Dominican Peso currency
 */
export function formatDOP(amount: number): string {
  return new Intl.NumberFormat("es-DO", {
    style: "currency",
    currency: "DOP",
    minimumFractionDigits: 2,
  }).format(amount)
}

/**
 * Format amount without currency symbol
 */
export function formatAmount(amount: number): string {
  return new Intl.NumberFormat("es-DO", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }).format(amount)
}

// ===== RNC (Dominican Tax ID) Functions =====

/**
 * Validate RNC format (9 or 11 digits)
 */
export function validateRNC(rnc: string): boolean {
  const cleaned = rnc.replace(/[-\s]/g, "")
  return /^[0-9]{9}$|^[0-9]{11}$/.test(cleaned)
}

/**
 * Format RNC for display with dashes
 */
export function formatRNC(rnc: string): string {
  const cleaned = rnc.replace(/[-\s]/g, "")
  if (cleaned.length === 9) {
    return `${cleaned.slice(0, 3)}-${cleaned.slice(3, 8)}-${cleaned.slice(8)}`
  }
  if (cleaned.length === 11) {
    return `${cleaned.slice(0, 3)}-${cleaned.slice(3, 10)}-${cleaned.slice(10)}`
  }
  return cleaned
}

/**
 * Clean RNC for API submission
 */
export function cleanRNC(rnc: string): string {
  return rnc.replace(/[-\s]/g, "")
}

// ===== NCF (Fiscal Number) Functions =====

/**
 * Format NCF for display (e.g., B01-00000089)
 */
export function formatNCF(ncf: string): string {
  if (ncf.length === 11) {
    return `${ncf.slice(0, 3)}-${ncf.slice(3)}`
  }
  if (ncf.length === 13) {
    return `${ncf.slice(0, 3)}-${ncf.slice(3, 5)}-${ncf.slice(5)}`
  }
  return ncf
}

// ===== Date Formatting (Dominican Format) =====

/**
 * Format date as DD/MM/YYYY
 */
export function formatDateDO(date: string | Date): string {
  const d = typeof date === "string" ? new Date(date) : date
  return new Intl.DateTimeFormat("es-DO", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
  }).format(d)
}

/**
 * Format date for API (ISO)
 */
export function formatDateISO(date: Date): string {
  return date.toISOString().split("T")[0]
}

/**
 * Format date with time
 */
export function formatDateTimeDO(date: string | Date): string {
  const d = typeof date === "string" ? new Date(date) : date
  return new Intl.DateTimeFormat("es-DO", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  }).format(d)
}

// ===== Status Color Functions =====

export function getClientStatusColor(status: ClientStatus): string {
  switch (status) {
    case "ACTIVE":
      return "text-emerald-500 bg-emerald-500/10 border-emerald-500/20"
    case "INACTIVE":
      return "text-gray-500 bg-gray-500/10 border-gray-500/20"
    case "SUSPENDED":
      return "text-red-500 bg-red-500/10 border-red-500/20"
    default:
      return "text-gray-500 bg-gray-500/10 border-gray-500/20"
  }
}

export function getContractStatusColor(status: ContractStatus): string {
  switch (status) {
    case "DRAFT":
      return "text-gray-500 bg-gray-500/10 border-gray-500/20"
    case "ACTIVE":
      return "text-emerald-500 bg-emerald-500/10 border-emerald-500/20"
    case "SUSPENDED":
      return "text-amber-500 bg-amber-500/10 border-amber-500/20"
    case "TERMINATED":
      return "text-red-500 bg-red-500/10 border-red-500/20"
    case "EXPIRED":
      return "text-gray-500 bg-gray-500/10 border-gray-500/20"
    default:
      return "text-gray-500 bg-gray-500/10 border-gray-500/20"
  }
}

export function getInvoiceStatusColor(status: InvoiceStatus): string {
  switch (status) {
    case "DRAFT":
      return "text-gray-500 bg-gray-500/10 border-gray-500/20"
    case "ISSUED":
      return "text-blue-500 bg-blue-500/10 border-blue-500/20"
    case "PARTIAL":
      return "text-amber-500 bg-amber-500/10 border-amber-500/20"
    case "PAID":
      return "text-emerald-500 bg-emerald-500/10 border-emerald-500/20"
    case "CANCELLED":
      return "text-red-500 bg-red-500/10 border-red-500/20"
    case "VOID":
      return "text-gray-500 bg-gray-500/10 border-gray-500/20"
    default:
      return "text-gray-500 bg-gray-500/10 border-gray-500/20"
  }
}

export function getPaymentStatusColor(status: PaymentStatus): string {
  switch (status) {
    case "PENDING":
      return "text-amber-500 bg-amber-500/10 border-amber-500/20"
    case "COMPLETED":
      return "text-emerald-500 bg-emerald-500/10 border-emerald-500/20"
    case "FAILED":
      return "text-red-500 bg-red-500/10 border-red-500/20"
    case "REFUNDED":
      return "text-blue-500 bg-blue-500/10 border-blue-500/20"
    default:
      return "text-gray-500 bg-gray-500/10 border-gray-500/20"
  }
}

// ===== Status Label Functions =====

export function getClientStatusLabel(status: ClientStatus): string {
  const labels: Record<ClientStatus, string> = {
    ACTIVE: "Activo",
    INACTIVE: "Inactivo",
    SUSPENDED: "Suspendido",
  }
  return labels[status] || status
}

export function getContractStatusLabel(status: ContractStatus): string {
  const labels: Record<ContractStatus, string> = {
    DRAFT: "Borrador",
    ACTIVE: "Activo",
    SUSPENDED: "Suspendido",
    TERMINATED: "Terminado",
    EXPIRED: "Vencido",
  }
  return labels[status] || status
}

export function getInvoiceStatusLabel(status: InvoiceStatus): string {
  const labels: Record<InvoiceStatus, string> = {
    DRAFT: "Borrador",
    ISSUED: "Emitida",
    PARTIAL: "Pago Parcial",
    PAID: "Pagada",
    CANCELLED: "Cancelada",
    VOID: "Anulada",
  }
  return labels[status] || status
}

export function getPaymentStatusLabel(status: PaymentStatus): string {
  const labels: Record<PaymentStatus, string> = {
    PENDING: "Pendiente",
    COMPLETED: "Completado",
    FAILED: "Fallido",
    REFUNDED: "Reembolsado",
  }
  return labels[status] || status
}

export function getBillingFrequencyLabel(frequency: BillingFrequency): string {
  const labels: Record<BillingFrequency, string> = {
    WEEKLY: "Semanal",
    BIWEEKLY: "Quincenal",
    MONTHLY: "Mensual",
    QUARTERLY: "Trimestral",
    ANNUALLY: "Anual",
    ONE_TIME: "Una vez",
  }
  return labels[frequency] || frequency
}

// ===== Calculation Helpers =====

/**
 * Calculate ITBIS (Dominican VAT) - default 18%
 */
export function calculateITBIS(amount: number, rate = 0.18): number {
  return amount * rate
}

/**
 * Calculate line total with optional ITBIS
 */
export function calculateLineTotal(
  quantity: number,
  unitPrice: number,
  itbisApplicable: boolean,
  itbisRate = 0.18,
): { subtotal: number; itbis: number; total: number } {
  const subtotal = quantity * unitPrice
  const itbis = itbisApplicable ? calculateITBIS(subtotal, itbisRate) : 0
  return {
    subtotal,
    itbis,
    total: subtotal + itbis,
  }
}

// ===== Validation Helpers =====

/**
 * Check if invoice is editable
 */
export function isInvoiceEditable(status: InvoiceStatus): boolean {
  return status === "DRAFT"
}

/**
 * Check if contract is editable
 */
export function isContractEditable(status: ContractStatus): boolean {
  return status === "DRAFT"
}

/**
 * Check if invoice can receive payment
 */
export function canReceivePayment(status: InvoiceStatus): boolean {
  return status === "ISSUED" || status === "PARTIAL"
}

// ===== FILE: lib\utils\formatters.ts =====

import { formatDistanceToNow, format } from "date-fns"

export function formatDate(date: string | Date): string {
  return format(new Date(date), "MMM d, yyyy")
}

export function formatDateTime(date: string | Date): string {
  return format(new Date(date), "MMM d, yyyy 'at' h:mm a")
}

export function formatRelativeTime(date: string | Date): string {
  return formatDistanceToNow(new Date(date), { addSuffix: true })
}

export function formatFullName(firstName: string, lastName: string): string {
  return `${firstName} ${lastName}`.trim()
}

export function getInitials(firstName: string, lastName: string): string {
  return `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase()
}

// ===== FILE: lib\utils\permissions.ts =====

import type { User } from "@/types"

// Check if user has specific permission
export function can(user: User | null, permission: string): boolean {
  if (!user) return false
  if (user.roles.includes("SUPERADMIN")) return true
  return user.permissions.includes(permission)
}

// Check if user has any of the permissions
export function canAny(user: User | null, permissions: string[]): boolean {
  if (!user) return false
  if (user.roles.includes("SUPERADMIN")) return true
  return permissions.some((p) => user.permissions.includes(p))
}

// Check if user has all permissions
export function canAll(user: User | null, permissions: string[]): boolean {
  if (!user) return false
  if (user.roles.includes("SUPERADMIN")) return true
  return permissions.every((p) => user.permissions.includes(p))
}

// Check if user has role
export function hasRole(user: User | null, role: string): boolean {
  if (!user) return false
  return user.roles.includes(role)
}

// Check if user has any of the roles
export function hasAnyRole(user: User | null, roles: string[]): boolean {
  if (!user) return false
  return roles.some((r) => user.roles.includes(r))
}

// Role hierarchy (lower number = higher authority)
export const ROLE_HIERARCHY: Record<string, number> = {
  SUPERADMIN: 1,
  ADMINISTRADOR_GENERAL: 2,
  USER_ADMIN: 3,
  VIEWER: 4,
}

// Check if user has higher or equal role
export function hasHigherOrEqualRole(user: User | null, role: string): boolean {
  if (!user) return false
  const userHighestRole = Math.min(...user.roles.map((r) => ROLE_HIERARCHY[r] ?? 999))
  const targetLevel = ROLE_HIERARCHY[role] ?? 999
  return userHighestRole <= targetLevel
}

// Get role color for UI
export function getRoleColor(role: string): string {
  switch (role) {
    case "SUPERADMIN":
      return "bg-red-500/10 text-red-500 border-red-500/20"
    case "ADMINISTRADOR_GENERAL":
      return "bg-blue-500/10 text-blue-500 border-blue-500/20"
    case "USER_ADMIN":
      return "bg-emerald-500/10 text-emerald-500 border-emerald-500/20"
    case "VIEWER":
      return "bg-gray-500/10 text-gray-400 border-gray-500/20"
    default:
      return "bg-muted text-muted-foreground border-border"
  }
}

// Format permission for display
export function formatPermission(permission: string): string {
  return permission
    .split("_")
    .map((word) => word.charAt(0) + word.slice(1).toLowerCase())
    .join(" ")
}

// Group permissions by module
export function groupPermissionsByModule(permissions: string[]): Record<string, string[]> {
  return permissions.reduce(
    (acc, perm) => {
      const parts = perm.split("_")
      const module = parts[0]
      if (!acc[module]) acc[module] = []
      acc[module].push(perm)
      return acc
    },
    {} as Record<string, string[]>,
  )
}

// ===== FILE: lib\validations\auth.ts =====

import { z } from "zod"

export const loginSchema = z.object({
  email: z.string().email("Invalid email address"),
  password: z.string().min(1, "Password is required"),
})

export const registerSchema = z
  .object({
    userName: z
      .string()
      .min(3, "Username must be at least 3 characters")
      .max(50, "Username must be less than 50 characters")
      .regex(/^[a-zA-Z0-9_]+$/, "Username can only contain letters, numbers, and underscores"),
    email: z.string().email("Invalid email address"),
    password: z
      .string()
      .min(8, "Password must be at least 8 characters")
      .regex(/[A-Z]/, "Password must contain at least one uppercase letter")
      .regex(/[a-z]/, "Password must contain at least one lowercase letter")
      .regex(/[0-9]/, "Password must contain at least one number"),
    confirmPassword: z.string(),
    firstName: z.string().min(1, "First name is required"),
    lastName: z.string().min(1, "Last name is required"),
  })
  .refine((data) => data.password === data.confirmPassword, {
    message: "Passwords do not match",
    path: ["confirmPassword"],
  })

export const forgotPasswordSchema = z.object({
  email: z.string().email("Invalid email address"),
})

export const resetPasswordSchema = z
  .object({
    newPassword: z
      .string()
      .min(8, "Password must be at least 8 characters")
      .regex(/[A-Z]/, "Password must contain at least one uppercase letter")
      .regex(/[a-z]/, "Password must contain at least one lowercase letter")
      .regex(/[0-9]/, "Password must contain at least one number"),
    confirmPassword: z.string(),
  })
  .refine((data) => data.newPassword === data.confirmPassword, {
    message: "Passwords do not match",
    path: ["confirmPassword"],
  })

export type LoginFormData = z.infer<typeof loginSchema>
export type RegisterFormData = z.infer<typeof registerSchema>
export type ForgotPasswordFormData = z.infer<typeof forgotPasswordSchema>
export type ResetPasswordFormData = z.infer<typeof resetPasswordSchema>

// ===== FILE: lib\validations\business.ts =====

// ===== Business Module Zod Validations =====

import { z } from "zod"

const rncRegex = /^[0-9]{9}$|^[0-9]{11}$/

// ===== Client Validations =====

export const createClientSchema = z.object({
  name: z.string().min(1, "El nombre es requerido").max(200),
  legalName: z.string().max(200).optional(),
  legalTypeId: z.string().uuid("Seleccione un tipo legal"),
  rnc: z
    .string()
    .optional()
    .refine((val) => !val || rncRegex.test(val.replace(/[-\s]/g, "")), "El RNC debe tener 9 u 11 dígitos"),
  primaryEmail: z.string().email("Email inválido").optional().or(z.literal("")),
  secondaryEmail: z.string().email("Email inválido").optional().or(z.literal("")),
  primaryPhone: z.string().max(30).optional(),
  secondaryPhone: z.string().max(30).optional(),
  contactPerson: z.string().max(200).optional(),
  billingAddressLine1: z.string().max(255).optional(),
  billingAddressLine2: z.string().max(255).optional(),
  billingCity: z.string().max(100).optional(),
  billingProvince: z.string().max(100).optional(),
  billingPostalCode: z.string().max(20).optional(),
  serviceAddressLine1: z.string().max(255).optional(),
  serviceAddressLine2: z.string().max(255).optional(),
  serviceCity: z.string().max(100).optional(),
  serviceProvince: z.string().max(100).optional(),
  servicePostalCode: z.string().max(20).optional(),
  notes: z.string().optional(),
})

export const updateClientSchema = createClientSchema.partial().extend({
  status: z.enum(["ACTIVE", "INACTIVE", "SUSPENDED"]).optional(),
})

// ===== Service Validations =====

export const createServiceSchema = z.object({
  code: z
    .string()
    .min(1, "El código es requerido")
    .max(30)
    .regex(/^[A-Z0-9-]+$/, "Use letras mayúsculas, números y guiones"),
  name: z.string().min(1, "El nombre es requerido").max(100),
  description: z.string().max(500).optional(),
  billingUnitId: z.string().uuid("Seleccione una unidad de facturación"),
  itbisApplicable: z.boolean().default(true),
})

export const updateServiceSchema = createServiceSchema.partial().extend({
  active: z.boolean().optional(),
})

// ===== Pricing Validations =====

export const setGlobalPriceSchema = z.object({
  serviceId: z.string().uuid("Seleccione un servicio"),
  price: z.number().min(0, "El precio debe ser positivo"),
  effectiveFrom: z.string().min(1, "La fecha de vigencia es requerida"),
})

export const setClientPriceSchema = z.object({
  clientId: z.string().uuid("Seleccione un cliente"),
  serviceId: z.string().uuid("Seleccione un servicio"),
  price: z.number().min(0, "El precio debe ser positivo"),
  effectiveFrom: z.string().min(1, "La fecha de vigencia es requerida"),
})

// ===== Contract Validations =====

export const createContractLineSchema = z.object({
  serviceId: z.string().uuid("Seleccione un servicio"),
  quantity: z.number().min(0.01, "La cantidad debe ser mayor a 0"),
  billingUnitId: z.string().uuid().optional(),
  manualUnitPrice: z.number().min(0).optional(),
  itbisApplicable: z.boolean().default(true),
  scheduleNotes: z.string().max(500).optional(),
})

export const createContractSchema = z.object({
  clientId: z.string().uuid("Seleccione un cliente"),
  startDate: z.string().min(1, "La fecha de inicio es requerida"),
  endDate: z.string().optional(),
  terms: z.string().optional(),
  notes: z.string().optional(),
  billingFrequency: z.enum(["WEEKLY", "BIWEEKLY", "MONTHLY", "QUARTERLY", "ANNUALLY", "ONE_TIME"]),
  billingDayOfMonth: z.number().min(1).max(28).optional(),
  lines: z.array(createContractLineSchema).min(1, "Se requiere al menos una línea de servicio"),
})

export const updateContractSchema = z.object({
  startDate: z.string().optional(),
  endDate: z.string().optional(),
  terms: z.string().optional(),
  notes: z.string().optional(),
  billingFrequency: z.enum(["WEEKLY", "BIWEEKLY", "MONTHLY", "QUARTERLY", "ANNUALLY", "ONE_TIME"]).optional(),
  billingDayOfMonth: z.number().min(1).max(28).optional(),
})

// ===== Invoice Validations =====

export const createInvoiceLineSchema = z.object({
  serviceId: z.string().uuid().optional(),
  contractLineId: z.string().uuid().optional(),
  description: z.string().min(1, "La descripción es requerida"),
  quantity: z.number().min(0.01, "La cantidad debe ser mayor a 0"),
  billingUnitId: z.string().uuid().optional(),
  unitPrice: z.number().min(0, "El precio debe ser positivo"),
  itbisApplicable: z.boolean(),
})

export const createInvoiceSchema = z.object({
  clientId: z.string().uuid("Seleccione un cliente"),
  contractId: z.string().uuid().optional(),
  issueDate: z.string().min(1, "La fecha de emisión es requerida"),
  dueDate: z.string().min(1, "La fecha de vencimiento es requerida"),
  notes: z.string().optional(),
  lines: z.array(createInvoiceLineSchema).min(1, "Se requiere al menos una línea"),
})

export const cancelInvoiceSchema = z.object({
  reason: z.string().min(1, "El motivo de cancelación es requerido"),
})

// ===== Payment Validations =====

export const paymentAllocationSchema = z.object({
  invoiceId: z.string().uuid(),
  amount: z.number().min(0.01, "El monto debe ser mayor a 0"),
})

export const recordPaymentSchema = z.object({
  clientId: z.string().uuid("Seleccione un cliente"),
  paymentTypeId: z.string().uuid("Seleccione un tipo de pago"),
  amount: z.number().min(0.01, "El monto debe ser mayor a 0"),
  paymentDate: z.string().min(1, "La fecha de pago es requerida"),
  reference: z.string().max(100).optional(),
  notes: z.string().optional(),
  allocations: z.array(paymentAllocationSchema).optional(),
  generateReceipt: z.boolean().default(true),
})

export const createPaymentTypeSchema = z.object({
  code: z
    .string()
    .min(1, "El código es requerido")
    .max(20)
    .regex(/^[A-Z0-9-]+$/, "Use letras mayúsculas, números y guiones"),
  name: z.string().min(1, "El nombre es requerido").max(50),
  description: z.string().max(200).optional(),
  requiresReference: z.boolean().default(false),
})

// ===== Receipt Validations =====

export const voidReceiptSchema = z.object({
  reason: z.string().min(1, "El motivo de anulación es requerido"),
})

// ===== Type Exports =====

export type CreateClientFormData = z.infer<typeof createClientSchema>
export type UpdateClientFormData = z.infer<typeof updateClientSchema>
export type CreateServiceFormData = z.infer<typeof createServiceSchema>
export type UpdateServiceFormData = z.infer<typeof updateServiceSchema>
export type SetGlobalPriceFormData = z.infer<typeof setGlobalPriceSchema>
export type SetClientPriceFormData = z.infer<typeof setClientPriceSchema>
export type CreateContractFormData = z.infer<typeof createContractSchema>
export type CreateContractLineFormData = z.infer<typeof createContractLineSchema>
export type UpdateContractFormData = z.infer<typeof updateContractSchema>
export type CreateInvoiceFormData = z.infer<typeof createInvoiceSchema>
export type CreateInvoiceLineFormData = z.infer<typeof createInvoiceLineSchema>
export type CancelInvoiceFormData = z.infer<typeof cancelInvoiceSchema>
export type RecordPaymentFormData = z.infer<typeof recordPaymentSchema>
export type CreatePaymentTypeFormData = z.infer<typeof createPaymentTypeSchema>
export type VoidReceiptFormData = z.infer<typeof voidReceiptSchema>

// ===== FILE: lib\validations\roles.ts =====

import { z } from "zod"

export const createRoleSchema = z.object({
  name: z
    .string()
    .min(2, "Role name must be at least 2 characters")
    .max(50, "Role name must be less than 50 characters")
    .regex(/^[A-Z_]+$/, "Role name must be uppercase letters and underscores only"),
  description: z
    .string()
    .min(10, "Description must be at least 10 characters")
    .max(255, "Description must be less than 255 characters"),
  level: z.number().min(1).max(100, "Level must be between 1 and 100"),
  permissions: z.array(z.string()).min(1, "At least one permission is required"),
})

export const updateRoleSchema = z.object({
  description: z
    .string()
    .min(10, "Description must be at least 10 characters")
    .max(255, "Description must be less than 255 characters"),
  permissions: z.array(z.string()).min(1, "At least one permission is required"),
})

export type CreateRoleFormData = z.infer<typeof createRoleSchema>
export type UpdateRoleFormData = z.infer<typeof updateRoleSchema>

// ===== FILE: lib\validations\users.ts =====

import { z } from "zod"

export const updateUserSchema = z.object({
  firstName: z.string().min(1, "First name is required").optional(),
  lastName: z.string().min(1, "Last name is required").optional(),
  userName: z
    .string()
    .min(3, "Username must be at least 3 characters")
    .max(50, "Username must be less than 50 characters")
    .regex(/^[a-zA-Z0-9_]+$/, "Username can only contain letters, numbers, and underscores")
    .optional(),
})

export type UpdateUserFormData = z.infer<typeof updateUserSchema>
